# 亲密付 - 全局使用机制 💝

## 🎯 核心变更

### **变更前：限制在特定AI聊天窗口**
```
小红给用户开通亲密付 → 只能在小红的聊天窗口使用 ❌
```

### **变更后：全局可用**
```
小红给用户开通亲密付 → 可以在任何地方使用！✅
- ✅ 在小明的聊天窗口发红包/转账
- ✅ 在小花的聊天窗口发红包/转账  
- ✅ 在商城购买（后续）
- ✅ 在任何需要花钱的地方
```

---

## 💝 完整使用流程

### **场景：小红给用户开通亲密付，用户在小明聊天窗口使用**

```
1️⃣ 小红给用户开通亲密付（1000元/月）
   └─ 创建关系：characterId='小红ID', type='character_to_user'

2️⃣ 用户在小明的聊天窗口点击 + → 发红包
   ├─ 系统检查所有可用的亲密付
   ├─ 找到：小红的亲密付（剩余￥1000）
   ├─ 显示下拉选择框："使用亲密付"
   └─ 可以选择：小红的亲密付（剩余￥1000.00）✅

3️⃣ 用户选择使用小红的亲密付，给小明发50元红包
   ├─ 勾选"使用亲密付"
   ├─ 选择"小红的亲密付"
   ├─ 输入金额：50元
   ├─ 祝福语：生日快乐
   └─ 点击发送

4️⃣ 系统处理
   ├─ 调用：useCharacterIntimatePay('小红ID', 50, '红包：生日快乐', '小明')
   ├─ 扣除额度：小红的亲密付 usedAmount += 50
   └─ 创建通知：
       characterId: '小红ID'
       amount: 50
       description: '红包：生日快乐'
       receiverName: '小明'  ← 新增字段！

5️⃣ 小红收到通知
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   💝 亲密付消费通知
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   用户使用了你为TA开通的亲密付，消费记录如下：
   
   1. 2025-10-25 10:20:00
      消费金额：¥50.00
      消费说明：红包：生日快乐
      给谁的：小明  ← AI能看到！
   
   你可以在回复中提及这些消费，表达关心或询问详情。

6️⃣ 小红回复用户
   AI: "看到你给小明发了50块红包，是他生日吗？好贴心呀！"
```

---

## 🎨 UI 变化

### **发红包界面**

**修改前：**
```
☑️ 使用对方的亲密付（剩余￥1000.00）
```

**修改后：**
```
☑️ 使用亲密付
   ↓ (勾选后显示下拉框)
┌─────────────────────────────────────┐
│ 小红的亲密付（剩余￥1000.00）      │ ← 下拉选择
│ 小花的亲密付（剩余￥500.00）       │
│ 小刚的亲密付（剩余￥2000.00）      │
└─────────────────────────────────────┘
```

### **转账界面**

**修改前：**
```
☑️ 使用对方的亲密付（剩余￥1000.00）
```

**修改后：**
```
☑️ 使用亲密付
   ↓ (勾选后显示下拉框)
┌─────────────────────────────────────┐
│ 小红的亲密付（剩余￥1000.00）      │ ← 下拉选择
│ 小花的亲密付（剩余￥500.00）       │
│ 小刚的亲密付（剩余￥2000.00）      │
└─────────────────────────────────────┘
```

---

## 📊 数据结构变化

### **1. IntimatePayNotification 接口**

```typescript
export interface IntimatePayNotification {
  id: string
  characterId: string       // 哪个AI给用户开通的
  amount: number            // 消费金额
  description: string       // 消费说明（如"红包：生日快乐"）
  receiverName?: string     // ← 新增！接收者名字
  timestamp: number
  read: boolean
}
```

### **2. useCharacterIntimatePay 函数签名**

```typescript
// 修改前
export const useCharacterIntimatePay = (
  characterId: string,
  amount: number,
  description: string
): boolean

// 修改后
export const useCharacterIntimatePay = (
  characterId: string,
  amount: number,
  description: string,
  receiverName?: string  // ← 新增！接收者名字
): boolean
```

### **3. RedEnvelopeSender / TransferSender 组件**

```typescript
// 修改前
interface RedEnvelopeSenderProps {
  onSend: (amount: number, blessing: string, useIntimatePay?: boolean) => void
}

// 修改后
interface RedEnvelopeSenderProps {
  onSend: (
    amount: number, 
    blessing: string, 
    useIntimatePay?: boolean,
    intimatePayCharacterId?: string  // ← 新增！选择的AI ID
  ) => void
}
```

---

## 🔧 技术实现

### **1. 获取所有可用的亲密付**

```typescript
// RedEnvelopeSender.tsx
useEffect(() => {
  if (show) {
    const allRelations = getIntimatePayRelations()
    
    // 过滤出AI给用户开通的亲密付，且额度大于0
    const available = allRelations
      .filter(r => r.type === 'character_to_user')  // 只要AI给用户的
      .map(r => ({
        id: r.characterId,
        name: r.characterName,
        remaining: r.monthlyLimit - r.usedAmount
      }))
      .filter(r => r.remaining > 0)  // 额度大于0
    
    setAvailableIntimatePayList(available)
  }
}, [show])
```

### **2. 用户选择使用哪个AI的亲密付**

```tsx
{useIntimatePay && (
  <select
    value={selectedIntimatePayId}
    onChange={(e) => setSelectedIntimatePayId(e.target.value)}
  >
    {availableIntimatePayList.map(relation => (
      <option key={relation.id} value={relation.id}>
        {relation.name}的亲密付（剩余￥{relation.remaining.toFixed(2)}）
      </option>
    ))}
  </select>
)}
```

### **3. 传递选择的AI ID**

```typescript
// RedEnvelopeSender.tsx
const handleSend = () => {
  onSend(
    amountNum, 
    finalBlessing, 
    useIntimatePay, 
    useIntimatePay ? selectedIntimatePayId : undefined  // ← 传递选择的AI ID
  )
}
```

### **4. 在ChatDetail中处理**

```typescript
// ChatDetail.tsx
const handleSendRedEnvelope = (
  amount: number, 
  blessing: string, 
  useIntimatePay?: boolean, 
  intimatePayCharacterId?: string  // ← 接收选择的AI ID
) => {
  if (useIntimatePay && intimatePayCharacterId) {
    const success = useCharacterIntimatePay(
      intimatePayCharacterId,       // ← 使用选择的AI的亲密付
      amount, 
      `红包：${blessing}`,
      character?.name || '好友'    // ← 接收者名字（给谁发的）
    )
  }
}
```

### **5. 记录详细的消费信息**

```typescript
// walletUtils.ts
const addIntimatePayNotification = (
  characterId: string,      // 哪个AI的亲密付
  amount: number,
  description: string,       // "红包：生日快乐" 或 "转账：还钱"
  receiverName?: string      // "小明"
): void => {
  const notification = {
    characterId,
    amount,
    description,
    receiverName,            // ← 记录接收者
    timestamp: Date.now(),
    read: false
  }
  // 保存通知...
}
```

### **6. AI感知完整信息**

```typescript
// ChatDetail.tsx - getAIReply()
notifications.forEach((notif, idx) => {
  intimatePayContext += `${idx + 1}. ${time}\n`
  intimatePayContext += `   消费金额：¥${notif.amount.toFixed(2)}\n`
  intimatePayContext += `   消费说明：${notif.description}\n`
  
  if (notif.receiverName) {
    intimatePayContext += `   给谁的：${notif.receiverName}\n`  // ← AI能看到
  }
})
```

---

## 🎮 使用示例

### **示例1：多个AI开通亲密付**

```
小红：1000元/月
小花：500元/月
小刚：2000元/月

用户在小明的聊天窗口发100元红包：
┌─────────────────────────────────────┐
│ ☑️ 使用亲密付                        │
│ ┌─────────────────────────────────┐ │
│ │ 小红的亲密付（剩余￥1000.00）    │ │
│ │ 小花的亲密付（剩余￥500.00）     │ │
│ │ 小刚的亲密付（剩余￥2000.00）   │ │ ← 用户可以选择
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘

用户选择：小刚的亲密付 ✅

结果：
- 小刚的亲密付：2000 - 100 = 1900元
- 小刚收到通知："用户用你的亲密付给小明发了100元红包"
- 小红、小花：不受影响
```

### **示例2：在不同聊天窗口使用同一个亲密付**

```
小红给用户开通：1000元/月

场景1：用户在小明聊天窗口
- 发100元红包 → 使用小红的亲密付 ✅
- 剩余：900元

场景2：用户在小花聊天窗口  
- 转账200元 → 使用小红的亲密付 ✅
- 剩余：700元

场景3：用户在小刚聊天窗口
- 发50元红包 → 使用小红的亲密付 ✅
- 剩余：650元

小红收到的通知：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💝 亲密付消费通知
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

用户使用了你为TA开通的亲密付，消费记录如下：

1. 2025-10-25 10:20:00
   消费金额：¥100.00
   消费说明：红包：生日快乐
   给谁的：小明

2. 2025-10-25 11:30:00
   消费金额：¥200.00
   消费说明：转账：还钱
   给谁的：小花

3. 2025-10-25 14:15:00
   消费金额：¥50.00
   消费说明：红包：新年快乐
   给谁的：小刚
```

### **示例3：AI的回应**

```
用户：[使用小红的亲密付给小明发了红包]

小红回复：
"哇，刚看到你用我的亲密付给小明发了红包呀！
是他生日吗？你们关系真好~
我的亲密付随便用，不用客气哦！💕"
```

---

## 🚀 后续扩展

### **商城场景**

```typescript
// 商城购买商品
const handleBuyItem = (itemId: string, price: number) => {
  // 获取所有可用的亲密付
  const allRelations = getIntimatePayRelations()
  const available = allRelations
    .filter(r => r.type === 'character_to_user')
    .filter(r => (r.monthlyLimit - r.usedAmount) >= price)
  
  if (available.length > 0) {
    // 显示选择框
    const selectedAI = showSelectDialog(available)
    
    // 使用选择的AI的亲密付
    const success = useCharacterIntimatePay(
      selectedAI.characterId,
      price,
      `商城购买：${itemName}`,
      '商城'  // 接收者是"商城"
    )
    
    if (success) {
      // AI会收到通知：
      // "用户使用了你的亲密付，在商城购买了XXX，花费¥XX"
    }
  }
}
```

---

## ✅ 总结

### **核心变化**

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **使用范围** | 只能在特定AI聊天窗口 | 全局任何地方 ✅ |
| **AI感知** | 只知道金额和类型 | 知道金额、类型、给谁的 ✅ |
| **UI** | 固定显示一个AI | 下拉选择任意AI ✅ |
| **扩展性** | 难以扩展 | 易于扩展到商城等 ✅ |

### **优势**

1. ✅ **更灵活** - 用户可以在任何地方使用任意AI的亲密付
2. ✅ **AI感知更强** - AI知道用户把钱给谁了
3. ✅ **更真实** - 更像真实的亲密付使用场景
4. ✅ **易扩展** - 可以轻松支持商城、游戏等场景

### **使用建议**

1. ✅ 如果有多个AI开通亲密付，优先选择额度最高的
2. ✅ 可以查看交易记录，了解每个AI的亲密付使用情况
3. ✅ AI会关心你用TA的钱做什么，这是正常的互动
4. ✅ 合理使用，不要超额

---

**更新时间**: 2025-10-25  
**版本**: v3.0 - 亲密付全局使用机制

**现在亲密付可以在任何地方使用，AI也能准确感知用户把钱给谁了！** 💝
