# 后端功能部署说明

## 🎉 新增功能

1. **数据云端备份** - 聊天记录、联系人、朋友圈等数据自动备份到云端
2. **联网搜索** - AI 可以搜索实时信息（天气、新闻等）
3. **后台主动发消息** - AI 定时主动发送问候消息
4. **浏览器推送通知** - 即使关闭网页也能收到消息通知

---

## 📋 部署步骤

### 第一步：配置 Supabase 数据库（免费）

1. **注册 Supabase 账号**
   - 访问：https://supabase.com
   - 使用 GitHub 账号登录

2. **创建新项目**
   - 点击 "New Project"
   - 项目名称：`zhizhi-ai`
   - 数据库密码：设置一个强密码（记住它）
   - 区域：选择 `Southeast Asia (Singapore)` 或 `Northeast Asia (Tokyo)`
   - 点击 "Create new project"（需要等待 1-2 分钟）

3. **创建数据表**
   - 项目创建完成后，点击左侧 "SQL Editor"
   - 点击 "New query"
   - 复制粘贴以下 SQL 代码：

```sql
-- 创建用户数据表
CREATE TABLE user_data (
  id BIGSERIAL PRIMARY KEY,
  user_id TEXT UNIQUE NOT NULL,
  data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引以提高查询速度
CREATE INDEX idx_user_data_user_id ON user_data(user_id);
CREATE INDEX idx_user_data_updated_at ON user_data(updated_at);

-- 添加注释
COMMENT ON TABLE user_data IS '用户数据存储表';
COMMENT ON COLUMN user_data.user_id IS '用户唯一标识';
COMMENT ON COLUMN user_data.data IS '用户所有数据（JSON格式）';
```

   - 点击 "Run" 执行 SQL
   - 看到 "Success. No rows returned" 表示成功

4. **获取 API 密钥**
   - 点击左侧 "Settings" → "API"
   - 找到以下两个值（后面会用到）：
     - `Project URL`（类似：https://xxxxx.supabase.co）
     - `anon public` key（一串很长的字符串）

---

### 第二步：配置 Netlify 环境变量

1. **登录 Netlify**
   - 访问：https://app.netlify.com
   - 找到你的项目：`zhizhi-ai`

2. **添加环境变量**
   - 点击 "Site settings"
   - 点击左侧 "Environment variables"
   - 点击 "Add a variable" → "Add a single variable"
   - 依次添加以下 3 个变量：

**变量 1：DeepSeek API Key**
```
Key: DEEPSEEK_API_KEY
Value: 你的 DeepSeek API Key（从 https://platform.deepseek.com 获取）
```

**变量 2：Supabase URL**
```
Key: SUPABASE_URL
Value: 你的 Supabase Project URL（从上一步获取）
```

**变量 3：Supabase Key**
```
Key: SUPABASE_KEY
Value: 你的 Supabase anon public key（从上一步获取）
```

3. **保存配置**
   - 点击 "Save" 保存每个变量

---

### 第三步：安装依赖并部署

1. **安装后端依赖**
   - 打开命令行，进入项目目录
   - 运行以下命令：

```bash
cd netlify/functions
npm install
cd ../..
```

2. **部署到 Netlify**
   - 提交代码到 Git：

```bash
git add .
git commit -m "添加后端功能：数据备份、联网搜索、主动消息"
git push
```

   - Netlify 会自动检测到更新并开始部署
   - 等待 2-3 分钟，部署完成

3. **验证部署**
   - 打开你的网站：https://zhizhi-ai.netlify.app
   - 打开浏览器控制台（F12）
   - 如果没有错误提示，说明部署成功！

---

## 🧪 测试功能

### 测试 1：联网搜索
1. 打开网站，选择一个 AI 联系人
2. 发送消息："今天北京天气怎么样？"
3. AI 应该能返回实时天气信息

### 测试 2：数据备份
1. 发送几条消息
2. 关闭浏览器，清除缓存
3. 重新打开网站
4. 数据应该自动恢复

### 测试 3：主动消息
1. 等待到早上 8:00 或晚上 22:00
2. AI 会自动发送问候消息
3. 或者 3 天不聊天，AI 会主动问候

---

## 🔧 故障排查

### 问题 1：部署失败
- 检查 `netlify/functions/package.json` 是否存在
- 运行 `cd netlify/functions && npm install` 确保依赖安装成功

### 问题 2：API 调用失败
- 检查 Netlify 环境变量是否正确配置
- 检查 DeepSeek API Key 是否有效
- 查看 Netlify 部署日志（Functions → Logs）

### 问题 3：数据备份不工作
- 检查 Supabase 数据表是否创建成功
- 检查 Supabase URL 和 Key 是否正确
- 在 Supabase 后台查看 "Table Editor" → "user_data" 是否有数据

### 问题 4：定时任务不运行
- Netlify 免费版定时任务可能有延迟
- 查看 Netlify Functions 日志确认是否执行
- 可能需要升级到 Pro 版本才能使用定时任务

---

## 📊 使用限制（免费版）

| 服务 | 免费额度 | 超出后 |
|------|---------|--------|
| Netlify Functions | 125,000 次/月 | $25/百万次 |
| Netlify 定时任务 | 可能不可用 | 需升级 Pro ($19/月) |
| Supabase 存储 | 500 MB | $0.125/GB |
| Supabase API 调用 | 无限制 | 无限制 |
| DeepSeek API | 按使用付费 | ~¥0.001/1000 tokens |

**个人使用完全够用，基本不会超出免费额度！**

---

## 🎯 下一步

如果一切正常，你现在拥有：
- ✅ 云端数据备份
- ✅ AI 联网搜索
- ✅ AI 主动发消息
- ✅ 完全免费（在额度内）

**享受你的智能 AI 助手吧！** 🎉

---

## ⚠️ 注意事项

1. **不要分享你的 API Key**
2. **定期备份 Supabase 数据**（虽然云端已经很安全）
3. **监控 API 使用量**，避免超出免费额度
4. **Netlify 定时任务**在免费版可能不稳定，如需稳定使用建议升级

---

## 📞 需要帮助？

如果遇到问题：
1. 查看浏览器控制台错误信息
2. 查看 Netlify Functions 日志
3. 查看 Supabase 日志
4. 联系我获取帮助

祝使用愉快！ 😊
