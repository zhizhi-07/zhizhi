# 字体自定义功能说明

## 🎨 功能概述

在小程序中新增了**字体设置**功能，用户可以自定义聊天界面的字体样式，支持实时预览和一键应用。

## ✨ 功能特点

### 1. 丰富的字体选择
提供10种精选字体：
- **系统默认** - 使用系统默认字体，简洁清晰
- **宋体** - 经典宋体，适合正式场合
- **黑体** - 现代黑体，清晰易读
- **楷体** - 优雅楷体，温和亲切
- **仿宋** - 古典仿宋，文艺气息
- **微软雅黑** - 圆润雅黑，现代简约
- **苹方** - Apple设计，精致优雅
- **Noto Sans** - Google字体，国际化设计
- **思源黑体** - Adobe开源，专业品质
- **霞鹜文楷** - 开源楷体，温暖手写感

### 2. 实时预览
- 每个字体都有完整的预览示例
- 包含中文、英文、数字和符号
- 点击即可查看实际效果

### 3. 一键应用
- 点击任意字体即可立即应用
- 自动保存设置，下次打开仍然生效
- 支持实时切换，无需刷新页面

### 4. 视觉反馈
- 当前使用的字体会显示"使用中"标签
- 选中的字体卡片有蓝色边框高亮
- 平滑的过渡动画

## 📁 文件结构

```
src/
├── pages/
│   ├── MiniPrograms.tsx          # 小程序列表（新增字体设置入口）
│   └── FontCustomizer.tsx        # 字体自定义页面（新建）
├── App.tsx                        # 路由配置（新增字体设置路由）
├── pages/ChatDetail.tsx          # 聊天页面（新增字体应用逻辑）
└── index.css                      # 全局样式（新增字体CSS变量）
```

## 🔧 技术实现

### 1. 字体存储
```typescript
// 保存到localStorage
localStorage.setItem('chat_font_family', fontId)

// 读取字体设置
const savedFont = localStorage.getItem('chat_font_family')
```

### 2. CSS变量应用
```css
/* 在 index.css 中定义 */
:root {
  --chat-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

/* 应用到聊天消息 */
.message-bubble {
  font-family: var(--chat-font-family);
}
```

### 3. 动态更新
```typescript
// 在 ChatDetail.tsx 中监听变化
const fontId = localStorage.getItem('chat_font_family')
if (fontId && fontId !== 'system') {
  const fontFamily = fontMap[fontId]
  document.documentElement.style.setProperty('--chat-font-family', fontFamily)
}
```

### 4. 字体映射
```typescript
const fontMap: Record<string, string> = {
  'songti': '"SimSun", "STSong", serif',
  'heiti': '"SimHei", "STHeiti", "Microsoft YaHei", sans-serif',
  'kaiti': '"KaiTi", "STKaiti", serif',
  'fangsong': '"FangSong", "STFangsong", serif',
  'yahei': '"Microsoft YaHei", sans-serif',
  'pingfang': '"PingFang SC", "Hiragino Sans GB", sans-serif',
  'noto': '"Noto Sans SC", sans-serif',
  'source-han': '"Source Han Sans SC", "Noto Sans CJK SC", sans-serif',
  'lxgw': '"LXGW WenKai", "STKaiti", serif'
}
```

## 📱 使用方法

### 用户操作流程
1. 打开微信界面
2. 点击右下角"我"
3. 点击"小程序"
4. 选择"字体设置"
5. 浏览字体列表，查看预览
6. 点击喜欢的字体即可应用
7. 返回聊天界面查看效果

### 开发者使用
```typescript
// 1. 在小程序列表中添加入口（已完成）
{
  id: 4,
  name: '字体设置',
  description: '自定义聊天字体样式',
  icon: 'font',
  path: '/font-customizer',
  color: 'bg-gradient-to-br from-blue-500 to-cyan-500'
}

// 2. 创建字体自定义页面（已完成）
// src/pages/FontCustomizer.tsx

// 3. 添加路由（已完成）
<Route path="/font-customizer" element={<FontCustomizer />} />

// 4. 在聊天页面应用字体（已完成）
// src/pages/ChatDetail.tsx
```

## 🎯 核心代码

### FontCustomizer.tsx 核心逻辑
```typescript
// 应用字体
const applyFont = (fontFamily: string, fontId: string) => {
  // 保存到localStorage
  localStorage.setItem('chat_font_family', fontId)
  setCurrentFont(fontId)
  
  // 应用到全局
  document.documentElement.style.setProperty('--chat-font-family', fontFamily)
  
  // 触发storage事件，让其他页面也能更新
  window.dispatchEvent(new Event('storage'))
}
```

### ChatDetail.tsx 字体监听
```typescript
// 监听字体变化
const handleStorageChange = () => {
  const fontId = localStorage.getItem('chat_font_family')
  if (fontId && fontId !== 'system') {
    const fontFamily = fontMap[fontId]
    if (fontFamily) {
      document.documentElement.style.setProperty('--chat-font-family', fontFamily)
    }
  } else {
    document.documentElement.style.removeProperty('--chat-font-family')
  }
}

// 轮询检测变化（500ms）
const interval = setInterval(handleStorageChange, 500)
```

## 🎨 UI设计

### 字体卡片样式
```tsx
<div className={`glass-card rounded-2xl p-5 ${
  currentFont === font.id 
    ? 'ring-2 ring-blue-500 shadow-lg'  // 选中状态
    : 'hover:shadow-lg'                  // 悬停状态
}`}>
  {/* 字体名称和标签 */}
  <div className="flex items-center gap-2">
    <h3>{font.name}</h3>
    {currentFont === font.id && (
      <span className="bg-blue-500 text-white px-2 py-0.5 rounded-full">
        使用中
      </span>
    )}
  </div>
  
  {/* 字体预览 */}
  <div className="bg-white/50 rounded-xl p-4">
    <div style={{ fontFamily: font.fontFamily }}>
      你好，这是{font.name}字体
    </div>
  </div>
</div>
```

### 预览内容
每个字体卡片包含三种预览：
1. **中文预览**：你好，这是XX字体
2. **英文预览**：The quick brown fox jumps over the lazy dog
3. **符号预览**：0123456789 ！@#￥%……&*（）

## 📊 兼容性

### 字体回退机制
每个字体都配置了多个回退选项：

```typescript
// 示例：楷体
fontFamily: '"KaiTi", "STKaiti", serif'
// 优先使用 KaiTi
// 如果不可用，使用 STKaiti
// 如果都不可用，使用系统默认 serif 字体
```

### 系统支持
- **Windows**: SimSun, SimHei, KaiTi, FangSong, Microsoft YaHei
- **macOS**: STSong, STHeiti, STKaiti, STFangsong, PingFang SC
- **跨平台**: Noto Sans SC, Source Han Sans SC

## 💡 使用建议

### 1. 字体选择建议
- **日常聊天**：推荐使用系统默认、微软雅黑、苹方
- **正式场合**：推荐使用宋体、黑体
- **文艺风格**：推荐使用楷体、仿宋、霞鹜文楷
- **现代简约**：推荐使用Noto Sans、思源黑体

### 2. 性能考虑
- 字体设置立即生效，无需重启应用
- 使用CSS变量，性能开销极小
- 轮询检测间隔为500ms，不影响性能

### 3. 用户体验
- 提供丰富的预览，让用户直观选择
- 显示"使用中"标签，清晰的状态反馈
- 平滑的过渡动画，提升视觉体验

## 🔄 数据流

```
用户点击字体
    ↓
保存到 localStorage
    ↓
更新 CSS 变量 (--chat-font-family)
    ↓
触发 storage 事件
    ↓
ChatDetail 监听到变化
    ↓
应用新字体到聊天消息
    ↓
用户看到字体变化
```

## 🐛 注意事项

### 1. 字体可用性
部分字体可能需要系统支持才能正常显示：
- Windows 系统默认支持：宋体、黑体、楷体、仿宋、微软雅黑
- macOS 系统默认支持：宋体、黑体、楷体、仿宋、苹方
- 思源黑体、霞鹜文楷需要用户自行安装

### 2. 字体回退
如果用户系统不支持选择的字体，会自动回退到：
1. 字体族中的下一个字体
2. 系统默认 sans-serif 或 serif 字体

### 3. 存储持久化
- 字体设置保存在 localStorage
- 清除浏览器数据会重置为系统默认
- 建议提醒用户不要清除浏览器数据

## 🚀 未来优化方向

### 1. 更多字体
- 添加更多开源字体
- 支持用户上传自定义字体
- 提供字体下载链接

### 2. 字体大小
- 支持调整字体大小
- 提供预设的大小选项（小、中、大）
- 支持自定义字体大小

### 3. 字体粗细
- 支持调整字体粗细
- 提供预设选项（细、正常、粗）
- 支持自定义字重

### 4. 字体颜色
- 支持自定义字体颜色
- 区分用户消息和AI消息的颜色
- 提供颜色预设

### 5. 高级设置
- 字间距调整
- 行高调整
- 字体阴影效果
- 字体描边效果

## 📞 问题反馈

如果遇到以下问题，请及时反馈：
1. 字体无法正常显示
2. 字体切换不生效
3. 字体预览不准确
4. 性能问题

---

**开发时间**: 2025-01-23  
**版本**: v1.0.0  
**开发人员**: 汁汁项目团队
