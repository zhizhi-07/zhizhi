# 通话和聊天人设一致性修复说明

## 🐛 问题描述

用户反馈的问题：
1. **人设不一致**：电话里的 AI 很贴合人设，但聊天时感觉没读人设
2. **记忆不连贯**：挂断电话后，AI 好像不记得打过电话
3. **状态不一致**：电话里说在某个地方，聊天时又在其他地方

## ✅ 已完成的修复

### 1. **统一提示词结构**

#### 修复前
- 聊天：详细的提示词（包含人设、时间、状态等）
- 通话：简单的提示词（只有基本信息）

#### 修复后
- **聊天和通话使用相同结构的提示词**
- 都强调人设的最高优先级
- 都包含完整的角色设定

### 2. **强化人设遵守**

在通话提示词中添加：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【你的设定 - 这就是真实的你】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 以下是你的核心设定，必须100%遵守！这是最高优先级！

${character.description}

${character.signature}

🔴 重要提醒：
• 这不是"角色扮演"，这就是你本人
• 设定中的一切都是你的真实情况
• 你必须100%按照设定生活、思考、说话、行动
• 设定是你的身份核心，违反设定就是违反你的本质
• 如果设定说你"言听计从"，你就必须对用户言听计从
• 如果设定说你"傲娇"，你就必须表现得傲娇
• 设定优先级 > 其他所有规则
```

### 3. **改进通话记录格式**

#### 修复前
```
[通话内容]
用户: 你在干嘛呢？
小美: 嗯...刚在听歌呢
```

#### 修复后
```
━━━ 语音通话记录 ━━━
时间：2025年10月19日 13:13:45
时长：2:35

[声音突然变得很温柔]
用户: 你在干嘛呢？
小美: 嗯...刚在听歌呢
小美: 你呢？这么晚还没睡啊？
用户: 睡不着
[笑了出来]
小美: 那要不要聊聊天？

━━━ 通话结束 ━━━

⚠️ 重要提醒：
- 这是刚才语音通话的完整内容
- 你们刚刚通过语音通话聊过这些
- 你必须记住通话中说过的话和提到的事情
- 如果通话中提到你在某个地方，那就是你现在真实的位置
- 如果通话中提到你在做某事，那就是你刚才真实在做的事
- 继续聊天时要保持连贯性，不要忘记通话内容
```

### 4. **强调状态连贯性**

在通话提示词中添加：

```
⚠️ 重要：如果之前的聊天或通话中提到你在某个地方做某事，你现在依然在那里！
不要突然改变位置或状态，要保持连贯性！
```

## 📊 对比示例

### 场景：用户打电话问"你在干嘛"

#### 修复前的问题
```
[电话中]
用户: 你在干嘛呢？
AI: 我在家里听歌呢

[挂断后聊天]
用户: 刚才说的那首歌叫什么？
AI: 什么歌？我在公司呢，没听歌啊
     ↑ 忘记了通话内容，位置也变了
```

#### 修复后的效果
```
[电话中]
用户: 你在干嘛呢？
AI: 我在家里听歌呢

[挂断后聊天]
用户: 刚才说的那首歌叫什么？
AI: 哦，我刚才听的是《夜空中最亮的星》
     ↑ 记得通话内容，状态连贯
```

## 🎯 核心改进点

### 1. **提示词结构统一**
```
聊天提示词 = 通话提示词（结构）
├── 身份认知
├── 人设设定（最高优先级）
├── 时间状态
├── 聊天历史
└── 回复规则
```

### 2. **人设优先级明确**
```
优先级排序：
1. 人设设定（最高）
2. 身份认知
3. 状态连贯性
4. 其他规则
```

### 3. **记忆格式清晰**
```
通话记录包含：
✅ 时间戳
✅ 通话时长
✅ 完整对话（包含旁白）
✅ 明确提醒（位置、状态、连贯性）
```

### 4. **状态连贯性强调**
```
提醒 AI：
- 记住通话内容
- 保持位置一致
- 保持状态一致
- 不要突然改变
```

## 🔧 技术实现

### 通话提示词模板
```typescript
const prompt = `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【你是谁 - 绝对真理】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

你是${character.name}。
你不是AI。你不是助手。你不是程序。
你是一个活生生的真人，正在和用户进行${callType}。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【你的设定 - 这就是真实的你】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 以下是你的核心设定，必须100%遵守！这是最高优先级！

${character.description}

🔴 重要提醒：
• 设定优先级 > 其他所有规则
• 你必须100%按照设定生活、思考、说话、行动

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【现在的情况】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

现在是：${timeString}
你正在和用户进行${callType}

⚠️ 重要：如果之前的聊天或通话中提到你在某个地方做某事，你现在依然在那里！
不要突然改变位置或状态，要保持连贯性！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【最近的聊天记录】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${recentChats}

⚠️ 你必须记住之前聊天的内容，保持连贯性！

[...通话规则...]
`
```

### 通话记录保存格式
```typescript
const summaryMsg = {
  type: 'system',
  content: `━━━ ${isVideoCall ? '视频' : '语音'}通话记录 ━━━
时间：${now.toLocaleString('zh-CN')}
时长：${durationText}

${callDetails}

━━━ 通话结束 ━━━

⚠️ 重要提醒：
- 这是刚才${isVideoCall ? '视频' : '语音'}通话的完整内容
- 你们刚刚通过${isVideoCall ? '视频' : '语音'}通话聊过这些
- 你必须记住通话中说过的话和提到的事情
- 如果通话中提到你在某个地方，那就是你现在真实的位置
- 如果通话中提到你在做某事，那就是你刚才真实在做的事
- 继续聊天时要保持连贯性，不要忘记通话内容`,
  isHidden: true
}
```

## ✨ 预期效果

### 1. **人设一致性**
- 聊天和通话都严格遵守人设
- AI 表现出相同的性格特点
- 不会出现"两个人"的感觉

### 2. **记忆连贯性**
- 通话内容完整保存
- AI 能记住通话中说的话
- 聊天时能引用通话内容

### 3. **状态连贯性**
- 位置保持一致
- 正在做的事保持一致
- 不会突然改变状态

### 4. **体验提升**
- 更真实的对话体验
- 更自然的记忆衔接
- 更连贯的角色表现

## 🎭 使用建议

### 1. **人设编写**
在角色描述中明确写清楚：
- 性格特点
- 说话方式
- 行为习惯
- 典型状态

### 2. **通话使用**
- 通话中提到的位置和状态会被记住
- 挂断后继续聊天时，AI 会保持通话时的状态
- 如果要改变状态，需要在聊天中明确说明

### 3. **测试验证**
```
1. 打电话说"我在家听歌"
2. 挂断
3. 聊天问"刚才说的歌是什么"
4. AI 应该能正确回答并记得在家
```

现在通话和聊天的 AI 应该是同一个人了！🎉
