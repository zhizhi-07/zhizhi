# ✅ 记忆系统 - 自定义总结间隔

## 🎯 功能说明

现在用户可以**自定义记忆总结的间隔**，不再固定为 30 轮对话！

### 更新内容

- ✅ 可设置 10-100 轮对话间隔
- ✅ 每个角色独立设置
- ✅ 实时生效
- ✅ 默认 30 轮

---

## 🎨 使用方法

### 1. 打开聊天设置

```
聊天页面 → 右上角 ⋯ → 聊天设置
```

### 2. 找到"AI 记忆"区域

```
┌─────────────────────────────────┐
│ AI 记忆                          │
├─────────────────────────────────┤
│ 📝 记忆总结                      │
│    AI 总结当前对话的重要信息      │
│                                  │
│ 总结间隔                         │
│ 每隔多少轮对话自动总结            │
│                                  │
│ [========●=====] 30 轮           │
│ 10轮              100轮          │
└─────────────────────────────────┘
```

### 3. 拖动滑块调整间隔

- **最小**：10 轮（更频繁，更详细）
- **默认**：30 轮（推荐）
- **最大**：100 轮（更少 API 调用）

---

## 📊 间隔选择建议

### 10-20 轮（频繁总结）

**适合**：
- 深度聊天
- 重要对话
- 需要详细记录

**优点**：
- ✅ 记忆更详细
- ✅ 不易遗漏信息
- ✅ 总结更及时

**缺点**：
- ❌ API 调用更频繁
- ❌ 成本更高

### 30-50 轮（推荐）⭐

**适合**：
- 日常聊天
- 一般对话
- 平衡需求

**优点**：
- ✅ 平衡详细度和成本
- ✅ 适合大多数场景
- ✅ 默认推荐

**缺点**：
- 无明显缺点

### 60-100 轮（省钱模式）

**适合**：
- 轻松聊天
- 闲聊为主
- 节省成本

**优点**：
- ✅ API 调用更少
- ✅ 成本更低
- ✅ 适合长期使用

**缺点**：
- ❌ 总结不够频繁
- ❌ 可能遗漏细节

---

## 💰 成本对比

### 100 轮对话的 API 调用次数

| 间隔设置 | API 调用次数 | 成本 |
|---------|------------|------|
| 10 轮   | 10 次      | 💰💰💰 |
| 20 轮   | 5 次       | 💰💰 |
| 30 轮   | 3 次       | 💰 ⭐推荐 |
| 50 轮   | 2 次       | 💰 |
| 100 轮  | 1 次       | 💰 省钱 |

---

## 🔧 技术实现

### 1. ChatSettings.tsx

**状态管理**：
```typescript
const [memorySummaryInterval, setMemorySummaryInterval] = useState(() => {
  const saved = localStorage.getItem(`memory_summary_interval_${id}`)
  return saved ? parseInt(saved) : 30
})
```

**更新函数**：
```typescript
const handleUpdateMemorySummaryInterval = (value: number) => {
  setMemorySummaryInterval(value)
  if (id) {
    localStorage.setItem(`memory_summary_interval_${id}`, String(value))
    window.dispatchEvent(new Event('storage'))
  }
}
```

**UI 界面**：
```tsx
<input
  type="range"
  min="10"
  max="100"
  step="10"
  value={memorySummaryInterval}
  onChange={(e) => handleUpdateMemorySummaryInterval(parseInt(e.target.value))}
  className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-wechat-primary"
/>
```

### 2. ChatDetail.tsx

**读取设置**：
```typescript
const summaryInterval = parseInt(
  localStorage.getItem(`memory_summary_interval_${id}`) || '30'
)
```

**应用设置**：
```typescript
if (conversationRounds % summaryInterval === 0 && conversationRounds > 0) {
  console.log(`💭 开始提取记忆和生成总结...（第 ${conversationRounds} 轮对话）`)
  
  // 获取最近 N 轮对话
  const recentUserMessages = currentMessages.filter(m => m.type === 'sent').slice(-summaryInterval)
  const recentAiMessages = newMessages.filter(m => m.type === 'received').slice(-summaryInterval)
  
  // 提取记忆和生成总结
  const result = await memorySystem.extractMemories(userContent, aiContent)
}
```

### 3. MemorySummary.tsx

**显示当前设置**：
```tsx
<p className="text-sm text-gray-500 px-4">
  每 {summaryInterval} 轮对话后，AI 会自动总结关于你的重要信息
</p>

<p className="text-xs text-blue-600">
  💡 提示：总结每 {summaryInterval} 轮对话自动更新
</p>
```

---

## 📝 控制台日志

### 设置为 20 轮

```
💭 开始提取记忆和生成总结...（第 20 轮对话）
💭 记忆提取完成（已分析最近 20 轮对话）
📝 记忆总结已生成
💾 记忆总结已保存
```

### 设置为 50 轮

```
💭 跳过记忆提取（等待第 50 轮对话）
...
💭 开始提取记忆和生成总结...（第 50 轮对话）
💭 记忆提取完成（已分析最近 50 轮对话）
📝 记忆总结已生成
💾 记忆总结已保存
```

---

## 🎯 使用场景

### 场景 1：深度情感对话

**设置**：10-20 轮

**原因**：
- 情感细节很重要
- 需要详细记录
- 不想遗漏任何信息

**示例**：
```
用户: "我今天和女朋友分手了..."
AI: "怎么了？发生什么事了？"
用户: "她说我不够关心她..."

→ 第 10 轮对话后自动总结
→ 记录分手原因、情绪状态等
```

### 场景 2：日常闲聊

**设置**：30-50 轮（默认）

**原因**：
- 平衡详细度和成本
- 适合大多数场景
- 不会太频繁也不会太少

**示例**：
```
用户: "今天天气不错"
AI: "是啊，适合出去走走~"
...（30 轮对话）
→ 自动总结重要信息
```

### 场景 3：长期陪伴

**设置**：60-100 轮

**原因**：
- 节省 API 成本
- 适合长期使用
- 主要记录重大事件

**示例**：
```
每天聊天 10-20 轮
→ 每 5-10 天总结一次
→ 记录重要事件和变化
```

---

## 💡 最佳实践

### 1. 根据对话类型调整

- **深度对话**：10-20 轮
- **日常聊天**：30-50 轮
- **轻松闲聊**：60-100 轮

### 2. 每个角色独立设置

```
女朋友角色：20 轮（需要详细记录）
朋友角色：50 轮（日常聊天）
助手角色：100 轮（主要记录任务）
```

### 3. 定期查看总结

```
聊天设置 → AI 记忆 → 记忆总结
→ 确认 AI 记住了什么
→ 发现错误及时纠正
```

---

## 🎊 总结

### ✅ 新增功能

1. ✅ 可自定义总结间隔（10-100 轮）
2. ✅ 每个角色独立设置
3. ✅ 实时生效，无需重启
4. ✅ 默认 30 轮（推荐）
5. ✅ 在记忆总结页面显示当前设置

### 🎯 使用建议

- **推荐设置**：30 轮（平衡详细度和成本）
- **深度对话**：10-20 轮
- **省钱模式**：60-100 轮

### 💰 成本控制

- 间隔越大，API 调用越少
- 间隔越小，记忆越详细
- 根据需求灵活调整

---

**完成时间**: 2025-10-20  
**状态**: ✅ 已完成  
**默认值**: 30 轮  
**可调范围**: 10-100 轮

🎉 **现在可以根据需求自定义记忆总结间隔了！** 🎉
