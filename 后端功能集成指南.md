# 后端功能集成指南

## 📦 已创建的文件

### 后端文件
- `netlify/functions/chat.ts` - AI 对话 API（支持联网搜索）
- `netlify/functions/sync-data.ts` - 数据同步 API（云端备份/恢复）
- `netlify/functions/scheduled-messages.ts` - 定时任务（AI 主动发消息）
- `netlify/functions/package.json` - 后端依赖配置

### 前端文件
- `src/hooks/useBackend.ts` - 后端 API 调用 Hook
- `src/hooks/useNotifications.ts` - 浏览器通知 Hook
- `src/components/BackendStatus.tsx` - 后端状态显示组件

### 配置文件
- `netlify.toml` - 已更新，支持 Functions 和定时任务

---

## 🔧 如何集成到现有代码

### 1. 在 App.tsx 中添加后端状态组件

找到 `src/App.tsx`，在顶部导入：

```typescript
import { BackendStatus } from './components/BackendStatus';
```

在返回的 JSX 中添加（通常在最外层）：

```typescript
return (
  <div className="app">
    <BackendStatus />  {/* 添加这一行 */}
    {/* 其他组件 */}
  </div>
);
```

---

### 2. 在 ApiContext 中集成后端 API

找到 `src/context/ApiContext.tsx`，修改如下：

#### 步骤 2.1：导入 Hook

```typescript
import { useBackend } from '../hooks/useBackend';
```

#### 步骤 2.2：在 ApiProvider 中使用

```typescript
export const ApiProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [apiKey, setApiKey] = useState('');
  const { isBackendAvailable, chatWithAI, backupData, restoreData } = useBackend();

  // 原有代码...

  // 修改 callApi 函数，优先使用后端
  const callApi = async (messages: any[]) => {
    // 如果后端可用，使用后端 API（支持联网搜索）
    if (isBackendAvailable) {
      try {
        const response = await chatWithAI(messages, true); // true = 启用联网搜索
        return response.choices[0].message.content;
      } catch (error) {
        console.error('后端 API 调用失败，回退到直接调用:', error);
        // 回退到原有的直接调用方式
      }
    }

    // 原有的 API 调用代码（作为后备）
    // ...
  };

  return (
    <ApiContext.Provider value={{ 
      apiKey, 
      setApiKey, 
      callApi,
      isBackendAvailable,
      backupData,
      restoreData
    }}>
      {children}
    </ApiContext.Provider>
  );
};
```

---

### 3. 添加自动数据备份

在需要保存数据的地方（比如发送消息后），调用自动备份：

```typescript
import { useBackend } from '../hooks/useBackend';

const { autoBackup } = useBackend();

// 在数据变化时调用
useEffect(() => {
  const allData = {
    messages: messages,
    contacts: contacts,
    moments: moments,
    memories: memories,
    settings: settings
  };
  
  autoBackup(allData); // 自动防抖备份
}, [messages, contacts, moments, memories, settings]);
```

---

### 4. 添加数据恢复功能

在应用启动时恢复数据：

```typescript
import { useBackend } from '../hooks/useBackend';

const { restoreData } = useBackend();

useEffect(() => {
  const loadData = async () => {
    const cloudData = await restoreData();
    
    if (cloudData) {
      // 恢复数据到 state
      setMessages(cloudData.messages || []);
      setContacts(cloudData.contacts || []);
      setMoments(cloudData.moments || []);
      setMemories(cloudData.memories || []);
      setSettings(cloudData.settings || {});
      
      console.log('✅ 数据已从云端恢复');
    }
  };
  
  loadData();
}, []);
```

---

### 5. 添加消息通知

在收到新消息时发送通知：

```typescript
import { useNotifications } from '../hooks/useNotifications';

const { notifyNewMessage, permission, requestPermission } = useNotifications();

// 首次使用时请求权限
useEffect(() => {
  if (permission === 'default') {
    requestPermission();
  }
}, []);

// 收到新消息时
const handleNewMessage = (contactName: string, message: string) => {
  // 如果窗口不在焦点，发送通知
  if (document.hidden) {
    notifyNewMessage(contactName, message);
  }
};
```

---

## 🎯 功能特性

### 1. 联网搜索

AI 现在可以搜索实时信息：

```typescript
// 用户问："今天北京天气怎么样？"
// AI 会自动联网搜索并返回实时天气信息
```

**无需额外配置，后端 API 已自动启用！**

---

### 2. 数据云端备份

数据自动备份到 Supabase：

- 聊天记录
- 联系人列表
- 朋友圈内容
- AI 记忆
- 用户设置

**每次数据变化后 5 秒自动备份（防抖）**

---

### 3. AI 主动发消息

定时任务每小时运行一次，检查：

- **早上 8:00** - 发送早安问候
- **晚上 22:00** - 发送晚安消息
- **3 天未聊天** - AI 主动问候

**消息会保存到数据库，用户打开网页时自动显示**

---

### 4. 浏览器推送通知

即使关闭网页也能收到通知：

- 新消息通知
- 朋友圈更新通知
- 提醒通知

---

## 🚀 部署步骤

### 1. 安装依赖

```bash
# 安装后端依赖
cd netlify/functions
npm install
cd ../..

# 安装前端依赖（如果有新增）
npm install
```

### 2. 配置 Supabase

参考 `后端部署说明.md` 中的详细步骤。

### 3. 配置 Netlify 环境变量

在 Netlify 后台添加：
- `DEEPSEEK_API_KEY`
- `SUPABASE_URL`
- `SUPABASE_KEY`

### 4. 部署

```bash
git add .
git commit -m "添加后端功能"
git push
```

Netlify 会自动部署！

---

## 🧪 测试功能

### 测试联网搜索

1. 打开网站
2. 发送消息："今天天气怎么样？"
3. AI 应该返回实时天气信息

### 测试数据备份

1. 发送几条消息
2. 打开浏览器控制台，查看是否有 "数据备份成功" 日志
3. 清除浏览器缓存
4. 刷新页面
5. 数据应该自动恢复

### 测试推送通知

1. 点击 "开启通知" 按钮
2. 允许通知权限
3. 最小化浏览器窗口
4. 等待 AI 主动发消息（或手动触发）
5. 应该收到桌面通知

---

## 📊 API 使用示例

### 调用 AI 对话（带联网搜索）

```typescript
const { chatWithAI } = useBackend();

const response = await chatWithAI([
  { role: 'user', content: '今天北京天气怎么样？' }
], true); // true = 启用联网搜索

console.log(response.choices[0].message.content);
```

### 备份数据

```typescript
const { backupData } = useBackend();

await backupData({
  messages: [...],
  contacts: [...],
  moments: [...],
});
```

### 恢复数据

```typescript
const { restoreData } = useBackend();

const data = await restoreData();
if (data) {
  console.log('恢复的数据:', data);
}
```

---

## ⚠️ 注意事项

1. **后端可选**：如果后端不可用，应用会自动回退到本地模式
2. **渐进增强**：所有功能都是渐进增强，不会破坏现有功能
3. **错误处理**：所有 API 调用都有错误处理和回退机制
4. **性能优化**：数据备份使用防抖，避免频繁请求

---

## 🎉 完成！

现在你的应用拥有：
- ✅ AI 联网搜索能力
- ✅ 云端数据备份
- ✅ AI 主动发消息
- ✅ 浏览器推送通知
- ✅ 完全免费（在免费额度内）

**享受你的智能 AI 助手吧！** 🚀
