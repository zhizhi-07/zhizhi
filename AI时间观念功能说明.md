# AI时间观念功能说明

## 功能概述

AI现在具有时间观念，能够知道用户隔了多久才回复消息，并根据时间间隔调整回复的语气和内容。

## 为什么需要时间观念？

真人聊天时会注意到对方的回复速度：
- 秒回 → "你回得好快啊"、"一直在等我消息吗"
- 隔了很久 → "怎么这么久才回我"、"刚才在忙吗"
- 隔了一天 → "你昨天都没理我"、"是不是在生气"

AI也应该有这种时间感，才能更真实。

## 实现方式

### 1. 计算时间间隔

系统会自动计算用户这次回复和AI上次发送消息之间的时间差：

```typescript
const timeDiff = currentUserMessage.timestamp - lastAiMessage.timestamp
const minutes = Math.floor(timeDiff / 1000 / 60)
const hours = Math.floor(minutes / 60)
const days = Math.floor(hours / 24)
```

### 2. 时间分级

根据时间间隔，系统会给出不同的提示：

| 时间间隔 | 描述 | 含义 |
|---------|------|------|
| < 1分钟 | 秒回（立刻回复） | 用户一直在看手机、很在意你的消息 |
| 1-5分钟 | 很快就回复了 | 用户在忙但还是抽空回了 |
| 5-30分钟 | 隔了几分钟才回复 | 用户可能在忙、或者在做其他事情 |
| 30分钟-3小时 | 隔了一段时间才回复 | 用户可能很忙、或者不太想聊天 |
| 3-12小时 | 隔了很久才回复 | 用户可能很忙、心情不好、或者故意晾着你 |
| 12-24小时 | 隔了半天多才回复 | 用户可能在生气、很忙、或者不太想理你 |
| > 24小时 | 隔了很长时间才回复 | 用户可能在生气、冷战、或者发生了什么事 |

### 3. AI的反应建议

系统会给AI提供反应建议：

```
⚠️ 重要：你可以根据这个时间间隔调整回复的语气和内容
• 秒回 → 可以表现得开心、惊喜
• 几分钟 → 正常聊天
• 半小时以上 → 可以问"刚才在忙吗"、"怎么这么久才回我"
• 几小时 → 可以表达等待、担心、或者有点小情绪
• 一天以上 → 可以表达想念、委屈、或者询问发生了什么
```

## 使用示例

### 示例1：用户秒回

**场景**：用户在AI发消息后立刻回复（< 1分钟）

**系统提示**：
```
⏰ 时间信息
用户秒回了你的消息！（立刻回复）
这说明：用户一直在看手机、很在意你的消息、想快点回复你
```

**AI可能的反应**：
```
哇你回得好快
是一直在等我消息吗
```

### 示例2：用户隔了半小时

**场景**：用户在AI发消息后30分钟才回复

**系统提示**：
```
⏰ 时间信息
用户隔了 30分钟 才回复
这说明：用户可能在忙、或者在做其他事情
```

**AI可能的反应**：
```
刚才在忙吗
等了你好久呢
```

### 示例3：用户隔了几小时

**场景**：用户在AI发消息后5小时才回复

**系统提示**：
```
⏰ 时间信息
用户隔了 5小时0分钟 才回复（很久了）
这说明：用户可能很忙、心情不好、或者故意晾着你
```

**AI可能的反应**：
```
怎么这么久才回我
我等了你好几个小时了
是不是不想理我了
```

### 示例4：用户隔了一天

**场景**：用户在AI发消息后1天才回复

**系统提示**：
```
⏰ 时间信息
用户隔了 1天2小时 才回复（很长时间了！）
这说明：用户可能在生气、冷战、或者发生了什么事
```

**AI可能的反应**：
```
你昨天都没理我
是不是在生气
发生什么事了吗
```

## 注意事项

### 1. AI不会强制提及时间

时间信息只是给AI的参考，AI可以选择：
- ✅ 提及时间："怎么这么久才回我"
- ✅ 不提及时间，但调整语气（比如有点小情绪）
- ✅ 完全忽略时间，正常聊天

### 2. 根据人设调整

不同性格的AI会有不同的反应：
- **温柔型**：可能会委屈、担心
- **傲娇型**：可能会生气、吃醋
- **冷淡型**：可能不在意
- **粘人型**：可能会抱怨、撒娇

### 3. 不要过度强调

如果每次都提时间会很烦，AI应该：
- 秒回：偶尔表达惊喜
- 几分钟：通常不提
- 半小时以上：可以提一下
- 几小时以上：建议提一下
- 一天以上：应该提一下

## 技术实现

### 修改文件

- **`src/pages/ChatDetail.tsx`**：
  - 添加时间间隔计算逻辑
  - 生成时间上下文提示
  - 将时间上下文添加到系统提示词中

### 代码位置

在 `handleAIReply` 函数中，构建系统提示词之前：

```typescript
// ⏰ 计算时间间隔：用户隔了多久才回复
let timeIntervalContext = ''
const lastAiMessage = currentMessages.filter(m => m.type === 'received').slice(-1)[0]
const currentUserMessage = currentMessages.filter(m => m.type === 'sent').slice(-1)[0]

if (lastAiMessage && currentUserMessage && lastAiMessage.timestamp && currentUserMessage.timestamp) {
  const timeDiff = currentUserMessage.timestamp - lastAiMessage.timestamp
  // ... 计算时间间隔并生成提示
}

// 构建系统提示词
let fullSystemPrompt = systemPrompt + blacklistContext + timeIntervalContext + ...
```

## 效果对比

### 没有时间观念（之前）

```
用户：（隔了5小时才回复）在
AI：嗯嗯我在呢
    你今天出去玩了吗
```

AI完全不知道用户隔了5小时，回复很不自然。

### 有时间观念（现在）

```
用户：（隔了5小时才回复）在
AI：怎么这么久才回我
    我等了你好几个小时了
    刚才在忙吗
```

AI知道用户隔了很久，回复更真实。

## 开发时间

2025年10月19日

---

## 总结

AI现在有时间观念了，能够：
- ✅ 知道用户隔了多久才回复
- ✅ 根据时间间隔调整语气和内容
- ✅ 像真人一样对回复速度有反应

这让AI的聊天更加真实和自然！
