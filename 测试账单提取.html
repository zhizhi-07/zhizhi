<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•è´¦å•æå–</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>è´¦å•æå–æµ‹è¯•å·¥å…·</h1>
    
    <div>
        <h2>æµ‹è¯•AIå›å¤</h2>
        <textarea id="testInput" style="width: 100%; height: 100px; padding: 10px; font-size: 14px;" placeholder="ç²˜è´´AIçš„å®Œæ•´å›å¤..."></textarea>
        <button onclick="testExtraction()">æµ‹è¯•æå–</button>
        <button onclick="checkLocalStorage()">æŸ¥çœ‹æœ¬åœ°è´¦å•</button>
        <button onclick="clearTransactions()">æ¸…ç©ºè´¦å•</button>
    </div>
    
    <div id="result"></div>
    
    <h2>æ ‡å‡†æµ‹è¯•ç”¨ä¾‹</h2>
    <div id="testCases"></div>

    <script>
        // æå–å‡½æ•°ï¼ˆå¤åˆ¶è‡ªä»£ç ï¼‰
        function extractBillFromAIResponse(response) {
            const billPattern = /\[BILL:(expense|income)\|(\d+\.?\d*)\|(\w+)\|([^\]]+)\]/;
            const match = response.match(billPattern);
            
            if (!match) return null;
            
            const [, type, amount, category, description] = match;
            
            return {
                type: type,
                amount: parseFloat(amount),
                category,
                description: description.trim(),
                cleanResponse: response.replace(billPattern, '').trim()
            };
        }

        function testExtraction() {
            const input = document.getElementById('testInput').value;
            const result = extractBillFromAIResponse(input);
            
            const resultDiv = document.getElementById('result');
            if (result) {
                resultDiv.innerHTML = `
                    <div class="test-case success">
                        <h3>âœ… æå–æˆåŠŸï¼</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                        <p><strong>æ˜¾ç¤ºç»™ç”¨æˆ·çš„å†…å®¹ï¼š</strong></p>
                        <pre>${result.cleanResponse}</pre>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="test-case fail">
                        <h3>âŒ æå–å¤±è´¥</h3>
                        <p>AIå›å¤ä¸­æ²¡æœ‰æ‰¾åˆ° [BILL:...] æ ‡è®°</p>
                        <p><strong>åŸå§‹å›å¤ï¼š</strong></p>
                        <pre>${input}</pre>
                    </div>
                `;
            }
        }

        function checkLocalStorage() {
            const transactions = localStorage.getItem('accounting_transactions');
            const resultDiv = document.getElementById('result');
            
            if (transactions) {
                const parsed = JSON.parse(transactions);
                resultDiv.innerHTML = `
                    <div class="test-case">
                        <h3>ğŸ“Š æœ¬åœ°è´¦å•æ•°æ®ï¼ˆå…± ${parsed.length} æ¡ï¼‰</h3>
                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="test-case fail">
                        <h3>âŒ æ²¡æœ‰æ‰¾åˆ°è´¦å•æ•°æ®</h3>
                        <p>localStorage ä¸­æ²¡æœ‰ accounting_transactions</p>
                    </div>
                `;
            }
        }

        function clearTransactions() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è´¦å•å—ï¼Ÿ')) {
                localStorage.removeItem('accounting_transactions');
                alert('å·²æ¸…ç©ºè´¦å•æ•°æ®');
                checkLocalStorage();
            }
        }

        // è¿è¡Œæ ‡å‡†æµ‹è¯•ç”¨ä¾‹
        function runStandardTests() {
            const testCases = [
                {
                    name: 'å¥¶èŒ¶æ¶ˆè´¹',
                    input: 'å¥½çš„ï¼Œå·²ç»å¸®ä½ è®°å½•äº†ï¼é¤é¥®æ¶ˆè´¹20å…ƒï¼Œå¤‡æ³¨ï¼šä¹°äº†ä¸€æ¯å¥¶èŒ¶ã€‚ä»Šå¤©å–å¥¶èŒ¶å•¦ï½[BILL:expense|20|food|ä¹°äº†ä¸€æ¯å¥¶èŒ¶]',
                    expected: { type: 'expense', amount: 20, category: 'food' }
                },
                {
                    name: 'èºè›³ç²‰æ¶ˆè´¹',
                    input: 'å“‡ï¼ä¸‰å—é’±çœŸçš„å¥½åˆ’ç®—å•Šï½å·²ç»å¸®ä½ è®°å½•å¥½äº†ï¼šé¤é¥®æ¶ˆè´¹3å…ƒï¼Œå¤‡æ³¨ï¼šä¸€ç¢—èºè›³ç²‰ã€‚è¿™ä¹ˆä¾¿å®œçš„èºè›³ç²‰æ˜¯åœ¨å“ªé‡Œä¹°çš„å‘€ï¼Ÿ[BILL:expense|3|food|ä¸€ç¢—èºè›³ç²‰]',
                    expected: { type: 'expense', amount: 3, category: 'food' }
                },
                {
                    name: 'æ‰“è½¦æ¶ˆè´¹',
                    input: 'å¥½çš„ï¼äº¤é€š15å…ƒå·²è®°å½•ã€‚è®°å¾—æ³¨æ„å®‰å…¨å“¦ï½[BILL:expense|15|transport|æ‰“è½¦å›å®¶]',
                    expected: { type: 'expense', amount: 15, category: 'transport' }
                },
                {
                    name: 'å·¥èµ„æ”¶å…¥',
                    input: 'æ­å–œæ­å–œï¼å·¥èµ„5000å…ƒå·²è®°å½•ï½è¿™ä¸ªæœˆè¦å¥½å¥½è§„åˆ’å“¦[BILL:income|5000|salary|å·¥èµ„]',
                    expected: { type: 'income', amount: 5000, category: 'salary' }
                },
                {
                    name: 'æ²¡æœ‰æ ‡è®°ï¼ˆæ­£å¸¸èŠå¤©ï¼‰',
                    input: 'æ€ä¹ˆå•¦ï¼Ÿå‘ç”Ÿä»€ä¹ˆäº‹äº†å—ï¼Ÿè·Ÿæˆ‘è¯´è¯´å§ï½',
                    expected: null
                }
            ];

            const testCasesDiv = document.getElementById('testCases');
            testCasesDiv.innerHTML = testCases.map(tc => {
                const result = extractBillFromAIResponse(tc.input);
                const success = tc.expected === null 
                    ? result === null 
                    : result && result.type === tc.expected.type && result.amount === tc.expected.amount;
                
                return `
                    <div class="test-case ${success ? 'success' : 'fail'}">
                        <h3>${success ? 'âœ…' : 'âŒ'} ${tc.name}</h3>
                        <p><strong>è¾“å…¥ï¼š</strong></p>
                        <pre>${tc.input}</pre>
                        <p><strong>æå–ç»“æœï¼š</strong></p>
                        <pre>${result ? JSON.stringify(result, null, 2) : 'null'}</pre>
                    </div>
                `;
            }).join('');
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        runStandardTests();
    </script>
</body>
</html>
