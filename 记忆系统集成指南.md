# ğŸ”§ è®°å¿†ç³»ç»Ÿé›†æˆæŒ‡å—

## ğŸ“‹ å¿«é€Ÿé›†æˆæ­¥éª¤

### ç¬¬1æ­¥ï¼šæ·»åŠ è·¯ç”±ï¼ˆApp.tsxï¼‰

```typescript
// åœ¨ App.tsx ä¸­æ·»åŠ è®°å¿†æŸ¥çœ‹å™¨è·¯ç”±
import MemoryViewer from './pages/MemoryViewer'

// åœ¨ Routes ä¸­æ·»åŠ 
<Route path="/memory/:id" element={<MemoryViewer />} />
```

### ç¬¬2æ­¥ï¼šåœ¨ ChatSettings ä¸­æ·»åŠ å…¥å£

```typescript
// src/pages/ChatSettings.tsx
import { useNavigate } from 'react-router-dom'

const ChatSettings = () => {
  const navigate = useNavigate()
  
  return (
    // ... å…¶ä»–è®¾ç½®
    
    <div 
      className="flex items-center justify-between p-4 bg-white border-b"
      onClick={() => navigate(`/memory/${id}`)}
    >
      <div className="flex items-center gap-3">
        <span className="text-2xl">ğŸ’­</span>
        <div>
          <div className="font-medium">æŸ¥çœ‹è®°å¿†</div>
          <div className="text-xs text-gray-500">æŸ¥çœ‹ AI è®°ä½çš„å†…å®¹</div>
        </div>
      </div>
      <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
      </svg>
    </div>
  )
}
```

### ç¬¬3æ­¥ï¼šé›†æˆåˆ° ChatDetail.tsx

è¿™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼åœ¨èŠå¤©é¡µé¢ä¸­é›†æˆè®°å¿†ç³»ç»Ÿã€‚

#### 3.1 å¯¼å…¥å¿…è¦çš„æ¨¡å—

```typescript
// åœ¨ ChatDetail.tsx é¡¶éƒ¨æ·»åŠ 
import { useMemory } from '../hooks/useMemory'
```

#### 3.2 åˆå§‹åŒ–è®°å¿†ç³»ç»Ÿ

```typescript
const ChatDetail = () => {
  const { id } = useParams()
  
  // åˆå§‹åŒ–è®°å¿†ç³»ç»Ÿ
  const { 
    extractMemories, 
    getMemorySummary,
    getRelevantMemories 
  } = useMemory(id || '')
  
  // ... å…¶ä»–ä»£ç 
}
```

#### 3.3 ä¿®æ”¹ AI å›å¤å‡½æ•°

æ‰¾åˆ°ä½ çš„ `getAIReply` æˆ–ç±»ä¼¼çš„ AI è°ƒç”¨å‡½æ•°ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

```typescript
const getAIReply = async (userMessage: string) => {
  setIsAiTyping(true)
  
  try {
    // 1. è·å–è®°å¿†æ‘˜è¦
    const memorySummary = getMemorySummary()
    console.log('ğŸ“š è®°å¿†æ‘˜è¦:', memorySummary)
    
    // 2. è·å–ç›¸å…³è®°å¿†ï¼ˆå¯é€‰ï¼Œç”¨äºæ›´ç²¾ç¡®çš„ä¸Šä¸‹æ–‡ï¼‰
    const relevantMemories = getRelevantMemories(userMessage, 5)
    console.log('ğŸ” ç›¸å…³è®°å¿†:', relevantMemories)
    
    // 3. æ„å»ºæç¤ºè¯ï¼ˆåœ¨åŸæœ‰æç¤ºè¯åŸºç¡€ä¸Šæ·»åŠ è®°å¿†ï¼‰
    const systemPrompt = buildRoleplayPrompt(
      character,
      currentUser,
      chatBackground,
      enableNarration,
      scenarioSettings
    )
    
    // åœ¨æç¤ºè¯ä¸­æ·»åŠ è®°å¿†éƒ¨åˆ†
    const fullPrompt = `${systemPrompt}

${memorySummary}

ã€é‡è¦ã€‘è¯·æ ¹æ®ä½ å¯¹ç”¨æˆ·çš„è®°å¿†ï¼Œç»™å‡ºæ›´åŠ ä¸ªæ€§åŒ–å’Œè´´å¿ƒçš„å›å¤ã€‚

ã€æœ€è¿‘å¯¹è¯ã€‘
${messages.slice(-10).map(m => 
  `${m.type === 'sent' ? currentUser?.name || 'ç”¨æˆ·' : character?.name || 'AI'}: ${m.content}`
).join('\n')}

ã€å½“å‰æ¶ˆæ¯ã€‘
ç”¨æˆ·: ${userMessage}

è¯·å›å¤:`
    
    // 4. è°ƒç”¨ AI API
    const aiReply = await callAI(fullPrompt)
    
    // 5. æå–æ–°è®°å¿†ï¼ˆé‡è¦ï¼ï¼‰
    const newMemories = extractMemories(userMessage, aiReply)
    if (newMemories.length > 0) {
      console.log(`ğŸ’­ æå–äº† ${newMemories.length} æ¡æ–°è®°å¿†:`)
      newMemories.forEach(m => {
        console.log(`  - [${m.type}] ${m.content} (é‡è¦åº¦: ${m.importance})`)
      })
    }
    
    // 6. æ·»åŠ  AI å›å¤åˆ°æ¶ˆæ¯åˆ—è¡¨
    const newMessage: Message = {
      id: Date.now(),
      type: 'received',
      content: aiReply,
      time: new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      timestamp: Date.now(),
      messageType: 'text'
    }
    
    setMessages(prev => [...prev, newMessage])
    
  } catch (error) {
    console.error('AI å›å¤å¤±è´¥:', error)
    // é”™è¯¯å¤„ç†
  } finally {
    setIsAiTyping(false)
  }
}
```

## ğŸ¯ å®Œæ•´ç¤ºä¾‹ä»£ç 

### ChatDetail.tsx é›†æˆç¤ºä¾‹

```typescript
import { useState, useEffect, useRef } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { useCharacter } from '../context/CharacterContext'
import { useUser } from '../context/UserContext'
import { useMemory } from '../hooks/useMemory'
import { buildRoleplayPrompt } from '../utils/prompts'
import { Message } from '../types/message'

const ChatDetail = () => {
  const { id } = useParams()
  const navigate = useNavigate()
  const { getCharacter } = useCharacter()
  const { currentUser } = useUser()
  
  const character = id ? getCharacter(id) : undefined
  
  // åˆå§‹åŒ–è®°å¿†ç³»ç»Ÿ
  const { 
    extractMemories, 
    getMemorySummary,
    getRelevantMemories 
  } = useMemory(id || '')
  
  const [messages, setMessages] = useState<Message[]>([])
  const [inputText, setInputText] = useState('')
  const [isAiTyping, setIsAiTyping] = useState(false)
  
  // åŠ è½½å†å²æ¶ˆæ¯
  useEffect(() => {
    if (id) {
      const saved = localStorage.getItem(`chat_${id}`)
      if (saved) {
        setMessages(JSON.parse(saved))
      }
    }
  }, [id])
  
  // ä¿å­˜æ¶ˆæ¯
  useEffect(() => {
    if (id && messages.length > 0) {
      localStorage.setItem(`chat_${id}`, JSON.stringify(messages))
    }
  }, [id, messages])
  
  // å‘é€æ¶ˆæ¯
  const handleSend = async () => {
    if (!inputText.trim() || !character) return
    
    const userMessage = inputText.trim()
    setInputText('')
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const newUserMessage: Message = {
      id: Date.now(),
      type: 'sent',
      content: userMessage,
      time: new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      timestamp: Date.now(),
      messageType: 'text'
    }
    
    setMessages(prev => [...prev, newUserMessage])
    
    // è·å– AI å›å¤
    await getAIReply(userMessage)
  }
  
  // AI å›å¤
  const getAIReply = async (userMessage: string) => {
    if (!character) return
    
    setIsAiTyping(true)
    
    try {
      // 1. è·å–è®°å¿†æ‘˜è¦
      const memorySummary = getMemorySummary()
      
      // 2. æ„å»ºæç¤ºè¯
      const systemPrompt = buildRoleplayPrompt(character, currentUser)
      
      const fullPrompt = `${systemPrompt}

${memorySummary}

ã€é‡è¦ã€‘è¯·æ ¹æ®ä½ å¯¹ç”¨æˆ·çš„è®°å¿†ï¼Œç»™å‡ºä¸ªæ€§åŒ–çš„å›å¤ã€‚å¦‚æœè®°å¿†ä¸­æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è‡ªç„¶åœ°æåŠã€‚

ã€æœ€è¿‘å¯¹è¯ã€‘
${messages.slice(-10).map(m => 
  `${m.type === 'sent' ? currentUser?.name || 'ç”¨æˆ·' : character.name}: ${m.content}`
).join('\n')}

ã€å½“å‰æ¶ˆæ¯ã€‘
${currentUser?.name || 'ç”¨æˆ·'}: ${userMessage}

${character.name}:`
      
      // 3. è°ƒç”¨ AIï¼ˆè¿™é‡Œéœ€è¦æ›¿æ¢æˆä½ çš„ API è°ƒç”¨ï¼‰
      const aiReply = await callYourAIAPI(fullPrompt)
      
      // 4. æå–æ–°è®°å¿†
      const newMemories = extractMemories(userMessage, aiReply)
      if (newMemories.length > 0) {
        console.log(`ğŸ’­ æå–äº† ${newMemories.length} æ¡æ–°è®°å¿†`)
      }
      
      // 5. æ·»åŠ  AI å›å¤
      const newAIMessage: Message = {
        id: Date.now() + 1,
        type: 'received',
        content: aiReply,
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
        timestamp: Date.now(),
        messageType: 'text'
      }
      
      setMessages(prev => [...prev, newAIMessage])
      
    } catch (error) {
      console.error('AI å›å¤å¤±è´¥:', error)
    } finally {
      setIsAiTyping(false)
    }
  }
  
  // ä½ çš„ AI API è°ƒç”¨å‡½æ•°
  const callYourAIAPI = async (prompt: string): Promise<string> => {
    // è¿™é‡Œæ›¿æ¢æˆä½ å®é™…çš„ API è°ƒç”¨
    // ä¾‹å¦‚ï¼šOpenAI, Claude, DeepSeek ç­‰
    const response = await fetch('YOUR_API_ENDPOINT', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer YOUR_API_KEY`
      },
      body: JSON.stringify({
        messages: [{ role: 'user', content: prompt }]
      })
    })
    
    const data = await response.json()
    return data.choices[0].message.content
  }
  
  return (
    <div className="h-screen flex flex-col">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <div className="bg-white border-b p-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button onClick={() => navigate(-1)}>â†</button>
          <div>
            <div className="font-medium">{character?.name}</div>
            <div className="text-xs text-gray-500">åœ¨çº¿</div>
          </div>
        </div>
        <button onClick={() => navigate(`/chat-settings/${id}`)}>
          âš™ï¸
        </button>
      </div>
      
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4">
        {messages.map(msg => (
          <div key={msg.id} className={`mb-3 ${msg.type === 'sent' ? 'text-right' : ''}`}>
            <div className={`inline-block px-4 py-2 rounded-lg ${
              msg.type === 'sent' ? 'bg-green-500 text-white' : 'bg-white'
            }`}>
              {msg.content}
            </div>
          </div>
        ))}
        
        {isAiTyping && (
          <div className="text-gray-500">æ­£åœ¨è¾“å…¥...</div>
        )}
      </div>
      
      {/* è¾“å…¥æ¡† */}
      <div className="bg-white border-t p-4 flex gap-2">
        <input
          type="text"
          value={inputText}
          onChange={(e) => setInputText(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && handleSend()}
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          className="flex-1 px-4 py-2 border rounded-lg"
        />
        <button
          onClick={handleSend}
          disabled={!inputText.trim() || isAiTyping}
          className="px-6 py-2 bg-green-500 text-white rounded-lg disabled:opacity-50"
        >
          å‘é€
        </button>
      </div>
    </div>
  )
}

export default ChatDetail
```

## ğŸ¨ æç¤ºè¯ä¼˜åŒ–å»ºè®®

### åŸºç¡€ç‰ˆæç¤ºè¯

```typescript
const prompt = `
ä½ æ˜¯ ${character.name}ï¼Œ${character.description}

${memorySummary}

è¯·æ ¹æ®è®°å¿†ä¸­çš„ä¿¡æ¯ï¼Œç»™å‡ºä¸ªæ€§åŒ–çš„å›å¤ã€‚

ç”¨æˆ·: ${userMessage}
`
```

### è¿›é˜¶ç‰ˆæç¤ºè¯

```typescript
const prompt = `
ã€è§’è‰²è®¾å®šã€‘
ä½ æ˜¯ ${character.name}
æ€§æ ¼: ${character.personality}
è¯´è¯é£æ ¼: ${character.style}

${memorySummary}

ã€å¯¹è¯è§„åˆ™ã€‘
1. å¦‚æœè®°å¿†ä¸­æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è‡ªç„¶åœ°æåŠ
2. è®°ä½ç”¨æˆ·çš„åå­—ã€å–œå¥½ç­‰é‡è¦ä¿¡æ¯
3. æ ¹æ®ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€è°ƒæ•´å›å¤
4. ä¿æŒè§’è‰²ä¸€è‡´æ€§

ã€ç¤ºä¾‹ã€‘
ç”¨æˆ·è¯´"ä»Šå¤©åƒä»€ä¹ˆ"ï¼Œå¦‚æœè®°å¿†ä¸­æœ‰ç”¨æˆ·å–œæ¬¢åƒè‰è“ï¼š
âœ… å¥½çš„å›å¤: "è¦ä¸è¦åƒè‰è“ï¼Ÿæˆ‘è®°å¾—ä½ å¾ˆå–œæ¬¢åƒå‘¢~"
âŒ ä¸å¥½çš„å›å¤: "éšä¾¿åƒä»€ä¹ˆéƒ½è¡Œ"

ã€å½“å‰å¯¹è¯ã€‘
ç”¨æˆ·: ${userMessage}
${character.name}:`
```

## ğŸ› å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šè®°å¿†æ²¡æœ‰è¢«æå–

**åŸå› **: å¯èƒ½æ˜¯æå–æ¨¡å¼æ²¡æœ‰åŒ¹é…åˆ°

**è§£å†³**:
```typescript
// æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
console.log('ç”¨æˆ·æ¶ˆæ¯:', userMessage)
console.log('AIå›å¤:', aiReply)
console.log('æå–çš„è®°å¿†:', newMemories)

// å¦‚æœæ²¡æœ‰æå–åˆ°ï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ 
if (newMemories.length === 0) {
  // æ‰‹åŠ¨æ·»åŠ é‡è¦ä¿¡æ¯
  addMemory('fact', 'ä»å¯¹è¯ä¸­æå–çš„ä¿¡æ¯', 7)
}
```

### é—®é¢˜2ï¼šAI æ²¡æœ‰ä½¿ç”¨è®°å¿†

**åŸå› **: æç¤ºè¯ä¸­æ²¡æœ‰å¼ºè°ƒä½¿ç”¨è®°å¿†

**è§£å†³**:
```typescript
const prompt = `
${memorySummary}

âš ï¸ é‡è¦ï¼šè¯·åŠ¡å¿…æ ¹æ®ä¸Šè¿°è®°å¿†ä¿¡æ¯å›å¤ï¼
å¦‚æœè®°å¿†ä¸­æœ‰ç›¸å…³å†…å®¹ï¼Œè¯·è‡ªç„¶åœ°æåŠã€‚

ç”¨æˆ·: ${userMessage}
`
```

### é—®é¢˜3ï¼šè®°å¿†å¤ªå¤šå¯¼è‡´æç¤ºè¯è¿‡é•¿

**è§£å†³**:
```typescript
// åªè·å–æœ€ç›¸å…³çš„è®°å¿†
const relevantMemories = getRelevantMemories(userMessage, 5)

// æˆ–è€…åªåŒ…å«é«˜é‡è¦åº¦çš„è®°å¿†
const importantMemories = searchMemories({ minImportance: 7 })
```

## ğŸ“Š æµ‹è¯•è®°å¿†ç³»ç»Ÿ

### æµ‹è¯•å¯¹è¯è„šæœ¬

```
ç¬¬1å¤©ï¼š
ç”¨æˆ·: ä½ å¥½ï¼æˆ‘å«å°æ˜
AI: ä½ å¥½å°æ˜ï¼
â†’ æ£€æŸ¥ï¼šæ˜¯å¦è®°å½•äº†åå­—ï¼Ÿ

ç”¨æˆ·: æˆ‘ä»Šå¹´25å²ï¼Œåœ¨åŒ—äº¬å·¥ä½œ
AI: å¥½çš„ï¼
â†’ æ£€æŸ¥ï¼šæ˜¯å¦è®°å½•äº†å¹´é¾„å’Œå·¥ä½œåœ°ç‚¹ï¼Ÿ

ç”¨æˆ·: æˆ‘æœ€å–œæ¬¢åƒè‰è“äº†
AI: å¥½çš„ï¼Œæˆ‘è®°ä½äº†ï¼
â†’ æ£€æŸ¥ï¼šæ˜¯å¦è®°å½•äº†å–œå¥½ï¼Ÿ

ç¬¬2å¤©ï¼š
ç”¨æˆ·: ä»Šå¤©åƒä»€ä¹ˆå¥½å‘¢ï¼Ÿ
AI: è¦ä¸è¦åƒè‰è“ï¼Ÿæˆ‘è®°å¾—ä½ å¾ˆå–œæ¬¢åƒå‘¢~
â†’ æµ‹è¯•ï¼šAIæ˜¯å¦ä½¿ç”¨äº†æ˜¨å¤©çš„è®°å¿†ï¼Ÿ

ç”¨æˆ·: ä½ è¿˜è®°å¾—æˆ‘å«ä»€ä¹ˆåå­—å—ï¼Ÿ
AI: å½“ç„¶è®°å¾—ï¼Œå°æ˜ï¼
â†’ æµ‹è¯•ï¼šAIæ˜¯å¦è®°å¾—åå­—ï¼Ÿ
```

### æ£€æŸ¥è®°å¿†

1. è¿›å…¥èŠå¤©è®¾ç½®
2. ç‚¹å‡»"æŸ¥çœ‹è®°å¿†"
3. æ£€æŸ¥æ˜¯å¦æœ‰ä»¥ä¸‹è®°å¿†ï¼š
   - [äº‹å®] ç”¨æˆ·åå­—æ˜¯å°æ˜
   - [äº‹å®] ç”¨æˆ·25å²
   - [äº‹å®] ç”¨æˆ·åœ¨åŒ—äº¬å·¥ä½œ
   - [åå¥½] ç”¨æˆ·å–œæ¬¢è‰è“

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### 1. å®šæœŸæ¸…ç†è®°å¿†
```typescript
// æ¯å¤©è‡ªåŠ¨æ¸…ç†ä¸€æ¬¡
useEffect(() => {
  const cleanup = setInterval(() => {
    memorySystem.cleanupMemories()
  }, 24 * 60 * 60 * 1000)
  
  return () => clearInterval(cleanup)
}, [])
```

### 2. è®°å¿†å¤‡ä»½
```typescript
// å¯¼å‡ºè®°å¿†åˆ°æ–‡ä»¶
const backupMemories = () => {
  const data = memorySystem.exportMemories()
  // ä¿å­˜åˆ°æ–‡ä»¶æˆ–äº‘ç«¯
}
```

### 3. è®°å¿†åˆ†æ
```typescript
// åˆ†æç”¨æˆ·ç”»åƒ
const analyzeUser = () => {
  const stats = getStatistics()
  const preferences = searchMemories({ type: 'preference' })
  
  console.log('ç”¨æˆ·ç”»åƒ:')
  console.log('- æ€»è®°å¿†æ•°:', stats.total)
  console.log('- å–œå¥½æ•°:', preferences.length)
  // ... æ›´å¤šåˆ†æ
}
```

## âœ… é›†æˆæ£€æŸ¥æ¸…å•

- [ ] å·²æ·»åŠ  MemoryViewer è·¯ç”±
- [ ] å·²åœ¨ ChatSettings æ·»åŠ å…¥å£
- [ ] å·²åœ¨ ChatDetail å¯¼å…¥ useMemory
- [ ] å·²åœ¨ AI å›å¤åè°ƒç”¨ extractMemories
- [ ] å·²åœ¨æç¤ºè¯ä¸­æ·»åŠ  memorySummary
- [ ] å·²æµ‹è¯•è®°å¿†æå–åŠŸèƒ½
- [ ] å·²æµ‹è¯•è®°å¿†ä½¿ç”¨åŠŸèƒ½
- [ ] å·²æµ‹è¯•è®°å¿†æŸ¥çœ‹å™¨
- [ ] æ§åˆ¶å°èƒ½çœ‹åˆ°è®°å¿†æ—¥å¿—
- [ ] AI èƒ½è‡ªç„¶åœ°ä½¿ç”¨è®°å¿†

---

**å®Œæˆé›†æˆåï¼Œä½ çš„ AI å°±èƒ½çœŸæ­£è®°ä½ç”¨æˆ·äº†ï¼** ğŸ‰

éœ€è¦å¸®åŠ©ï¼ŸæŸ¥çœ‹ `AIè®°å¿†ç³»ç»Ÿä½¿ç”¨è¯´æ˜.md` äº†è§£æ›´å¤šç»†èŠ‚ã€‚
