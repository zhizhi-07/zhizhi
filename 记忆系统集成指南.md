# 🔧 记忆系统集成指南

## 📋 快速集成步骤

### 第1步：添加路由（App.tsx）

```typescript
// 在 App.tsx 中添加记忆查看器路由
import MemoryViewer from './pages/MemoryViewer'

// 在 Routes 中添加
<Route path="/memory/:id" element={<MemoryViewer />} />
```

### 第2步：在 ChatSettings 中添加入口

```typescript
// src/pages/ChatSettings.tsx
import { useNavigate } from 'react-router-dom'

const ChatSettings = () => {
  const navigate = useNavigate()
  
  return (
    // ... 其他设置
    
    <div 
      className="flex items-center justify-between p-4 bg-white border-b"
      onClick={() => navigate(`/memory/${id}`)}
    >
      <div className="flex items-center gap-3">
        <span className="text-2xl">💭</span>
        <div>
          <div className="font-medium">查看记忆</div>
          <div className="text-xs text-gray-500">查看 AI 记住的内容</div>
        </div>
      </div>
      <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
      </svg>
    </div>
  )
}
```

### 第3步：集成到 ChatDetail.tsx

这是最重要的一步！在聊天页面中集成记忆系统。

#### 3.1 导入必要的模块

```typescript
// 在 ChatDetail.tsx 顶部添加
import { useMemory } from '../hooks/useMemory'
```

#### 3.2 初始化记忆系统

```typescript
const ChatDetail = () => {
  const { id } = useParams()
  
  // 初始化记忆系统
  const { 
    extractMemories, 
    getMemorySummary,
    getRelevantMemories 
  } = useMemory(id || '')
  
  // ... 其他代码
}
```

#### 3.3 修改 AI 回复函数

找到你的 `getAIReply` 或类似的 AI 调用函数，修改如下：

```typescript
const getAIReply = async (userMessage: string) => {
  setIsAiTyping(true)
  
  try {
    // 1. 获取记忆摘要
    const memorySummary = getMemorySummary()
    console.log('📚 记忆摘要:', memorySummary)
    
    // 2. 获取相关记忆（可选，用于更精确的上下文）
    const relevantMemories = getRelevantMemories(userMessage, 5)
    console.log('🔍 相关记忆:', relevantMemories)
    
    // 3. 构建提示词（在原有提示词基础上添加记忆）
    const systemPrompt = buildRoleplayPrompt(
      character,
      currentUser,
      chatBackground,
      enableNarration,
      scenarioSettings
    )
    
    // 在提示词中添加记忆部分
    const fullPrompt = `${systemPrompt}

${memorySummary}

【重要】请根据你对用户的记忆，给出更加个性化和贴心的回复。

【最近对话】
${messages.slice(-10).map(m => 
  `${m.type === 'sent' ? currentUser?.name || '用户' : character?.name || 'AI'}: ${m.content}`
).join('\n')}

【当前消息】
用户: ${userMessage}

请回复:`
    
    // 4. 调用 AI API
    const aiReply = await callAI(fullPrompt)
    
    // 5. 提取新记忆（重要！）
    const newMemories = extractMemories(userMessage, aiReply)
    if (newMemories.length > 0) {
      console.log(`💭 提取了 ${newMemories.length} 条新记忆:`)
      newMemories.forEach(m => {
        console.log(`  - [${m.type}] ${m.content} (重要度: ${m.importance})`)
      })
    }
    
    // 6. 添加 AI 回复到消息列表
    const newMessage: Message = {
      id: Date.now(),
      type: 'received',
      content: aiReply,
      time: new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      timestamp: Date.now(),
      messageType: 'text'
    }
    
    setMessages(prev => [...prev, newMessage])
    
  } catch (error) {
    console.error('AI 回复失败:', error)
    // 错误处理
  } finally {
    setIsAiTyping(false)
  }
}
```

## 🎯 完整示例代码

### ChatDetail.tsx 集成示例

```typescript
import { useState, useEffect, useRef } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { useCharacter } from '../context/CharacterContext'
import { useUser } from '../context/UserContext'
import { useMemory } from '../hooks/useMemory'
import { buildRoleplayPrompt } from '../utils/prompts'
import { Message } from '../types/message'

const ChatDetail = () => {
  const { id } = useParams()
  const navigate = useNavigate()
  const { getCharacter } = useCharacter()
  const { currentUser } = useUser()
  
  const character = id ? getCharacter(id) : undefined
  
  // 初始化记忆系统
  const { 
    extractMemories, 
    getMemorySummary,
    getRelevantMemories 
  } = useMemory(id || '')
  
  const [messages, setMessages] = useState<Message[]>([])
  const [inputText, setInputText] = useState('')
  const [isAiTyping, setIsAiTyping] = useState(false)
  
  // 加载历史消息
  useEffect(() => {
    if (id) {
      const saved = localStorage.getItem(`chat_${id}`)
      if (saved) {
        setMessages(JSON.parse(saved))
      }
    }
  }, [id])
  
  // 保存消息
  useEffect(() => {
    if (id && messages.length > 0) {
      localStorage.setItem(`chat_${id}`, JSON.stringify(messages))
    }
  }, [id, messages])
  
  // 发送消息
  const handleSend = async () => {
    if (!inputText.trim() || !character) return
    
    const userMessage = inputText.trim()
    setInputText('')
    
    // 添加用户消息
    const newUserMessage: Message = {
      id: Date.now(),
      type: 'sent',
      content: userMessage,
      time: new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      timestamp: Date.now(),
      messageType: 'text'
    }
    
    setMessages(prev => [...prev, newUserMessage])
    
    // 获取 AI 回复
    await getAIReply(userMessage)
  }
  
  // AI 回复
  const getAIReply = async (userMessage: string) => {
    if (!character) return
    
    setIsAiTyping(true)
    
    try {
      // 1. 获取记忆摘要
      const memorySummary = getMemorySummary()
      
      // 2. 构建提示词
      const systemPrompt = buildRoleplayPrompt(character, currentUser)
      
      const fullPrompt = `${systemPrompt}

${memorySummary}

【重要】请根据你对用户的记忆，给出个性化的回复。如果记忆中有相关信息，请自然地提及。

【最近对话】
${messages.slice(-10).map(m => 
  `${m.type === 'sent' ? currentUser?.name || '用户' : character.name}: ${m.content}`
).join('\n')}

【当前消息】
${currentUser?.name || '用户'}: ${userMessage}

${character.name}:`
      
      // 3. 调用 AI（这里需要替换成你的 API 调用）
      const aiReply = await callYourAIAPI(fullPrompt)
      
      // 4. 提取新记忆
      const newMemories = extractMemories(userMessage, aiReply)
      if (newMemories.length > 0) {
        console.log(`💭 提取了 ${newMemories.length} 条新记忆`)
      }
      
      // 5. 添加 AI 回复
      const newAIMessage: Message = {
        id: Date.now() + 1,
        type: 'received',
        content: aiReply,
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
        timestamp: Date.now(),
        messageType: 'text'
      }
      
      setMessages(prev => [...prev, newAIMessage])
      
    } catch (error) {
      console.error('AI 回复失败:', error)
    } finally {
      setIsAiTyping(false)
    }
  }
  
  // 你的 AI API 调用函数
  const callYourAIAPI = async (prompt: string): Promise<string> => {
    // 这里替换成你实际的 API 调用
    // 例如：OpenAI, Claude, DeepSeek 等
    const response = await fetch('YOUR_API_ENDPOINT', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer YOUR_API_KEY`
      },
      body: JSON.stringify({
        messages: [{ role: 'user', content: prompt }]
      })
    })
    
    const data = await response.json()
    return data.choices[0].message.content
  }
  
  return (
    <div className="h-screen flex flex-col">
      {/* 顶部导航 */}
      <div className="bg-white border-b p-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button onClick={() => navigate(-1)}>←</button>
          <div>
            <div className="font-medium">{character?.name}</div>
            <div className="text-xs text-gray-500">在线</div>
          </div>
        </div>
        <button onClick={() => navigate(`/chat-settings/${id}`)}>
          ⚙️
        </button>
      </div>
      
      {/* 消息列表 */}
      <div className="flex-1 overflow-y-auto p-4">
        {messages.map(msg => (
          <div key={msg.id} className={`mb-3 ${msg.type === 'sent' ? 'text-right' : ''}`}>
            <div className={`inline-block px-4 py-2 rounded-lg ${
              msg.type === 'sent' ? 'bg-green-500 text-white' : 'bg-white'
            }`}>
              {msg.content}
            </div>
          </div>
        ))}
        
        {isAiTyping && (
          <div className="text-gray-500">正在输入...</div>
        )}
      </div>
      
      {/* 输入框 */}
      <div className="bg-white border-t p-4 flex gap-2">
        <input
          type="text"
          value={inputText}
          onChange={(e) => setInputText(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && handleSend()}
          placeholder="输入消息..."
          className="flex-1 px-4 py-2 border rounded-lg"
        />
        <button
          onClick={handleSend}
          disabled={!inputText.trim() || isAiTyping}
          className="px-6 py-2 bg-green-500 text-white rounded-lg disabled:opacity-50"
        >
          发送
        </button>
      </div>
    </div>
  )
}

export default ChatDetail
```

## 🎨 提示词优化建议

### 基础版提示词

```typescript
const prompt = `
你是 ${character.name}，${character.description}

${memorySummary}

请根据记忆中的信息，给出个性化的回复。

用户: ${userMessage}
`
```

### 进阶版提示词

```typescript
const prompt = `
【角色设定】
你是 ${character.name}
性格: ${character.personality}
说话风格: ${character.style}

${memorySummary}

【对话规则】
1. 如果记忆中有相关信息，请自然地提及
2. 记住用户的名字、喜好等重要信息
3. 根据用户的情绪状态调整回复
4. 保持角色一致性

【示例】
用户说"今天吃什么"，如果记忆中有用户喜欢吃草莓：
✅ 好的回复: "要不要吃草莓？我记得你很喜欢吃呢~"
❌ 不好的回复: "随便吃什么都行"

【当前对话】
用户: ${userMessage}
${character.name}:`
```

## 🐛 常见问题解决

### 问题1：记忆没有被提取

**原因**: 可能是提取模式没有匹配到

**解决**:
```typescript
// 检查控制台日志
console.log('用户消息:', userMessage)
console.log('AI回复:', aiReply)
console.log('提取的记忆:', newMemories)

// 如果没有提取到，可以手动添加
if (newMemories.length === 0) {
  // 手动添加重要信息
  addMemory('fact', '从对话中提取的信息', 7)
}
```

### 问题2：AI 没有使用记忆

**原因**: 提示词中没有强调使用记忆

**解决**:
```typescript
const prompt = `
${memorySummary}

⚠️ 重要：请务必根据上述记忆信息回复！
如果记忆中有相关内容，请自然地提及。

用户: ${userMessage}
`
```

### 问题3：记忆太多导致提示词过长

**解决**:
```typescript
// 只获取最相关的记忆
const relevantMemories = getRelevantMemories(userMessage, 5)

// 或者只包含高重要度的记忆
const importantMemories = searchMemories({ minImportance: 7 })
```

## 📊 测试记忆系统

### 测试对话脚本

```
第1天：
用户: 你好！我叫小明
AI: 你好小明！
→ 检查：是否记录了名字？

用户: 我今年25岁，在北京工作
AI: 好的！
→ 检查：是否记录了年龄和工作地点？

用户: 我最喜欢吃草莓了
AI: 好的，我记住了！
→ 检查：是否记录了喜好？

第2天：
用户: 今天吃什么好呢？
AI: 要不要吃草莓？我记得你很喜欢吃呢~
→ 测试：AI是否使用了昨天的记忆？

用户: 你还记得我叫什么名字吗？
AI: 当然记得，小明！
→ 测试：AI是否记得名字？
```

### 检查记忆

1. 进入聊天设置
2. 点击"查看记忆"
3. 检查是否有以下记忆：
   - [事实] 用户名字是小明
   - [事实] 用户25岁
   - [事实] 用户在北京工作
   - [偏好] 用户喜欢草莓

## 🎯 优化建议

### 1. 定期清理记忆
```typescript
// 每天自动清理一次
useEffect(() => {
  const cleanup = setInterval(() => {
    memorySystem.cleanupMemories()
  }, 24 * 60 * 60 * 1000)
  
  return () => clearInterval(cleanup)
}, [])
```

### 2. 记忆备份
```typescript
// 导出记忆到文件
const backupMemories = () => {
  const data = memorySystem.exportMemories()
  // 保存到文件或云端
}
```

### 3. 记忆分析
```typescript
// 分析用户画像
const analyzeUser = () => {
  const stats = getStatistics()
  const preferences = searchMemories({ type: 'preference' })
  
  console.log('用户画像:')
  console.log('- 总记忆数:', stats.total)
  console.log('- 喜好数:', preferences.length)
  // ... 更多分析
}
```

## ✅ 集成检查清单

- [ ] 已添加 MemoryViewer 路由
- [ ] 已在 ChatSettings 添加入口
- [ ] 已在 ChatDetail 导入 useMemory
- [ ] 已在 AI 回复后调用 extractMemories
- [ ] 已在提示词中添加 memorySummary
- [ ] 已测试记忆提取功能
- [ ] 已测试记忆使用功能
- [ ] 已测试记忆查看器
- [ ] 控制台能看到记忆日志
- [ ] AI 能自然地使用记忆

---

**完成集成后，你的 AI 就能真正记住用户了！** 🎉

需要帮助？查看 `AI记忆系统使用说明.md` 了解更多细节。
