# AI主动发消息功能说明

## 功能概述

AI现在可以像真人一样主动发消息给用户，不再只是被动回复。

## 功能特点

### 1. 智能触发时机

AI会在合适的时候主动发消息：
- ✅ 用户至少30分钟没发消息
- ✅ 距离上次AI主动发消息至少1小时
- ✅ 24小时随时可以发消息
- ✅ 30%随机概率触发（不会太频繁）

### 2. 自然的发消息理由

AI可以主动发消息的理由：
- 分享今天的事情
- 关心用户
- 随便聊聊
- 发个表情包

### 3. 根据时间段调整

- **凌晨（0:00-6:00）**："还没睡吗"、"睡不着吗"、"熬夜了"
- **早上（6:00-9:00）**："早上好"、"起床了吗"
- **上午（9:00-12:00）**："在忙吗"、"工作顺利吗"
- **中午（12:00-14:00）**："吃饭了吗"、"午休了吗"
- **下午（14:00-18:00）**："下午好"、"累不累"
- **晚上（18:00-22:00）**："下班了吗"、"晚上吃什么"
- **深夜（22:00-24:00）**："还没睡吗"、"在干嘛呢"

## 使用方法

### 1. 开启功能

在聊天设置中找到"AI主动发消息"开关，打开即可。

路径：聊天页面 → 右上角菜单 → 聊天设置 → AI主动发消息

### 2. 功能说明

- **已开启**：AI会主动找你聊天
- **已关闭**：AI只会回复你的消息

## 触发条件

### 必须满足的条件

1. ✅ 功能已开启
2. ✅ 用户最后一条消息至少30分钟前
3. ✅ 距离上次AI主动发消息至少1小时
4. ✅ 30%随机概率

### 不会触发的情况

- ❌ 功能未开启
- ❌ 用户刚发过消息（30分钟内）
- ❌ AI刚主动发过消息（1小时内）
- ❌ 随机概率未命中

## AI主动发消息示例

### 示例1：分享事情

```
AI: 今天遇到个有意思的事
AI: 你猜我看到什么了
```

### 示例2：关心用户

```
AI: 在干嘛呢
AI: 吃饭了吗
```

### 示例3：随便聊聊

```
AI: 好无聊啊
AI: 陪我聊聊天呗
```

### 示例4：发表情包

```
AI: [表情包:想你了]
```

## 技术实现

### 文件结构

- **`src/utils/aiProactiveMessage.ts`**：AI主动发消息工具函数
- **`src/pages/ChatSettings.tsx`**：聊天设置页面，添加开关
- **`src/pages/ChatDetail.tsx`**：聊天页面，实现主动发消息逻辑

### 核心函数

#### 1. `shouldTriggerProactive()`

判断是否应该触发AI主动发消息：

```typescript
export const shouldTriggerProactive = (
  characterId: string,
  lastUserMessageTime: number
): boolean => {
  // 检查功能是否开启
  // 检查时间是否合适
  // 检查间隔时间
  // 随机触发
}
```

#### 2. `buildProactivePrompt()`

生成AI主动发消息的提示词：

```typescript
export const buildProactivePrompt = (
  characterName: string,
  userName: string
): string => {
  // 根据时间段生成提示
  // 给AI提供发消息的理由
}
```

#### 3. `isSuitableTimeForProactive()`

判断当前时间是否适合发消息：

```typescript
export const isSuitableTimeForProactive = (): boolean => {
  const hour = now.getHours()
  // 避免深夜（23:00-7:00）
  if (hour >= 23 || hour < 7) {
    return false
  }
  return true
}
```

## 注意事项

### 1. 不会太频繁

- AI不会一直主动发消息
- 至少间隔1小时
- 30%随机概率

### 2. 尊重用户

- 24小时随时可以发消息
- 用户刚发过消息不会立刻主动发

### 3. 符合人设

- AI会根据自己的性格决定发什么
- 不会说"我是AI"这种话
- 语气自然，不刻意

## 开发时间

2025年10月19日

---

## 总结

AI主动发消息功能让AI更像真人：
- ✅ 会主动找你聊天
- ✅ 不会太频繁
- ✅ 时间合适
- ✅ 语气自然

就像真正的朋友一样！
