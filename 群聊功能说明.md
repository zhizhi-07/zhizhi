# 群聊功能说明

## ✅ 已完成功能

### 1. 核心架构
- **GroupContext.tsx** - 群聊数据管理
  - 群聊创建、更新、删除
  - 群成员管理（添加、移除、更新）
  - 群设置管理（AI回复模式、回复间隔等）
  - 数据持久化到 localStorage

### 2. 页面功能

#### 📋 群聊列表页 (GroupList.tsx)
- 显示所有群聊
- 九宫格群头像（最多显示9个成员）
- 显示群名称、成员数、最后消息、未读数
- 点击进入群聊详情
- 空状态提示

#### ➕ 创建群聊页 (CreateGroup.tsx)
- **步骤1：选择成员**
  - 多选AI角色（至少2个）
  - 显示角色头像、名称、签名
  - 选中状态高亮显示
- **步骤2：设置群名称**
  - 自动生成群名称（可修改）
  - 预览已选成员
  - 字数限制（20字）

#### 💬 群聊详情页 (GroupChatDetail.tsx)
- **消息展示**
  - 显示发送者头像和名称
  - 用户消息（右侧，绿色气泡）
  - AI消息（左侧，白色气泡）
  - 消息时间显示
- **消息输入**
  - 文本输入框
  - 智能发送按钮（有输入显示发送，无输入显示AI主动回复）
  - 输入中禁用发送
  - 支持回车键发送/触发AI
- **AI回复状态**
  - 输入中动画提示
  - 禁用输入框防止冲突
- **AI主动发消息** ✨ 新增
  - 点击纸飞机按钮让AI主动说话
  - 空群聊：AI们会打招呼、介绍自己
  - 有对话：AI们会聊最近话题或发起新话题

### 3. AI对话逻辑（全员参与模式）✨ 优化版

#### 核心特性
- **一次API调用**：所有AI回复在一次API调用中生成（节省成本和时间）
- **全员参与**：所有AI成员都可能回复
- **智能控制**：
  - 随机选择回复的AI（避免每次都全员回复）
  - 最多3个AI回复（可配置）
  - 回复间隔2秒（仅用于显示效果）
- **群聊上下文**：
  - 包含最近10条消息
  - AI知道其他成员的存在
  - 提示词强调群聊环境

#### AI提示词设计（一次性生成多角色回复）
```
【任务】
模拟群聊场景，为多个AI角色生成回复

【群聊信息】
- 群名称、群成员列表
- 每个AI角色的性格描述
- 最近对话历史
- 用户最新消息

【回复格式】
[角色名1] 回复内容1
[角色名2] 回复内容2
[角色名3] 回复内容3

【重要规则】
1. 每个角色的回复要符合其性格特点
2. 回复要简短自然（1-2句话）
3. 不同角色的回复要有差异，不要重复
4. 可以互相@对方
5. 如果某个角色觉得不需要回复，可以回复"..."表示沉默
6. 严格按照格式输出
```

#### 技术优势
- ✅ **成本降低**：1次API调用 vs 3次API调用
- ✅ **速度更快**：并行生成所有回复
- ✅ **一致性好**：AI能同时考虑所有角色的回复
- ✅ **体验优化**：前端控制显示间隔，模拟真实打字

### 4. 入口与路由

#### 入口位置
1. **通讯录** → 点击"群聊" → 群聊列表
2. **微信首页** → 右上角"+" → "创建群聊"

#### 路由配置
- `/group-list` - 群聊列表
- `/create-group` - 创建群聊
- `/group/:id` - 群聊详情

## 🎯 使用流程

### 创建群聊
1. 点击"创建群聊"按钮
2. 选择至少2个AI角色
3. 点击"下一步"
4. 设置群名称（自动生成可修改）
5. 点击"完成"
6. 自动跳转到群聊详情页

### 群聊对话
1. 在群聊详情页输入消息
2. 点击发送或按回车
3. 等待AI回复（2秒间隔）
4. 最多3个AI会回复
5. 每个AI根据性格和话题决定是否回复

## ⚙️ 配置选项

### 群设置（在 GroupContext 中）
```typescript
settings: {
  allowMemberInvite: true,        // 允许成员邀请
  muteAll: false,                 // 全员禁言
  showMemberName: true,           // 显示成员名称
  aiReplyMode: 'all',             // AI回复模式（all=全员参与）
  aiReplyInterval: 2,             // AI回复间隔（秒）
  maxAiRepliesPerMessage: 3       // 单条消息最多AI回复数
}
```

## 📊 数据存储

### localStorage 存储
- `groups` - 群聊列表数据
- `group_messages_{groupId}` - 每个群的消息记录

### 数据结构
```typescript
Group {
  id: string
  name: string
  avatar: string
  members: GroupMember[]
  owner: string
  admins: string[]
  settings: GroupSettings
  lastMessage?: string
  lastMessageTime?: string
  unread?: number
}

GroupMessage {
  id: number
  groupId: string
  senderId: string
  senderType: 'user' | 'character'
  senderName: string
  senderAvatar: string
  content: string
  time: string
  timestamp: number
}
```

## 🎨 UI特点

### 设计风格
- 玻璃拟态效果（glass-card）
- 圆角设计（rounded-2xl）
- 阴影效果（shadow-lg）
- 微信绿主题色

### 交互体验
- 平滑滚动到底部
- 输入中禁用操作
- 加载动画提示
- 空状态引导

## 🔧 技术实现

### 核心技术
- **React Hooks**：useState, useEffect, useRef
- **Context API**：GroupContext 全局状态管理
- **React Router**：路由跳转和参数传递
- **TypeScript**：类型安全
- **localStorage**：数据持久化

### 性能优化
- 消息分页加载（最近10条用于上下文）
- AI回复间隔控制（避免刷屏）
- 随机选择回复AI（减少API调用）

## 🚀 后续可扩展功能

### 高优先级
- [ ] @功能（提及特定成员）
- [ ] 群设置页面（修改群名称、管理成员）
- [ ] 群公告
- [ ] 退出群聊

### 中优先级
- [ ] 群聊红包（拼手气红包）
- [ ] 群成员权限管理
- [ ] 群消息免打扰
- [ ] 群聊置顶

### 低优先级
- [ ] 群文件共享
- [ ] 群相册
- [ ] 群投票
- [ ] 群直播

## 📝 注意事项

1. **AI回复控制**
   - 默认最多3个AI回复，避免刷屏
   - 2秒间隔，模拟真实打字时间
   - 随机选择，增加对话自然度

2. **性能考虑**
   - 群成员不宜过多（建议≤10人）
   - 消息历史定期清理
   - 上下文控制在10条以内

3. **用户体验**
   - 输入中禁用发送
   - 清晰的加载状态
   - 友好的空状态提示

## 🎉 总结

群聊功能已完整实现，包括：
- ✅ 群聊创建和管理
- ✅ 群聊列表展示
- ✅ 群聊消息收发
- ✅ AI全员参与对话
- ✅ 智能回复控制
- ✅ 完整的UI/UX

现在可以创建群聊，与多个AI角色一起聊天了！🎊
