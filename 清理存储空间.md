# 清理localStorage存储空间

## 问题说明

如果遇到以下错误：
```
QuotaExceededError: Failed to execute 'setItem' on 'Storage'
```

说明localStorage存储空间已满（通常是5-10MB）。

## 解决方案

### 方法1：在浏览器控制台执行（推荐）

打开浏览器控制台（F12），执行以下命令：

```javascript
// 清理朋友圈数据
localStorage.removeItem('moments')

// 或者清理所有数据（谨慎使用）
localStorage.clear()

// 然后刷新页面
location.reload()
```

### 方法2：查看存储使用情况

```javascript
// 查看localStorage总大小
let total = 0
for(let key in localStorage) {
  if(localStorage.hasOwnProperty(key)) {
    total += localStorage[key].length + key.length
  }
}
console.log('总大小:', (total / 1024).toFixed(2), 'KB')

// 查看各项数据大小
for(let key in localStorage) {
  if(localStorage.hasOwnProperty(key)) {
    const size = (localStorage[key].length + key.length) / 1024
    console.log(key, ':', size.toFixed(2), 'KB')
  }
}
```

### 方法3：只清理大文件

```javascript
// 清理聊天记录（保留最近的）
for(let key in localStorage) {
  if(key.startsWith('chat_messages_')) {
    const messages = JSON.parse(localStorage[key])
    if(messages.length > 50) {
      localStorage.setItem(key, JSON.stringify(messages.slice(0, 50)))
      console.log('清理了', key)
    }
  }
}
```

## 已实施的预防措施

代码已更新，现在会自动：
1. 只保存最近50条朋友圈
2. 如果保存失败，尝试只保存20条
3. 如果还是失败，清空旧数据

## 防止AI无限循环的措施

1. **冷却时间**：每个AI至少间隔2分钟才能再次互动
2. **概率控制**：AI评论后，其他AI只有30%概率回复
3. **去重机制**：同一条评论不会被处理两次
4. **冷却检查**：触发前检查哪些AI可用

## 控制台日志说明

正常情况下你会看到：
```
🔔 检测到新评论: 小雪 在 微信用户 的朋友圈评论了
🎲 AI评论，其他AI有70%概率跳过
```

或者：
```
⏰ 小明 互动冷却中，跳过
⏰ 所有AI都在冷却中
```

这些都是正常的防护机制。
