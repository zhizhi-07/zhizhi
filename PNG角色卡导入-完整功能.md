# PNG Character Card 导入 - 完整功能说明

## 功能概述

支持从 PNG 格式的 Character Card 中导入角色数据，兼容 SillyTavern 和其他酒馆客户端的角色卡格式。

---

## 支持的格式

### Character Card V1
基础格式，包含角色的基本信息。

### Character Card V2/V3
扩展格式，支持更多高级功能：
- 系统提示词
- 备用问候语
- 标签和创建者信息
- **世界书（Character Book）**

---

## 导入流程

### 1. 选择文件
在"创建角色"页面，点击"导入 Character Card"按钮，选择 PNG 文件。

### 2. 自动解析
系统会自动：
- 提取 PNG 中的角色数据
- 解码 Base64 编码
- 转换为内部格式
- 使用 PNG 图片作为头像

### 3. 世界书检测
如果角色卡包含世界书，系统会弹窗询问：

```
检测到角色卡包含世界书（X 个条目）

是否同时导入到世界书系统？

• 点击"确定"：导入世界书并关联到该角色
• 点击"取消"：仅保存在角色数据中
```

**选择"确定"**：
- 世界书会被导入到世界书系统
- 自动创建名为"角色名的世界书"
- 包含所有条目和设置
- 可以在世界书页面管理

**选择"取消"**：
- 世界书数据仍保存在角色数据中
- 不会在世界书系统中显示
- 后续可以手动导出

### 4. 填充表单
所有数据自动填充到表单：
- 角色名称
- 头像（PNG 图片）
- 个性签名
- 角色描述
- 性格、场景、首条消息等

### 5. 保存角色
检查信息无误后，点击"完成"保存角色。

---

## 导入的数据

### 基础信息
- ✅ 角色名称（name）
- ✅ 角色描述（description）
- ✅ 性格（personality）
- ✅ 场景（scenario）
- ✅ 首条消息（first_mes）
- ✅ 示例对话（mes_example）

### 扩展信息（V2）
- ✅ 系统提示词（system_prompt）
- ✅ 备用问候语（alternate_greetings）
- ✅ 标签（tags）
- ✅ 创建者（creator）
- ✅ 创建者备注（creator_notes）

### 世界书（Character Book）
- ✅ 所有条目（entries）
- ✅ 扫描深度（scan_depth）
- ✅ Token 预算（token_budget）
- ✅ 递归扫描（recursive_scanning）
- ✅ 条目设置（优先级、位置、触发条件等）

---

## 世界书导入详情

### 自动转换
系统会自动转换世界书格式：

**原始格式（Character Book）**：
```json
{
  "character_book": {
    "name": "角色世界书",
    "entries": [
      {
        "keys": ["关键词"],
        "content": "内容",
        "enabled": true,
        ...
      }
    ]
  }
}
```

**转换后（Lorebook）**：
```json
{
  "name": "角色名的世界书",
  "description": "从 Character Card 导入的世界书",
  "entries": [...],
  "is_global": false,
  "character_ids": []
}
```

### 条目映射
所有条目字段都会正确映射：
- `keys` → 关键词
- `content` → 内容
- `enabled` → 启用状态
- `priority` → 优先级
- `insertion_order` → 插入顺序
- `case_sensitive` → 大小写敏感
- `constant` → 常驻
- `selective` → 选择性注入
- `position` → 插入位置

---

## 使用场景

### 场景1：从 SillyTavern 迁移
1. 在 SillyTavern 中导出角色卡（PNG）
2. 在本应用中导入
3. 选择导入世界书
4. 完整迁移完成

### 场景2：分享角色
1. 接收他人分享的角色卡 PNG
2. 导入到应用
3. 世界书自动导入
4. 立即可用

### 场景3：备份恢复
1. 之前导出的角色卡
2. 重新导入
3. 所有数据完整恢复

---

## 常见问题

### Q: 世界书导入后在哪里？
A: 在"世界书"应用中，名称为"角色名的世界书"。

### Q: 可以不导入世界书吗？
A: 可以！选择"取消"即可，世界书数据仍保存在角色中。

### Q: 导入后可以修改世界书吗？
A: 可以！在世界书页面找到对应的世界书，点击编辑即可。

### Q: 世界书会自动关联到角色吗？
A: 目前需要手动关联。未来版本会支持自动关联。

### Q: 导入失败怎么办？
A: 检查以下几点：
1. 确认是 PNG 格式
2. 确认包含 Character Card 数据
3. 查看控制台错误信息
4. 尝试重新导出角色卡

### Q: 支持哪些来源的角色卡？
A: 支持所有符合 Character Card V1/V2 规范的角色卡：
- SillyTavern
- TavernAI
- Agnai
- RisuAI
- 其他兼容客户端

---

## 技术细节

### 数据提取
1. 读取 PNG 文件的二进制数据
2. 解析 PNG chunk 结构
3. 查找 tEXt chunk 中的 'chara' 字段
4. Base64 解码
5. UTF-8 解码
6. JSON 解析

### 错误处理
- ✅ 文件格式验证
- ✅ Base64 解码错误
- ✅ JSON 解析错误
- ✅ 数据结构验证
- ✅ 循环引用清理
- ✅ 存储空间检查

### 性能优化
- ✅ 使用 TextDecoder 避免栈溢出
- ✅ 使用 latin1 编码处理 Base64
- ✅ 清理循环引用
- ✅ 数据大小限制（5MB）

---

## 更新日志

### 2024-10-24
- ✅ 修复 PNG 解析栈溢出问题
- ✅ 修复 Base64 解码乱码问题
- ✅ 添加世界书自动导入功能
- ✅ 改进错误提示
- ✅ 添加数据大小检查

---

## 未来计划

### 短期
- ⏳ 世界书自动关联到角色
- ⏳ 导入进度提示
- ⏳ 批量导入支持

### 中期
- ⏳ 导入预览
- ⏳ 选择性导入字段
- ⏳ 导入历史记录

### 长期
- ⏳ 导出为 Character Card
- ⏳ 在线角色卡库
- ⏳ 角色卡版本管理

---

**现在就试试导入你的角色卡吧！** 🎉
