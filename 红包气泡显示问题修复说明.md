# 红包气泡显示问题修复说明

## 问题描述

AI发送红包时，红包信息（如 `[红包:200:给你买好吃的]`）会先显示在文字气泡里，然后才显示红包卡片。

## 问题原因

在 `ChatDetail.tsx` 的 AI 回复处理逻辑中，代码执行顺序有问题：

1. **第1488行**：从 `aiResponse` 中清理红包标记，存储到 `cleanedResponse`
   ```typescript
   cleanedResponse = aiResponse.replace(/\[红包:\d+\.?\d*:.+?\]/g, '').trim()
   ```

2. **第1493行**：用 `parsedEmoji.textContent` 覆盖 `cleanedResponse`
   ```typescript
   cleanedResponse = parsedEmoji.textContent
   ```

由于 `parsedEmoji.textContent` 是从原始 `aiResponse` 解析出来的，它仍然包含红包标记，导致之前的清理操作被覆盖。

## 修复方案

调整代码顺序，将红包标记的清理移到使用 `parsedEmoji.textContent` **之后**：

```typescript
// 使用解析后的文字内容（已经清理了所有表情包标记）
let cleanedResponse = parsedEmoji.textContent

// 清理红包标记（必须在使用parsedEmoji.textContent之后）
cleanedResponse = cleanedResponse.replace(/\[红包:\d+\.?\d*:.+?\]/g, '').trim()
```

## 修复位置

- **文件**：`src/pages/ChatDetail.tsx`
- **行号**：1490-1494

## 验证

其他特殊标记（转账、亲密付、照片、语音、位置等）的清理都在 `cleanedResponse` 上进行，不存在类似问题。

## 修复效果

修复后，AI发送红包时：
1. 不会在气泡里显示 `[红包:200:给你买好吃的]` 这样的文字
2. 直接显示红包卡片
3. 如果AI同时发送文字和红包，文字会正常显示，红包标记会被正确清理

## 修复时间

2025年10月19日
