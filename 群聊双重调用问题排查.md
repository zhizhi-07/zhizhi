# 群聊双重调用问题排查

## 问题描述

系统在发送消息后会调用两次API：
1. 第一次：传统模式（最大Token: 2000）
2. 第二次：剧本导演模式（最大Token: 8000）

## 可能的原因

### 1. ✅ 已修复：handleAIReply函数
- 原因：点击纸飞机按钮时直接调用 `handleAiReplies`
- 修复：添加模式判断逻辑

### 2. ✅ 已修复：主动发消息逻辑
- 原因：空群聊时直接调用 `handleAiReplies`
- 修复：添加模式判断逻辑

### 3. ⚠️ 需要检查：其他触发点

可能的触发点：
- AI自由对话定时器（独立功能，正常）
- 其他组件的调用
- React状态更新导致的重复渲染

## 调试建议

### 1. 添加调用堆栈日志

在 `handleAiReplies` 和 `handleAiRepliesWithDirector` 开头添加：

```typescript
console.trace('📞 handleAiReplies 调用堆栈')
```

### 2. 检查React渲染

可能是某个状态更新触发了重复渲染。检查：
- `useEffect` 依赖项
- 组件重复挂载

### 3. 临时禁用传统模式

为了测试，可以临时注释掉传统模式的调用：

```typescript
if (useDirector) {
  await handleAiRepliesWithDirector(userMessage)
} else {
  console.log('⏭️ 传统模式已禁用')
  // await handleAiReplies(userMessage)
}
```

## 当前状态

✅ 已修复 `handleAIReply` 函数  
✅ 已修复主动发消息逻辑  
⚠️ 需要进一步测试确认是否完全修复

## 下一步

1. 刷新页面，清除旧代码
2. 重新测试发送消息
3. 观察控制台日志
4. 如果仍有问题，添加调用堆栈跟踪
