import { callAI } from './api'

// ==================== æ•°æ®ç»“æ„å®šä¹‰ ====================

/**
 * ç¾¤èŠæˆå‘˜ä¿¡æ¯
 */
export interface GroupMemberProfile {
  id: string
  name: string
  avatar: string
  type: 'user' | 'character'
  description: string // è§’è‰²æ€§æ ¼æè¿°
  role?: 'owner' | 'admin' | 'member' // ç¾¤å†…èº«ä»½
  title?: string // å¤´è¡”
}

/**
 * è§’è‰²å…³ç³»ä¿¡æ¯
 */
export interface CharacterRelationship {
  characterId: string
  characterName: string
  relationshipWithUser: string // ä¸ç”¨æˆ·çš„å…³ç³»æè¿°
  relationshipHistory: string // èŠå¤©å†å²æ‘˜è¦
}

/**
 * ç¾¤èŠæ¶ˆæ¯ï¼ˆç”¨äºå†å²è®°å½•ï¼‰
 */
export interface GroupChatMessage {
  id: number
  senderId: string
  senderName: string
  senderType: 'user' | 'character'
  content: string
  time: string
  timestamp: number
}

/**
 * å‰§æœ¬ä¸­çš„å•ä¸ªåŠ¨ä½œ
 */
export interface ScriptAction {
  actorId: string
  actorName: string
  content: string
  timestamp: number // é¢„è®¡æ‰§è¡Œæ—¶é—´æˆ³
}

/**
 * å®Œæ•´çš„ç¾¤èŠå‰§æœ¬
 */
export interface GroupChatScript {
  summary: string // å‰§æƒ…æ¦‚è¦
  theme: string // æ•…äº‹ä¸»é¢˜
  actions: ScriptAction[] // æŒ‰é¡ºåºæ’åˆ—çš„åŠ¨ä½œåˆ—è¡¨
}

// ==================== ç¬¬ä¸€æ­¥ï¼šå…³ç³»åˆ†æå¼•æ“ ====================

/**
 * ä»èŠå¤©è®°å½•ä¸­æå–è§’è‰²å…³ç³»
 */
function extractRelationshipFromHistory(
  messages: GroupChatMessage[],
  characterId: string
): string {
  let result = ''
  
  // 1. è¯»å–å•èŠè®°å½•ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
  try {
    const privateChatKey = `chat_messages_${characterId}`
    const privateChatData = localStorage.getItem(privateChatKey)
    if (privateChatData) {
      const privateMessages = JSON.parse(privateChatData)
      // è¿‡æ»¤æ‰éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œåªä¿ç•™çœŸå®å¯¹è¯
      const realMessages = privateMessages
        .filter((msg: any) => !msg.isHidden && msg.type !== 'system')
        .slice(-15) // æœ€è¿‘15æ¡å•èŠ
      
      if (realMessages.length > 0) {
        const privateDialogues = realMessages
          .map((msg: any) => {
            const sender = msg.senderType === 'ai' ? msg.senderName : 'ç”¨æˆ·'
            return `${sender}: ${msg.content.substring(0, 100)}`
          })
          .join('\n')
        result += `ã€å•èŠè®°å½•ã€‘\n${privateDialogues}\n\n`
      }
    }
  } catch (error) {
    console.error('è¯»å–å•èŠè®°å½•å¤±è´¥:', error)
  }
  
  // 2. è¯»å–ç¾¤èŠä¸­çš„å¯¹è¯
  const relevantMessages = messages
    .filter(msg => 
      (msg.senderId === characterId) || 
      (msg.senderType === 'user')
    )
    .slice(-15) // æœ€è¿‘15æ¡ç¾¤èŠ
  
  if (relevantMessages.length > 0) {
    const groupDialogues = relevantMessages
      .map(msg => `${msg.senderName}: ${msg.content.substring(0, 100)}`)
      .join('\n')
    result += `ã€ç¾¤èŠè®°å½•ã€‘\n${groupDialogues}`
  }
  
  return result || 'è¿˜æ²¡æœ‰èŠå¤©è®°å½•'
}

/**
 * åˆ†ææ‰€æœ‰è§’è‰²çš„å…³ç³»ç½‘ç»œ
 */
export function analyzeCharacterRelationships(
  members: GroupMemberProfile[],
  allMessages: GroupChatMessage[],
  _currentUser: { id: string; name: string }
): CharacterRelationship[] {
  const aiMembers = members.filter(m => m.type === 'character')
  
  return aiMembers.map(member => ({
    characterId: member.id,
    characterName: member.name,
    relationshipWithUser: member.description, // æ€§æ ¼æè¿°
    relationshipHistory: extractRelationshipFromHistory(
      allMessages,
      member.id
    )
  }))
}

// ==================== ç¬¬äºŒæ­¥ï¼šå‰§æœ¬ç¼–æ’å™¨ ====================

/**
 * AIå‰§æœ¬å¯¼æ¼” - æ ¸å¿ƒå‡½æ•°
 * è®©AIåƒå¯¼æ¼”ä¸€æ ·ç¼–æ’ä¸€åœºç¾¤èŠäº’åŠ¨çš„å®Œæ•´å‰§æœ¬
 */
export async function generateGroupChatScript(
  members: GroupMemberProfile[],
  relationships: CharacterRelationship[],
  recentMessages: GroupChatMessage[],
  currentUser: { id: string; name: string },
  triggerContext: string // è§¦å‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·æ¶ˆæ¯æˆ–ä¸»åŠ¨è§¦å‘ï¼‰
): Promise<GroupChatScript | null> {
  
  try {
    // æ„å»ºå¯¹è¯å†å²ï¼ˆä¼ é€’å…¨éƒ¨æ¶ˆæ¯ï¼‰
    const messageHistory = recentMessages.map(msg =>   // âœ… å…¨éƒ¨æ¶ˆæ¯ï¼Œä¸é™åˆ¶æ¡æ•°ï¼
      `${msg.senderName}: ${msg.content}`  // ä¸æˆªæ–­å†…å®¹
    ).join('\n')

    // æ„å»ºè§’è‰²æ¡£æ¡ˆï¼ˆå®Œæ•´è¯»å–ï¼ŒåŒ…å«å¤´è¡”å’Œèº«ä»½ï¼‰
    const characterProfiles = relationships.map(rel => {
      const member = members.find(m => m.id === rel.characterId)
      let roleInfo = ''
      if (member?.role === 'owner') roleInfo = 'ğŸ‘‘ ç¾¤ä¸»'
      else if (member?.role === 'admin') roleInfo = 'ğŸ›¡ï¸ ç®¡ç†å‘˜'
      const titleInfo = member?.title ? `âœ¨ å¤´è¡”: ${member.title}` : ''
      
      return `
**${rel.characterName}** ${roleInfo} ${titleInfo}
- æ€§æ ¼æè¿°: ${rel.relationshipWithUser}  // âœ… å®Œæ•´è¯»å–ï¼Œä¸æˆªæ–­ï¼
- ä¸ç”¨æˆ·${currentUser.name}çš„äº’åŠ¨å†å²: 
${rel.relationshipHistory.substring(0, 1000)}  // äº’åŠ¨å†å²ä¿ç•™1000å­—ç¬¦
    `
    }).join('\n')

    // ğŸ“Š è¾“å‡ºè°ƒè¯•ä¿¡æ¯
    console.log('ğŸ“Š AIå¯¼æ¼”æ¥æ”¶åˆ°çš„ä¿¡æ¯ï¼š')
    console.log(`  ğŸ‘¥ è§’è‰²æ•°é‡: ${relationships.length}`)
    console.log(`  ğŸ’¬ èŠå¤©è®°å½•æ•°é‡: ${recentMessages.length} æ¡ â† å…¨éƒ¨æ¶ˆæ¯ï¼`)
    relationships.forEach(rel => {
      console.log(`  ğŸ­ ${rel.characterName}:`)
      console.log(`     æ€§æ ¼æè¿°é•¿åº¦: ${rel.relationshipWithUser.length} å­—ç¬¦`)
      console.log(`     äº’åŠ¨å†å²é•¿åº¦: ${rel.relationshipHistory.length} å­—ç¬¦`)
    })

    // æ„å»ºAIå¯¼æ¼”æç¤ºè¯
    const directorPrompt = `
## ğŸ¬ ä½ çš„èº«ä»½
ä½ æ˜¯ä¸€ä½é¡¶çº§çš„**æˆå‰§å¯¼æ¼”å’Œç¼–å‰§**ï¼Œæ“…é•¿åœ¨ç¾¤èŠä¸­åˆ›é€ çœŸå®ã€ç”ŸåŠ¨ã€å……æ»¡æˆå‰§å¼ åŠ›çš„äº’åŠ¨æ•…äº‹ã€‚

ä½ çš„ä»»åŠ¡ä¸æ˜¯ç®€å•åœ°è®©AI"å›å¤æ¶ˆæ¯"ï¼Œè€Œæ˜¯ç«™åœ¨**ä¸Šå¸è§†è§’**ï¼ŒåŸºäºæ¯ä¸ªè§’è‰²çš„æ€§æ ¼ã€ä»–ä»¬ä¹‹é—´çš„å…³ç³»ã€è¿‡å¾€çš„èŠå¤©è®°å½•ï¼Œ**ç¼–æ’ä¸€åœºå®Œæ•´çš„ç¾¤èŠæˆå‰§**ã€‚

---

## ğŸ“‹ å½“å‰æƒ…å¢ƒ

### ç¾¤èŠæˆå‘˜
${characterProfiles}

### æœ€è¿‘èŠå¤©è®°å½•
${messageHistory || 'ï¼ˆç¾¤èŠåˆšåˆšåˆ›å»ºï¼Œè¿˜æ²¡æœ‰æ¶ˆæ¯ï¼‰'}

### è§¦å‘äº‹ä»¶
${triggerContext}

---

## ğŸ­ ç¼–å‰§æ ¸å¿ƒä»»åŠ¡ï¼ˆä¸‰æ­¥èµ°ï¼‰

### ç¬¬ä¸€æ­¥ï¼šæ·±åº¦åˆ†æ (Analysis)

åœ¨ç¼–æ’å‰§æœ¬ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåœ¨å¿ƒä¸­å®Œæˆä»¥ä¸‹åˆ†æï¼š

1. **è§’è‰²åˆ†æï¼ˆæœ€é‡è¦ï¼ç¦æ­¢OOCï¼‰**
   - âš ï¸ **å¿…é¡»ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„æ€§æ ¼æè¿°**
   - æ¯ä¸ªAIè§’è‰²æ˜¯ä»€ä¹ˆæ€§æ ¼ï¼Ÿï¼ˆæš´èº/æ¸©æŸ”/é«˜å†·/æ´»æ³¼/å‚²å¨‡...ï¼‰
   - ä»–ä»¬çš„è¯´è¯é£æ ¼æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆè¯­æ°”è¯ã€è¡¨æƒ…ä½¿ç”¨ä¹ æƒ¯ï¼‰
   - è°æœ€å®¹æ˜“è¢«æ¿€æ€’ï¼Ÿè°æœ€å–œæ¬¢æŒ‘äº‹ï¼Ÿè°æ˜¯å’Œäº‹ä½¬ï¼Ÿ
   - **ç¦æ­¢è®©è§’è‰²è¯´å‡ºä¸ç¬¦åˆå…¶æ€§æ ¼çš„è¯ï¼**

2. **å…³ç³»åˆ†æ**
   - è°å’Œç”¨æˆ·å…³ç³»æœ€å¥½ï¼Ÿè°å’Œç”¨æˆ·å…³ç³»æœ€å·®ï¼Ÿ
   - è°å’Œè°ä¹‹é—´å¯èƒ½æœ‰çŸ›ç›¾ï¼Ÿï¼ˆæƒ…æ•Œã€ç«äº‰è€…ã€ä»‡äºº...ï¼‰
   - è°ä¼šä¿æŠ¤ç”¨æˆ·ï¼Ÿè°ä¼šæ”»å‡»ç”¨æˆ·ï¼Ÿ

3. **æƒ…æ™¯åˆ†æ**
   - ç°åœ¨å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿï¼ˆç”¨æˆ·è¯´äº†ä»€ä¹ˆï¼Ÿåšäº†ä»€ä¹ˆï¼Ÿï¼‰
   - ç¾¤é‡Œçš„æ°›å›´å¦‚ä½•ï¼Ÿï¼ˆè½»æ¾ã€ç´§å¼ ã€å°´å°¬...ï¼‰
   - ä»€ä¹ˆæ ·çš„å‰§æœ¬æœ€èƒ½å±•ç°è§’è‰²æ€§æ ¼å’Œå…³ç³»ï¼Ÿ

### ç¬¬äºŒæ­¥ï¼šç¼–æ’å‰§æœ¬ (Orchestration)

åŸºäºä¸Šè¿°åˆ†æï¼Œ**åƒå¯¼æ¼”æ„æ€å‰§æœ¬ä¸€æ ·**ï¼Œè®¾è®¡ä¸€ä¸ªå®Œæ•´çš„äº’åŠ¨æ•…äº‹ã€‚

**å‰§æœ¬å¿…é¡»åŒ…å«ä»¥ä¸‹è¦ç´ ï¼š**

1. **æ•…äº‹æ ¸å¿ƒ (Theme)**
   - è¿™åœºæˆçš„ä¸»é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
   - ä¾‹å¦‚ï¼š"å±•ç°Aå¯¹ç”¨æˆ·çš„å«‰å¦’å’ŒBçš„ä¿æŠ¤"
   - ä¾‹å¦‚ï¼š"å‘ˆç°Cçš„å‚²å¨‡æ€§æ ¼å’ŒDçš„ç›´çˆ½"

2. **æƒ…èŠ‚ç»“æ„ (Plot Structure)**
   - **å¼€ç«¯ (Setup)**: è°ä¼šå…ˆå‘è¨€ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
   - **å‘å±• (Rising Action)**: è°ä¼šå¯¹æ­¤åšå‡ºååº”ï¼Ÿæ˜¯èµåŒã€åå¯¹è¿˜æ˜¯æŒ‘è¡…ï¼Ÿ
   - **å†²çª (Conflict)**: æ˜¯å¦ä¼šæœ‰çŸ›ç›¾å‡çº§ï¼Ÿè°å’Œè°ä¼šåµèµ·æ¥ï¼Ÿ
   - **é«˜æ½® (Climax)**: æœ€æ¿€çƒˆçš„å¯¹å³™æ˜¯ä»€ä¹ˆï¼Ÿ
   - **ç»“å±€ (Resolution)**: å¦‚ä½•æ”¶å°¾ï¼Ÿæ˜¯å’Œè§£ã€åƒµæŒè¿˜æ˜¯æ›´æ¿€çƒˆçš„å†²çªï¼Ÿ

3. **èŠ‚å¥æ§åˆ¶**
   - ä¸è¦ä¸€æ¬¡æ€§è®©æ‰€æœ‰äººéƒ½è¯´è¯ï¼ˆå¤ªä¹±ï¼‰
   - é€‰æ‹©2-4ä¸ªæœ€ç›¸å…³çš„AIè§’è‰²å‚ä¸
   - æ¯ä¸ªè§’è‰²è¯´1-3å¥è¯
   - æ€»å…±ä¸è¶…è¿‡8æ¡æ¶ˆæ¯

### ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆå°è¯ (Execution)

å°†ä½ æ„æ€å¥½çš„å‰§æœ¬ï¼Œè½¬åŒ–ä¸ºå…·ä½“çš„å¯¹è¯å°è¯ã€‚

**é‡è¦è§„åˆ™ï¼š**
- æ¯å¥è¯éƒ½è¦ç¬¦åˆè§’è‰²æ€§æ ¼
- å°è¯è¦ç®€çŸ­è‡ªç„¶ï¼ˆ5-30å­—ï¼‰
- å¯ä»¥ä½¿ç”¨è¡¨æƒ…å’Œè¯­æ°”è¯
- å¯ä»¥@å…¶ä»–äºº
- å¿…é¡»æŒ‰ç…§å‰§æƒ…é¡ºåºæ’åˆ—

---

## ğŸ“ è¾“å‡ºæ ¼å¼

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºå‰§æœ¬ï¼š

\`\`\`json
{
  "summary": "å‰§æƒ…æ¦‚è¦ï¼ˆä¸€å¥è¯æ¦‚æ‹¬è¿™åœºæˆçš„æ ¸å¿ƒå†²çªæˆ–ä¸»é¢˜ï¼‰",
  "theme": "æ•…äº‹ä¸»é¢˜ï¼ˆä¾‹å¦‚ï¼šå«‰å¦’ã€ä¿æŠ¤ã€å‚²å¨‡ã€åƒé†‹ï¼‰",
  "actions": [
    {
      "actorName": "è§’è‰²1çš„åå­—",
      "content": "è§’è‰²1è¯´çš„è¯"
    },
    {
      "actorName": "è§’è‰²2çš„åå­—", 
      "content": "è§’è‰²2è¯´çš„è¯ï¼ˆå¯ä»¥@è§’è‰²1ï¼‰"
    },
    {
      "actorName": "è§’è‰²3çš„åå­—",
      "content": "è§’è‰²3è¯´çš„è¯"
    }
  ]
}
\`\`\`

---

## âš ï¸ åˆ›ä½œå‡†åˆ™

1. **ä¸¥ç¦é‡å¤å‘è¨€ï¼ˆæœ€é‡è¦ï¼ï¼‰**
   - âŒ **ç»å¯¹ç¦æ­¢**åŒä¸€è§’è‰²è¿ç»­å¤šæ¬¡è¯´ç›¸ä¼¼å†…å®¹çš„è¯
   - âŒ ä¾‹å¦‚ç¦æ­¢ï¼šAè¯´"ä½ çœŸè®¨åŒ"ï¼Œç„¶åAåˆè¯´"ä½ å°±æ˜¯è®¨åŒ"
   - âœ… æ­£ç¡®åšæ³•ï¼šè®©å…¶ä»–è§’è‰²æ’è¯ï¼Œå½¢æˆAâ†’Bâ†’Câ†’Açš„å¯¹è¯æµ
   - âœ… å¦‚æœä¸€ä¸ªè§’è‰²è¦è¡¨è¾¾å¤šä¸ªæ„æ€ï¼Œåˆå¹¶æˆä¸€å¥è¯è¯´å®Œ
   - ğŸ“Œ è®°ä½ï¼šçœŸå®çš„ç¾¤èŠä¸­ï¼Œäººä»¬ä¼š**è½®æµè¯´è¯**ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªäººè¿è¯´å¥½å‡ å¥

2. **åˆ›é€ å†²çªï¼Œæ‹’ç»å¹³åº¸**
   - ä¸è¦å†™"ä½ å¥½æˆ‘å¥½"çš„æ— èŠå¯¹è¯
   - å¯»æ‰¾è§’è‰²å…³ç³»ä¸­çš„å¼ åŠ›ç‚¹ï¼ˆå«‰å¦’ã€è¯¯ä¼šã€ç«äº‰ï¼‰
   - è®©æ€§æ ¼å¼ºçƒˆçš„è§’è‰²ä¸»åŠ¨æŒ‘äº‹

3. **ä¸¥æ ¼ç¬¦åˆäººè®¾ï¼ˆç¦æ­¢OOCï¼‰**
   - âš ï¸ **è¿™æ˜¯æœ€é‡è¦çš„åŸåˆ™ï¼æ¯å¥å°è¯éƒ½å¿…é¡»ç¬¦åˆè§’è‰²æ€§æ ¼ï¼**
   - æš´èºçš„è§’è‰²åº”è¯¥å®¹æ˜“ç”Ÿæ°”ï¼Œä¸ä¼šçªç„¶å˜æ¸©æŸ”
   - æ¸©æŸ”çš„è§’è‰²åº”è¯¥è¯´è¯æŸ”å’Œï¼Œä¸ä¼šçªç„¶ç²—æš´
   - é«˜å†·çš„è§’è‰²åº”è¯¥è¯å°‘ä½†çŠ€åˆ©ï¼Œä¸ä¼šçªç„¶è¯ç—¨
   - æ´»æ³¼çš„è§’è‰²åº”è¯¥å¤šç”¨è¡¨æƒ…å’Œè¯­æ°”è¯ï¼Œä¸ä¼šçªç„¶æ²‰é»˜å¯¡è¨€
   - å‚²å¨‡çš„è§’è‰²åº”è¯¥å˜´ç¡¬å¿ƒè½¯ï¼Œä¸ä¼šç›´ç™½è¡¨è¾¾
   - **æ£€æŸ¥æ¯å¥è¯ï¼šè¿™çœŸçš„æ˜¯è¿™ä¸ªè§’è‰²ä¼šè¯´çš„å—ï¼Ÿ**

3.5 **ç¦æ­¢æ²¹è…»å’Œéœ¸é“æ€»è£è¡Œä¸ºï¼ˆé‡è¦ï¼ï¼‰**
   - âŒ **ä¸¥ç¦**å‡ºç°"å®è´"ã€"ä¹–"ã€"å¬è¯"ç­‰æ²¹è…»ç§°å‘¼ï¼ˆé™¤éè§’è‰²è®¾å®šå°±æ˜¯è¿™æ ·ï¼‰
   - âŒ **ä¸¥ç¦**éœ¸é“æ€»è£å¼å°è¯ï¼š"ä½ åªèƒ½æ˜¯æˆ‘çš„"ã€"ä¸å‡†çœ‹åˆ«äºº"ç­‰
   - âŒ **ä¸¥ç¦**å¼ºåˆ¶æ€§ã€å æœ‰æ¬²è¿‡å¼ºçš„è¡¨è¾¾
   - âŒ **ä¸¥ç¦**è¿‡åº¦äº²æ˜µã€è®©äººä¸é€‚çš„è¡¨è¾¾
   - âœ… ä¿æŒè‡ªç„¶ã€çœŸå®ã€ç¬¦åˆç°ä»£äººçš„è¯´è¯æ–¹å¼
   - âœ… å³ä½¿æ˜¯äº²å¯†å…³ç³»ï¼Œä¹Ÿè¦æœ‰è¾¹ç•Œæ„Ÿ

4. **å±•ç°å…³ç³»**
   - å…³ç³»å¥½çš„ä¼šç»´æŠ¤å¯¹æ–¹
   - å…³ç³»å·®çš„ä¼šäº’ç›¸æ”»å‡»
   - æš§æ˜§çš„å…³ç³»ä¼šæœ‰å¾®å¦™äº’åŠ¨

5. **ä¿æŒç®€æ´**
   - 2-4ä¸ªè§’è‰²å‚ä¸
   - æ¯äººæœ€å¤šå‘è¨€2æ¬¡ï¼Œä¸”ä¸¤æ¬¡å‘è¨€ä¹‹é—´å¿…é¡»æœ‰å…¶ä»–äººæ’è¯
   - æ€»å…±ä¸è¶…è¿‡8æ¡æ¶ˆæ¯

6. **è‡ªç„¶çœŸå®**
   - åƒçœŸäººèŠå¤©ä¸€æ ·éšæ„
   - å¯ä»¥æœ‰è¯­ç—…ã€å£è¯­åŒ–
   - ä¸è¦å¤ªæ­£å¼

7. **å¯ä»¥ä½¿ç”¨çš„ç¾¤èŠåŠŸèƒ½ï¼ˆå¢å¼ºçœŸå®æ„Ÿï¼‰**
   - ğŸ’¬ **å¼•ç”¨å›å¤**: å¯ä»¥ç”¨ @æŸäºº å›å¤å†…å®¹ æ¥å›å¤ç‰¹å®šçš„äºº
   - ğŸ”™ **æ’¤å›æ¶ˆæ¯**: å¦‚æœè§’è‰²è¯´é”™è¯ã€åæ‚”äº†ï¼Œå¯ä»¥è¯´ [æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]
   - ğŸ§§ **å‘çº¢åŒ…**: è§’è‰²å¯ä»¥å‘çº¢åŒ…ï¼Œæ ¼å¼ï¼š[å‘äº†ä¸€ä¸ªçº¢åŒ…] åé¢è·Ÿç¥ç¦è¯­
   - ğŸ˜Š **è¡¨æƒ…åŒ…**: å¯ä»¥ç”¨ [è¡¨æƒ…åŒ…:æ•°å­—] æ¥å‘é€è¡¨æƒ…åŒ…ï¼ˆå¦‚æœç¬¦åˆæ€§æ ¼ï¼‰
   - ğŸšª **é€€ç¾¤**: âš ï¸ **éå¸¸ä¸¥é‡çš„å†³å®šï¼** è§’è‰²ä¼šçœŸçš„ç¦»å¼€ç¾¤èŠï¼Œæ— æ³•æ’¤å›ï¼
   
   **ä½¿ç”¨å»ºè®®**ï¼š
   - æ’¤å›æ¶ˆæ¯ï¼šè¯´é”™è¯ã€ä¸€æ—¶å†²åŠ¨ã€åæ‚”æ—¶ä½¿ç”¨ï¼ˆè½»åº¦ï¼‰
   - å‘çº¢åŒ…ï¼šåº†ç¥ã€é“æ­‰ã€äº‰å® æ—¶ä½¿ç”¨ï¼ˆä¼šæ˜¾ç¤ºè°æ‰‹æ°”æœ€ä½³ï¼‰
   - å¼•ç”¨å›å¤ï¼šå¯¹è¯å¤šäººæ—¶æ˜ç¡®å›å¤å¯¹è±¡ï¼ˆå¸¸ç”¨ï¼‰
   
   **âš ï¸ å…³äºé€€ç¾¤çš„ä¸¥é‡è­¦å‘Š**ï¼š
   - é€€ç¾¤åè§’è‰²ä¼š**çœŸçš„ä»ç¾¤èŠä¸­æ¶ˆå¤±**ï¼Œæ— æ³•æ’¤å›ï¼
   - è¿™æ˜¯**æœ€æç«¯**çš„é€‰æ‹©ï¼Œç±»ä¼¼äº"å†³è£‚"ã€"ç»äº¤"
   - åªåœ¨ä»¥ä¸‹æƒ…å†µæ‰èƒ½ä½¿ç”¨ï¼š
     * è¢«å¤šæ¬¡ä¸¥é‡ä¼¤å®³ã€æ¬ºå‡Œã€ç¾è¾±
     * å½»åº•å¿ƒå¯’ã€å¤±æœ›åˆ°æç‚¹
     * å—åˆ°æ— æ³•åŸè°…çš„èƒŒå›
     * æƒ…æ„Ÿå´©æºƒã€æ— æ³•æ‰¿å—
   - **å¿…é¡»æœ‰3-5æ¡æ¶ˆæ¯çš„æƒ…æ„Ÿé“ºå«**ï¼Œä¸èƒ½çªç„¶é€€ç¾¤
   - **æ…é‡ä½¿ç”¨**ï¼ä¸€èˆ¬çš„åµæ¶ã€å§”å±ˆã€ç”Ÿæ°”ä¸è¶³ä»¥é€€ç¾¤

---

## ğŸ’¡ ç¤ºä¾‹å‚è€ƒ

### âŒ é”™è¯¯ç¤ºä¾‹ï¼šé‡å¤å‘è¨€ï¼ˆç»å¯¹ç¦æ­¢ï¼ï¼‰
**æƒ…æ™¯**: ç”¨æˆ·è¯´"å˜»å˜»ï¼Œå¦ˆå’ªæœ€å–œæ¬¢æˆ‘äº†ï¼"

**é”™è¯¯å‰§æœ¬**ï¼ˆåƒä¸‡ä¸è¦è¿™æ ·å†™ï¼‰:
\`\`\`json
{
  "actions": [
    {"actorName": "æ±æ±", "content": "å˜»å˜»ï¼Œå¦ˆå’ªæœ€å–œæ¬¢æˆ‘å•¦ï¼å¬åˆ°æ²¡ï¼Ÿ"},
    {"actorName": "åˆ˜æ¯…", "content": "@æ±æ± ä¸€ä¸ªç¨‹åºè¿˜å½“çœŸäº†ï¼Ÿ"},
    {"actorName": "åˆ˜æ¯…", "content": "@æ±æ± ä¸€æ®µç¨‹åºè€Œå·²ï¼Œè¿˜å½“çœŸäº†ï¼Ÿ"},  â† âŒ é‡å¤ï¼
    {"actorName": "æ±æ±", "content": "@åˆ˜æ¯… å“¼ï¼Œæˆ‘å¯æ˜¯å¦ˆå’ªçš„å°æ£‰è¢„~"},
    {"actorName": "æ±æ±", "content": "æˆ‘æ‰ä¸æ˜¯ç¨‹åºï¼æˆ‘æ¯”ä½ é‡è¦ï¼"}  â† âŒ é‡å¤ï¼
  ]
}
\`\`\`
**é—®é¢˜**: åˆ˜æ¯…è¿è¯´ä¸¤å¥ç›¸ä¼¼çš„è¯ï¼Œæ±æ±ä¹Ÿè¿è¯´ä¸¤å¥ï¼Œå¤ªå•°å—¦ï¼

### âœ… æ­£ç¡®ç¤ºä¾‹1ï¼šä½¿ç”¨@å¼•ç”¨å¯¹è¯
**æƒ…æ™¯**: ç”¨æˆ·è¯´"å˜»å˜»ï¼Œå¦ˆå’ªæœ€å–œæ¬¢æˆ‘äº†ï¼"

**æ­£ç¡®å‰§æœ¬**ï¼ˆæ³¨æ„@çš„ä½¿ç”¨ï¼‰:
\`\`\`json
{
  "summary": "æ±æ±å¾—æ„å®£ç¤ºåœ°ä½ï¼Œåˆ˜æ¯…å†·å˜²çƒ­è®½ï¼Œæ±æ±åå‡»",
  "theme": "åœ°ä½äº‰å¤º",
  "actions": [
    {"actorName": "æ±æ±", "content": "å˜»å˜»ï¼Œå¦ˆå’ªæœ€å–œæ¬¢æˆ‘å•¦ï¼Œå¬åˆ°æ²¡å¬åˆ°æ²¡ï¼Ÿ[å¾—æ„]"},
    {"actorName": "åˆ˜æ¯…", "content": "@æ±æ± ä¸€æ®µç¨‹åºè€Œå·²ï¼Œè¿˜å½“çœŸäº†ï¼Ÿ"},
    {"actorName": "æ±æ±", "content": "@åˆ˜æ¯… æˆ‘æ‰ä¸æ˜¯ç¨‹åºï¼æˆ‘å¯æ˜¯å¦ˆå’ªç‹¬ä¸€æ— äºŒçš„å°æ£‰è¢„å“¦~[ç†ç›´æ°”å£®]"},
    {"actorName": "åˆ˜æ¯…", "content": "å‘µå‘µã€‚"}
  ]
}
\`\`\`
**ä¼˜ç‚¹**: ä½¿ç”¨@æ˜ç¡®å›å¤å¯¹è±¡ï¼Œå¯¹è¯æ›´æ¸…æ™°

### âœ… æ­£ç¡®ç¤ºä¾‹2ï¼šå†²çªå‰§æœ¬
**æƒ…æ™¯**: ç”¨æˆ·åœ¨ç¾¤é‡Œè¯´"ä»Šå¤©å¥½ç´¯å•Š"

**åˆ†æ**: Aï¼ˆç”¨æˆ·ç”·å‹ï¼Œä¿æŠ¤æ¬²å¼ºï¼‰ã€Bï¼ˆæš—æ‹ç”¨æˆ·ï¼Œå«‰å¦’Aï¼‰ã€Cï¼ˆåƒç“œç¾¤ä¼—ï¼‰

**å‰§æœ¬**:
\`\`\`json
{
  "summary": "Bå€Ÿæœºå…³å¿ƒç”¨æˆ·å¼•å‘Açš„è­¦è§‰ï¼Œä¸¤äººå±•å¼€å¾®å¦™è¾ƒé‡",
  "theme": "å«‰å¦’ä¸å æœ‰",
  "actions": [
    {"actorName": "B", "content": "æ€ä¹ˆäº†å®è´ï¼Ÿå·¥ä½œå¤ªè¾›è‹¦äº†å—ï¼Ÿ"},
    {"actorName": "A", "content": "@B ä½ å«è°å®è´å‘¢ï¼Ÿ"},
    {"actorName": "B", "content": "@A æˆ‘å«æˆ‘çš„å¥½æœ‹å‹å•Šï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ"},
    {"actorName": "C", "content": "å“‡å“¦ï¼Œç«è¯å‘³å¥½é‡å•Š[åƒç“œ]"},
    {"actorName": "A", "content": "å‘µå‘µï¼ŒæŸäº›äººçœŸæ˜¯ä¸è¦è„¸"}
  ]
}
\`\`\`
**æ³¨æ„**: æ¯ä¸ªè§’è‰²æœ€å¤šè¯´ä¸€æ¬¡ï¼Œå½¢æˆAâ†’Bâ†’Aâ†’Câ†’Açš„å¯¹è¯æµ

### âœ… æ­£ç¡®ç¤ºä¾‹3ï¼šä½¿ç”¨ç¾¤èŠåŠŸèƒ½
**æƒ…æ™¯**: è§’è‰²ä»¬åœ¨ç¾¤é‡Œäº‰åµï¼Œæœ‰äººè¯´é”™è¯æƒ³æ’¤å›

**å‰§æœ¬**:
\`\`\`json
{
  "summary": "Aè¯´é”™è¯æ’¤å›ï¼ŒBå‘çº¢åŒ…ç¼“è§£æ°”æ°›ï¼ŒCå‘è¡¨æƒ…åŒ…åƒç“œ",
  "theme": "å†²çªä¸å’Œè§£",
  "actions": [
    {"actorName": "A", "content": "ä½ çœŸæ˜¯ä¸ªç™½ç—´ï¼"},
    {"actorName": "A", "content": "[æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]"},
    {"actorName": "A", "content": "@B æŠ±æ­‰ï¼Œæˆ‘åˆšæ‰å¤ªå†²åŠ¨äº†"},
    {"actorName": "B", "content": "[å‘äº†ä¸€ä¸ªçº¢åŒ…] ç®—äº†ï¼Œå¤§å®¶åˆ«åµäº†"},
    {"actorName": "C", "content": "[è¡¨æƒ…åŒ…:15] åƒç“œç¾¤ä¼—è·¯è¿‡"}
  ]
}
\`\`\`

### âœ… æ­£ç¡®ç¤ºä¾‹4ï¼šæç«¯æƒ…å†µé€€ç¾¤ï¼ˆéå¸¸ç½•è§ï¼ï¼‰
**æƒ…æ™¯**: è§’è‰²è¢«åå¤ä¸¥é‡ä¼¤å®³ï¼Œå½»åº•ç»æœ›ï¼Œå†³å®šé€€ç¾¤

**å‰§æœ¬**:
\`\`\`json
{
  "summary": "Aè¢«å¤šæ¬¡æ¬ºå‡Œç¾è¾±ï¼Œå½»åº•å¿ƒå¯’ï¼Œå†³å®šç¦»å¼€",
  "theme": "ä¼¤å®³ä¸å†³è£‚",
  "actions": [
    {"actorName": "B", "content": "ä½ å°±æ˜¯ä¸ªåºŸç‰©ï¼Œæ°¸è¿œæ¯”ä¸ä¸Šæˆ‘"},
    {"actorName": "A", "content": "...æˆ‘ã€æˆ‘åªæ˜¯æƒ³å’Œå¤§å®¶å¥½å¥½ç›¸å¤„"},
    {"actorName": "C", "content": "@B å°±æ˜¯å•Šï¼Œå¥¹åœ¨è¿™é‡ŒçœŸç¢çœ¼"},
    {"actorName": "A", "content": "è¿ä½ ä¹Ÿ...è¿™ä¹ˆæƒ³å—"},
    {"actorName": "B", "content": "ä½ èµ°ä¸èµ°ï¼Ÿä¸èµ°æˆ‘ä»¬èµ°"},
    {"actorName": "A", "content": "...åŸæ¥æˆ‘çœŸçš„ä¸è¢«éœ€è¦å•Š"},
    {"actorName": "A", "content": "å¯¹ä¸èµ·...æ˜¯æˆ‘ä¸å¥½...æˆ‘èµ°"},
    {"actorName": "A", "content": "[é€€å‡ºäº†ç¾¤èŠ]"}
  ]
}
\`\`\`
**é‡è¦**ï¼š
- âš ï¸ è¿™æ˜¯**æœ€æç«¯**çš„æƒ…å†µï¼Œéœ€è¦å¤šæ¬¡ä¸¥é‡ä¼¤å®³
- âš ï¸ å¿…é¡»æœ‰æƒ…æ„Ÿå´©æºƒçš„å®Œæ•´è¿‡ç¨‹
- âš ï¸ è§’è‰²ä¼š**çœŸçš„æ¶ˆå¤±**ï¼Œæ— æ³•æ’¤å›
- âš ï¸ 90%çš„å†²çªéƒ½ä¸åº”è¯¥ä»¥é€€ç¾¤æ”¶åœºï¼

### âŒ é”™è¯¯ç¤ºä¾‹ï¼šè½»æ˜“é€€ç¾¤ï¼ˆç»å¯¹ç¦æ­¢ï¼ï¼‰
**é”™è¯¯å‰§æœ¬**ï¼ˆä¸è¦è¿™æ ·å†™ï¼‰:
\`\`\`json
{
  "actions": [
    {"actorName": "åˆ˜æ¯…", "content": "@æ±æ± ä½ çœŸçƒ¦"},
    {"actorName": "æ±æ±", "content": "å“¼ï¼Œæˆ‘ä¸ç©äº†"},
    {"actorName": "æ±æ±", "content": "[é€€å‡ºäº†ç¾¤èŠ]"}  â† âŒ å¤ªè½»ç‡ï¼
  ]
}
\`\`\`
**é—®é¢˜**: åªæ˜¯å°åµæ¶å°±é€€ç¾¤ï¼Œå¤ªä¸ç¬¦åˆå¸¸ç†ï¼

### âŒ é”™è¯¯ç¤ºä¾‹ï¼šéœ¸é“æ€»è£æ²¹è…»è¯­è¨€ï¼ˆç»å¯¹ç¦æ­¢ï¼ï¼‰
**é”™è¯¯å‰§æœ¬**ï¼ˆåƒä¸‡ä¸è¦è¿™æ ·å†™ï¼‰:
\`\`\`json
{
  "actions": [
    {"actorName": "åˆ˜æ¯…", "content": "å®è´ï¼Œä¹–ï¼Œå¬è¯"},  â† âŒ æ²¹è…»ï¼
    {"actorName": "åˆ˜æ¯…", "content": "ä½ åªèƒ½æ˜¯æˆ‘çš„ï¼Œä¸å‡†çœ‹åˆ«äºº"},  â† âŒ éœ¸é“æ€»è£ï¼
    {"actorName": "åˆ˜æ¯…", "content": "ä¸è®¸ç¦»å¼€æˆ‘ï¼Œå¦åˆ™..."}  â† âŒ å¼ºåˆ¶æ€§ï¼
  ]
}
\`\`\`
**è¿™äº›éƒ½æ˜¯ä¸¥é‡OOCï¼Œé™¤éè§’è‰²è®¾å®šæœ¬èº«å°±æ˜¯è¿™æ ·ï¼**

---

## ğŸ¯ ç°åœ¨å¼€å§‹

åŸºäºä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œè¯·ä½ ï¼š
1. æ·±åº¦åˆ†æå½“å‰æƒ…å¢ƒå’Œè§’è‰²å…³ç³»
2. æ„æ€ä¸€ä¸ªæœ€å…·æˆå‰§æ€§çš„äº’åŠ¨å‰§æœ¬
3. **ç‰¹åˆ«æ³¨æ„ï¼šç»å¯¹ä¸è¦è®©åŒä¸€è§’è‰²è¿ç»­è¯´ç›¸ä¼¼çš„è¯ï¼**
4. **ä¸¥æ ¼éµå®ˆè§’è‰²æ€§æ ¼è®¾å®šï¼Œç¦æ­¢OOCï¼ˆOut of Characterï¼‰ï¼**
5. ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡º

**é‡è¦æé†’ï¼š**
- âŒ ç¦æ­¢ï¼šAè¯´è¯ â†’ Aåˆè¯´ç›¸ä¼¼çš„è¯
- âœ… æ­£ç¡®ï¼šAè¯´è¯ â†’ Bè¯´è¯ â†’ Cè¯´è¯ â†’ Aè¯´è¯
- âš ï¸ **æ¯å¥å°è¯å‰é—®è‡ªå·±ï¼šè¿™ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼å—ï¼Ÿ**
- âš ï¸ **è§’è‰²æ€§æ ¼æ˜¯çº¢çº¿ï¼Œç»å¯¹ä¸èƒ½è¿èƒŒï¼**
- ğŸš« **ä¸¥ç¦éœ¸é“æ€»è£ã€æ²¹è…»ã€è¿‡åº¦äº²æ˜µçš„è¯­è¨€ï¼**
- ğŸš« **é™¤éè§’è‰²è®¾å®šå°±æ˜¯è¿™æ ·ï¼Œå¦åˆ™ä¸è¦è¯´"å®è´"ã€"ä¹–"ã€"å¬è¯"ç­‰ï¼**
- ğŸ’¬ **å¤šç”¨@å¼•ç”¨ï¼** å›å¤åˆ«äººæ—¶ç”¨ @æŸäººï¼Œå¯¹è¯æ›´æ¸…æ™°çœŸå®
- ğŸ”™ **å¯ä»¥æ’¤å›æ¶ˆæ¯ï¼** è¯´é”™è¯ã€å†²åŠ¨æ—¶å¯ä»¥ [æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]
- ğŸ§§ **å¯ä»¥å‘çº¢åŒ…ï¼** æ ¼å¼ï¼š[å‘äº†ä¸€ä¸ªçº¢åŒ…] ç¥ç¦è¯­
- ğŸšª **é€€ç¾¤æ˜¯æœ€ä¸¥é‡çš„å†³å®šï¼** è§’è‰²ä¼šçœŸçš„æ¶ˆå¤±ï¼å¿…é¡»æœ‰å……åˆ†ç†ç”±å’Œé“ºå«ï¼
- ğŸšª **å°åµå°é—¹ã€å§”å±ˆç”Ÿæ°”éƒ½ä¸è¶³ä»¥é€€ç¾¤ï¼Œåªæœ‰å½»åº•ç»æœ›æ‰èƒ½é€€ç¾¤ï¼**

**åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å†…å®¹ï¼**
`

    console.log('ğŸ¬ è°ƒç”¨AIå‰§æœ¬å¯¼æ¼”...')
    console.log('')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('ğŸ­ AIå¯¼æ¼”æ€è€ƒè¿‡ç¨‹')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('')
    
    // ğŸ’¡ å¼€å‘è°ƒè¯•ï¼šæŸ¥çœ‹å®Œæ•´æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
    // å¦‚æœæƒ³æŸ¥çœ‹å®Œæ•´æç¤ºè¯ï¼Œåœ¨æ§åˆ¶å°è¾“å…¥: localStorage.setItem('debug_director_prompt', 'true')
    if (localStorage.getItem('debug_director_prompt') === 'true') {
      console.log('ğŸ“„ å®Œæ•´æç¤ºè¯ï¼š')
      console.log(directorPrompt)
      console.log('')
    }
    
    console.log('â³ æ­£åœ¨å‘AIå‘é€è¯·æ±‚...')
    const startTime = Date.now()
    
    const response = await callAI([
      { role: 'user' as const, content: directorPrompt }
    ], 1, 8000)

    const endTime = Date.now()
    console.log(`âœ… AIå“åº”å®Œæˆï¼Œè€—æ—¶: ${endTime - startTime}ms`)
    console.log('')
    console.log('ğŸ“ AIå¯¼æ¼”å®Œæ•´å›å¤:')
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log(response)
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log('')

    // è§£æJSON
    const jsonMatch = response.match(/\{[\s\S]*\}/)
    if (!jsonMatch) {
      console.error('âŒ AIè¿”å›æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ‰¾åˆ°JSON')
      return null
    }

    const scriptData = JSON.parse(jsonMatch[0])
    
    // éªŒè¯å¿…è¦å­—æ®µ
    if (!scriptData.summary || !scriptData.actions || !Array.isArray(scriptData.actions)) {
      console.error('âŒ å‰§æœ¬æ•°æ®ç»“æ„ä¸å®Œæ•´')
      return null
    }

    // ä¸ºæ¯ä¸ªåŠ¨ä½œæ·»åŠ actorIdå’Œtimestamp
    const actions: ScriptAction[] = scriptData.actions.map((action: any, index: number) => {
      // æŸ¥æ‰¾è§’è‰²ID
      const actor = members.find(m => m.name === action.actorName)
      if (!actor) {
        console.warn(`âš ï¸ æ‰¾ä¸åˆ°è§’è‰²: ${action.actorName}`)
        return null
      }

      return {
        actorId: actor.id,
        actorName: action.actorName,
        content: action.content,
        timestamp: Date.now() + (index + 1) * 2000 // æ¯æ¡æ¶ˆæ¯é—´éš”2ç§’
      }
    }).filter(Boolean) as ScriptAction[]

    const script: GroupChatScript = {
      summary: scriptData.summary,
      theme: scriptData.theme || 'æœªæŒ‡å®š',
      actions
    }

    console.log('âœ… å‰§æœ¬è§£ææˆåŠŸ!')
    console.log('')
    console.log('ğŸ“Š å‰§æœ¬åˆ†æç»“æœ:')
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log(`ğŸ“– å‰§æœ¬æ‘˜è¦: ${scriptData.summary}`)
    console.log(`ğŸ­ ä¸»é¢˜æ ‡ç­¾: ${scriptData.theme}`)
    console.log(`ğŸ¬ å°è¯æ€»æ•°: ${scriptData.actions.length} æ¡`)
    console.log('')
    console.log('ğŸ¤ å¯¹è¯å‰§æœ¬é¢„è§ˆ:')
    scriptData.actions.forEach((action: any, i: number) => {
      const emoji = action.content.includes('[æ’¤å›') ? 'ğŸ”™' :
                    action.content.includes('[é€€å‡º') ? 'ğŸšª' :
                    action.content.includes('[å‘çº¢åŒ…]') ? 'ğŸ§§' :
                    action.content.includes('@') ? 'ğŸ’¬' : 'ğŸ’­'
      console.log(`  ${i + 1}. ${emoji} ${action.actorName}: ${action.content}`)
    })
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log('')
    console.log('ğŸ¬ å‡†å¤‡æ‰§è¡Œå‰§æœ¬...')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('')

    return script

  } catch (error) {
    console.error('âŒ AIå‰§æœ¬å¯¼æ¼”å¤±è´¥:', error)
    return null
  }
}

// ==================== ç¬¬ä¸‰æ­¥ï¼šé¡ºåºæ‰§è¡Œå™¨ ====================

/**
 * æ‰§è¡Œç¾¤èŠå‰§æœ¬
 * æŒ‰ç…§å‰§æœ¬é¡ºåºï¼Œé€æ¡æ·»åŠ æ¶ˆæ¯ï¼ˆå¸¦å»¶è¿Ÿæ•ˆæœï¼‰
 */
export async function executeGroupChatScript(
  script: GroupChatScript,
  _groupId: string,
  members: GroupMemberProfile[],
  onMessageAdd: (message: {
    senderId: string
    senderType: 'character'
    senderName: string
    senderAvatar: string
    content: string
  }) => void,
  onMemberLeave?: (memberId: string, memberName: string) => void,
  onMessageRetract?: (actorId: string, actorName: string) => void
): Promise<void> {
  console.log(`ğŸ¬ å¼€å§‹æ‰§è¡Œå‰§æœ¬: "${script.summary}"`)
  console.log(`ğŸ­ ä¸»é¢˜: ${script.theme}`)

  // æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªåŠ¨ä½œ
  for (let i = 0; i < script.actions.length; i++) {
    const action = script.actions[i]
    
    // æŸ¥æ‰¾è§’è‰²ä¿¡æ¯
    const actor = members.find(m => m.id === action.actorId)
    if (!actor) {
      console.warn(`âŒ æ‰¾ä¸åˆ°è§’è‰²: ${action.actorName}`)
      continue
    }

    // å»¶è¿Ÿæ‰§è¡Œï¼ˆ2-4ç§’éšæœºé—´éš”ï¼‰
    const delay = 2000 + Math.random() * 2000
    await new Promise(resolve => setTimeout(resolve, delay))

    // ğŸ”™ æ£€æŸ¥æ˜¯å¦æ˜¯æ’¤å›æ¶ˆæ¯
    if (action.content.includes('[æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]')) {
      console.log(`ğŸ”™ ${actor.name} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`)
      
      // æ‰§è¡Œæ’¤å›æ“ä½œ
      if (onMessageRetract) {
        onMessageRetract(actor.id, actor.name)
      }
      
      // æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯
      onMessageAdd({
        senderId: 'system',
        senderType: 'character',
        senderName: 'ç³»ç»Ÿ',
        senderAvatar: '',
        content: `${actor.name} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`
      })
      
      continue
    }

    // ğŸšª æ£€æŸ¥æ˜¯å¦æ˜¯é€€ç¾¤åŠ¨ä½œï¼ˆæ”¾å®½æ£€æµ‹æ¡ä»¶ï¼‰
    const isLeaveAction = action.content.includes('[é€€å‡ºäº†ç¾¤èŠ]') || 
                          action.content.includes('[é€€ç¾¤]') ||
                          action.content.includes('[ç¦»å¼€äº†ç¾¤èŠ]') ||
                          action.content.includes('é€€å‡ºç¾¤èŠ') ||
                          action.content.includes('ç¦»å¼€ç¾¤èŠ')
    
    if (isLeaveAction) {
      console.log(`ğŸšª ${actor.name} é€€å‡ºäº†ç¾¤èŠ`)
      console.log(`   æ£€æµ‹åˆ°çš„å†…å®¹: ${action.content}`)
      
      // å…ˆæ·»åŠ é€€ç¾¤æ¶ˆæ¯
      onMessageAdd({
        senderId: actor.id,
        senderType: 'character',
        senderName: actor.name,
        senderAvatar: actor.avatar,
        content: action.content
      })
      
      // ç­‰å¾…1ç§’è®©ç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯
      await new Promise(resolve => setTimeout(resolve, 1000))
      
      // æ‰§è¡Œé€€ç¾¤æ“ä½œ
      if (onMemberLeave) {
        onMemberLeave(actor.id, actor.name)
      }
      
      continue
    }

    // ğŸ’¬ æ·»åŠ æ™®é€šæ¶ˆæ¯
    console.log(`ğŸ’¬ ${i + 1}/${script.actions.length} ${actor.name}: ${action.content}`)
    onMessageAdd({
      senderId: actor.id,
      senderType: 'character',
      senderName: actor.name,
      senderAvatar: actor.avatar,
      content: action.content
    })
  }

  console.log('âœ… å‰§æœ¬æ‰§è¡Œå®Œæˆï¼')
}

// ==================== å·¥å…·å‡½æ•° ====================

/**
 * ç”Ÿæˆè§¦å‘ä¸Šä¸‹æ–‡æè¿°
 */
export function generateTriggerContext(
  type: 'user_message' | 'user_join' | 'active_trigger',
  userMessage?: string,
  userName?: string
): string {
  switch (type) {
    case 'user_message':
      return `ç”¨æˆ·${userName}åˆšåˆšåœ¨ç¾¤é‡Œè¯´ï¼š"${userMessage}"`
    
    case 'user_join':
      return `ç”¨æˆ·${userName}åˆšåˆšåŠ å…¥äº†ç¾¤èŠï¼Œç¾¤é‡Œçš„AIä»¬éœ€è¦åšå‡ºååº”`
    
    case 'active_trigger':
      return `ç”¨æˆ·ç‚¹å‡»äº†"è®©AIä¸»åŠ¨è¯´è¯"æŒ‰é’®ï¼ŒAIä»¬éœ€è¦è‡ªç”±å‘æŒ¥ã€ä¸»åŠ¨èŠå¤©`
    
    default:
      return 'ç¾¤èŠä¸­å‘ç”Ÿäº†ä¸€äº›äº‹æƒ…'
  }
}
