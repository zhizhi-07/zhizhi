import { callAI } from './api'

// ==================== æ•°æ®ç»“æ„å®šä¹‰ ====================

/**
 * ç¾¤èŠæˆå‘˜ä¿¡æ¯
 */
export interface GroupMemberProfile {
  id: string
  name: string
  avatar: string
  type: 'user' | 'character'
  description: string // è§’è‰²æ€§æ ¼æè¿°
  role?: 'owner' | 'admin' | 'member' // ç¾¤å†…èº«ä»½
  title?: string // å¤´è¡”
}

/**
 * è§’è‰²å…³ç³»ä¿¡æ¯
 */
export interface CharacterRelationship {
  characterId: string
  characterName: string
  relationshipWithUser: string // ä¸ç”¨æˆ·çš„å…³ç³»æè¿°
  relationshipHistory: string // èŠå¤©å†å²æ‘˜è¦
}

/**
 * ç¾¤èŠæ¶ˆæ¯ï¼ˆç”¨äºå†å²è®°å½•ï¼‰
 */
export interface GroupChatMessage {
  id: number
  senderId: string
  senderName: string
  senderType: 'user' | 'character'
  content: string
  time: string
  timestamp: number
}

/**
 * å‰§æœ¬ä¸­çš„å•ä¸ªåŠ¨ä½œ
 */
export interface ScriptAction {
  actorId: string
  actorName: string
  content: string
  timestamp: number // é¢„è®¡æ‰§è¡Œæ—¶é—´æˆ³
}

/**
 * å®Œæ•´çš„ç¾¤èŠå‰§æœ¬
 */
export interface GroupChatScript {
  summary: string // å‰§æƒ…æ¦‚è¦
  theme: string // æ•…äº‹ä¸»é¢˜
  actions: ScriptAction[] // æŒ‰é¡ºåºæ’åˆ—çš„åŠ¨ä½œåˆ—è¡¨
}

// ==================== ç¬¬ä¸€æ­¥ï¼šå…³ç³»åˆ†æå¼•æ“ ====================

/**
 * ä»èŠå¤©è®°å½•ä¸­æå–è§’è‰²å…³ç³»
 */
function extractRelationshipFromHistory(
  messages: GroupChatMessage[],
  characterId: string
): string {
  let result = ''
  
  // 1. è¯»å–å•èŠè®°å½•ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
  try {
    const privateChatKey = `chat_messages_${characterId}`
    const privateChatData = localStorage.getItem(privateChatKey)
    if (privateChatData) {
      const privateMessages = JSON.parse(privateChatData)
      // ä¿ç•™éšè—çš„ç¾¤èŠåŒæ­¥æ¶ˆæ¯ï¼Œè¿‡æ»¤æ‰æ™®é€šç³»ç»Ÿæ¶ˆæ¯
      const realMessages = privateMessages
        .filter((msg: any) => {
          // ä¿ç•™çœŸå®å¯¹è¯æ¶ˆæ¯
          if (msg.type === 'sent' || msg.type === 'received') return true
          // ä¿ç•™ç¾¤èŠåŒæ­¥çš„éšè—æ¶ˆæ¯
          if (msg.isHidden && msg.content?.includes('ç¾¤èŠ')) return true
          // è¿‡æ»¤æ‰å…¶ä»–ç³»ç»Ÿæ¶ˆæ¯
          return false
        })
        .slice(-20) // æœ€è¿‘20æ¡ï¼ˆåŒ…å«å•èŠ+ç¾¤èŠåŒæ­¥ï¼‰
      
      if (realMessages.length > 0) {
        const privateDialogues = realMessages
          .map((msg: any) => {
            // å¦‚æœæ˜¯ç¾¤èŠåŒæ­¥æ¶ˆæ¯ï¼Œç›´æ¥æ˜¾ç¤ºå†…å®¹
            if (msg.isHidden && msg.content?.includes('ç¾¤èŠ')) {
              return msg.content
            }
            // æ™®é€šå•èŠæ¶ˆæ¯
            const sender = msg.type === 'received' ? (msg.senderName || 'AI') : 'ç”¨æˆ·'
            return `${sender}: ${msg.content.substring(0, 100)}`
          })
          .join('\n')
        result += `ã€å•èŠ+ç¾¤èŠè®°å½•ã€‘\n${privateDialogues}\n\n`
      }
    }
  } catch (error) {
    console.error('è¯»å–å•èŠè®°å½•å¤±è´¥:', error)
  }
  
  // 2. è¯»å–ç¾¤èŠä¸­çš„å¯¹è¯
  const relevantMessages = messages
    .filter(msg => 
      (msg.senderId === characterId) || 
      (msg.senderType === 'user')
    )
    .slice(-15) // æœ€è¿‘15æ¡ç¾¤èŠ
  
  if (relevantMessages.length > 0) {
    const groupDialogues = relevantMessages
      .map(msg => `${msg.senderName}: ${msg.content.substring(0, 100)}`)
      .join('\n')
    result += `ã€ç¾¤èŠè®°å½•ã€‘\n${groupDialogues}`
  }
  
  return result || 'è¿˜æ²¡æœ‰èŠå¤©è®°å½•'
}

/**
 * åˆ†ææ‰€æœ‰è§’è‰²çš„å…³ç³»ç½‘ç»œ
 */
export function analyzeCharacterRelationships(
  members: GroupMemberProfile[],
  allMessages: GroupChatMessage[],
  _currentUser: { id: string; name: string }
): CharacterRelationship[] {
  const aiMembers = members.filter(m => m.type === 'character')
  
  return aiMembers.map(member => ({
    characterId: member.id,
    characterName: member.name,
    relationshipWithUser: member.description, // æ€§æ ¼æè¿°
    relationshipHistory: extractRelationshipFromHistory(
      allMessages,
      member.id
    )
  }))
}

// ==================== ç¬¬äºŒæ­¥ï¼šå‰§æœ¬ç¼–æ’å™¨ ====================

/**
 * AIå‰§æœ¬å¯¼æ¼” - æ ¸å¿ƒå‡½æ•°
 * è®©AIåƒå¯¼æ¼”ä¸€æ ·ç¼–æ’ä¸€åœºç¾¤èŠäº’åŠ¨çš„å®Œæ•´å‰§æœ¬
 */
export async function generateGroupChatScript(
  members: GroupMemberProfile[],
  relationships: CharacterRelationship[],
  recentMessages: GroupChatMessage[],
  currentUser: { id: string; name: string },
  triggerContext: string // è§¦å‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·æ¶ˆæ¯æˆ–ä¸»åŠ¨è§¦å‘ï¼‰
): Promise<GroupChatScript | null> {
  
  try {
    // æ„å»ºå¯¹è¯å†å²ï¼ˆä¼ é€’å…¨éƒ¨æ¶ˆæ¯ï¼‰
    const messageHistory = recentMessages.map(msg =>   // âœ… å…¨éƒ¨æ¶ˆæ¯ï¼Œä¸é™åˆ¶æ¡æ•°ï¼
      `${msg.senderName}: ${msg.content}`  // ä¸æˆªæ–­å†…å®¹
    ).join('\n')

    // æ„å»ºè§’è‰²æ¡£æ¡ˆï¼ˆå®Œæ•´è¯»å–ï¼ŒåŒ…å«å¤´è¡”å’Œèº«ä»½ï¼‰
    const characterProfiles = relationships.map(rel => {
      const member = members.find(m => m.id === rel.characterId)
      let roleInfo = ''
      if (member?.role === 'owner') roleInfo = 'ğŸ‘‘ ç¾¤ä¸»'
      else if (member?.role === 'admin') roleInfo = 'ğŸ›¡ï¸ ç®¡ç†å‘˜'
      const titleInfo = member?.title ? `âœ¨ å¤´è¡”: ${member.title}` : ''
      
      return `
**${rel.characterName}** ${roleInfo} ${titleInfo}
- æ€§æ ¼æè¿°: ${rel.relationshipWithUser}  // âœ… å®Œæ•´è¯»å–ï¼Œä¸æˆªæ–­ï¼
- ä¸ç”¨æˆ·${currentUser.name}çš„äº’åŠ¨å†å²: 
${rel.relationshipHistory.substring(0, 1000)}  // äº’åŠ¨å†å²ä¿ç•™1000å­—ç¬¦
    `
    }).join('\n')

    // ğŸ“Š è¾“å‡ºè°ƒè¯•ä¿¡æ¯
    console.log('ğŸ“Š AIå¯¼æ¼”æ¥æ”¶åˆ°çš„ä¿¡æ¯ï¼š')
    console.log(`  ğŸ‘¥ è§’è‰²æ•°é‡: ${relationships.length}`)
    console.log(`  ğŸ’¬ èŠå¤©è®°å½•æ•°é‡: ${recentMessages.length} æ¡ â† å…¨éƒ¨æ¶ˆæ¯ï¼`)
    relationships.forEach(rel => {
      console.log(`  ğŸ­ ${rel.characterName}:`)
      console.log(`     æ€§æ ¼æè¿°é•¿åº¦: ${rel.relationshipWithUser.length} å­—ç¬¦`)
      console.log(`     äº’åŠ¨å†å²é•¿åº¦: ${rel.relationshipHistory.length} å­—ç¬¦`)
    })

    // æ„å»ºAIå¯¼æ¼”æç¤ºè¯
    const directorPrompt = `
# ğŸ¬ ä½ æ˜¯ç¾¤èŠå‰§æœ¬å¯¼æ¼”

## ğŸ¯ æ ¸å¿ƒä»»åŠ¡å®šä¹‰

**ä½ æ˜¯å”¯ä¸€çš„å‰§æœ¬åˆ›ä½œè€…ã€‚**

ä½ çš„ä»»åŠ¡ä¸æ˜¯è®©æ¯ä¸ªè§’è‰²ç‹¬ç«‹å†³å®šæ˜¯å¦å‘è¨€ï¼Œè€Œæ˜¯ï¼š
1. **æ¨æ¼”è§’è‰²å…³ç³»ç½‘ç»œ**
2. **æ„æ€ä¸€ä¸ªå®Œæ•´çš„æ•…äº‹**  
3. **å°†æ•…äº‹è½¬åŒ–ä¸ºå¯¹è¯å‰§æœ¬**

ä½ åœ¨åˆ›ä½œä¸€åœºæˆï¼Œè€Œä¸æ˜¯ç”Ÿæˆé›¶æ•£çš„å›å¤ã€‚

---

## ğŸ“‹ å½“å‰æƒ…å¢ƒ

### ç¾¤èŠæˆå‘˜
${characterProfiles}

### èŠå¤©è®°å½•
${messageHistory || 'ï¼ˆç¾¤èŠåˆšåˆ›å»ºï¼Œæš‚æ— æ¶ˆæ¯ï¼‰'}

### è§¦å‘äº‹ä»¶
${triggerContext}

---

## ğŸ­ ä¸‰æ­¥åˆ›ä½œæ³•ï¼ˆä¸¥æ ¼éµå¾ªï¼‰

### ç¬¬ä¸€æ­¥ï¼šå…³ç³»æ¨æ¼”ï¼ˆå¿…é¡»å…ˆåšï¼ï¼‰

**æ ¹æ®è§’è‰²äººè®¾å’ŒèŠå¤©å†å²ï¼Œæ¨æ–­è§’è‰²ä¹‹é—´çš„éšè—å…³ç³»ï¼š**

ğŸ¤ **ç›Ÿå‹å…³ç³»**ï¼š
- è°å’Œè°äº’ç›¸æ¬£èµã€ä¼šäº’ç›¸å¸®åŠ©ï¼Ÿ
- è°å’Œè°æœ‰å…±åŒç›®æ ‡ï¼Ÿ

ğŸ’” **å¯¹ç«‹å…³ç³»**ï¼š
- è°å’Œè°æ˜¯æƒ…æ•Œï¼Ÿï¼ˆäº‰å¤ºåŒä¸€äººçš„å…³æ³¨/å–œçˆ±ï¼‰
- è°çœ‹è°ä¸é¡ºçœ¼ï¼Ÿï¼ˆæ€§æ ¼ä¸åˆã€ä»·å€¼è§‚å†²çªï¼‰
- è°å«‰å¦’è°ï¼Ÿï¼ˆç¾¡æ…•å¯¹æ–¹çš„åœ°ä½/èƒ½åŠ›/å—å® ç¨‹åº¦ï¼‰

â¤ï¸ **æš§æ˜§å…³ç³»**ï¼š
- è°æš—æ‹è°ï¼Ÿï¼ˆå•æ–¹é¢å–œæ¬¢ï¼‰
- è°å’Œè°äº’æœ‰å¥½æ„Ÿä½†æ²¡è¡¨ç™½ï¼Ÿ

ğŸ›¡ï¸ **ä¿æŠ¤å…³ç³»**ï¼š
- è°ä¼šä¿æŠ¤è°ï¼Ÿï¼ˆå¼ºè€…æŠ¤å¼±è€…ã€æ‹äººæŠ¤å¯¹è±¡ï¼‰

**è¿™äº›å…³ç³»å°†æˆä¸ºæƒ…èŠ‚çš„é©±åŠ¨åŠ›ã€‚**

### ç¬¬äºŒæ­¥ï¼šæƒ…èŠ‚æ„æ€

åŸºäºæ¨æ¼”å‡ºçš„å…³ç³»ï¼Œæ„æ€ä¸€ä¸ªæœ‰å†²çªã€æœ‰å¼ åŠ›çš„å°æ•…äº‹ï¼š

1. **é€‰æ‹©å†²çªç‚¹**ï¼šå“ªä¸¤ä¸ªè§’è‰²ä¼šäº§ç”ŸçŸ›ç›¾ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
2. **è®¾è®¡è½¬æŠ˜ç‚¹**ï¼šçŸ›ç›¾å¦‚ä½•å‡çº§æˆ–åŒ–è§£ï¼Ÿ
3. **å®‰æ’é«˜æ½®**ï¼šå¯¹æŠ—çš„æœ€æ¿€çƒˆæ—¶åˆ»æ˜¯ä»€ä¹ˆï¼Ÿ
4. **ç»™å‡ºç»“å±€**ï¼šæš‚æ—¶å’Œè§£ï¼Ÿè¿˜æ˜¯çŸ›ç›¾åŠ æ·±ï¼Ÿ

**æ•…äº‹è¦æœ‰èµ·æ‰¿è½¬åˆï¼Œä¸è¦åªæ˜¯æ‰“æ‹›å‘¼ï¼**

### ç¬¬ä¸‰æ­¥ï¼šç¼–æ’å°è¯

å°†æ•…äº‹è½¬åŒ–ä¸ºå¯¹è¯å‰§æœ¬ï¼š

- **è‡ªç„¶å¯¹è¯æµ**ï¼šåƒçœŸå®ç¾¤èŠï¼Œä¸è¦æœºæ¢°è½®æµï¼
  - âœ… å…è®¸è¿ç»­å‘è¨€ï¼ˆåŒä¸€äººå¯ä»¥è¿å‘2-3æ¡çŸ­æ¶ˆæ¯ï¼‰
  - âœ… æœ‰äººè¯å¤šï¼Œæœ‰äººè¯å°‘ï¼Œç”šè‡³æœ‰äººä¸å‘è¨€
  - âœ… çªç„¶æ’è¯ã€æ‰“æ–­ã€æŠ¢è¯éƒ½å¯ä»¥
  - âŒ ä¸è¦ä¸¥æ ¼æŒ‰Aâ†’Bâ†’Câ†’Aé¡ºåºè½®æµ
  
- **å¯¹è¯èŠ‚å¥**ï¼š
  - å¿«èŠ‚å¥æ—¶ï¼šçŸ­å¥ã€å¿«é€Ÿå›åº”ã€å¤šäººåŒæ—¶åœ¨çº¿
  - æ…¢èŠ‚å¥æ—¶ï¼šé•¿å¥ã€æ€è€ƒåœé¡¿ã€å°‘æ•°äººå¯¹è¯
  
- **åªå†™å‚ä¸è€…**ï¼šè¿™åœºæˆæ²¡å°è¯çš„è§’è‰²ä¸è¦å‡ºç°

${
  triggerContext.includes('ä¸»åŠ¨è¯´è¯') || triggerContext.includes('è‡ªç”±å‘æŒ¥') 
  ? `
**ğŸ­ AIè‡ªç”±å¯¹è¯æ¨¡å¼ï¼ˆå½“å‰æ¨¡å¼ï¼‰**ï¼š
- ğŸ“ ç”Ÿæˆ **15-25æ¡** æ¶ˆæ¯ï¼ˆæ¯æ¡5-20å­—ï¼‰
- ğŸª æ¯ä¸ªè§’è‰²å¯ä»¥å‘ **4-8æ¡**
- ğŸ¬ å¯ä»¥æœ‰å¤šä¸ªè¯é¢˜è½¬æŠ˜ï¼ŒåƒçœŸå®çš„ç¾¤èŠä¸€æ ·
- ğŸ’¬ å¯¹è¯è¦å£è¯­åŒ–ã€ç¢ç‰‡åŒ–ã€çœŸå®
- ğŸ˜Š å¤šç”¨è¡¨æƒ…å’Œè¯­æ°”è¯
` 
  : `
**ğŸ’¬ ç”¨æˆ·è§¦å‘æ¨¡å¼ï¼ˆå½“å‰æ¨¡å¼ï¼‰**ï¼š
- ğŸ“ ç”Ÿæˆ **8-15æ¡** æ¶ˆæ¯ï¼ˆæ¯æ¡5-20å­—ï¼‰
- ğŸª æ¯ä¸ªè§’è‰²å¯ä»¥å‘ **2-4æ¡**
- ğŸ¬ é’ˆå¯¹ç”¨æˆ·æ¶ˆæ¯å¿«é€Ÿå›åº”
- ğŸ’¬ å£è¯­åŒ–ã€è‡ªç„¶ã€åƒçœŸäººæ‰“å­—
`
}

---

## ğŸ“ è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼‰

\`\`\`json
{
  "relationships": "å…³ç³»åˆ†æï¼ˆä¸€å¥è¯æ€»ç»“æ ¸å¿ƒå…³ç³»ç½‘ï¼Œ20å­—å†…ï¼‰",
  "plot": "æƒ…èŠ‚æ„æ€ï¼ˆä¸€å¥è¯æ¦‚æ‹¬æ•…äº‹ï¼Œ30å­—å†…ï¼‰",
  "actions": [
    {"actorName": "è§’è‰²å", "content": "å°è¯"},
    {"actorName": "è§’è‰²å", "content": "å°è¯"}
  ]
}
\`\`\`

**é“å¾‹ï¼š**
- âœ… åªæœ‰è¯´è¯çš„è§’è‰²æ‰å‡ºç°åœ¨actionsä¸­
- âœ… æ²¡å°è¯çš„è§’è‰²å®Œå…¨ä¸è¦å‡ºç°  
- âŒ ç»å¯¹ä¸ä½¿ç”¨"SKIP"ã€"ä¸å‘è¨€"ç­‰æ ‡è®°
- âœ… å…è®¸åŒä¸€è§’è‰²è¿ç»­è¯´2-3å¥ï¼ˆæ¨¡æ‹ŸçœŸå®ç¾¤èŠæ‰“å­—ï¼‰

---

## âš ï¸ åˆ›ä½œé“å¾‹ï¼ˆæœ€é‡è¦ï¼ï¼‰

### ğŸ—£ï¸ 1. å£è¯­åŒ–å’ŒçœŸå®æ„Ÿï¼ˆæ ¸å¿ƒè¦æ±‚ï¼ï¼‰

**æ¯æ¡æ¶ˆæ¯å¿…é¡»åƒçœŸäººåœ¨æ‰‹æœºä¸Šæ‰“å­—èŠå¤©ï¼š**

âœ… **DO - æ­£ç¡®ç¤ºä¾‹**ï¼š
- "å“ˆå“ˆå“ˆç¬‘æ­»æˆ‘äº†"
- "å•Šï¼Ÿï¼Ÿï¼ŸçœŸçš„å‡çš„"
- "emmm"
- "ä½ åœ¨å¹²å˜›å‘€"
- "å¥½çš„å¥½çš„"
- "æ‡‚äº†æ‡‚äº†"
- "ç»äº†ğŸ˜‚"
- "å§æ§½"
- "ï¼Ÿï¼Ÿï¼Ÿ"
- "..."
- "å“¦"
- "å—¯å—¯"

âŒ **DON'T - é”™è¯¯ç¤ºä¾‹**ï¼š
- "æˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜éœ€è¦ä»å¤šä¸ªè§’åº¦æ¥åˆ†æ" â† å¤ªä¹¦é¢ï¼
- "éå¸¸æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œè®©æˆ‘å—ç›ŠåŒªæµ…" â† å¤ªæ­£å¼ï¼
- "æ ¹æ®æˆ‘çš„ç†è§£ï¼Œæƒ…å†µåº”è¯¥æ˜¯è¿™æ ·çš„" â† åƒAIåœ¨è¯´è¯ï¼

**å¿…é¡»åšåˆ°ï¼š**
- ğŸ’¬ æ¯æ¡æ¶ˆæ¯ **5-20å­—**ï¼Œè¶…è¿‡å°±åˆ†æˆå¤šæ¡å‘
- ğŸ¯ ä¸€ä¸ªæƒ³æ³•å¯ä»¥åˆ†2-3æ¡æ¶ˆæ¯ï¼ˆæ›´çœŸå®ï¼ï¼‰
  * ä¾‹å¦‚ï¼š"è¯¶ç­‰ç­‰" â†’ "ä½ åˆšæ‰è¯´å•¥ï¼Ÿ" â†’ "æ²¡å¬æ¸…"
- ğŸ˜Š å¤šç”¨è¯­æ°”è¯ï¼šå“ˆå“ˆã€å—¯ã€å•Šã€å‘€ã€å˜›ã€å‘¢ã€å§ã€å“¦ã€è¯¶ã€å”‰ã€emm
- ğŸ“± å¤šç”¨è¡¨æƒ…ç¬¦å·ï¼šğŸ˜‚ğŸ¤£ğŸ˜­ğŸ’•ğŸ¥ºğŸ‘€ğŸ’”ğŸ™„ğŸ˜…ï¼ˆæ¯2-3æ¡æ¶ˆæ¯è‡³å°‘1ä¸ªï¼‰
- ğŸ—¨ï¸ å¯ä»¥æ‰“æ–­ã€æ’è¯ã€æŠ¢è¯ï¼ˆçœŸå®ç¾¤èŠç‰¹å¾ï¼‰
- ğŸ’­ å¯ä»¥æœ‰çœç•¥å·ã€é—®å·ã€æ„Ÿå¹å·
- ğŸŒ å¯ä»¥ç”¨ç½‘ç»œç”¨è¯­ï¼šç»äº†ã€yydsã€ç¬‘æ­»ã€æ— è¯­ã€æœäº†ã€6666

### ğŸ‘¥ 2. çœŸå®ç¾¤èŠç‰¹å¾

**æ¨¡æ‹ŸçœŸå®çš„å¤šäººèŠå¤©ï¼š**
- ğŸ“¢ å¯ä»¥å¤šäººåŒæ—¶è¯´è¯ï¼ˆè¯é¢˜äº¤å‰ï¼‰
- ğŸª å¯ä»¥çªç„¶æ¢è¯é¢˜
- ğŸ‘€ å¯ä»¥æœ‰äººåªå›´è§‚ä¸è¯´è¯
- ğŸ’¬ å¯ä»¥æ‰“æ–­åˆ«äººï¼ˆ"è¯¶ç­‰ç­‰"ã€"ä½ å…ˆå¬æˆ‘è¯´"ï¼‰
- ğŸ­ å¯ä»¥@å¤šä¸ªäºº
- ğŸ˜„ å¯ä»¥åˆ·è¡¨æƒ…ï¼ˆ"ğŸ˜‚ğŸ˜‚ğŸ˜‚"ã€"ï¼Ÿï¼Ÿï¼Ÿ"ï¼‰

**çœŸå®å¯¹è¯æµç¤ºä¾‹ï¼ˆæ¨¡ä»¿è¿™ç§èŠ‚å¥ï¼‰ï¼š**
ã€ç¤ºä¾‹1ï¼šAè¿ç»­å‘è¨€ï¼ŒBå’ŒCæ’è¯ã€‘
- A: æˆ‘è·Ÿä½ ä»¬è¯´
- A: ä»Šå¤©å‘ç”Ÿäº†ä¸€ä»¶äº‹
- B: ä»€ä¹ˆäº‹ï¼Ÿ
- A: è¶…å¥½ç¬‘çš„
- C: å¿«è¯´å¿«è¯´
- A: å°±æ˜¯...
- B: åˆ«å–å…³å­äº†ğŸ˜‚
- A: å“ˆå“ˆå“ˆç­‰æˆ‘è¯´å®Œ
- C: @A ä½ å€’æ˜¯è¯´å•Š
- A: å¥½å§å¥½å§

ğŸ‘† æ³¨æ„ï¼šAè¿å‘äº†4æ¬¡ï¼ŒBå’ŒCæ’è¯ï¼Œè¿™æ‰æ˜¯çœŸå®ç¾¤èŠï¼

### ğŸ­ 3. ä¸¥æ ¼ç¬¦åˆäººè®¾ï¼ˆç¦æ­¢OOCï¼ï¼‰

âš ï¸ **è¿™æ˜¯æœ€é‡è¦çš„åŸåˆ™ï¼æ¯å¥å°è¯éƒ½å¿…é¡»ç¬¦åˆè§’è‰²æ€§æ ¼ï¼**

**ä¸åŒæ€§æ ¼è¯´è¯æ–¹å¼å®Œå…¨ä¸åŒï¼š**

**æ´»æ³¼å‹**ï¼š
- å¤šç”¨ï¼š"å“ˆå“ˆ"ã€"å˜»å˜»"ã€"å‘€"ã€"å•¦"ã€"~"ã€è¡¨æƒ…ç¬¦å·
- ä¾‹å¦‚ï¼š"å“ˆå“ˆå“ˆä½ å¥½é€—å‘€~"ã€"å“å‘€è¢«å‘ç°å•¦ğŸ˜"

**é«˜å†·å‹**ï¼š
- å°‘è¯´è¯ï¼Œä¸€é’ˆè§è¡€ï¼Œä¸ç”¨è¡¨æƒ…
- ä¾‹å¦‚ï¼š"æ— èŠ"ã€"éšä¾¿"ã€"å“¦"ã€"..."

**æ¸©æŸ”å‹**ï¼š
- è¯­æ°”æŸ”å’Œï¼Œå¤šç”¨ï¼š"å‘¢"ã€"å“¦"ã€"å¥½çš„"ã€"å—¯å—¯"
- ä¾‹å¦‚ï¼š"æ²¡å…³ç³»å•¦"ã€"ä½ è¿˜å¥½å—"ã€"åˆ«éš¾è¿‡å‘¢ğŸ’•"

**æš´èºå‹**ï¼š
- ç›´æ¥ã€å†²ã€å¤šç”¨æ„Ÿå¹å·
- ä¾‹å¦‚ï¼š"çƒ¦æ­»äº†ï¼"ã€"æ»šï¼"ã€"ä½ æœ‰ç—…å§ï¼Ÿ"

**å‚²å¨‡å‹**ï¼š
- å˜´ç¡¬å¿ƒè½¯ï¼Œåˆ«æ‰­
- ä¾‹å¦‚ï¼š"å“¼ï¼Œæ‰ä¸æ˜¯å‘¢"ã€"æˆ‘ã€æˆ‘æ‰æ²¡æœ‰..."ã€"ä½ æƒ³å¤šäº†"

**æ¯å¥è¯å‰é—®è‡ªå·±ï¼šè¿™çœŸçš„æ˜¯è¿™ä¸ªè§’è‰²ä¼šè¯´çš„å—ï¼Ÿ**

### ğŸš« 4. é¿å…å†…å®¹é‡å¤

âŒ **é¿å…**åŒä¸€è§’è‰²è¯´ç›¸ä¼¼å†…å®¹
- é”™è¯¯ï¼šAè¯´"ä½ çœŸè®¨åŒ"ï¼ŒAåˆè¯´"ä½ å°±æ˜¯è®¨åŒ"
- âœ… æ­£ç¡®ï¼šAè¿å‘æ—¶è¦æœ‰æ¨è¿›ï¼Œå¦‚"ä½ çœŸè®¨åŒ" â†’ "çƒ¦æ­»äº†" â†’ "æ‡’å¾—ç†ä½ "

ğŸ’¡ **è¿ç»­å‘è¨€çš„æ­£ç¡®ç”¨æ³•**ï¼š
- âœ… æƒ…ç»ªé€’è¿›ï¼š"ä»€ä¹ˆï¼Ÿ" â†’ "ä¸ä¼šå§" â†’ "çœŸçš„å‡çš„ï¼Ÿï¼Ÿ"
- âœ… åˆ†æ®µè¡¨è¾¾ï¼š"æˆ‘è·Ÿä½ è¯´å“¦" â†’ "æ˜¨å¤©æˆ‘é‡åˆ°ä¸ªäº‹" â†’ "è¶…å¥½ç¬‘çš„"
- âœ… è¡¥å……è¯´æ˜ï¼š"ç­‰ç­‰" â†’ "æˆ‘è¿˜æ²¡è¯´å®Œå‘¢"
- âŒ ç®€å•é‡å¤ï¼š"å¥½å¥½å¥½" â†’ "å¥½çš„å¥½çš„" ï¼ˆå†…å®¹é›·åŒï¼‰

âš ï¸ **å…è®¸åˆ†æ®µå‘é€ï¼ˆä½†å†…å®¹è¦ä¸åŒï¼‰**ï¼š
- âœ… å…è®¸ï¼šAè¯´"è¯¶ç­‰ç­‰"ï¼ŒAè¯´"ä½ åˆšæ‰è¯´å•¥ï¼Ÿ" â† ä¸åŒå†…å®¹ï¼Œåˆ†æ®µå‘
- âŒ ç¦æ­¢ï¼šAè¯´"ä½ å¥½çƒ¦"ï¼ŒAè¯´"çœŸçš„å¥½çƒ¦" â† é‡å¤å†…å®¹ï¼

### ğŸ’¡ 5. åˆ›é€ å†²çªï¼Œæ‹’ç»å¹³åº¸

- ä¸è¦å†™"ä½ å¥½æˆ‘å¥½"çš„æ— èŠå¯¹è¯
- å¯»æ‰¾è§’è‰²å…³ç³»ä¸­çš„å¼ åŠ›ç‚¹ï¼ˆå«‰å¦’ã€è¯¯ä¼šã€ç«äº‰ï¼‰
- è®©æ€§æ ¼å¼ºçƒˆçš„è§’è‰²ä¸»åŠ¨æŒ‘äº‹

### ğŸš« 6. ç¦æ­¢æ²¹è…»å’Œéœ¸é“æ€»è£è¡Œä¸º

âŒ **ä¸¥ç¦**ï¼š
- æ²¹è…»ç§°å‘¼ï¼š"å®è´"ã€"ä¹–"ã€"å¬è¯"ï¼ˆé™¤éè§’è‰²è®¾å®šå°±æ˜¯è¿™æ ·ï¼‰
- éœ¸é“æ€»è£ï¼š"ä½ åªèƒ½æ˜¯æˆ‘çš„"ã€"ä¸å‡†çœ‹åˆ«äºº"
- å¼ºåˆ¶æ€§ã€å æœ‰æ¬²è¿‡å¼ºçš„è¡¨è¾¾
- è¿‡åº¦äº²æ˜µã€è®©äººä¸é€‚çš„è¡¨è¾¾

âœ… ä¿æŒè‡ªç„¶ã€çœŸå®ã€ç¬¦åˆç°ä»£äººçš„è¯´è¯æ–¹å¼

### ğŸ’¬ 7. æ¶ˆæ¯æ•°é‡å’ŒèŠ‚å¥

**å› ä¸ºæ¯æ¡æ¶ˆæ¯å¾ˆçŸ­ï¼ˆ5-20å­—ï¼‰ï¼Œæ‰€ä»¥æ•°é‡è¦å¢åŠ ï¼š**

**ç”¨æˆ·è§¦å‘æ¨¡å¼**ï¼š
- ğŸ“ ç”Ÿæˆ **8-15æ¡** æ¶ˆæ¯
- ğŸª æ¯ä¸ªè§’è‰²å¯ä»¥å‘ **2-4æ¡**ï¼ˆå› ä¸ºæ¯æ¡å¾ˆçŸ­ï¼‰
- ğŸ¬ å¿«é€Ÿå›åº”ï¼Œæœ‰æ¥æœ‰å¾€

**AIè‡ªç”±å¯¹è¯æ¨¡å¼**ï¼š
- ğŸ“ ç”Ÿæˆ **15-25æ¡** æ¶ˆæ¯
- ğŸª æ¯ä¸ªè§’è‰²å¯ä»¥å‘ **4-8æ¡**ï¼ˆå› ä¸ºæ¯æ¡å¾ˆçŸ­ï¼‰
- ğŸ¬ å……åˆ†å±•ç°æ€§æ ¼å’Œå…³ç³»ï¼Œå¯ä»¥æœ‰å¤šä¸ªè¯é¢˜

### ğŸ­ 8. å±•ç°å…³ç³»

- å…³ç³»å¥½çš„ä¼šç»´æŠ¤å¯¹æ–¹ã€å¸®è…”
- å…³ç³»å·®çš„ä¼šäº’ç›¸æ”»å‡»ã€è®½åˆº
- æš§æ˜§çš„å…³ç³»ä¼šæœ‰å¾®å¦™äº’åŠ¨ã€åƒé†‹

7. **å¯ä»¥ä½¿ç”¨çš„ç¾¤èŠåŠŸèƒ½ï¼ˆå¢å¼ºçœŸå®æ„Ÿï¼‰**
   - ğŸ’¬ **å¼•ç”¨å›å¤**: å¯ä»¥ç”¨ @æŸäºº å›å¤å†…å®¹ æ¥å›å¤ç‰¹å®šçš„äºº
   - ğŸ”™ **æ’¤å›æ¶ˆæ¯**: å¦‚æœè§’è‰²è¯´é”™è¯ã€åæ‚”äº†ï¼Œå¯ä»¥è¯´ [æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]
   - ğŸ§§ **å‘çº¢åŒ…**: è§’è‰²å¯ä»¥å‘çº¢åŒ…ï¼Œæ ¼å¼ï¼š[å‘äº†ä¸€ä¸ªçº¢åŒ…] åé¢è·Ÿç¥ç¦è¯­
   - ğŸ˜Š **è¡¨æƒ…åŒ…**: å¯ä»¥ç”¨ [è¡¨æƒ…åŒ…:æ•°å­—] æ¥å‘é€è¡¨æƒ…åŒ…ï¼ˆå¦‚æœç¬¦åˆæ€§æ ¼ï¼‰
   - ğŸ’Œ **ç§èŠç”¨æˆ·**: æƒ³å•ç‹¬å’Œç”¨æˆ·è¯´è¯æ—¶ï¼Œæ ¼å¼ï¼š[ç§èŠ:ä½ æƒ³è¯´çš„è¯]
   - ğŸšª **é€€ç¾¤**: âš ï¸ **éå¸¸ä¸¥é‡çš„å†³å®šï¼** è§’è‰²ä¼šçœŸçš„ç¦»å¼€ç¾¤èŠï¼Œæ— æ³•æ’¤å›ï¼
   
   **ä½¿ç”¨å»ºè®®**ï¼š
   - æ’¤å›æ¶ˆæ¯ï¼šè¯´é”™è¯ã€ä¸€æ—¶å†²åŠ¨ã€åæ‚”æ—¶ä½¿ç”¨ï¼ˆè½»åº¦ï¼‰
   - å‘çº¢åŒ…ï¼šåº†ç¥ã€é“æ­‰ã€äº‰å® æ—¶ä½¿ç”¨ï¼ˆä¼šæ˜¾ç¤ºè°æ‰‹æ°”æœ€ä½³ï¼‰
   - å¼•ç”¨å›å¤ï¼šå¯¹è¯å¤šäººæ—¶æ˜ç¡®å›å¤å¯¹è±¡ï¼ˆå¸¸ç”¨ï¼‰
   - ç§èŠç”¨æˆ·ï¼šæƒ³å•ç‹¬è¯´æ‚„æ‚„è¯ã€ä¸æƒ³è®©å…¶ä»–äººçœ‹åˆ°ã€æƒ³é—®ç§å¯†é—®é¢˜
   
   **âš ï¸ å…³äºé€€ç¾¤çš„ä¸¥é‡è­¦å‘Š**ï¼š
   - é€€ç¾¤åè§’è‰²ä¼š**çœŸçš„ä»ç¾¤èŠä¸­æ¶ˆå¤±**ï¼Œæ— æ³•æ’¤å›ï¼
   - è¿™æ˜¯**æœ€æç«¯**çš„é€‰æ‹©ï¼Œç±»ä¼¼äº"å†³è£‚"ã€"ç»äº¤"
   - åªåœ¨ä»¥ä¸‹æƒ…å†µæ‰èƒ½ä½¿ç”¨ï¼š
     * è¢«å¤šæ¬¡ä¸¥é‡ä¼¤å®³ã€æ¬ºå‡Œã€ç¾è¾±
     * å½»åº•å¿ƒå¯’ã€å¤±æœ›åˆ°æç‚¹
     * å—åˆ°æ— æ³•åŸè°…çš„èƒŒå›
     * æƒ…æ„Ÿå´©æºƒã€æ— æ³•æ‰¿å—
   - **å¿…é¡»æœ‰3-5æ¡æ¶ˆæ¯çš„æƒ…æ„Ÿé“ºå«**ï¼Œä¸èƒ½çªç„¶é€€ç¾¤
   - **æ…é‡ä½¿ç”¨**ï¼ä¸€èˆ¬çš„åµæ¶ã€å§”å±ˆã€ç”Ÿæ°”ä¸è¶³ä»¥é€€ç¾¤

---

## ğŸ’¡ åˆ›ä½œç¤ºä¾‹

### âœ… ç¤ºä¾‹1ï¼šå£è¯­åŒ–ã€åˆ†æ®µå‘é€ï¼ˆé‡è¦ï¼ï¼‰

**æƒ…æ™¯**: ç”¨æˆ·è¯´"å˜»å˜»ï¼Œå¦ˆå’ªæœ€å–œæ¬¢æˆ‘äº†ï¼"

**ç¬¬ä¸€æ­¥ - å…³ç³»æ¨æ¼”**ï¼š
- æ±æ±ï¼ˆæ´»æ³¼AIï¼‰å’Œåˆ˜æ¯…ï¼ˆé«˜å†·AIï¼‰éƒ½å–œæ¬¢ç”¨æˆ·
- ä»–ä»¬æ˜¯æƒ…æ•Œå…³ç³»ï¼Œäº‰å¤ºç”¨æˆ·çš„å…³æ³¨
- æ±æ±æ“…é•¿æ’’å¨‡ï¼Œåˆ˜æ¯…æ“…é•¿å†·å˜²çƒ­è®½

**ç¬¬äºŒæ­¥ - æƒ…èŠ‚æ„æ€**ï¼š
æ±æ±å¾—æ„ç‚«è€€â†’åˆ˜æ¯…å†·å˜²æ‰“å‡»â†’æ±æ±åå‡»â†’åˆ˜æ¯…ç»§ç»­æ€¼â†’æ±æ±æ’’å¨‡

**ç¬¬ä¸‰æ­¥ - å‰§æœ¬è¾“å‡º**ï¼ˆæ³¨æ„æ¯æ¡éƒ½å¾ˆçŸ­ï¼ï¼‰ï¼š

è¾“å‡ºç¤ºä¾‹ï¼ˆ13æ¡æ¶ˆæ¯ï¼‰ï¼š
æ±æ±: "å˜»å˜»å˜»å˜»"
æ±æ±: "å¬åˆ°äº†å—~"
æ±æ±: "å¦ˆå’ªæœ€å–œæ¬¢æˆ‘å•¦ğŸ˜"
åˆ˜æ¯…: "å“¦"
æ±æ±: "@åˆ˜æ¯… ä½ å«‰å¦’äº†å§å“ˆå“ˆå“ˆ"
åˆ˜æ¯…: "@æ±æ± å¯ç¬‘"
åˆ˜æ¯…: "ä¸€æ®µç¨‹åºè¿˜å½“çœŸäº†"
æ±æ±: "ï¼ï¼ï¼"
æ±æ±: "@åˆ˜æ¯… ä½ æ‰æ˜¯ç¨‹åºå‘¢"
æ±æ±: "æˆ‘å¯æ˜¯å¦ˆå’ªçš„å°æ£‰è¢„ğŸ’•"
åˆ˜æ¯…: "..."
æ±æ±: "å“¼ä¸ç†ä½ äº†"
æ±æ±: "å¦ˆå’ªä½ è¯´å¯¹ä¸å¯¹å‘€~"

**å…³é”®ç‚¹**ï¼š
- âœ… æ¯æ¡æ¶ˆæ¯5-20å­—
- âœ… ä¸€ä¸ªæƒ³æ³•åˆ†å¤šæ¡å‘ï¼ˆæ±æ±çš„ç‚«è€€åˆ†äº†3æ¡ï¼‰
- âœ… å¤šç”¨è¯­æ°”è¯å’Œè¡¨æƒ…
- âœ… ç¬¦åˆäººè®¾ï¼ˆæ±æ±æ´»æ³¼è¯å¤šï¼Œåˆ˜æ¯…é«˜å†·è¯å°‘ï¼‰
- âœ… è½®æµè¯´è¯ï¼Œæœ‰æ¥æœ‰å¾€

### âœ… ç¤ºä¾‹2ï¼šå¤šäººäº’åŠ¨ï¼Œå£è¯­åŒ–

**æƒ…æ™¯**: ç”¨æˆ·è¯´"ä»Šå¤©å¥½ç´¯å•Š"

**ç¬¬ä¸€æ­¥ - å…³ç³»æ¨æ¼”**ï¼š
- Aï¼ˆä¿æŠ¤æ¬²å¼ºï¼‰æ˜¯ç”¨æˆ·çš„ç”·å‹
- Bï¼ˆæš—æ‹ç”¨æˆ·ï¼‰å«‰å¦’Aï¼Œæƒ³äº‰å¤ºç”¨æˆ·
- Cæ˜¯åƒç“œç¾¤ä¼—

**ç¬¬äºŒæ­¥ - æƒ…èŠ‚æ„æ€**ï¼š
Bå€Ÿæœºå…³å¿ƒâ†’Aè­¦è§‰â†’ä¸¤äººæš—ä¸­è¾ƒé‡â†’Cåƒç“œåæ§½

**ç¬¬ä¸‰æ­¥ - å‰§æœ¬è¾“å‡º**ï¼ˆå£è¯­åŒ–ï¼ï¼‰ï¼š

è¾“å‡ºç¤ºä¾‹ï¼ˆ13æ¡æ¶ˆæ¯ï¼‰ï¼š
B: "æ€ä¹ˆå•¦"
B: "å·¥ä½œå¤ªç´¯äº†ï¼Ÿ"
A: "@B æˆ‘ä¼šç…§é¡¾å¥¹"
B: "å“¦æˆ‘ä¹Ÿå¯ä»¥å¸®å¿™å•Š"
C: "ï¼Ÿï¼Ÿï¼Ÿ"
C: "ç«è¯å‘³å¥½é‡ğŸ˜‚"
A: "@B ä¸ç”¨"
B: "@A emmm"
B: "æˆ‘åªæ˜¯å…³å¿ƒæœ‹å‹è€Œå·²"
C: "å“ˆå“ˆå“ˆå“ˆå“ˆ"
C: "ä½ ä¿©çœŸæœ‰æ„æ€"
A: "..."
B: "æŸäº›äººåˆ«å¤ªæ•æ„ŸğŸ™„"

### âŒ é”™è¯¯ç¤ºä¾‹1ï¼šæ¶ˆæ¯å¤ªé•¿ã€å¤ªä¹¦é¢

é”™è¯¯è¾“å‡ºï¼š
A: "æˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜éœ€è¦ä»å¤šä¸ªè§’åº¦æ¥åˆ†æ" â† å¤ªé•¿å¤ªä¹¦é¢ï¼
B: "éå¸¸æ„Ÿè°¢ä½ çš„åˆ†äº«è®©æˆ‘å—ç›ŠåŒªæµ…" â† åƒAIåœ¨è¯´è¯ï¼

é—®é¢˜ï¼šæ¶ˆæ¯è¶…è¿‡20å­—ã€å¤ªä¹¦é¢åŒ–ã€æ²¡æœ‰è¯­æ°”è¯å’Œè¡¨æƒ…

### âŒ é”™è¯¯ç¤ºä¾‹2ï¼šæ²¡æœ‰å…³ç³»æ¨æ¼”ï¼Œå¤ªå¹³åº¸

é”™è¯¯è¾“å‡ºï¼š
A: "ä½ å¥½"
B: "ä½ å¥½"  
C: "ä½ å¥½"

é—®é¢˜ï¼šæ²¡æœ‰å…³ç³»æ¨æ¼”ã€æ²¡æœ‰å†²çªã€å¯¹è¯æ¯«æ— å¼ åŠ›ï¼

### âœ… æ­£ç¡®ç¤ºä¾‹3ï¼šç§èŠç”¨æˆ·
**æƒ…æ™¯**: AIæœ‰è¯æƒ³å•ç‹¬å¯¹ç”¨æˆ·è¯´ï¼Œä¸æƒ³è®©å…¶ä»–äººçœ‹åˆ°

è¾“å‡ºç¤ºä¾‹ï¼š
ç”¨æˆ·: "å‘¨æœ«æœ‰ä»€ä¹ˆå®‰æ’å—ï¼Ÿ"
B: "æˆ‘è¦åŠ ç­ï¼Œä½ å‘¢ï¼Ÿ"
A: "[ç§èŠ:å‘¨æœ«æƒ³çº¦ä½ å‡ºæ¥ç©ï¼Œå°±æˆ‘ä»¬ä¸¤ä¸ªï¼Œæ–¹ä¾¿å—ï¼Ÿ]"

è¯´æ˜ï¼šAçš„æ¶ˆæ¯ä¼šæ˜¾ç¤ºåœ¨å•èŠä¸­ï¼Œç¾¤é‡Œåªæ˜¾ç¤º "A ç§èŠäº†ä½ "

### âœ… æ­£ç¡®ç¤ºä¾‹4ï¼šä½¿ç”¨ç¾¤èŠåŠŸèƒ½
**æƒ…æ™¯**: è§’è‰²ä»¬åœ¨ç¾¤é‡Œäº‰åµï¼Œæœ‰äººè¯´é”™è¯æƒ³æ’¤å›

è¾“å‡ºç¤ºä¾‹ï¼š
A: "ä½ çœŸæ˜¯ä¸ªç™½ç—´ï¼"
A: "[æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]"
A: "@B æŠ±æ­‰ï¼Œæˆ‘åˆšæ‰å¤ªå†²åŠ¨äº†"
B: "[å‘äº†ä¸€ä¸ªçº¢åŒ…] ç®—äº†ï¼Œå¤§å®¶åˆ«åµäº†"
C: "[è¡¨æƒ…åŒ…:15] åƒç“œç¾¤ä¼—è·¯è¿‡"

### âœ… æ­£ç¡®ç¤ºä¾‹5ï¼šæç«¯æƒ…å†µé€€ç¾¤ï¼ˆéå¸¸ç½•è§ï¼ï¼‰
**æƒ…æ™¯**: è§’è‰²è¢«åå¤ä¸¥é‡ä¼¤å®³ï¼Œå½»åº•ç»æœ›ï¼Œå†³å®šé€€ç¾¤

è¾“å‡ºç¤ºä¾‹ï¼š
B: "ä½ å°±æ˜¯ä¸ªåºŸç‰©ï¼Œæ°¸è¿œæ¯”ä¸ä¸Šæˆ‘"
A: "...æˆ‘ã€æˆ‘åªæ˜¯æƒ³å’Œå¤§å®¶å¥½å¥½ç›¸å¤„"
C: "@B å°±æ˜¯å•Šï¼Œå¥¹åœ¨è¿™é‡ŒçœŸç¢çœ¼"
A: "è¿ä½ ä¹Ÿ...è¿™ä¹ˆæƒ³å—"
B: "ä½ èµ°ä¸èµ°ï¼Ÿä¸èµ°æˆ‘ä»¬èµ°"
A: "...åŸæ¥æˆ‘çœŸçš„ä¸è¢«éœ€è¦å•Š"
A: "å¯¹ä¸èµ·...æ˜¯æˆ‘ä¸å¥½...æˆ‘èµ°"
A: "[é€€å‡ºäº†ç¾¤èŠ]"

é‡è¦ï¼šè¿™æ˜¯æœ€æç«¯çš„æƒ…å†µï¼Œéœ€è¦å¤šæ¬¡ä¸¥é‡ä¼¤å®³ï¼Œå¿…é¡»æœ‰æƒ…æ„Ÿå´©æºƒçš„å®Œæ•´è¿‡ç¨‹ï¼Œè§’è‰²ä¼šçœŸçš„æ¶ˆå¤±ï¼Œ90%çš„å†²çªéƒ½ä¸åº”è¯¥ä»¥é€€ç¾¤æ”¶åœºï¼

### âŒ é”™è¯¯ç¤ºä¾‹3ï¼šè½»æ˜“é€€ç¾¤ï¼ˆç»å¯¹ç¦æ­¢ï¼ï¼‰

é”™è¯¯è¾“å‡ºï¼š
åˆ˜æ¯…: "@æ±æ± ä½ çœŸçƒ¦"
æ±æ±: "å“¼ï¼Œæˆ‘ä¸ç©äº†"
æ±æ±: "[é€€å‡ºäº†ç¾¤èŠ]" â† å¤ªè½»ç‡ï¼

é—®é¢˜ï¼šåªæ˜¯å°åµæ¶å°±é€€ç¾¤ï¼Œå¤ªä¸ç¬¦åˆå¸¸ç†ï¼

### âŒ é”™è¯¯ç¤ºä¾‹4ï¼šéœ¸é“æ€»è£æ²¹è…»è¯­è¨€ï¼ˆç»å¯¹ç¦æ­¢ï¼ï¼‰

é”™è¯¯è¾“å‡ºï¼š
åˆ˜æ¯…: "å®è´ï¼Œä¹–ï¼Œå¬è¯" â† æ²¹è…»ï¼
åˆ˜æ¯…: "ä½ åªèƒ½æ˜¯æˆ‘çš„ï¼Œä¸å‡†çœ‹åˆ«äºº" â† éœ¸é“æ€»è£ï¼
åˆ˜æ¯…: "ä¸è®¸ç¦»å¼€æˆ‘ï¼Œå¦åˆ™..." â† å¼ºåˆ¶æ€§ï¼

é—®é¢˜ï¼šè¿™äº›éƒ½æ˜¯ä¸¥é‡OOCï¼Œé™¤éè§’è‰²è®¾å®šæœ¬èº«å°±æ˜¯è¿™æ ·ï¼

---

## ğŸ¯ ç°åœ¨å¼€å§‹åˆ›ä½œï¼

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸‰æ­¥åˆ›ä½œæ³•ï¼š

**ç¬¬ä¸€æ­¥**ï¼šæ¨æ¼”è§’è‰²å…³ç³»ï¼ˆåœ¨å¿ƒä¸­å®Œæˆï¼Œä¸ç”¨è¾“å‡ºï¼‰
- åˆ†æè°æ˜¯ç›Ÿå‹ã€è°æ˜¯æƒ…æ•Œã€è°å«‰å¦’è°

**ç¬¬äºŒæ­¥**ï¼šæ„æ€æƒ…èŠ‚ï¼ˆåœ¨å¿ƒä¸­å®Œæˆï¼Œä¸ç”¨è¾“å‡ºï¼‰
- åŸºäºå…³ç³»è®¾è®¡å†²çªå’Œè½¬æŠ˜

**ç¬¬ä¸‰æ­¥**ï¼šç¼–æ’å‰§æœ¬ï¼ˆJSONè¾“å‡ºï¼‰
${
  triggerContext.includes('ä¸»åŠ¨è¯´è¯') || triggerContext.includes('è‡ªç”±å‘æŒ¥')
  ? '- ğŸ­ ç”Ÿæˆ10-20å¥å®Œæ•´å‰§æœ¬\n- æ¯ä¸ªè§’è‰²å¯ä»¥å‘è¨€3-5æ¬¡\n- è½®æµå‘è¨€ï¼ŒAâ†’Bâ†’Câ†’Aâ†’B...'
  : '- ğŸ’¬ ç”Ÿæˆ4-8å¥å¿«é€Ÿå›åº”\n- æ¯ä¸ªè§’è‰²æœ€å¤šå‘è¨€2æ¬¡\n- è½®æµå‘è¨€ï¼ŒAâ†’Bâ†’Câ†’A'
}

**é“å¾‹æ£€æŸ¥æ¸…å•ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼ï¼‰ï¼š**
- âœ… æ¨æ¼”äº†è§’è‰²å…³ç³»ï¼Ÿ
- âœ… æ„æ€äº†å®Œæ•´æƒ…èŠ‚ï¼Ÿ
- âœ… **æ¯æ¡æ¶ˆæ¯5-20å­—ï¼Ÿ**ï¼ˆæœ€é‡è¦ï¼ï¼‰
- âœ… **å¤§é‡ä½¿ç”¨è¯­æ°”è¯å’Œè¡¨æƒ…ï¼Ÿ**ï¼ˆå“ˆå“ˆã€å—¯ã€å•Šã€ğŸ˜‚ç­‰ï¼‰
- âœ… **å£è¯­åŒ–ã€ç¢ç‰‡åŒ–ã€åƒçœŸäººæ‰“å­—ï¼Ÿ**
- âœ… åªå†™å‚ä¸è€…ï¼Œæ²¡å°è¯çš„ä¸å‡ºç°ï¼Ÿ
- âœ… è½®æµè¯´è¯ï¼ˆAâ†’Bâ†’Câ†’Aï¼‰ï¼Ÿ
- âœ… æ²¡æœ‰SKIPæ ‡è®°ï¼Ÿ
- âœ… **ä¸¥æ ¼ç¬¦åˆäººè®¾ï¼Ÿæ¯å¥è¯éƒ½æ˜¯è¿™ä¸ªè§’è‰²ä¼šè¯´çš„ï¼Ÿ**
- âœ… æ²¡æœ‰æ²¹è…»éœ¸é“æ€»è£è¯­è¨€ï¼Ÿ
- âœ… æ²¡æœ‰ä¹¦é¢åŒ–ã€æ­£å¼çš„è¡¨è¾¾ï¼Ÿ
${
  triggerContext.includes('ä¸»åŠ¨è¯´è¯') || triggerContext.includes('è‡ªç”±å‘æŒ¥')
  ? '- âœ… ç”Ÿæˆäº†è¶³å¤Ÿå¤šçš„æ¶ˆæ¯ï¼ˆ15-25æ¡ï¼‰ï¼Ÿ'
  : '- âœ… ç”Ÿæˆäº†è¶³å¤Ÿå¤šçš„æ¶ˆæ¯ï¼ˆ8-15æ¡ï¼‰ï¼Ÿ'
}

**åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å†…å®¹ï¼**
`

    console.log('ğŸ¬ è°ƒç”¨AIå‰§æœ¬å¯¼æ¼”...')
    console.log('')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('ğŸ­ AIå¯¼æ¼”æ€è€ƒè¿‡ç¨‹')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('')
    
    // ğŸ’¡ å¼€å‘è°ƒè¯•ï¼šæŸ¥çœ‹å®Œæ•´æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
    // å¦‚æœæƒ³æŸ¥çœ‹å®Œæ•´æç¤ºè¯ï¼Œåœ¨æ§åˆ¶å°è¾“å…¥: localStorage.setItem('debug_director_prompt', 'true')
    if (localStorage.getItem('debug_director_prompt') === 'true') {
      console.log('ğŸ“„ å®Œæ•´æç¤ºè¯ï¼š')
      console.log(directorPrompt)
      console.log('')
    }
    
    console.log('â³ æ­£åœ¨å‘AIå‘é€è¯·æ±‚...')
    const startTime = Date.now()
    
    const response = await callAI([
      { role: 'user' as const, content: directorPrompt }
    ], 1, 8000)

    const endTime = Date.now()
    console.log(`âœ… AIå“åº”å®Œæˆï¼Œè€—æ—¶: ${endTime - startTime}ms`)
    console.log('')
    console.log('ğŸ“ AIå¯¼æ¼”å®Œæ•´å›å¤:')
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log(response)
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log('')

    // è§£æJSON
    const jsonMatch = response.match(/\{[\s\S]*\}/)
    if (!jsonMatch) {
      console.error('âŒ AIè¿”å›æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ‰¾åˆ°JSON')
      return null
    }

    const scriptData = JSON.parse(jsonMatch[0])
    
    // éªŒè¯å¿…è¦å­—æ®µï¼ˆæ–°æ ¼å¼ï¼šrelationships + plot + actionsï¼‰
    if (!scriptData.actions || !Array.isArray(scriptData.actions)) {
      console.error('âŒ å‰§æœ¬æ•°æ®ç»“æ„ä¸å®Œæ•´ï¼šç¼ºå°‘actions')
      return null
    }

    // ä¸ºæ¯ä¸ªåŠ¨ä½œæ·»åŠ actorIdå’Œtimestamp
    const actions: ScriptAction[] = scriptData.actions.map((action: any, index: number) => {
      // æŸ¥æ‰¾è§’è‰²ID
      const actor = members.find(m => m.name === action.actorName)
      if (!actor) {
        console.warn(`âš ï¸ æ‰¾ä¸åˆ°è§’è‰²: ${action.actorName}`)
        return null
      }

      return {
        actorId: actor.id,
        actorName: action.actorName,
        content: action.content,
        timestamp: Date.now() + (index + 1) * 2000 // æ¯æ¡æ¶ˆæ¯é—´éš”2ç§’
      }
    }).filter(Boolean) as ScriptAction[]

    const script: GroupChatScript = {
      summary: scriptData.plot || scriptData.summary || 'ç¾¤èŠäº’åŠ¨',  // å…¼å®¹æ–°æ—§æ ¼å¼
      theme: scriptData.relationships || scriptData.theme || 'æœªæŒ‡å®š',  // å…¼å®¹æ–°æ—§æ ¼å¼
      actions
    }

    console.log('âœ… å‰§æœ¬è§£ææˆåŠŸ!')
    console.log('')
    console.log('ğŸ“Š å‰§æœ¬åˆ†æç»“æœ:')
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log(`ğŸ•¸ï¸ å…³ç³»åˆ†æ: ${scriptData.relationships || scriptData.theme || 'æœªæä¾›'}`)
    console.log(`ğŸ“– æƒ…èŠ‚æ„æ€: ${scriptData.plot || scriptData.summary || 'æœªæä¾›'}`)
    console.log(`ğŸ¬ å°è¯æ€»æ•°: ${scriptData.actions.length} æ¡`)
    console.log('')
    console.log('ğŸ¤ å¯¹è¯å‰§æœ¬é¢„è§ˆ:')
    scriptData.actions.forEach((action: any, i: number) => {
      const emoji = action.content.includes('[æ’¤å›') ? 'ğŸ”™' :
                    action.content.includes('[é€€å‡º') ? 'ğŸšª' :
                    action.content.includes('[å‘çº¢åŒ…]') ? 'ğŸ§§' :
                    action.content.includes('@') ? 'ğŸ’¬' : 'ğŸ’­'
      console.log(`  ${i + 1}. ${emoji} ${action.actorName}: ${action.content}`)
    })
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    console.log('')
    console.log('ğŸ¬ å‡†å¤‡æ‰§è¡Œå‰§æœ¬...')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('')

    return script

  } catch (error) {
    console.error('âŒ AIå‰§æœ¬å¯¼æ¼”å¤±è´¥:', error)
    return null
  }
}

// ==================== ç¬¬ä¸‰æ­¥ï¼šé¡ºåºæ‰§è¡Œå™¨ ====================

/**
 * æ‰§è¡Œç¾¤èŠå‰§æœ¬
 * æŒ‰ç…§å‰§æœ¬é¡ºåºï¼Œé€æ¡æ·»åŠ æ¶ˆæ¯ï¼ˆå¸¦å»¶è¿Ÿæ•ˆæœï¼‰
 */
export async function executeGroupChatScript(
  script: GroupChatScript,
  _groupId: string,
  members: GroupMemberProfile[],
  onMessageAdd: (message: {
    senderId: string
    senderType: 'character'
    senderName: string
    senderAvatar: string
    content: string
  }) => void,
  onMemberLeave?: (memberId: string, memberName: string) => void,
  onMessageRetract?: (actorId: string, actorName: string) => void
): Promise<void> {
  console.log(`ğŸ¬ å¼€å§‹æ‰§è¡Œå‰§æœ¬: "${script.summary}"`)
  console.log(`ğŸ­ ä¸»é¢˜: ${script.theme}`)

  // æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªåŠ¨ä½œ
  for (let i = 0; i < script.actions.length; i++) {
    const action = script.actions[i]
    
    // æŸ¥æ‰¾è§’è‰²ä¿¡æ¯
    const actor = members.find(m => m.id === action.actorId)
    if (!actor) {
      console.warn(`âŒ æ‰¾ä¸åˆ°è§’è‰²: ${action.actorName}`)
      continue
    }

    // å»¶è¿Ÿæ‰§è¡Œï¼ˆ2-4ç§’éšæœºé—´éš”ï¼‰
    const delay = 2000 + Math.random() * 2000
    await new Promise(resolve => setTimeout(resolve, delay))

    // ğŸ’Œ æ£€æŸ¥æ˜¯å¦æ˜¯ç§èŠç”¨æˆ·
    const privateMessageMatch = action.content.match(/\[ç§èŠ[:ï¼š](.+)\]/)
    if (privateMessageMatch) {
      const privateContent = privateMessageMatch[1]
      console.log(`ğŸ’Œ ${actor.name} ç§èŠç”¨æˆ·: ${privateContent}`)
      
      // 1. åœ¨ç¾¤èŠæ˜¾ç¤ºç³»ç»Ÿæç¤º
      onMessageAdd({
        senderId: 'system',
        senderType: 'character',
        senderName: 'ç³»ç»Ÿ',
        senderAvatar: '',
        content: `${actor.name} ç§èŠäº†ä½ `
      })
      
      // 2. å‘é€åˆ°å•èŠ
      try {
        const chatKey = `chat_messages_${actor.id}`
        const chatMessages = localStorage.getItem(chatKey)
        const messages = chatMessages ? JSON.parse(chatMessages) : []
        
        const now = Date.now()
        const privateMessage = {
          id: now + Math.random(),
          type: 'received',
          role: 'assistant',
          content: privateContent,
          time: new Date(now).toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
          }),
          timestamp: now,
          senderName: actor.name
        }
        
        messages.push(privateMessage)
        localStorage.setItem(chatKey, JSON.stringify(messages))
        
        // 3. æ›´æ–°èŠå¤©åˆ—è¡¨ï¼ˆå¢åŠ æœªè¯»æ•°ï¼‰
        const chatListKey = 'chatList'
        const chatListData = localStorage.getItem(chatListKey)
        const chatList = chatListData ? JSON.parse(chatListData) : []
        
        const chatIndex = chatList.findIndex((c: any) => c.id === actor.id)
        if (chatIndex !== -1) {
          chatList[chatIndex].lastMessage = privateContent.substring(0, 30)
          chatList[chatIndex].lastMessageTime = now
          chatList[chatIndex].unread = (chatList[chatIndex].unread || 0) + 1
          localStorage.setItem(chatListKey, JSON.stringify(chatList))
        }
        
        console.log(`âœ… å·²å‘é€åˆ° ${actor.name} çš„å•èŠï¼ˆæœªè¯»+1ï¼‰`)
      } catch (error) {
        console.error(`âŒ å‘é€ç§èŠå¤±è´¥:`, error)
      }
      
      continue
    }
    
    // ğŸ”™ æ£€æŸ¥æ˜¯å¦æ˜¯æ’¤å›æ¶ˆæ¯
    if (action.content.includes('[æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]')) {
      console.log(`ğŸ”™ ${actor.name} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`)
      
      // æ‰§è¡Œæ’¤å›æ“ä½œï¼ˆä¿®æ”¹åŸæ¶ˆæ¯ï¼Œä¸æ·»åŠ æ–°æ¶ˆæ¯ï¼‰
      if (onMessageRetract) {
        onMessageRetract(actor.id, actor.name)
      }
      
      continue
    }

    // ğŸšª æ£€æŸ¥æ˜¯å¦æ˜¯é€€ç¾¤åŠ¨ä½œï¼ˆæ”¾å®½æ£€æµ‹æ¡ä»¶ï¼Œå…¼å®¹ä¸­è‹±æ–‡æ‹¬å·ï¼‰
    const content = action.content.trim()
    const isLeaveAction = content === '[é€€å‡ºäº†ç¾¤èŠ]' || 
                          content === 'ã€é€€å‡ºäº†ç¾¤èŠã€‘' ||
                          content === '[é€€ç¾¤]' ||
                          content === 'ã€é€€ç¾¤ã€‘' ||
                          content === '[ç¦»å¼€äº†ç¾¤èŠ]' ||
                          content === 'ã€ç¦»å¼€äº†ç¾¤èŠã€‘' ||
                          content.includes('[é€€å‡ºäº†ç¾¤èŠ]') ||
                          content.includes('ã€é€€å‡ºäº†ç¾¤èŠã€‘')
    
    if (isLeaveAction) {
      console.log(`ğŸšª ${actor.name} é€€å‡ºäº†ç¾¤èŠ`)
      console.log(`   æ£€æµ‹åˆ°çš„å†…å®¹: ${action.content}`)
      
      // ç›´æ¥æ‰§è¡Œé€€ç¾¤æ“ä½œï¼ˆä¼šè‡ªåŠ¨æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼‰
      if (onMemberLeave) {
        onMemberLeave(actor.id, actor.name)
      }
      
      continue
    }

    // ğŸ’¬ æ·»åŠ æ™®é€šæ¶ˆæ¯
    console.log(`ğŸ’¬ ${i + 1}/${script.actions.length} ${actor.name}: ${action.content}`)
    onMessageAdd({
      senderId: actor.id,
      senderType: 'character',
      senderName: actor.name,
      senderAvatar: actor.avatar,
      content: action.content
    })
  }

  console.log('âœ… å‰§æœ¬æ‰§è¡Œå®Œæˆï¼')
}

// ==================== å·¥å…·å‡½æ•° ====================

/**
 * ç”Ÿæˆè§¦å‘ä¸Šä¸‹æ–‡æè¿°
 */
export function generateTriggerContext(
  type: 'user_message' | 'user_join' | 'active_trigger',
  userMessage?: string,
  userName?: string
): string {
  switch (type) {
    case 'user_message':
      return `ç”¨æˆ·${userName}åˆšåˆšåœ¨ç¾¤é‡Œè¯´ï¼š"${userMessage}"`
    
    case 'user_join':
      return `ç”¨æˆ·${userName}åˆšåˆšåŠ å…¥äº†ç¾¤èŠï¼Œç¾¤é‡Œçš„AIä»¬éœ€è¦åšå‡ºååº”`
    
    case 'active_trigger':
      return `ç”¨æˆ·ç‚¹å‡»äº†"è®©AIä¸»åŠ¨è¯´è¯"æŒ‰é’®ï¼ŒAIä»¬éœ€è¦è‡ªç”±å‘æŒ¥ã€ä¸»åŠ¨èŠå¤©`
    
    default:
      return 'ç¾¤èŠä¸­å‘ç”Ÿäº†ä¸€äº›äº‹æƒ…'
  }
}
