import { useNavigate, useParams } from 'react-router-dom'
import { useState, useRef, useEffect } from 'react'
import { ImageIcon } from '../components/Icons'
import { useCharacter } from '../context/CharacterContext'
import { toPinyin } from '../utils/pinyin'

const EditCharacter = () => {
  const navigate = useNavigate()
  const { id } = useParams<{ id: string }>()
  const { getCharacter, updateCharacter } = useCharacter()
  const fileInputRef = useRef<HTMLInputElement>(null)

  const character = id ? getCharacter(id) : undefined

  const [formData, setFormData] = useState({
    name: character?.name || '',
    nickname: character?.nickname || '',
    username: character?.username || '',
    avatar: character?.avatar || '',
    signature: character?.signature || '',
    description: character?.description || ''
  })

  const [avatarPreview, setAvatarPreview] = useState(character?.avatar || '')
  const [isUploading, setIsUploading] = useState(false)

  useEffect(() => {
    if (character) {
      setFormData({
        name: character.name,
        nickname: character.nickname || '',
        username: character.username,
        avatar: character.avatar,
        signature: character.signature,
        description: character.description
      })
      setAvatarPreview(character.avatar)
    }
  }, [character])

  if (!character) {
    return (
      <div className="h-full flex items-center justify-center">
        <p className="text-gray-500">è§’è‰²ä¸å­˜åœ¨</p>
      </div>
    )
  }

  // å¤„ç†å¤´åƒä¸Šä¼ 
  const handleAvatarUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    if (!file.type.startsWith('image/')) {
      alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶')
      return
    }

    if (file.size > 5 * 1024 * 1024) {
      alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB')
      return
    }

    setIsUploading(true)

    const reader = new FileReader()
    reader.onloadend = async () => {
      const base64String = reader.result as string
      setAvatarPreview(base64String)
      setFormData({ ...formData, avatar: base64String })
      
      // ğŸ” è§¦å‘AIå¤´åƒè¯†å›¾å¹¶ç«‹å³ä¿å­˜
      if (character?.id) {
        try {
          console.log('ğŸ‘ï¸ å¼€å§‹è¯†åˆ«AIè§’è‰²å¤´åƒ...')
          const visionResponse = await fetch('/.netlify/functions/vision', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image: base64String,
              prompt: 'è¯¦ç»†æè¿°è¿™ä¸ªå¤´åƒçš„å†…å®¹ï¼ŒåŒ…æ‹¬ï¼šè§’è‰²ç‰¹å¾ã€é£æ ¼ã€é¢œè‰²ã€è¡¨æƒ…ã€æ°›å›´ç­‰ã€‚è¯·ç”¨ç®€æ´çš„è¯­è¨€æè¿°ã€‚'
            })
          })
          
          if (visionResponse.ok) {
            const visionData = await visionResponse.json()
            const avatarDescription = visionData.description || visionData.result
            
            // ç›´æ¥ä¿å­˜è¯†å›¾ç»“æœï¼ˆç¼–è¾‘æ—¶è§’è‰²IDå·²å­˜åœ¨ï¼‰
            localStorage.setItem(`character_avatar_description_${character.id}`, avatarDescription)
            localStorage.setItem(`character_avatar_recognized_at_${character.id}`, Date.now().toString())
            // ğŸ”‘ ä¿å­˜å¤´åƒæŒ‡çº¹ï¼ˆå‰200å­—ç¬¦ï¼‰ï¼Œç”¨äºæ£€æµ‹å¤´åƒæ˜¯å¦å˜åŒ–
            localStorage.setItem(`character_avatar_fingerprint_${character.id}`, base64String.substring(0, 200))
            console.log('âœ… AIè§’è‰²å¤´åƒè¯†åˆ«å®Œæˆ:', avatarDescription)
          } else {
            console.warn('âš ï¸ å¤´åƒè¯†åˆ«å¤±è´¥')
          }
        } catch (error) {
          console.error('âŒ å¤´åƒè¯†åˆ«å¼‚å¸¸:', error)
        }
      }
      
      setIsUploading(false)
    }
    reader.onerror = () => {
      alert('å›¾ç‰‡è¯»å–å¤±è´¥')
      setIsUploading(false)
    }
    reader.readAsDataURL(file)
  }

  // å¤„ç†åå­—å˜åŒ–ï¼Œè‡ªåŠ¨ç”Ÿæˆå¾®ä¿¡å·
  const handleNameChange = (name: string) => {
    setFormData(prev => {
      // å¦‚æœå¾®ä¿¡å·ä¸ºç©ºæˆ–è€…æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œåˆ™è‡ªåŠ¨æ›´æ–°
      const isAutoGenerated = !prev.username || prev.username.startsWith('wxid_')
      if (isAutoGenerated && name) {
        const pinyin = toPinyin(name)
        return {
          ...prev,
          name,
          username: `wxid_${pinyin || Date.now().toString().slice(-6)}`
        }
      }
      return { ...prev, name }
    })
  }

  const handleSave = () => {
    if (!formData.name.trim()) {
      alert('è¯·è¾“å…¥è§’è‰²åå­—')
      return
    }

    if (!formData.avatar) {
      alert('è¯·ä¸Šä¼ è§’è‰²å¤´åƒ')
      return
    }

    // å¦‚æœæ²¡æœ‰å¾®ä¿¡å·ï¼Œè‡ªåŠ¨ç”Ÿæˆ
    const username = formData.username || `wxid_${toPinyin(formData.name) || Date.now().toString().slice(-6)}`

    updateCharacter(character.id, {
      ...formData,
      username,
      signature: formData.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹',
      description: formData.description
    })
    navigate(`/character/${character.id}`)
  }

  return (
    <div className="h-full flex flex-col">
      {/* é¡¶éƒ¨æ ‡é¢˜æ  */}
      <div className="glass-effect px-4 py-3 flex items-center justify-between border-b border-gray-200/50">
        <button
          onClick={() => navigate(-1)}
          className="ios-button text-gray-700 hover:text-gray-900"
        >
          å–æ¶ˆ
        </button>
        <h1 className="text-base font-semibold text-gray-900">
          ç¼–è¾‘è§’è‰²
        </h1>
        <button
          onClick={handleSave}
          className="ios-button text-primary font-medium"
        >
          å®Œæˆ
        </button>
      </div>

      {/* ç¼–è¾‘è¡¨å• */}
      <div className="flex-1 overflow-y-auto hide-scrollbar px-3 pt-3">
        {/* ä¸Šä¼ å¤´åƒ */}
        <div className="mb-3">
          <div className="px-4 py-2">
            <span className="text-sm text-gray-600 font-medium">è§’è‰²å¤´åƒ</span>
            <p className="text-xs text-gray-400 mt-1">ç‚¹å‡»ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼Œæ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡ 5MB</p>
          </div>
          <div className="glass-card rounded-2xl p-6 flex justify-center">
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handleAvatarUpload}
              className="hidden"
            />
            <button
              onClick={() => fileInputRef.current?.click()}
              disabled={isUploading}
              className="relative w-32 h-32 rounded-2xl bg-gray-100 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center ios-button overflow-hidden"
            >
              {avatarPreview ? (
                <>
                  {avatarPreview.startsWith('data:image') ? (
                    <img
                      src={avatarPreview}
                      alt="å¤´åƒé¢„è§ˆ"
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <span className="text-5xl">{avatarPreview}</span>
                  )}
                  <div className="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all flex items-center justify-center">
                    <span className="text-white opacity-0 hover:opacity-100 text-sm">ç‚¹å‡»æ›´æ¢</span>
                  </div>
                </>
              ) : (
                <>
                  {isUploading ? (
                    <div className="text-gray-400">ä¸Šä¼ ä¸­...</div>
                  ) : (
                    <>
                      <ImageIcon size={32} className="text-gray-400 mb-2" />
                      <span className="text-sm text-gray-500">ä¸Šä¼ å¤´åƒ</span>
                    </>
                  )}
                </>
              )}
            </button>
          </div>
        </div>

        {/* åŸºæœ¬ä¿¡æ¯ */}
        <div className="mb-3">
          <div className="px-4 py-2">
            <span className="text-sm text-gray-600 font-medium">è§’è‰²ä¿¡æ¯</span>
          </div>
          <div className="glass-card rounded-2xl overflow-hidden">
            <div className="px-4 py-3 border-b border-gray-100">
              <label className="block text-xs text-gray-500 mb-1">çœŸå®åå­— *</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => handleNameChange(e.target.value)}
                placeholder="è¯·è¾“å…¥è§’è‰²çœŸå®åå­—"
                maxLength={20}
                className="w-full bg-transparent border-none outline-none text-gray-900 placeholder-gray-400"
              />
            </div>

            <div className="px-4 py-3 border-b border-gray-100">
              <label className="block text-xs text-gray-500 mb-1">
                ç½‘å
                <span className="text-gray-400 ml-2">ï¼ˆç•™ç©ºåˆ™æ˜¾ç¤ºçœŸå®åå­—ï¼ŒAIå¯ä¿®æ”¹ï¼‰</span>
              </label>
              <input
                type="text"
                value={formData.nickname}
                onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                placeholder="è§’è‰²çš„ç½‘å"
                maxLength={20}
                className="w-full bg-transparent border-none outline-none text-gray-900 placeholder-gray-400"
              />
            </div>

            <div className="px-4 py-3 border-b border-gray-100">
              <label className="block text-xs text-gray-500 mb-1">
                è§’è‰²IDè´¦å·
                <span className="text-gray-400 ml-2">ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰</span>
              </label>
              <input
                type="text"
                value={formData.username}
                onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                placeholder={`wxid_${toPinyin(formData.name) || 'auto'}`}
                className="w-full bg-transparent border-none outline-none text-gray-900 placeholder-gray-400"
              />
            </div>

            <div className="px-4 py-3 border-b border-gray-100">
              <label className="block text-xs text-gray-500 mb-1">ä¸ªæ€§ç­¾å</label>
              <textarea
                value={formData.signature}
                onChange={(e) => setFormData({ ...formData, signature: e.target.value })}
                placeholder="æ˜¾ç¤ºåœ¨ç”¨æˆ·èµ„æ–™çš„ä¸ªæ€§ç­¾å"
                maxLength={100}
                className="w-full h-16 bg-transparent border-none outline-none text-gray-900 placeholder-gray-400 resize-none"
              />
              <div className="text-right text-xs text-gray-400 mt-1">
                {(formData.signature || '').length}/100
              </div>
            </div>

            <div className="px-4 py-3">
              <label className="block text-xs text-gray-500 mb-1">AIè§’è‰²æè¿°</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="æè¿°AIè§’è‰²çš„èƒŒæ™¯ã€æ€§æ ¼ã€è¯´è¯é£æ ¼ç­‰ï¼Œç”¨äºAIè§’è‰²æ‰®æ¼”ï¼ˆå»ºè®®è¯¦ç»†æè¿°ï¼Œå­—æ•°è¶Šå¤šAIç†è§£è¶Šå‡†ç¡®ï¼‰"
                maxLength={5000}
                className="w-full h-48 bg-transparent border-none outline-none text-gray-900 placeholder-gray-400 resize-none"
              />
              <div className="text-right text-xs text-gray-400 mt-1">
                {(formData.description || '').length}/5000
              </div>
            </div>
          </div>
        </div>

        {/* æç¤ºä¿¡æ¯ */}
        <div className="glass-card rounded-2xl p-4 mb-6">
          <div className="text-xs text-gray-500 space-y-2">
            <p>ğŸ’¡ <strong>è§’è‰²åå­—ï¼š</strong>ç”¨äºæ˜¾ç¤ºåœ¨å¾®ä¿¡ç•Œé¢ä¸­</p>
            <p>ğŸ†” <strong>è§’è‰²IDï¼š</strong>å¦‚æœä¸å¡«å†™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®è§’è‰²åå­—çš„æ‹¼éŸ³ç”Ÿæˆ wxid_xxx æ ¼å¼çš„ID</p>
            <p>âœï¸ <strong>ä¸ªæ€§ç­¾åï¼š</strong>æ˜¾ç¤ºåœ¨ç”¨æˆ·èµ„æ–™é¡µçš„ç­¾åï¼Œå¯¹å¤–å±•ç¤º</p>
            <p>ğŸ¤– <strong>AIè§’è‰²æè¿°ï¼š</strong>æè¿°AIçš„èƒŒæ™¯ã€æ€§æ ¼ã€è¯´è¯æ–¹å¼ç­‰ï¼Œç”¨äºAIè§’è‰²æ‰®æ¼”ï¼ˆåç»­æ¥å…¥APIæ—¶ä½¿ç”¨ï¼‰</p>
            <p>ğŸ–¼ï¸ <strong>å¤´åƒï¼š</strong>æ”¯æŒæœ¬åœ°ä¸Šä¼ å›¾ç‰‡ï¼Œå»ºè®®ä½¿ç”¨æ­£æ–¹å½¢å›¾ç‰‡</p>
          </div>
        </div>
      </div>
    </div>
  )
}

export default EditCharacter

