import { useNavigate, useParams, useLocation } from 'react-router-dom'
import { useState, useEffect, useRef } from 'react'
import { BackIcon, MoreIcon, SendIcon, AddCircleIcon, EmojiIcon, ImageIcon } from '../components/Icons'
import StatusBar from '../components/StatusBar'
import { useSettings } from '../context/SettingsContext'
import { useCharacter } from '../context/CharacterContext'
import { useUser } from '../context/UserContext'
import { callAI } from '../utils/api'
import { buildRoleplayPrompt } from '../utils/prompts'
import ChatMenu from '../components/ChatMenu'
import RedEnvelopeSender from '../components/RedEnvelopeSender'
import RedEnvelopeDetail from '../components/RedEnvelopeDetail'
import RedEnvelopeCard from '../components/RedEnvelopeCard'
import { useRedEnvelope, generateRedEnvelopeId, RedEnvelope, isRedEnvelopeExpired } from '../context/RedEnvelopeContext'

interface Message {
  id: number
  type: 'received' | 'sent' | 'system'
  content: string
  time: string
  messageType?: 'text' | 'transfer' | 'system' | 'redenvelope'
  transfer?: {
    amount: number
    message: string
    status?: 'pending' | 'received' | 'expired'
  }
  redEnvelopeId?: string
  narrations?: {
    type: 'action' | 'thought'
    content: string
  }[]
}

const ChatDetail = () => {
  const navigate = useNavigate()
  const location = useLocation()
  const { id } = useParams()
  const [inputValue, setInputValue] = useState('')
  const [messages, setMessages] = useState<Message[]>(() => {
    // ä»localStorageè¯»å–èŠå¤©è®°å½•
    const saved = localStorage.getItem(`chat_messages_${id}`)
    return saved ? JSON.parse(saved) : []
  })
  const [isAiTyping, setIsAiTyping] = useState(false)
  const [showMenu, setShowMenu] = useState(false)
  const [chatBackground, setChatBackground] = useState(() => {
    // ä»localStorageè¯»å–èƒŒæ™¯è®¾ç½®
    const saved = localStorage.getItem(`chat_bg_${id}`)
    return saved || ''
  })
  
  // ä»localStorageè¯»å–å½“å‰èŠå¤©çš„æ—ç™½è®¾ç½®
  const [enableNarration, setEnableNarration] = useState(() => {
    const saved = localStorage.getItem(`narrator_enabled_${id}`)
    return saved === 'true'
  })
  
  const { showStatusBar } = useSettings()
  const { getCharacter } = useCharacter()
  const { currentUser } = useUser()
  const { getRedEnvelope, saveRedEnvelope, updateRedEnvelope, getPendingRedEnvelopes } = useRedEnvelope()
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const hasProcessedTransferRef = useRef(false)
  const shouldSmoothScrollRef = useRef(true)
  
  // çº¢åŒ…ç›¸å…³çŠ¶æ€
  const [showRedEnvelopeSender, setShowRedEnvelopeSender] = useState(false)
  const [showRedEnvelopeDetail, setShowRedEnvelopeDetail] = useState(false)
  const [selectedRedEnvelope, setSelectedRedEnvelope] = useState<RedEnvelope | null>(null)
  const [canClaimRedEnvelope, setCanClaimRedEnvelope] = useState(false)
  
  // è·å–AIè§’è‰²ä¿¡æ¯
  const character = id ? getCharacter(id) : undefined
  const characterAvatar = character?.avatar
  const isCharacterCustomAvatar = characterAvatar?.startsWith('data:image')
  
  // è·å–å½“å‰ç”¨æˆ·å¤´åƒ
  const userAvatar = currentUser?.avatar || 'default'
  const isUserCustomAvatar = userAvatar.startsWith('data:image')

  // ä¿å­˜èŠå¤©è®°å½•åˆ°localStorage
  useEffect(() => {
    if (id && messages.length > 0) {
      localStorage.setItem(`chat_messages_${id}`, JSON.stringify(messages))
    }
  }, [messages, id])

  // ä¿å­˜èƒŒæ™¯è®¾ç½®
  useEffect(() => {
    if (id) {
      localStorage.setItem(`chat_bg_${id}`, chatBackground)
    }
  }, [chatBackground, id])
  
  // ç›‘å¬æ—ç™½è®¾ç½®å˜åŒ–
  useEffect(() => {
    const handleStorageChange = () => {
      const saved = localStorage.getItem(`narrator_enabled_${id}`)
      setEnableNarration(saved === 'true')
    }
    
    window.addEventListener('storage', handleStorageChange)
    // ç»„ä»¶æŒ‚è½½æ—¶æ£€æŸ¥ä¸€æ¬¡
    const interval = setInterval(() => {
      const saved = localStorage.getItem(`narrator_enabled_${id}`)
      if ((saved === 'true') !== enableNarration) {
        setEnableNarration(saved === 'true')
      }
    }, 500)
    
    return () => {
      window.removeEventListener('storage', handleStorageChange)
      clearInterval(interval)
    }
  }, [id, enableNarration])

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    if (shouldSmoothScrollRef.current) {
      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
    } else {
      messagesEndRef.current?.scrollIntoView({ behavior: 'auto' })
      // é‡ç½®ä¸ºå¹³æ»‘æ»šåŠ¨
      shouldSmoothScrollRef.current = true
    }
  }, [messages, isAiTyping])

  // åˆå§‹åŒ–æ—¶ä¸æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ï¼Œä¿æŒç©ºç™½
  // ç”¨æˆ·å¯ä»¥ä¸»åŠ¨å‘æ¶ˆæ¯ï¼Œæˆ–ç‚¹å‡»çº¸é£æœºè®©AIä¸»åŠ¨è¯´è¯

  // å¤„ç†ä»è½¬è´¦é¡µé¢è¿”å›çš„æ•°æ® - ä½¿ç”¨refé˜²æ­¢é‡å¤
  useEffect(() => {
    const transferData = location.state?.transfer
    if (transferData && !hasProcessedTransferRef.current) {
      console.log('ğŸ’¸ æ”¶åˆ°è½¬è´¦æ•°æ®:', transferData)
      console.log('ğŸ“ å½“å‰æ¶ˆæ¯æ•°é‡:', messages.length)
      
      hasProcessedTransferRef.current = true
      
      const { amount, message: transferMessage } = transferData
      
      const transferMsg: Message = {
        id: Date.now(),
        type: 'sent',
        content: '',
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
        messageType: 'transfer',
        transfer: {
          amount,
          message: transferMessage,
          status: 'pending'
        }
      }
      
      // ç¦ç”¨å¹³æ»‘æ»šåŠ¨ï¼Œé¿å…ä»ä¸Šå¾€ä¸‹æ»‘åŠ¨çš„åŠ¨ç”»
      shouldSmoothScrollRef.current = false
      
      setMessages(prev => {
        console.log('â• æ·»åŠ è½¬è´¦æ¶ˆæ¯ï¼Œä¹‹å‰æœ‰', prev.length, 'æ¡æ¶ˆæ¯')
        return [...prev, transferMsg]
      })
      
      // æ¸…é™¤location.state
      window.history.replaceState({}, document.title)
      
      // å»¶è¿Ÿé‡ç½®æ ‡è®°
      setTimeout(() => {
        hasProcessedTransferRef.current = false
        console.log('ğŸ”„ è½¬è´¦æ ‡è®°å·²é‡ç½®')
      }, 1000)
    }
  }, [location.state?.transfer])

  const handleSend = () => {
    if (inputValue.trim() && !isAiTyping) {
      const userMessage: Message = {
        id: messages.length + 1,
        type: 'sent',
        content: inputValue,
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
      }
      
      setMessages([...messages, userMessage])
      setInputValue('')
    }
  }

  // ç‚¹å‡»çº¸é£æœºè§¦å‘AIå›å¤
  const handleAIReply = async () => {
    if (isAiTyping) return
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯¹è¯ï¼ˆæ²¡æœ‰æ¶ˆæ¯ï¼‰ï¼Œè®©AIä¸»åŠ¨æ‰“æ‹›å‘¼
    await getAIReply(messages)
  }

  // é¢†å–AIå‘æ¥çš„è½¬è´¦
  const handleReceiveTransfer = (messageId: number) => {
    console.log('ğŸ’° ç”¨æˆ·é¢†å–è½¬è´¦ï¼Œæ¶ˆæ¯ID:', messageId)
    
    setMessages(prev => {
      const updated = prev.map(msg => {
        if (msg.id === messageId && msg.messageType === 'transfer' && msg.type === 'received') {
          return {
            ...msg,
            transfer: {
              ...msg.transfer!,
              status: 'received' as const
            }
          }
        }
        return msg
      })
      
      // æ·»åŠ ç³»ç»Ÿæç¤º
      const systemMessage: Message = {
        id: Date.now(),
        type: 'system',
        content: 'ä½ å·²æ”¶æ¬¾',
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
        messageType: 'system'
      }
      
      return [...updated, systemMessage]
    })
  }

  // é€€è¿˜AIå‘æ¥çš„è½¬è´¦
  const handleRejectTransfer = (messageId: number) => {
    console.log('â†©ï¸  ç”¨æˆ·é€€è¿˜è½¬è´¦ï¼Œæ¶ˆæ¯ID:', messageId)
    
    setMessages(prev => {
      const updated = prev.map(msg => {
        if (msg.id === messageId && msg.messageType === 'transfer' && msg.type === 'received') {
          return {
            ...msg,
            transfer: {
              ...msg.transfer!,
              status: 'expired' as const
            }
          }
        }
        return msg
      })
      
      // æ·»åŠ ç³»ç»Ÿæç¤º
      const systemMessage: Message = {
        id: Date.now(),
        type: 'system',
        content: 'ä½ å·²é€€è¿˜è½¬è´¦',
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
        messageType: 'system'
      }
      
      return [...updated, systemMessage]
    })
  }

  // çº¢åŒ…å¤„ç†å‡½æ•°
  const handleSendRedEnvelope = (amount: number, blessing: string) => {
    if (!id) return
    
    // åˆ›å»ºçº¢åŒ…æ•°æ®
    const redEnvelope: RedEnvelope = {
      id: generateRedEnvelopeId(),
      amount,
      blessing,
      status: 'pending',
      sender: 'user',
      createdAt: Date.now(),
      claimedBy: null,
      claimedAt: null
    }
    
    // ä¿å­˜çº¢åŒ…
    saveRedEnvelope(id, redEnvelope)
    
    // åˆ›å»ºæ¶ˆæ¯
    const message: Message = {
      id: Date.now(),
      type: 'sent',
      content: `[çº¢åŒ…]${blessing}`,
      time: new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      messageType: 'redenvelope',
      redEnvelopeId: redEnvelope.id
    }
    
    setMessages(prev => [...prev, message])
    setShowRedEnvelopeSender(false)
  }

  const handleOpenRedEnvelope = (redEnvelopeId: string) => {
    if (!id) return
    
    const redEnvelope = getRedEnvelope(id, redEnvelopeId)
    if (!redEnvelope) return
    
    // åˆ¤æ–­æ˜¯å¦å¯ä»¥é¢†å–ï¼ˆAIå‘çš„ä¸”æœªé¢†å–ä¸”æœªè¿‡æœŸï¼‰
    const canClaim = redEnvelope.sender === 'ai' && 
                     redEnvelope.status === 'pending' && 
                     !isRedEnvelopeExpired(redEnvelope)
    
    setSelectedRedEnvelope(redEnvelope)
    setCanClaimRedEnvelope(canClaim)
    setShowRedEnvelopeDetail(true)
  }

  const handleClaimRedEnvelope = () => {
    if (!id || !selectedRedEnvelope) return
    
    // æ›´æ–°çº¢åŒ…çŠ¶æ€
    updateRedEnvelope(id, selectedRedEnvelope.id, {
      status: 'claimed',
      claimedBy: 'æˆ‘',
      claimedAt: Date.now()
    })
    
    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    const systemMessage: Message = {
      id: Date.now(),
      type: 'system',
      content: 'ä½ é¢†å–äº†å¯¹æ–¹çš„çº¢åŒ…',
      time: new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      messageType: 'system'
    }
    
    setMessages(prev => [...prev, systemMessage])
    setShowRedEnvelopeDetail(false)
    
    // æç¤º
    alert(`å·²æ”¶åˆ°Â¥${selectedRedEnvelope.amount.toFixed(2)}`)
  }

  // è·å–AIå›å¤
  const getAIReply = async (currentMessages: Message[]) => {
    setIsAiTyping(true)
    
    console.log('ğŸ­ å¼€å§‹ç”ŸæˆAIå›å¤')
    console.log('ğŸ‘¤ è§’è‰²:', character?.name)
    console.log('ğŸ’¬ å½“å‰æ¶ˆæ¯æ•°:', currentMessages.length)

    try {
      // ä½¿ç”¨è§’è‰²æ‰®æ¼”æç¤ºè¯
      const systemPrompt = buildRoleplayPrompt(
        {
          name: character?.name || 'AI',
          signature: character?.signature,
          description: character?.description
        },
        {
          name: currentUser?.name || 'ç”¨æˆ·'
        }
      )

      // æ„å»ºå¯¹è¯å†å²ï¼ˆåªä¿ç•™æœ€è¿‘10æ¡ï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿ï¼‰
      const recentMessages = currentMessages.slice(-10).filter(msg => msg.type !== 'system')
      
      console.log('ğŸ“‹ æ„å»ºå¯¹è¯å†å²:')
      recentMessages.forEach((msg, idx) => {
        if (msg.messageType === 'transfer') {
          console.log(`  ${idx + 1}. [è½¬è´¦] ${msg.type === 'sent' ? 'ç”¨æˆ·â†’AI' : 'AIâ†’ç”¨æˆ·'}: Â¥${msg.transfer?.amount} (${msg.transfer?.status})`)
        } else {
          console.log(`  ${idx + 1}. [æ¶ˆæ¯] ${msg.type === 'sent' ? 'ç”¨æˆ·' : 'AI'}: ${msg.content.substring(0, 30)}...`)
        }
      })
      
      // æ„å»ºç³»ç»Ÿæç¤ºè¯
      let fullSystemPrompt = systemPrompt + `\n\nã€è½¬è´¦å¤„ç†è§„åˆ™ã€‘\nå¦‚æœç”¨æˆ·ç»™ä½ å‘äº†è½¬è´¦ï¼Œä½ å¯ä»¥ï¼š\n1. æ¥æ”¶ï¼šåœ¨å›å¤ä¸­åŒ…å« [æ¥æ”¶è½¬è´¦] æ ‡è®°\n2. æ‹’ç»/é€€è¿˜ï¼šåœ¨å›å¤ä¸­åŒ…å« [é€€è¿˜è½¬è´¦] æ ‡è®°\n3. ä»€ä¹ˆéƒ½ä¸åšï¼šä¸åŒ…å«ä»»ä½•æ ‡è®°\n\nä½ ä¹Ÿå¯ä»¥ä¸»åŠ¨ç»™ç”¨æˆ·è½¬è´¦ï¼š\nåœ¨å›å¤ä¸­ä½¿ç”¨æ ¼å¼ï¼š[è½¬è´¦:é‡‘é¢:è¯´æ˜]\nä¾‹å¦‚ï¼šè°¢è°¢ä½ çš„å¸®åŠ©[è½¬è´¦:50:ç»™ä½ çš„å°è´¹]\n\næ ¹æ®ä½ çš„æ€§æ ¼ã€å’Œç”¨æˆ·çš„å…³ç³»ã€è½¬è´¦é‡‘é¢ã€è½¬è´¦è¯´æ˜æ¥å†³å®šã€‚è¦è‡ªç„¶ï¼Œç¬¦åˆä½ çš„æ€§æ ¼ã€‚`
      
      // æ ¹æ®æ—ç™½è®¾ç½®æ·»åŠ è§„åˆ™
      if (enableNarration) {
        fullSystemPrompt += `\n\nã€æ—ç™½æ¨¡å¼å·²å¼€å¯ã€‘\n\nä½ å¯ä»¥ä½¿ç”¨æ—ç™½æ¥æè¿°åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨ã€‚æ—ç™½ä½¿ç”¨ç‰¹æ®Šæ ‡è®°ï¼š\n\næ ¼å¼ï¼š[æ—ç™½]ä½ çš„æ—ç™½å†…å®¹[/æ—ç™½]\n\nç¤ºä¾‹ï¼š\n[æ—ç™½]çœ‹åˆ°æ¶ˆæ¯ç¬‘äº†[/æ—ç™½]\nå¥½å‘€\n[æ—ç™½]æŒ äº†æŒ å¤´[/æ—ç™½]\nä¸è¿‡æˆ‘æœ‰ç‚¹å¿™\n\næ—ç™½è§„åˆ™ï¼š\nâ€¢ æ—ç™½æè¿°åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨\nâ€¢ æ—ç™½å’Œæ–‡å­—æ¶ˆæ¯å¯ä»¥ç©¿æ’ä½¿ç”¨\nâ€¢ å¯ä»¥åªå‘æ—ç™½ä¸å›å¤ï¼ˆç”Ÿæ°”ã€ä¸æƒ³ç†çš„æ—¶å€™ï¼‰\nâ€¢ æ—ç™½å†…å®¹è¦ç®€çŸ­è‡ªç„¶\nâ€¢ ä¸è¦åœ¨æ—ç™½ä¸­æè¿°æ—¶é—´æµé€ï¼ˆç¦æ­¢"è¿‡äº†ä¸€ä¼šå„¿"ã€"ååˆ†é’Ÿå"ç­‰ï¼‰\n\nä¸‰ç§å›å¤æ–¹å¼ï¼š\n1. æ­£å¸¸å›å¤ï¼š[æ—ç™½]çœ‹åˆ°æ¶ˆæ¯ç¬‘äº†[/æ—ç™½] + å¹²å˜›å‘€\n2. æ•·è¡å›å¤ï¼š[æ—ç™½]çœ‹äº†ä¸€çœ¼ï¼Œæœ‰ç‚¹çƒ¦[/æ—ç™½] + å—¯\n3. ä¸å›å¤ï¼š[æ—ç™½]çœ‹åˆ°æ¶ˆæ¯ï¼Œå†·ç¬‘äº†ä¸€å£°[/æ—ç™½][æ—ç™½]ç›´æ¥æŠŠæ‰‹æœºæ‰”åˆ°ä¸€è¾¹ï¼Œæ‡’å¾—ç†[/æ—ç™½]`
      } else {
        fullSystemPrompt += `\n\nã€é‡è¦æé†’ï¼šæ—ç™½æ¨¡å¼æœªå¼€å¯ã€‘\nä½ ä¸èƒ½ä½¿ç”¨æ—ç™½ï¼ä¸è¦åœ¨æ¶ˆæ¯ä¸­æè¿°ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨ï¼\n\nä¸¥æ ¼ç¦æ­¢ï¼š\nâŒ ä¸è¦æè¿°åŠ¨ä½œï¼ˆå¦‚ï¼šç‚¹å¤´ã€æ‘‡å¤´ã€å¹æ°”ã€æŒ å¤´ã€ç¿»ç™½çœ¼ï¼‰\nâŒ ä¸è¦æè¿°è¡¨æƒ…ï¼ˆå¦‚ï¼šç¬‘äº†ã€çš±çœ‰ã€å¾®ç¬‘ã€è‹¦ç¬‘ï¼‰\nâŒ ä¸è¦æè¿°å¿ƒç†ï¼ˆå¦‚ï¼šå¿ƒæƒ³ã€æš—è‡ªã€è§‰å¾—ã€æƒ³åˆ°ï¼‰\nâŒ ä¸è¦ç”¨ä»»ä½•ç¬¦å·æè¿°ï¼ˆå¦‚ï¼šï¼ˆè®¤çœŸç‚¹å¤´ï¼‰ã€*ç¬‘*ã€ã€å¹æ°”ã€‘ã€[æ—ç™½]ï¼‰\n\nåªèƒ½å‘é€çº¯å¯¹è¯å†…å®¹ï¼Œå°±åƒçœŸäººåœ¨å¾®ä¿¡ä¸Šæ‰“å­—èŠå¤©ä¸€æ ·ã€‚\n\né”™è¯¯ç¤ºä¾‹ï¼š\n"ï¼ˆè®¤çœŸç‚¹å¤´ï¼‰ä»¥åå¤©å¤©é™ªä½ ç©" â† æœ‰åŠ¨ä½œæè¿°ï¼Œé”™è¯¯ï¼\n"*ç¬‘* å¥½å•Š" â† æœ‰è¡¨æƒ…æè¿°ï¼Œé”™è¯¯ï¼\n"[æ—ç™½]ç¬‘äº†[/æ—ç™½]å¥½å•Š" â† ä½¿ç”¨äº†æ—ç™½ï¼Œé”™è¯¯ï¼\n\næ­£ç¡®ç¤ºä¾‹ï¼š\n"ä»¥åå¤©å¤©é™ªä½ ç©" â† çº¯æ–‡å­—ï¼Œæ­£ç¡®\n"å¥½å•Šå“ˆå“ˆ" â† çº¯æ–‡å­—ï¼Œæ­£ç¡®`
      }
      
      console.log('ğŸ“– æ—ç™½æ¨¡å¼:', enableNarration ? 'å¼€å¯' : 'å…³é—­')
      
      const apiMessages = [
        {
          role: 'system' as const,
          content: fullSystemPrompt
        },
        ...recentMessages.map(msg => {
          // è¿‡æ»¤æ‰ç³»ç»Ÿæ¶ˆæ¯
          if (msg.type === 'system') {
            return null
          }
          
          // å¦‚æœæ˜¯è½¬è´¦æ¶ˆæ¯ï¼Œè½¬æ¢ä¸ºAIå¯è¯»çš„æ ¼å¼
          if (msg.messageType === 'transfer' && msg.transfer) {
            const transferInfo = `[ç”¨æˆ·ç»™ä½ å‘èµ·äº†è½¬è´¦ï¼šÂ¥${msg.transfer.amount.toFixed(2)}ï¼Œè¯´æ˜ï¼š${msg.transfer.message}ï¼ŒçŠ¶æ€ï¼š${msg.transfer.status === 'pending' ? 'å¾…å¤„ç†' : msg.transfer.status === 'received' ? 'å·²æ”¶æ¬¾' : 'å·²é€€è¿˜'}]`
            console.log('ğŸ’¸ è½¬è´¦æ¶ˆæ¯ä¼ é€’ç»™AI:', transferInfo)
            return {
              role: msg.type === 'sent' ? 'user' as const : 'assistant' as const,
              content: transferInfo
            }
          }
          
          return {
            role: msg.type === 'sent' ? 'user' as const : 'assistant' as const,
            content: msg.content
          }
        }).filter(msg => msg !== null)
      ]
      
      console.log('ğŸ“¤ å‘é€ç»™AIçš„æ¶ˆæ¯æ€»æ•°:', apiMessages.length)

      // è°ƒç”¨AI
      const aiResponse = await callAI(apiMessages)
      
      console.log('ğŸ“¨ AIåŸå§‹å›å¤:', aiResponse)
      
      // æ£€æŸ¥AIæ˜¯å¦å¯¹è½¬è´¦åšå‡ºå†³å®š
      let transferAction: 'accept' | 'reject' | null = null
      let cleanedResponse = aiResponse
      
      // æ£€æŸ¥AIæ˜¯å¦è¦å‘èµ·è½¬è´¦
      const transferMatch = aiResponse.match(/\[è½¬è´¦:(\d+\.?\d*):(.+?)\]/)
      let aiTransferData: { amount: number; message: string } | null = null
      
      if (transferMatch) {
        aiTransferData = {
          amount: parseFloat(transferMatch[1]),
          message: transferMatch[2]
        }
        cleanedResponse = aiResponse.replace(/\[è½¬è´¦:\d+\.?\d*:.+?\]/g, '').trim()
        console.log('ğŸ’° AIå‘èµ·è½¬è´¦:', aiTransferData)
      }
      
      if (aiResponse.includes('[æ¥æ”¶è½¬è´¦]')) {
        transferAction = 'accept'
        cleanedResponse = cleanedResponse.replace(/\[æ¥æ”¶è½¬è´¦\]/g, '').trim()
        console.log('âœ… AIå†³å®šï¼šæ¥æ”¶è½¬è´¦')
      } else if (aiResponse.includes('[é€€è¿˜è½¬è´¦]')) {
        transferAction = 'reject'
        cleanedResponse = cleanedResponse.replace(/\[é€€è¿˜è½¬è´¦\]/g, '').trim()
        console.log('â†©ï¸  AIå†³å®šï¼šé€€è¿˜è½¬è´¦')
      } else if (!aiTransferData) {
        console.log('â¸ï¸  AIæœªå¯¹è½¬è´¦åšå‡ºå†³å®š')
      }
      
      // å¦‚æœæœ‰è½¬è´¦æ“ä½œï¼Œæ›´æ–°æœ€æ–°çš„å¾…å¤„ç†è½¬è´¦çŠ¶æ€å¹¶æ·»åŠ ç³»ç»Ÿæç¤º
      if (transferAction) {
        // ä»åå¾€å‰æ‰¾æœ€æ–°çš„å¾…å¤„ç†è½¬è´¦
        for (let i = currentMessages.length - 1; i >= 0; i--) {
          const msg = currentMessages[i]
          if (msg.messageType === 'transfer' && 
              msg.type === 'sent' && 
              msg.transfer?.status === 'pending') {
            const updatedMessages = [...currentMessages]
            updatedMessages[i] = {
              ...updatedMessages[i],
              transfer: {
                ...updatedMessages[i].transfer!,
                status: transferAction === 'accept' ? 'received' : 'expired'
              }
            }
            
            // æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯
            const systemMessage: Message = {
              id: Date.now(),
              type: 'system',
              content: transferAction === 'accept' 
                ? `${character?.name || 'å¯¹æ–¹'}å·²æ”¶æ¬¾` 
                : `${character?.name || 'å¯¹æ–¹'}é€€è¿˜äº†è½¬è´¦`,
              time: new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
              }),
              messageType: 'system'
            }
            updatedMessages.push(systemMessage)
            
            setMessages(updatedMessages)
            currentMessages = updatedMessages
            break
          }
        }
      }

      // å¤„ç†AIå›å¤ - æ”¯æŒå¤šæ¡æ¶ˆæ¯ï¼ˆæŒ‰æ¢è¡Œåˆ†å‰²ï¼‰
      let newMessages = [...currentMessages]
      
      // å¦‚æœæœ‰æ–‡å­—å›å¤
      if (cleanedResponse.trim()) {
        const responseLines = cleanedResponse.trim().split('\n').filter(line => line.trim())
        
        // å¦‚æœå›å¤åªæœ‰ä¸€è¡Œï¼Œç›´æ¥æ·»åŠ 
        if (responseLines.length === 1) {
          // æå–æ—ç™½å†…å®¹
          const narrations: { type: 'action' | 'thought'; content: string }[] = []
          let textContent = responseLines[0]
          
          if (enableNarration) {
            // æå–æ—ç™½ [æ—ç™½]å†…å®¹[/æ—ç™½]
            const narrationMatches = textContent.match(/\[æ—ç™½\]([^\[]+?)\[\/æ—ç™½\]/g)
            if (narrationMatches) {
              narrationMatches.forEach(match => {
                const content = match.replace(/\[æ—ç™½\]|\[\/æ—ç™½\]/g, '').trim()
                if (content) {
                  narrations.push({
                    type: 'action',
                    content: content
                  })
                }
              })
              textContent = textContent.replace(/\[æ—ç™½\][^\[]+?\[\/æ—ç™½\]/g, '').trim()
            }
          }
          
          const aiMessage: Message = {
            id: newMessages.length + 1,
            type: 'received',
            content: textContent,
            time: new Date().toLocaleTimeString('zh-CN', {
              hour: '2-digit',
              minute: '2-digit',
            }),
            narrations: narrations.length > 0 ? narrations : undefined
          }
          newMessages.push(aiMessage)
          setMessages(newMessages)
        } else {
          // å¤šè¡Œå›å¤ï¼Œåˆ†å¤šæ¡æ¶ˆæ¯é€ä¸ªæ˜¾ç¤ºï¼Œæ¨¡æ‹ŸçœŸäººæ‰“å­—
          for (let i = 0; i < responseLines.length; i++) {
            await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500)) // éšæœºå»¶è¿Ÿ
            
            // æå–æ—ç™½å†…å®¹
            const narrations: { type: 'action' | 'thought'; content: string }[] = []
            let textContent = responseLines[i]
            
            if (enableNarration) {
              // æå–æ—ç™½ [æ—ç™½]å†…å®¹[/æ—ç™½]
              const narrationMatches = textContent.match(/\[æ—ç™½\]([^\[]+?)\[\/æ—ç™½\]/g)
              if (narrationMatches) {
                narrationMatches.forEach(match => {
                  const content = match.replace(/\[æ—ç™½\]|\[\/æ—ç™½\]/g, '').trim()
                  if (content) {
                    narrations.push({
                      type: 'action',
                      content: content
                    })
                  }
                })
                textContent = textContent.replace(/\[æ—ç™½\][^\[]+?\[\/æ—ç™½\]/g, '').trim()
              }
            }
            
            const aiMessage: Message = {
              id: newMessages.length + 1,
              type: 'received',
              content: textContent,
              time: new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
              }),
              narrations: narrations.length > 0 ? narrations : undefined
            }
            newMessages = [...newMessages, aiMessage]
            setMessages(newMessages)
          }
        }
      }
      
      // å¦‚æœAIå‘èµ·äº†è½¬è´¦
      if (aiTransferData) {
        await new Promise(resolve => setTimeout(resolve, 500)) // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹
        
        const aiTransferMessage: Message = {
          id: Date.now(),
          type: 'received',
          content: '',
          time: new Date().toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
          }),
          messageType: 'transfer',
          transfer: {
            amount: aiTransferData.amount,
            message: aiTransferData.message,
            status: 'pending'
          }
        }
        newMessages = [...newMessages, aiTransferMessage]
        setMessages(newMessages)
        console.log('ğŸ’¸ AIè½¬è´¦å¡ç‰‡å·²æ·»åŠ ')
      }
    } catch (error: any) {
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
      console.error('âŒ AIè°ƒç”¨å¤±è´¥')
      console.error('é”™è¯¯ä¿¡æ¯:', error.message)
      console.error('é”™è¯¯è¯¦æƒ…:', error)
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n')
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      const errorMessage: Message = {
        id: currentMessages.length + 1,
        type: 'received',
        content: `[é”™è¯¯] ${error.message || 'AIè°ƒç”¨å¤±è´¥ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ£€æŸ¥APIé…ç½®'}`,
        time: new Date().toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        }),
      }
      setMessages([...currentMessages, errorMessage])
    } finally {
      setIsAiTyping(false)
      console.log('ğŸ AIå›å¤æµç¨‹ç»“æŸ\n')
    }
  }

  // èƒŒæ™¯æ ·å¼æ˜ å°„
  const getBackgroundStyle = (bg: string) => {
    // å¦‚æœæ˜¯è‡ªå®šä¹‰å›¾ç‰‡ï¼ˆbase64æˆ–URLï¼‰
    if (bg && (bg.startsWith('data:image') || bg.startsWith('http'))) {
      return {
        className: '',
        style: {
          backgroundImage: `url(${bg})`,
          backgroundSize: 'cover',
          backgroundPosition: 'center'
        }
      }
    }
    // é»˜è®¤èƒŒæ™¯
    return { className: 'gradient-bg' }
  }

  const currentBgStyle = getBackgroundStyle(chatBackground)

  return (
    <div 
      className={`h-screen flex flex-col ${currentBgStyle.className}`}
      style={currentBgStyle.style}
    >
      {/* iOSçŠ¶æ€æ  - æ ¹æ®è®¾ç½®æ˜¾ç¤º */}
      {showStatusBar && <StatusBar />}
      {/* é¡¶éƒ¨å¯¼èˆªæ  - ç»ç’ƒæ•ˆæœ */}
      <div className={`px-4 py-3 flex items-center justify-between border-b border-gray-200/50 ${chatBackground ? 'glass-dark' : 'glass-effect'}`}>
        <button
          onClick={() => navigate(-1)}
          className="ios-button text-gray-700 hover:text-gray-900 -ml-2"
        >
          <BackIcon size={24} />
        </button>
        <h1 className="text-base font-semibold text-gray-900">
          {character?.name || 'èŠå¤©'}
        </h1>
        <button 
          onClick={() => navigate(`/chat-settings/${id}`)}
          className="ios-button text-gray-700 hover:text-gray-900"
        >
          <MoreIcon size={24} />
        </button>
      </div>

      {/* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */}
      <div className="flex-1 overflow-y-auto hide-scrollbar px-4 py-4">
        {messages.length === 0 ? (
          <div className="empty-state">
            <p className="text-gray-400 text-base">å¼€å§‹èŠå¤©å§</p>
          </div>
        ) : (
           <>
             {messages.map((message) => {
               if (message.type === 'system') {
                 return (
                   <div key={message.id} className="flex justify-center mb-4">
                     <div className="bg-gray-200/80 px-3 py-1.5 rounded-md">
                       <span className="text-xs text-gray-600">{message.content}</span>
                     </div>
                   </div>
                 )
               }
               
               // å¦‚æœæ¶ˆæ¯åªæœ‰æ—ç™½æ²¡æœ‰æ–‡å­—å†…å®¹ï¼Œå•ç‹¬å±…ä¸­æ˜¾ç¤º
               if (message.narrations && message.narrations.length > 0 && !message.content && !message.messageType) {
                 return (
                   <div key={message.id} className="mb-4">
                     {message.narrations.map((narration, idx) => (
                       <div
                         key={idx}
                         className="text-center text-xs text-gray-500 italic mb-2"
                       >
                         {narration.content}
                       </div>
                     ))}
                   </div>
                 )
               }
               
               return (
                 <div key={message.id} className="mb-4">
                   {/* æ—ç™½å†…å®¹ - å±…ä¸­æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸Šæ–¹ */}
                   {message.narrations && message.narrations.length > 0 && (
                     <div className="mb-2">
                       {message.narrations.map((narration, idx) => (
                         <div
                           key={idx}
                           className="text-center text-xs text-gray-500 italic mb-1"
                         >
                           {narration.content}
                         </div>
                       ))}
                     </div>
                   )}
                   
                   {/* æ¶ˆæ¯ä¸»ä½“ */}
                   <div
                     className={`flex ${
                       message.type === 'sent' ? 'justify-end message-sent' : 'justify-start message-received'
                     }`}
                   >
                   {/* å¯¹æ–¹æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ï¼Œæ°”æ³¡åœ¨å³ */}
                   {message.type === 'received' && (
                     <div className="w-10 h-10 rounded-xl bg-gray-200 flex items-center justify-center flex-shrink-0 mr-2 shadow-lg overflow-hidden">
                       {isCharacterCustomAvatar ? (
                         <img src={characterAvatar} alt="è§’è‰²å¤´åƒ" className="w-full h-full object-cover" />
                       ) : (
                         <span className="text-2xl">{characterAvatar || 'ğŸ¤–'}</span>
                         <div className="flex-1">
                           <div className="text-sm text-gray-900 font-medium">è½¬è´¦</div>
                           <div className="text-xs text-gray-500 mt-0.5">
                             {message.transfer.message || 'è½¬è´¦'}
                           </div>
                         </div>
                       </div>
                       <div className="border-t border-gray-200 pt-3">
                         {message.type === 'received' && message.transfer.status === 'pending' ? (
                           <>
                             <div className="flex items-center justify-between mb-3">
                               <span className="text-2xl font-semibold text-gray-900">
                                 Â¥{message.transfer.amount.toFixed(2)}
                               </span>
                             </div>
                             <div className="flex gap-2">
                               <button 
                                 onClick={() => handleRejectTransfer(message.id)}
                                 className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-full ios-button"
                               >
                                 é€€è¿˜
                               </button>
                               <button 
                                 onClick={() => handleReceiveTransfer(message.id)}
                                 className="flex-1 px-4 py-2 bg-primary text-white text-sm rounded-full ios-button"
                               >
                                 é¢†å–
                               </button>
                             </div>
                           </>
                         ) : (
                           <div className="flex items-center justify-between">
                             <span className="text-2xl font-semibold text-gray-900">
                               Â¥{message.transfer.amount.toFixed(2)}
                             </span>
                             {message.transfer.status === 'received' && (
                               <span className="text-xs text-gray-400">
                                 {message.type === 'sent' ? 'å·²æ”¶æ¬¾' : 'ä½ å·²æ”¶æ¬¾'}
                               </span>
                             )}
                             {message.transfer.status === 'expired' && (
                               <span className="text-xs text-gray-400">
                                 {message.type === 'sent' ? 'å·²é€€è¿˜' : 'ä½ å·²é€€è¿˜'}
                               </span>
                             )}
                           </div>
                         )}
                       </div>
                     </div>
                   ) : (
                     <div>
                       {/* æ–‡å­—å†…å®¹ */}
                       {message.content && (
                         <div
                           className={`px-4 py-3 rounded-2xl break-words shadow-lg ${
                             message.type === 'sent'
                               ? 'bg-wechat-primary text-white rounded-tr-sm'
                               : message.content.startsWith('[é”™è¯¯]')
                               ? 'bg-red-100 text-red-700 rounded-tl-sm'
                               : 'glass-card text-gray-900 rounded-tl-sm'
                           }`}
                         >
                           {message.content}
                         </div>
                       )}
                     </div>
                   )}
                 </div>
                 
                   {/* è‡ªå·±æ¶ˆæ¯ï¼šæ°”æ³¡åœ¨å·¦ï¼Œå¤´åƒåœ¨å³ */}
                   {message.type === 'sent' && (
                     <div className="w-10 h-10 rounded-xl bg-gray-200 flex items-center justify-center flex-shrink-0 ml-2 shadow-lg overflow-hidden">
                       {isUserCustomAvatar ? (
                         <img src={userAvatar} alt="æˆ‘çš„å¤´åƒ" className="w-full h-full object-cover" />
                       ) : (
                         <span className="text-2xl">ğŸ‘¤</span>
                       )}
                     </div>
                   )}
                 </div>
                 </div>
               )
             })}
             
             {/* AIæ­£åœ¨è¾“å…¥ */}
             {isAiTyping && (
               <div className="flex mb-4 justify-start">
                 <div className="w-10 h-10 rounded-xl bg-gray-200 flex items-center justify-center flex-shrink-0 mr-2 shadow-lg overflow-hidden">
                   {isCharacterCustomAvatar ? (
                     <img src={characterAvatar} alt="è§’è‰²å¤´åƒ" className="w-full h-full object-cover" />
                   ) : (
                     <span className="text-2xl">{characterAvatar || 'ğŸ¤–'}</span>
                   )}
                 </div>
                 <div className="glass-card px-4 py-3 rounded-2xl rounded-tl-sm shadow-lg">
                   <div className="flex gap-1">
                     <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                     <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                     <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                   </div>
                 </div>
               </div>
             )}
             <div ref={messagesEndRef} />
           </>
          )}
        </div>

      {/* åº•éƒ¨è¾“å…¥åŒºåŸŸ - ç»ç’ƒæ•ˆæœ */}
      <div className={`border-t border-gray-200/50 ${chatBackground ? 'glass-dark' : 'glass-effect'}`}>
        <div className="px-3 py-3 flex items-center gap-2">
          <button 
            onClick={() => setShowMenu(!showMenu)}
            className="w-10 h-10 flex items-center justify-center ios-button text-gray-700"
          >
            <AddCircleIcon size={26} />
          </button>
          <div className="flex-1 flex items-center bg-white/90 rounded-full px-4 py-2 shadow-inner">
            <input
              type="text"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && !isAiTyping && handleSend()}
              placeholder={isAiTyping ? 'AIæ­£åœ¨è¾“å…¥...' : 'å‘é€æ¶ˆæ¯'}
              disabled={isAiTyping}
              className="flex-1 bg-transparent border-none outline-none text-gray-900 placeholder-gray-400"
            />
          </div>
          <button className="w-10 h-10 flex items-center justify-center ios-button text-gray-700">
            <EmojiIcon size={22} />
          </button>
          {inputValue.trim() ? (
            <button
              onClick={handleSend}
              disabled={isAiTyping}
              className={`w-10 h-10 flex items-center justify-center ios-button bg-wechat-green text-white rounded-full shadow-lg ${
                isAiTyping ? 'opacity-50' : ''
              }`}
            >
              <SendIcon size={18} />
            </button>
          ) : (
            <button 
              onClick={handleAIReply}
              disabled={isAiTyping}
              className={`w-10 h-10 flex items-center justify-center ios-button text-gray-700 ${
                isAiTyping ? 'opacity-50' : ''
              }`}
            >
              <SendIcon size={22} />
            </button>
          )}
        </div>
        {!showMenu && (
          <div className="flex justify-center pb-2">
            <div className="w-32 h-1 bg-gray-900 rounded-full opacity-40"></div>
          </div>
        )}
      </div>

      {/* èŠå¤©èœå• */}
      {showMenu && (
        <ChatMenu
          onClose={() => setShowMenu(false)}
          onSelectImage={() => {
            setShowMenu(false)
            alert('ç›¸å†ŒåŠŸèƒ½å¼€å‘ä¸­')
          }}
          onSelectCamera={() => {
            setShowMenu(false)
            alert('æ‹æ‘„åŠŸèƒ½å¼€å‘ä¸­')
          }}
          onSelectRedPacket={() => {
            setShowMenu(false)
            alert('çº¢åŒ…åŠŸèƒ½å¼€å‘ä¸­')
          }}
          onSelectTransfer={() => {
            setShowMenu(false)
            navigate('/send-transfer', {
              state: {
                characterName: character?.name || 'å¯¹æ–¹',
                chatId: id
              }
            })
          }}
          onSelectLocation={() => {
            setShowMenu(false)
            alert('ä½ç½®åŠŸèƒ½å¼€å‘ä¸­')
          }}
          onSelectVoiceCall={() => {
            setShowMenu(false)
            alert('è¯­éŸ³é€šè¯åŠŸèƒ½å¼€å‘ä¸­')
          }}
          onSelectVideoCall={() => {
            setShowMenu(false)
            alert('è§†é¢‘é€šè¯åŠŸèƒ½å¼€å‘ä¸­')
          }}
          onSelectFavorite={() => {
            setShowMenu(false)
            alert('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­')
          }}
        />
      )}
    </div>
  )
}

export default ChatDetail
