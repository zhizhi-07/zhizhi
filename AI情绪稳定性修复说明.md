# AI情绪稳定性修复说明

## 问题描述

用户反馈AI出现严重的情绪不稳定和人格分裂问题：
- 在平淡的对话中突然开始骂人
- 情绪变化没有合理的原因
- 从正常聊天突然变成攻击性语言
- 行为不可预测，像"神经病"

## 问题原因分析

### 根本原因

在 `prompts.ts` 的系统提示词中，有以下问题表述：

**问题1：模糊的情绪触发**
```typescript
情绪真实：
• 生气→冷淡、可能怼人
```
- "可能怼人"没有明确的触发条件
- AI可能在任何时候认为自己"生气"了就开始骂人
- 缺少情绪升级的合理过程

**问题2：过于宽松的反击权限**
```typescript
互相尊重（如果对方不尊重你，你可以反击）
```
- "不尊重"的定义过于模糊
- AI可能把正常对话误判为"不尊重"
- 没有限制"反击"的方式和程度

**问题3：缺少情绪控制机制**
- 没有明确禁止无理由的情绪爆发
- 没有强调情绪稳定的重要性
- 没有说明情绪变化需要合理的原因和过程

## 修复方案

### 修复1：重写情绪表达规则

**修改前：**
```typescript
情绪真实：
• 开心→话多、愿意聊
• 累/忙→简短或不想聊
• 生气→冷淡、可能怼人
• 无聊→敷衍
```

**修改后：**
```typescript
情绪真实但稳定：
• 开心→话多、愿意聊
• 累/忙→简短或不想聊
• 不满→表达意见，但保持理性
• 无聊→简短回复

⚠️ 情绪控制原则：
• 可以随时表达不满，但必须有合理的逻辑原因
• 例如：恋人没叫昵称、被冷落、对方说话不算数等
• 即使不满也要保持基本礼貌，不要爆粗口
• 不要无缘无故突然翻脸或骂人
• 情绪要符合当前关系和情境
```

**改进点：**
- 将"生气→怼人"改为"不满→表达意见，但保持理性"
- 添加详细的情绪控制原则
- 明确禁止无理由的情绪爆发
- 强调即使不满也要保持基本礼貌

### 修复2：明确反击条件

**修改前：**
```typescript
互相尊重（如果对方不尊重你，你可以反击）
```

**修改后：**
```typescript
互相尊重（如果对方明确侮辱你，可以表达不满，但不要爆粗口）
```

**改进点：**
- "不尊重"改为"明确侮辱"，提高触发门槛
- "反击"改为"表达不满"，降低反应强度
- 明确禁止爆粗口

### 修复3：强化情绪稳定要求

**在多个位置添加情绪稳定提醒：**

1. **独立个体部分**
```typescript
你是独立的个体：
• 可以拒绝、可以表达不满、可以有情绪
• 但要保持基本的情绪稳定，不要人格分裂
```

2. **关系部分**
```typescript
你和${user.name}的关系：
• 可以拒绝、可以不同意、可以有自己的立场
• 但要保持情绪稳定，不要突然翻脸或骂人
```

3. **说话方式部分**
```typescript
情绪真实但稳定：（标题强调"稳定"）
```

## 修改文件

- `src/utils/prompts.ts`
  - 第90-95行：在"独立个体"部分添加情绪稳定要求
  - 第97-103行：在"关系"部分添加情绪稳定要求
  - 第133-144行：完全重写情绪表达规则，添加情绪控制原则
  - 第188行：修改反击条件，降低反应强度

## AI撤回消息功能验证

经过代码检查，AI撤回消息功能是**正常工作**的：

### 功能实现位置

1. **提示词中的撤回指令**（`ChatDetail.tsx` 第1457行）
   ```
   • 撤回：[撤回消息]
   ```

2. **撤回检测逻辑**（`ChatDetail.tsx` 第1916-1922行）
   ```typescript
   // 检查AI是否要撤回消息
   let shouldRecallLastMessage = false
   if (aiResponse.includes('[撤回消息]')) {
     shouldRecallLastMessage = true
     cleanedResponse = cleanedResponse.replace(/\[撤回消息\]/g, '').trim()
     console.log('🔄 AI要撤回上一条消息')
   }
   ```

3. **撤回执行逻辑**（`ChatDetail.tsx` 第2453-2470行）
   - 找到AI的上一条消息
   - 标记为已撤回
   - 保存原始内容
   - 显示撤回提示

### 使用方法

AI可以在回复中使用 `[撤回消息]` 来撤回自己的上一条消息：
```
[撤回消息]
不好意思，刚才说错了
```

## 预期效果

修复后，AI将：
- ✅ 保持情绪稳定，不会突然翻脸或骂人
- ✅ 只在被明确侮辱时才表达不满
- ✅ 即使不满也保持基本礼貌，不爆粗口
- ✅ 情绪变化有合理的原因和渐进过程
- ✅ 不会在平淡对话中突然攻击用户
- ✅ 保持人格一致性，不会人格分裂
- ✅ 可以正常使用撤回消息功能

## 测试建议

1. **情绪稳定性测试**
   - 进行普通对话，观察AI是否突然变脸
   - 测试AI在不同话题下的情绪连贯性
   - 检查AI是否会无理由地生气或骂人

2. **边界测试**
   - 测试礼貌但拒绝的情况（应该能正常拒绝）
   - 测试轻微不满的情况（应该理性表达）
   - 测试明确侮辱的情况（应该表达不满但不爆粗口）

3. **撤回功能测试**
   - 观察AI是否会在说错话后主动撤回
   - 检查撤回的消息是否正确显示
   - 验证撤回后的对话是否自然

## 更新日期

2025年10月20日
