# ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

## ğŸ¯ å½“å‰çŠ¶æ€

âœ… **å·²å®Œæˆ**:
- Phase 0: ç±»å‹å®šä¹‰å’ŒåŸºç¡€å·¥å…· (100%)
- Phase 1: è‡ªå®šä¹‰Hooks (100%)
- Phase 2: UIç»„ä»¶æ‹†åˆ† (40%)

ğŸ”„ **è¿›è¡Œä¸­**:
- Phase 2: UIç»„ä»¶æ‹†åˆ† (ç»§ç»­å®Œæˆå‰©ä½™60%)

â³ **å¾…å¼€å§‹**:
- Phase 3: ä¸šåŠ¡é€»è¾‘æå–
- Phase 4: ä¸»ç»„ä»¶é‡æ„

## ğŸ“‹ è¯¦ç»†ä¼˜åŒ–æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®ŒæˆUIç»„ä»¶æ‹†åˆ† (Phase 2)

#### 1.1 åˆ›å»ºæ¶ˆæ¯åˆ—è¡¨ç»„ä»¶
```typescript
// src/pages/ChatDetail/components/MessageList.tsx
- æ¶ˆæ¯åˆ—è¡¨å®¹å™¨
- è™šæ‹Ÿæ»šåŠ¨æ”¯æŒ
- æ—¶é—´åˆ†éš”çº¿
- åŠ è½½æ›´å¤šæç¤º
```

#### 1.2 åˆ›å»ºç‰¹æ®Šæ¶ˆæ¯å¡ç‰‡ç»„ä»¶
```typescript
// src/pages/ChatDetail/components/cards/
- TransferCard.tsx        # è½¬è´¦å¡ç‰‡
- RedEnvelopeCard.tsx     # çº¢åŒ…å¡ç‰‡
- MusicCard.tsx           # éŸ³ä¹å¡ç‰‡
- LocationCard.tsx        # ä½ç½®å¡ç‰‡
- VoiceCard.tsx           # è¯­éŸ³å¡ç‰‡
- PhotoCard.tsx           # å›¾ç‰‡å¡ç‰‡
- XiaohongshuCard.tsx     # å°çº¢ä¹¦å¡ç‰‡
- CoupleSpaceCard.tsx     # æƒ…ä¾£ç©ºé—´å¡ç‰‡
```

#### 1.3 åˆ›å»ºäº¤äº’ç»„ä»¶
```typescript
// src/pages/ChatDetail/components/
- MessageMenu.tsx         # æ¶ˆæ¯é•¿æŒ‰èœå•
- EmojiPanel.tsx          # è¡¨æƒ…é¢æ¿
- AddMenu.tsx             # æ·»åŠ èœå•ï¼ˆ+å·ï¼‰
- BatchDeleteToolbar.tsx  # æ‰¹é‡åˆ é™¤å·¥å…·æ 
```

#### 1.4 åˆ›å»ºå¼¹çª—ç»„ä»¶
```typescript
// src/pages/ChatDetail/components/modals/
- RedEnvelopeModal.tsx    # çº¢åŒ…å‘é€å¼¹çª—
- TransferModal.tsx       # è½¬è´¦å‘é€å¼¹çª—
- MusicSelectorModal.tsx  # éŸ³ä¹é€‰æ‹©å¼¹çª—
- LocationModal.tsx       # ä½ç½®é€‰æ‹©å¼¹çª—
- CoupleSpaceModal.tsx    # æƒ…ä¾£ç©ºé—´å¼¹çª—
- TokenStatsModal.tsx     # Tokenç»Ÿè®¡å¼¹çª—
- CharacterStatusModal.tsx # è§’è‰²çŠ¶æ€å¼¹çª—
```

### ç¬¬äºŒæ­¥ï¼šæå–ä¸šåŠ¡é€»è¾‘ (Phase 3)

#### 2.1 AIç›¸å…³é€»è¾‘
```typescript
// src/pages/ChatDetail/services/ai/
- promptBuilder.ts        # æç¤ºè¯æ„å»º
  - buildSystemPrompt()
  - buildConversationHistory()
  - buildLorebookContext()
  - buildMemoryContext()

- responseParser.ts       # å“åº”è§£æ
  - parseAIResponse()
  - extractNarrations()
  - extractActions()
  - parseSpecialCommands()

- tokenCounter.ts         # Tokenè®¡æ•°
  - countTokens()
  - calculateTokenStats()
  - checkTokenLimit()
```

#### 2.2 æ¶ˆæ¯å¤„ç†é€»è¾‘
```typescript
// src/pages/ChatDetail/services/message/
- messageBuilder.ts       # æ¶ˆæ¯æ„å»º
  - buildTextMessage()
  - buildTransferMessage()
  - buildRedEnvelopeMessage()
  - buildMusicMessage()

- messageValidator.ts     # æ¶ˆæ¯éªŒè¯
  - validateMessage()
  - canSendMessage()
  - checkBlocked()

- messageProcessor.ts     # æ¶ˆæ¯å¤„ç†
  - processIncomingMessage()
  - processOutgoingMessage()
  - handleSpecialMessage()
```

#### 2.3 æ”¯ä»˜ç›¸å…³é€»è¾‘
```typescript
// src/pages/ChatDetail/services/payment/
- redEnvelopeService.ts   # çº¢åŒ…æœåŠ¡
  - createRedEnvelope()
  - receiveRedEnvelope()
  - checkRedEnvelopeStatus()

- transferService.ts      # è½¬è´¦æœåŠ¡
  - createTransfer()
  - receiveTransfer()
  - checkTransferStatus()

- walletService.ts        # é’±åŒ…æœåŠ¡
  - getBalance()
  - updateBalance()
  - checkSufficientFunds()
```

### ç¬¬ä¸‰æ­¥ï¼šé‡æ„ä¸»ç»„ä»¶ (Phase 4)

#### 3.1 ç®€åŒ–ä¸»ç»„ä»¶ç»“æ„
```typescript
// src/pages/ChatDetail/ChatDetail.tsx (ç›®æ ‡: < 500è¡Œ)

const ChatDetail = () => {
  // 1. ä½¿ç”¨æ‰€æœ‰hooks (çº¦50è¡Œ)
  const { messages, addMessage } = useChatMessages(id)
  const { isAiTyping, startAITyping } = useChatAIState()
  // ... å…¶ä»–hooks
  
  // 2. äº‹ä»¶å¤„ç†å‡½æ•° (çº¦100è¡Œ)
  const handleSend = () => { ... }
  const handleAIReply = () => { ... }
  // ... å…¶ä»–å¤„ç†å‡½æ•°
  
  // 3. å‰¯ä½œç”¨ (çº¦50è¡Œ)
  useEffect(() => { ... }, [])
  
  // 4. æ¸²æŸ“ (çº¦200è¡Œ)
  return (
    <div>
      <ChatHeader ... />
      <MessageList ... />
      <ChatInput ... />
      {/* å„ç§Modal */}
    </div>
  )
}
```

#### 3.2 åˆ›å»ºæœåŠ¡å±‚
```typescript
// src/pages/ChatDetail/services/chatService.ts
export class ChatService {
  async sendMessage(message: Message) { ... }
  async getAIReply(messages: Message[]) { ... }
  async sendRedEnvelope(amount: number) { ... }
  // ... å…¶ä»–æœåŠ¡æ–¹æ³•
}
```

#### 3.3 ä½¿ç”¨ç»„åˆæ¨¡å¼
```typescript
// å°†ç›¸å…³çš„hooksç»„åˆæˆæ›´é«˜çº§çš„hooks
export const useChatCore = (chatId: string) => {
  const messages = useChatMessages(chatId)
  const scroll = useChatScroll(messages.length, chatId)
  const input = useChatInput()
  const ai = useChatAIState()
  
  return { messages, scroll, input, ai }
}
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä»£ç åˆ†å‰²
```typescript
// ä½¿ç”¨React.lazyæ‡’åŠ è½½å¤§å‹ç»„ä»¶
const RedEnvelopeModal = lazy(() => import('./modals/RedEnvelopeModal'))
const MusicSelectorModal = lazy(() => import('./modals/MusicSelectorModal'))
```

### 2. è™šæ‹Ÿæ»šåŠ¨
```typescript
// ä½¿ç”¨react-windowæˆ–react-virtualized
import { FixedSizeList } from 'react-window'

<FixedSizeList
  height={600}
  itemCount={messages.length}
  itemSize={80}
>
  {MessageRow}
</FixedSizeList>
```

### 3. å›¾ç‰‡æ‡’åŠ è½½
```typescript
// ä½¿ç”¨Intersection Observer
const LazyImage = ({ src, alt }) => {
  const [isLoaded, setIsLoaded] = useState(false)
  const imgRef = useRef(null)
  
  useEffect(() => {
    const observer = new IntersectionObserver(...)
    // ...
  }, [])
  
  return <img ref={imgRef} src={isLoaded ? src : placeholder} />
}
```

### 4. é˜²æŠ–å’ŒèŠ‚æµ
```typescript
// å·²å®ç°çš„é˜²æŠ–ä¿å­˜
const debouncedSave = debounce(saveChatMessages, 500)

// å»ºè®®æ·»åŠ çš„èŠ‚æµ
const throttledScroll = throttle(handleScroll, 100)
```

## ğŸ“Š ä»£ç è´¨é‡æå‡

### 1. å•å…ƒæµ‹è¯•
```typescript
// src/pages/ChatDetail/__tests__/
- hooks/
  - useChatMessages.test.ts
  - useChatScroll.test.ts
  - ...
- utils/
  - messageHelpers.test.ts
  - timeHelpers.test.ts
  - ...
- components/
  - ChatHeader.test.tsx
  - MessageBubble.test.tsx
  - ...
```

### 2. é›†æˆæµ‹è¯•
```typescript
// src/pages/ChatDetail/__tests__/integration/
- ChatDetail.integration.test.tsx
- MessageFlow.integration.test.tsx
- AIReply.integration.test.tsx
```

### 3. E2Eæµ‹è¯•
```typescript
// e2e/chatDetail.spec.ts
describe('ChatDetail', () => {
  it('should send message', async () => { ... })
  it('should receive AI reply', async () => { ... })
  it('should send red envelope', async () => { ... })
})
```

## ğŸ¨ UI/UXä¼˜åŒ–å»ºè®®

### 1. åŠ è½½çŠ¶æ€
```typescript
// æ·»åŠ éª¨æ¶å±
<MessageSkeleton count={5} />

// æ·»åŠ åŠ è½½åŠ¨ç”»
<LoadingSpinner />
```

### 2. é”™è¯¯å¤„ç†
```typescript
// æ·»åŠ é”™è¯¯è¾¹ç•Œ
<ErrorBoundary fallback={<ErrorMessage />}>
  <ChatDetail />
</ErrorBoundary>

// æ·»åŠ é”™è¯¯æç¤º
<Toast message="å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•" type="error" />
```

### 3. äº¤äº’åé¦ˆ
```typescript
// æ·»åŠ è§¦è§‰åé¦ˆ
if (navigator.vibrate) {
  navigator.vibrate(50)
}

// æ·»åŠ éŸ³æ•ˆ
const playSound = (type: 'send' | 'receive') => {
  const audio = new Audio(`/sounds/${type}.mp3`)
  audio.play()
}
```

## ğŸ“ æ–‡æ¡£å®Œå–„

### 1. ç»„ä»¶æ–‡æ¡£
```typescript
/**
 * ChatHeader ç»„ä»¶
 * 
 * @description èŠå¤©é¡µé¢å¤´éƒ¨ï¼Œæ˜¾ç¤ºè§’è‰²ä¿¡æ¯å’Œæ“ä½œæŒ‰é’®
 * 
 * @example
 * ```tsx
 * <ChatHeader
 *   character={character}
 *   onBack={() => navigate(-1)}
 *   onMenuClick={() => setShowMenu(true)}
 * />
 * ```
 */
```

### 2. Hookæ–‡æ¡£
```typescript
/**
 * useChatMessages Hook
 * 
 * @description ç®¡ç†èŠå¤©æ¶ˆæ¯çš„CRUDæ“ä½œ
 * 
 * @param chatId - èŠå¤©ID
 * @returns æ¶ˆæ¯åˆ—è¡¨å’Œæ“ä½œæ–¹æ³•
 * 
 * @example
 * ```tsx
 * const { messages, addMessage, deleteMessage } = useChatMessages('chat-1')
 * ```
 */
```

### 3. APIæ–‡æ¡£
```markdown
# ChatDetail API æ–‡æ¡£

## Hooks

### useChatMessages
ç®¡ç†èŠå¤©æ¶ˆæ¯...

### useChatScroll
ç®¡ç†æ¶ˆæ¯æ»šåŠ¨...

## Components

### ChatHeader
èŠå¤©å¤´éƒ¨ç»„ä»¶...

### MessageBubble
æ¶ˆæ¯æ°”æ³¡ç»„ä»¶...
```

## ğŸš€ éƒ¨ç½²ä¼˜åŒ–

### 1. æ„å»ºä¼˜åŒ–
```javascript
// vite.config.ts
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'chat-core': ['./src/pages/ChatDetail/hooks'],
          'chat-ui': ['./src/pages/ChatDetail/components'],
          'chat-utils': ['./src/pages/ChatDetail/utils']
        }
      }
    }
  }
}
```

### 2. ç¼“å­˜ç­–ç•¥
```typescript
// Service Workerç¼“å­˜ç­–ç•¥
workbox.routing.registerRoute(
  /\/api\/chat/,
  new workbox.strategies.NetworkFirst()
)
```

## ğŸ“ˆ ç›‘æ§å’Œåˆ†æ

### 1. æ€§èƒ½ç›‘æ§
```typescript
// ä½¿ç”¨Performance API
const measure = (name: string, fn: Function) => {
  performance.mark(`${name}-start`)
  fn()
  performance.mark(`${name}-end`)
  performance.measure(name, `${name}-start`, `${name}-end`)
}
```

### 2. é”™è¯¯è¿½è¸ª
```typescript
// ä½¿ç”¨Sentryæˆ–ç±»ä¼¼å·¥å…·
Sentry.init({
  dsn: '...',
  integrations: [new BrowserTracing()],
  tracesSampleRate: 1.0
})
```

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§ (ç«‹å³æ‰§è¡Œ)
1. âœ… å®ŒæˆUIç»„ä»¶æ‹†åˆ† (Phase 2)
2. â³ æå–AIä¸šåŠ¡é€»è¾‘ (Phase 3)
3. â³ é‡æ„ä¸»ç»„ä»¶ (Phase 4)

### ä¸­ä¼˜å…ˆçº§ (1-2å‘¨å†…)
1. æ·»åŠ å•å…ƒæµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–ï¼ˆè™šæ‹Ÿæ»šåŠ¨ã€æ‡’åŠ è½½ï¼‰
3. é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ

### ä½ä¼˜å…ˆçº§ (é•¿æœŸä¼˜åŒ–)
1. E2Eæµ‹è¯•
2. æ€§èƒ½ç›‘æ§
3. æ–‡æ¡£å®Œå–„

---

**åˆ›å»ºæ—¶é—´**: 2025-11-02  
**å½“å‰è¿›åº¦**: 56%  
**é¢„è®¡å®Œæˆæ—¶é—´**: Phase 2-4 å®Œæˆåè¾¾åˆ° 90%+

