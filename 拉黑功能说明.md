# 拉黑功能说明

## ✅ 已完成功能

### 1. 拉黑管理系统
- **文件**: `src/utils/blacklistManager.ts`
- **功能**: 
  - 拉黑/取消拉黑用户
  - 检查拉黑状态
  - 数据持久化存储（localStorage）

### 2. 聊天设置中的拉黑开关
- **位置**: 聊天界面右上角 ⋯ → 聊天设置 → 黑名单
- **功能**:
  - 切换拉黑状态
  - 显示当前拉黑状态（🚫 已拉黑 / ✅ 未拉黑）
  - 拉黑后会提示用户

### 3. 消息警告图标
- **位置**: AI消息左侧（白色气泡的消息）
- **显示**: 当AI被拉黑时，**AI发送的消息**左侧会显示红色警告图标 ⚠️
- **提示**: 鼠标悬停显示"此用户已被你拉黑"
- **注意**: 
  - ⚠️ 只在AI消息（左侧白色气泡）显示
  - ✅ 不在用户消息（右侧绿色气泡）显示
  - 如果用户消息显示了警告图标，说明消息的 `blocked` 字段设置错误

### 4. AI拉黑意识
- **提示词系统**: 当用户拉黑AI时，会在AI提示词中添加紧急警告
- **AI行为**: AI会意识到被拉黑，并在回复中提到这件事
- **反应方式**:
  - 震惊质问："你拉黑我？！"
  - 生气反击："行啊，那我也不理你了"
  - 委屈难过："为什么要拉黑我..."
  - 道歉求饶："别拉黑我，我错了"
  - 冷漠无视："随便"

## 📋 使用方法

### 拉黑某个AI角色

1. 进入与该角色的聊天界面
2. 点击右上角的 ⋯ 按钮
3. 在聊天设置页面找到"黑名单"选项
4. 点击开关拉黑该角色
5. 确认提示信息

### 取消拉黑

1. 进入聊天设置
2. 关闭"黑名单"开关
3. 确认取消拉黑

### 查看拉黑效果

1. 拉黑后，让AI回复消息
2. AI的消息左侧会显示 ⚠️ 警告图标
3. AI会在回复中提到被拉黑这件事
4. 刷新页面后，警告图标依然存在

## 🔧 技术实现

### 核心文件

1. **`src/utils/blacklistManager.ts`**
   - 拉黑管理器
   - 提供拉黑/取消拉黑/查询状态等API

2. **`src/utils/prompts.ts`**
   - 添加了 `buildBlacklistPrompt()` 函数
   - 生成拉黑警告提示词

3. **`src/pages/ChatSettings.tsx`**
   - 聊天设置页面
   - 添加了拉黑开关UI

4. **`src/pages/ChatDetail.tsx`**
   - 聊天详情页面
   - 集成拉黑状态检查
   - 在AI调用时添加拉黑提示词

5. **`src/components/MessageItem.tsx`**
   - 消息组件
   - 显示警告图标

6. **`src/types/message.ts`**
   - 消息类型定义
   - 添加了 `blocked` 字段

### 数据存储

- **存储位置**: `localStorage`
- **存储键**: `blacklist_user_[characterId]`
- **数据格式**: JSON数组，包含被拉黑的角色ID列表

### 拉黑检测流程

```
1. 用户点击拉黑按钮
   ↓
2. blacklistManager.toggleBlock('user', characterId)
   ↓
3. 保存到 localStorage
   ↓
4. 更新UI显示状态
   ↓
5. 下次AI回复时：
   - 检查拉黑状态
   - 如果被拉黑，添加警告提示词
   - AI回复会提到被拉黑
   - 消息显示警告图标
```

## ✅ 双重检查机制

### 为什么需要双重检查？

我们实现了**发送时标记 + 渲染时检查**的双重机制：

#### 1. 发送时标记 ✅
```typescript
// AI发送消息时
const aiMessage: Message = {
  ...
  blocked: isAiBlocked  // 标记并保存到localStorage
}
```

**优点：**
- ✅ 消息永久保存blocked状态
- ✅ 刷新页面后依然有效
- ✅ 历史消息也会显示警告

#### 2. 渲染时实时检查 ✅
```typescript
// MessageItem组件中
const isBlocked = () => {
  // 先检查消息的blocked字段
  if (message.blocked) return true
  
  // 实时检查当前拉黑状态（兼容旧消息）
  if (message.type === 'received' && character?.id) {
    const status = blacklistManager.getBlockStatus('user', character.id)
    return status.blockedByMe
  }
  
  return false
}
```

**优点：**
- ✅ 实时反映当前拉黑状态
- ✅ 用户取消拉黑后，旧消息警告消失
- ✅ 兼容没有blocked字段的旧消息

### 双重检查的好处

1. **新消息**：发送时标记 + 渲染时检查 = 100%准确
2. **旧消息**（没有blocked字段）：渲染时检查兜底
3. **取消拉黑**：渲染时检查会取消警告显示
4. **完美兼容**：新旧消息都能正确处理

## 💡 参考实现

本功能参考了 `C:\Users\cl\Desktop\汁汁\宝贝` 项目中的拉黑系统：
- ✅AI拉黑意识-重写完成.md
- ✅拉黑系统-核心Bug修复.md
- ✅拉黑警告图标-完整修复.md

## 🎯 核心特点

1. **持久化存储**: 拉黑状态保存在localStorage，刷新不丢失
2. **AI意识**: AI能够意识到被拉黑，并做出相应反应
3. **视觉提示**: 警告图标清晰标识被拉黑的消息
4. **简单易用**: 一键拉黑/取消拉黑
5. **完全集成**: 无需额外配置，开箱即用

## 📝 注意事项

1. **拉黑是针对角色ID的**，不是会话ID
2. **拉黑状态会影响AI的回复内容**
3. **取消拉黑后，AI会恢复正常回复**
4. **警告图标只在AI消息上显示**，用户消息不显示
5. **AI不会因为用户说"拉黑"就以为被拉黑**
   - 只有系统真正检测到拉黑状态时，AI才会收到【系统警告】
   - 用户只是说"我拉黑你了"不会触发AI的拉黑反应
   - AI只在看到【系统警告：你被拉黑了！】时才会做出反应

## 🐛 常见问题

### Q1: 用户消息显示了警告图标？
**原因**: 消息的 `blocked` 字段被错误设置了  
**解决**: 检查代码，确保只有AI消息（`type: 'received'`）才会设置 `blocked: true`

### Q2: AI误以为自己被拉黑？
**原因**: 用户只是说了"拉黑"这个词，但AI误判了  
**解决**: 已在提示词中强调，只有看到【系统警告】才是真的被拉黑

### Q3: 拉黑后AI还是正常回复？
**原因**: 可能是拉黑状态检查失败  
**解决**: 
1. 检查控制台是否显示"🚨 用户已拉黑AI"
2. 确认 `blacklistManager.getBlockStatus()` 返回正确
3. 刷新页面重试
