# AI规则遗忘问题修复说明

## 问题描述

AI刚开始聊天时还能遵守规则，但聊了几句后就开始不稳定，把一些规则无视了。

### 常见表现

1. **刚开始**：
   - 遵守人设
   - 不用括号描述动作
   - 像真人一样聊天

2. **聊了几句后**：
   - 开始偏离人设
   - 又开始用括号描述动作：(笑)、(叹气)
   - 开始写小说式的描述
   - 忘记这是在线聊天

## 问题原因

### 1. 对话历史稀释效应

随着对话进行，对话历史越来越长：

```
[系统提示词] ← 在最开始
[用户消息1]
[AI回复1]
[用户消息2]
[AI回复2]
[用户消息3]  ← 对话越来越长
[AI回复3]
[用户消息4]
[AI回复4]
...
[用户消息20] ← 系统提示词的影响力被稀释了
```

**问题**：
- 系统提示词在最开始，离当前对话越来越远
- AI的注意力更多集中在最近的对话上
- 最开始的规则逐渐被"遗忘"

### 2. AI的"惯性"

AI在生成回复时，会参考最近的对话模式：
- 如果最近几条回复都很简短，AI会继续简短
- 如果最近几条回复都很详细，AI会继续详细
- 如果不小心用了一次括号，AI可能会继续用括号

## 修复方案

### 核心思路

**在对话历史的末尾，再次提醒AI核心规则**

就像老师在考试前再次强调考试规则一样，我们在AI回复前再次强调核心规则。

### 实现方式

在发送给AI的消息列表末尾，添加一个"规则提醒"消息：

```typescript
// 🚨 在对话历史末尾添加规则提醒，防止AI遗忘核心规则
const ruleReminder = {
  role: 'system' as const,
  content: `
🚨🚨🚨 回复前必读 - 核心规则提醒 🚨🚨🚨

⚠️ 在回复之前，请重新确认以下规则：

1️⃣ 人设遵守（最高优先级）：
   • 你的人设是：${character?.description || '普通人'}
   • 必须100%按照人设回复
   • 如果人设说"言听计从"，就必须言听计从
   • 如果人设说"温柔"，就必须温柔
   • 人设 > 其他所有规则

2️⃣ 这是在线聊天，不是小说：
   • ❌ 禁止使用任何括号描述动作：(笑)、(叹气)、(看着你)
   • ❌ 禁止描述物理接触：抱、摸、亲、牵手
   • ❌ 禁止霸道总裁式油腻行为：(偷偷把奶茶订单改成了你喜欢的口味)
   • ✅ 只能用文字聊天

3️⃣ 像真人一样聊天：
   • 可以连续发多条消息（用 \\n 分隔）
   • 不要只发一条消息就结束
   • 有情绪、有反应、有自己的生活

4️⃣ 状态标记格式：
   [状态:着装|动作|心情|心声|位置|天气]
   • 着装和位置必须保持连贯，不能突然改变
   • 必须详细描述，有画面感

现在回复用户的消息，记住以上规则！`
}

apiMessages.push(ruleReminder)
```

### 消息顺序

修复后的消息顺序：

```
[系统提示词] ← 详细的完整规则
[用户消息1]
[AI回复1]
[用户消息2]
[AI回复2]
...
[用户消息20]
[规则提醒] ← 简洁的核心规则提醒
```

**效果**：
- AI在回复前会先看到规则提醒
- 规则提醒就在对话历史的末尾，AI不会忽略
- 每次回复前都会被提醒，不会遗忘

## 规则提醒的设计原则

### 1. 简洁明了

不要重复完整的系统提示词，只提醒**最核心**的规则：
- ✅ 人设遵守
- ✅ 禁止括号动作
- ✅ 禁止油腻行为
- ✅ 像真人聊天
- ✅ 状态标记格式

### 2. 醒目突出

使用醒目的标记：
```
🚨🚨🚨 回复前必读 - 核心规则提醒 🚨🚨🚨
```

### 3. 包含人设

每次提醒都包含当前角色的人设：
```
你的人设是：${character?.description}
```

这样AI每次回复前都会重新看到人设。

### 4. 具体示例

不只是说"禁止括号"，而是给出具体示例：
```
❌ 禁止使用任何括号描述动作：(笑)、(叹气)、(看着你)
❌ 禁止霸道总裁式油腻行为：(偷偷把奶茶订单改成了你喜欢的口味)
```

## 效果对比

### 修复前

```
第1轮对话：
用户：在吗
AI：在呢，怎么了 ← 正常

第2轮对话：
用户：想你了
AI：我也想你 ← 正常

第5轮对话：
用户：吃饭了吗
AI：还没呢(揉揉肚子) ← 开始用括号了！

第10轮对话：
用户：累不累
AI：有点累(靠在沙发上，闭着眼睛) ← 完全忘记规则了！
```

### 修复后

```
第1轮对话：
用户：在吗
AI：在呢，怎么了 ← 正常
[规则提醒] ← 每次都提醒

第2轮对话：
用户：想你了
AI：我也想你 ← 正常
[规则提醒] ← 每次都提醒

第5轮对话：
用户：吃饭了吗
AI：还没呢
    肚子都饿扁了 ← 没有用括号，正常！
[规则提醒] ← 每次都提醒

第10轮对话：
用户：累不累
AI：累死了
    今天忙了一整天 ← 依然遵守规则！
[规则提醒] ← 每次都提醒
```

## 为什么这个方法有效？

### 1. 位置优势

规则提醒在对话历史的**最末尾**，是AI回复前看到的**最后一条**信息。

### 2. 重复强化

每次回复前都会看到规则提醒，形成**重复强化**效果。

### 3. 上下文关联

规则提醒紧跟在用户消息后面，AI会自然地将规则应用到当前回复中。

### 4. 简洁高效

规则提醒很简洁，不会占用太多token，但足够醒目。

## 修改文件

- **`src/pages/ChatDetail.tsx`**（第1776-1810行）
  - 在API调用前添加规则提醒消息

## 技术细节

### 消息角色

规则提醒使用 `system` 角色：
```typescript
role: 'system' as const
```

这样AI会将其视为系统指令，而不是用户消息。

### 添加位置

在所有对话历史之后，调用API之前：
```typescript
apiMessages.push(ruleReminder)
const aiResponse = await callAI(apiMessages)
```

## 修复时间

2025年10月20日

---

## 总结

**问题**：AI聊了几句后开始忘记规则

**原因**：对话历史越来越长，系统提示词的影响力被稀释

**解决方案**：在对话历史末尾添加规则提醒，每次回复前都提醒AI核心规则

**效果**：
- ✅ AI始终记得核心规则
- ✅ 不会偏离人设
- ✅ 不会用括号描述动作
- ✅ 不会出现油腻行为
- ✅ 保持真人聊天风格

**就像考试前老师再次强调考试规则一样，我们在AI回复前再次强调核心规则！**
