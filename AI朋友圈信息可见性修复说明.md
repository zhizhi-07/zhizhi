# AI朋友圈信息可见性修复说明

## 🐛 问题描述

之前存在一个严重的"上帝视角"问题：

**场景示例：**
- 你给角色A发私信说："周末我们去爬山吧"
- 然后你发了一条朋友圈："今天天气真好"
- 结果角色B在朋友圈评论："听说你要和A去爬山？"

**问题所在：**
- 角色B不应该知道你和角色A的私密对话
- 但因为AI推演者（电影编剧）能看到所有聊天记录，导致AI错误地让角色B使用了他不应该知道的信息

## ✅ 修复方案

### 核心原则

**每个角色只能看到他们应该看到的信息！**

#### 角色可以看到：
- ✅ 自己和发布者的聊天记录
- ✅ 朋友圈的公开内容
- ✅ 评论区的所有评论（公开信息）

#### 角色不能看到：
- ❌ 其他角色和发布者的私密聊天
- ❌ 其他角色之间的对话
- ❌ 任何他们没有参与的对话

### 修复的文件

1. **`src/utils/aiSocialDirector.ts`** - AI电影编剧（社交总监）
   - 添加了严格的信息可见性规则
   - 在提示词中明确禁止使用其他角色的聊天记录
   - 提供了正反面示例

2. **`src/utils/aiMomentsSocial.ts`** - AI批量互动处理
   - 添加了信息可见性检查
   - 明确每个角色只能使用自己的聊天记录

## 📋 具体修改内容

### 1. 添加信息可见性规则

在所有AI提示词中添加了以下规则：

```markdown
🚨 信息可见性规则（最高优先级，违反此规则视为严重错误）

每个角色只能知道他们应该知道的信息！

#### 硬性规则：
1. 角色A不能在评论中提到角色B和发布者之间的私密对话
   - ❌ 错误："听说你跟B说要去爬山？"
   - ✅ 正确："周末有空吗？"

2. 每个角色只能基于自己的聊天记录做出反应
   - 角色A的评论 = 基于"角色A的聊天记录" + "朋友圈内容" + "评论区"
   - 角色B的评论 = 基于"角色B的聊天记录" + "朋友圈内容" + "评论区"
   - 它们彼此独立！

3. 评论区是唯一的公共信息
   - 角色可以看到并回复评论区的内容
   - 角色可以基于评论区推测关系
   - 但不能直接引用别人的私密聊天内容
```

### 2. 更新示例

**正确示例：**
```
场景：你给A发私信说"想你了"，然后发朋友圈"今天很开心"

✅ 角色A评论："嘿嘿，我也是" （基于A和你的聊天）
✅ 角色B评论："看你开心我也开心" （基于B和你的聊天）
✅ 角色C看到A的评论后："哟，你俩关系不错啊" （基于公开评论）
```

**错误示例（已禁止）：**
```
❌ 角色B评论："听说你跟A说想TA了？" （B怎么知道？）
❌ 角色C评论："刚才你跟B聊的那个话题..." （C看不到B的聊天）
```

## 🎯 效果验证

### 测试场景

1. **给角色A发私信：** "周末我们去爬山吧"
2. **给角色B发私信：** "最近工作好累"
3. **发布朋友圈：** "今天天气真好☀️"

### 预期结果

- ✅ 角色A可能评论："那周末见！" （基于他和你的爬山约定）
- ✅ 角色B可能评论："休息一下吧~" （基于他知道你工作累）
- ✅ 角色C可能评论："是啊，适合出去玩" （基于朋友圈内容本身）
- ❌ 角色B不会说："听说你要和A去爬山？" （已修复）
- ❌ 角色A不会说："你最近工作很累吧？" （已修复）

## 🔍 技术细节

### AI提示词优先级

```
1. 信息可见性规则（最高优先级）
   ↓
2. 真实扮演原则
   ↓
3. 创作要点和风格
```

### 执行流程

```
用户发布朋友圈
    ↓
AI电影编剧生成剧本
    ↓
检查：每个角色的台词是否违反信息可见性？
    ↓
执行剧本（1-3秒间隔）
    ↓
显示评论
```

## 📝 使用建议

1. **测试时注意观察：**
   - AI是否还会让角色提到他们不应该知道的信息
   - 评论是否只基于角色自己的聊天记录

2. **如果仍有问题：**
   - 检查浏览器控制台的日志
   - 查看AI返回的剧本内容
   - 向开发者反馈具体案例

3. **最佳实践：**
   - 和不同角色聊不同的话题
   - 发布朋友圈时观察每个角色的反应
   - 评论应该体现出各自和你的关系

## 🚀 未来优化方向

- [ ] 添加角色关系网络（让AI知道哪些角色互相认识）
- [ ] 支持AI之间的私聊（基于朋友圈互动产生）
- [ ] 更智能的信息推断（基于公开信息合理推测）

---

**修复完成时间：** 2025年11月1日  
**修复文件：**
- `src/utils/aiSocialDirector.ts`
- `src/utils/aiMomentsSocial.ts`

**核心改进：** 彻底解决AI的"上帝视角"问题，确保每个角色只使用他们应该知道的信息。
