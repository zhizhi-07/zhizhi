# AI括号动作描述问题修复说明

## 问题描述

AI在没有开启旁白模式的情况下，使用括号描述动作，例如：

```
(66偷偷看了眼时间)
```

这是严重错误的行为！

## 问题分析

### 为什么这是错误的？

1. **这是在线聊天，不是写小说**
   - 真人用手机打字聊天不会写 (笑)、(叹气) 这种东西
   - 这种写法只存在于小说、剧本、角色扮演游戏中

2. **你们不在同一个地方**
   - 在线聊天看不到对方的动作
   - 只能通过文字表达

3. **违反真实感**
   - 破坏了真实聊天的沉浸感
   - 让AI显得很假

### 常见的错误形式

❌ 圆括号：
- (66偷偷看了眼时间)
- (笑)
- (叹气)
- (看了看手机)
- (小心翼翼戳手指)
- (羞愧乱都小本本)

❌ 方括号：
- [叹气]
- [看手机]
- 【偷偷看时间】

❌ 星号：
- *笑*
- *看手机*
- *摇头*

❌ 波浪号：
- ~摇头~
- ~叹气~

## 修复方案

### 1. 添加强力过滤器（最终解决方案）

在 `ChatDetail.tsx` 中添加强力过滤器，直接清除AI回复中的所有括号动作描述：

```typescript
// 🚨 强力清除所有括号动作描述
cleanedResponse = cleanedResponse.replace(/\([^)]*\)/g, '').trim() // 清除 (xxx)
cleanedResponse = cleanedResponse.replace(/（[^）]*）/g, '').trim() // 清除 （xxx）中文括号
cleanedResponse = cleanedResponse.replace(/\*[^*]*\*/g, '').trim() // 清除 *xxx*
cleanedResponse = cleanedResponse.replace(/~[^~]*~/g, '').trim() // 清除 ~xxx~
cleanedResponse = cleanedResponse.replace(/【[^】]*】/g, '').trim() // 清除 【xxx】
// 清理可能产生的多余空行
cleanedResponse = cleanedResponse.replace(/\n\s*\n/g, '\n').trim()
```

这样即使AI还是发了括号动作，也会被自动过滤掉，用户看不到。

### 2. 在prompts.ts中强化禁止规则

在"绝对禁止"部分添加超级醒目的警告：

```
❌ 🚨🚨🚨 使用括号或任何形式描述动作、表情、心理活动！🚨🚨🚨
   例如：(笑)、(叹气)、(小心翼翼戳手指)、(抱住)、(撒娇)
   例如：(66偷偷看了眼时间)、*看了看手机*、【叹气】
   这不是小说！这是在线聊天！你看不到对方，对方也看不到你！
   只能用文字表达，不能描述动作！
```

### 2. 在ChatDetail.tsx中添加超级醒目的警告

在系统提示词的最前面添加：

```
🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨
⚠️ 超级重要：这是在线聊天，不是写小说！⚠️
🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨

❌❌❌ 绝对禁止使用任何括号描述动作！❌❌❌

你是在用手机打字聊天，不是在写小说或剧本！
真人聊天不会写 (笑)、(叹气)、(看了看手机) 这种东西！

❌ 禁止：(66偷偷看了眼时间)
❌ 禁止：(笑)
❌ 禁止：*看手机*
❌ 禁止：【叹气】
❌ 禁止：任何形式的动作描述！

✅ 只发纯文字，像真人一样！
```

### 3. 添加更多具体的错误示例

在禁止括号的部分添加用户遇到的具体例子：

```
❌ (66偷偷看了眼时间) ← 严重错误！
❌ (看了看手机) ← 严重错误！
❌ (撇撇嘴) ← 严重错误！
```

## 正确的表达方式

### 错误 vs 正确

#### 示例1：表达时间

❌ 错误：
```
(66偷偷看了眼时间)
啊已经快九点半了
```

✅ 正确：
```
啊已经快九点半了
```

或者：
```
我看了下时间
啊已经快九点半了
```

#### 示例2：表达情绪

❌ 错误：
```
(笑)哈哈哈笑死我了
```

✅ 正确：
```
哈哈哈笑死我了
```

#### 示例3：表达动作

❌ 错误：
```
(叹气)算了算了
```

✅ 正确：
```
唉...算了算了
```

或者：
```
算了算了
```

#### 示例4：表达犹豫

❌ 错误：
```
(挠头)这个...怎么说呢
```

✅ 正确：
```
这个...怎么说呢
```

或者：
```
嗯...这个怎么说呢
```

## 核心原则

### ✅ 正确理解

1. **这是在线聊天**
   - 用手机打字
   - 只能发文字
   - 看不到对方

2. **像真人一样**
   - 真人不会写括号动作
   - 只用文字表达情绪
   - 用语气词、标点符号

3. **纯文字表达**
   - 用"哈哈哈"表达笑
   - 用"唉..."表达叹气
   - 用"嗯..."表达犹豫

### ❌ 错误理解

1. ~~这是角色扮演游戏~~
2. ~~可以描述动作~~
3. ~~像写小说一样~~

## 旁白模式说明

**注意**：只有在**开启旁白模式**的情况下，AI才可以使用特定格式描述动作：

```
[旁白]66偷偷看了眼时间[/旁白]
```

但这是特殊功能，需要用户主动开启。**默认情况下绝对不能使用任何形式的动作描述！**

## 修改文件

- **`src/utils/prompts.ts`**：强化禁止括号的规则
- **`src/pages/ChatDetail.tsx`**：
  - **添加强力过滤器**：自动清除AI回复中的所有括号动作描述
  - 在系统提示词最前面添加超级醒目的警告
  - 在禁止括号部分添加更多具体示例

## 效果

### 修复前

AI发送：
```
(默默记下你今天心情不好的状态)
(偷偷看了眼你之前最爱喝的奶茶店还在营业)
(小心翼翼发了条语音)
```

用户看到：
```
(默默记下你今天心情不好的状态)
(偷偷看了眼你之前最爱喝的奶茶店还在营业)
(小心翼翼发了条语音)
```

### 修复后

AI发送：
```
(默默记下你今天心情不好的状态)
(偷偷看了眼你之前最爱喝的奶茶店还在营业)
(小心翼翼发了条语音)
```

用户看到：
```
（这些括号内容被过滤掉了，用户看不到）
```

如果AI只发了括号内容，那么这条消息会被完全过滤掉，不会显示空消息。

## 修复时间

2025年10月19日

---

## 总结

**这是在线聊天，不是写小说！**

真人用手机打字聊天不会写 (笑)、(叹气)、(看了看手机) 这种东西。

只发纯文字，像真人一样！
