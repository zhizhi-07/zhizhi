# ğŸ” å…¨åŠŸèƒ½é€»è¾‘é—®é¢˜åˆ†ææŠ¥å‘Š

> **åˆ†ææ—¶é—´**: 2024-11-02  
> **åˆ†æèŒƒå›´**: é™¤æ”¯ä»˜ç³»ç»Ÿå¤–çš„æ‰€æœ‰åŠŸèƒ½æ¨¡å—  
> **é—®é¢˜æ€»æ•°**: 15 ä¸ª

---

## ğŸ“‹ ç›®å½•

1. [æƒ…ä¾£ç©ºé—´åŠŸèƒ½](#1-æƒ…ä¾£ç©ºé—´åŠŸèƒ½)
2. [æœ‹å‹åœˆåŠŸèƒ½](#2-æœ‹å‹åœˆåŠŸèƒ½)
3. [ç¾¤èŠåŠŸèƒ½](#3-ç¾¤èŠåŠŸèƒ½)
4. [è§’è‰²ç®¡ç†åŠŸèƒ½](#4-è§’è‰²ç®¡ç†åŠŸèƒ½)
5. [æ¶ˆæ¯ç®¡ç†åŠŸèƒ½](#5-æ¶ˆæ¯ç®¡ç†åŠŸèƒ½)
6. [AI APIè°ƒç”¨](#6-ai-apiè°ƒç”¨)
7. [å­˜å‚¨ç®¡ç†](#7-å­˜å‚¨ç®¡ç†)

---

## 1. æƒ…ä¾£ç©ºé—´åŠŸèƒ½

### ğŸ”´ é—®é¢˜ 1: æ‹’ç»æƒ…ä¾£ç©ºé—´é‚€è¯·æ²¡æœ‰å¤„ç†é€»è¾‘

**é—®é¢˜æè¿°**:
- ç”¨æˆ·å¯ä»¥æ¥å—æƒ…ä¾£ç©ºé—´é‚€è¯·ï¼ˆ`acceptCoupleSpaceInvite`ï¼‰
- ä½†æ˜¯**æ²¡æœ‰æ‹’ç»é‚€è¯·çš„å‡½æ•°**
- å¦‚æœç”¨æˆ·ä¸æƒ³æ¥å—é‚€è¯·ï¼Œé‚€è¯·ä¼šä¸€ç›´å¤„äº `pending` çŠ¶æ€

**å½±å“**:
- ç”¨æˆ·æ— æ³•æ‹’ç»ä¸æƒ³è¦çš„é‚€è¯·
- é‚€è¯·è®°å½•ä¼šä¸€ç›´å­˜åœ¨ï¼Œæ— æ³•æ¸…ç†
- å¯èƒ½å¯¼è‡´é‡å¤é‚€è¯·è¢«é˜»æ­¢ï¼ˆå› ä¸ºå·²æœ‰ pending çŠ¶æ€çš„é‚€è¯·ï¼‰

**ä½ç½®**:
- `src/utils/coupleSpaceUtils.ts` - ç¼ºå°‘ `rejectCoupleSpaceInvite()` å‡½æ•°
- `src/pages/ChatDetail.tsx` ç¬¬ 6500-6523 è¡Œ - åªæœ‰"æ¥å—"æŒ‰é’®ï¼Œæ²¡æœ‰"æ‹’ç»"æŒ‰é’®

**ä¿®å¤å»ºè®®**:
```typescript
// åœ¨ coupleSpaceUtils.ts ä¸­æ·»åŠ 
export const rejectCoupleSpaceInvite = (characterId: string): boolean => {
  const relation = getCoupleSpaceRelation()
  
  if (!relation || relation.characterId !== characterId) {
    return false
  }
  
  if (relation.status !== 'pending') {
    return false
  }
  
  // åˆ é™¤é‚€è¯·è®°å½•
  localStorage.removeItem('couple_space_relation')
  console.log('æƒ…ä¾£ç©ºé—´é‚€è¯·å·²æ‹’ç»')
  return true
}
```

---

### ğŸŸ¡ é—®é¢˜ 2: æƒ…ä¾£ç©ºé—´è§£é™¤å…³ç³»æ²¡æœ‰æ¸…ç†æ•°æ®

**é—®é¢˜æè¿°**:
- ç”¨æˆ·å¯ä»¥åˆ›å»ºå’Œæ¥å—æƒ…ä¾£ç©ºé—´
- ä½†æ˜¯**æ²¡æœ‰è§£é™¤æƒ…ä¾£ç©ºé—´å…³ç³»çš„å‡½æ•°**
- å¦‚æœç”¨æˆ·æƒ³è§£é™¤å…³ç³»ï¼Œç›¸å…³æ•°æ®ï¼ˆç…§ç‰‡ã€ç•™è¨€ã€çºªå¿µæ—¥ï¼‰ä¸ä¼šè¢«æ¸…ç†

**å½±å“**:
- ç”¨æˆ·æ— æ³•è§£é™¤æƒ…ä¾£ç©ºé—´å…³ç³»
- æ—§çš„æƒ…ä¾£ç©ºé—´æ•°æ®ä¼šä¸€ç›´å­˜åœ¨
- å¯èƒ½å¯¼è‡´ä¸æ–°è§’è‰²å»ºç«‹æƒ…ä¾£ç©ºé—´æ—¶å‡ºç°æ•°æ®æ··ä¹±

**ä½ç½®**:
- `src/utils/coupleSpaceUtils.ts` - ç¼ºå°‘è§£é™¤å…³ç³»å‡½æ•°
- `src/utils/coupleSpaceContentUtils.ts` - ç…§ç‰‡ã€ç•™è¨€ã€çºªå¿µæ—¥æ•°æ®æ²¡æœ‰æ¸…ç†æœºåˆ¶

**ä¿®å¤å»ºè®®**:
```typescript
// åœ¨ coupleSpaceUtils.ts ä¸­æ·»åŠ 
export const dissolveCoupleSpace = (characterId: string): boolean => {
  const relation = getCoupleSpaceRelation()
  
  if (!relation || relation.characterId !== characterId) {
    return false
  }
  
  // æ¸…ç†æ‰€æœ‰ç›¸å…³æ•°æ®
  localStorage.removeItem('couple_space_relation')
  localStorage.removeItem('couple_photos')
  localStorage.removeItem('couple_messages')
  localStorage.removeItem('couple_anniversaries')
  
  console.log('æƒ…ä¾£ç©ºé—´å·²è§£é™¤ï¼Œæ‰€æœ‰æ•°æ®å·²æ¸…ç†')
  return true
}
```

---

## 2. æœ‹å‹åœˆåŠŸèƒ½

### ğŸŸ¡ é—®é¢˜ 3: åˆ é™¤æœ‹å‹åœˆä¸æ¸…ç†ç›¸å…³è¯„è®ºå’Œç‚¹èµ

**é—®é¢˜æè¿°**:
- `deleteMoment()` åªåˆ é™¤æœ‹å‹åœˆæœ¬èº«
- ä½†æ˜¯**ä¸æ¸…ç†ç›¸å…³çš„é€šçŸ¥è®°å½•**ï¼ˆ`moment_notifications`ï¼‰
- åˆ é™¤çš„æœ‹å‹åœˆçš„è¯„è®ºå’Œç‚¹èµé€šçŸ¥ä¼šä¸€ç›´å­˜åœ¨

**å½±å“**:
- é€šçŸ¥åˆ—è¡¨ä¸­ä¼šå‡ºç°å·²åˆ é™¤æœ‹å‹åœˆçš„é€šçŸ¥
- ç‚¹å‡»é€šçŸ¥ä¼šæ‰¾ä¸åˆ°å¯¹åº”çš„æœ‹å‹åœˆ
- é€šçŸ¥æ•°æ®ä¼šæ— é™ç´¯ç§¯

**ä½ç½®**:
- `src/context/MomentsContext.tsx` ç¬¬ 104-106 è¡Œ
- `src/utils/momentsNotification.ts` - æ²¡æœ‰æ¸…ç†é€šçŸ¥çš„é€»è¾‘

**ä¿®å¤å»ºè®®**:
```typescript
const deleteMoment = (id: string) => {
  setMoments(prev => prev.filter(m => m.id !== id))
  
  // æ¸…ç†ç›¸å…³é€šçŸ¥
  const notifications = getMomentNotifications()
  const filtered = notifications.filter(n => n.momentId !== id)
  localStorage.setItem('moment_notifications', JSON.stringify(filtered))
  
  console.log(`å·²åˆ é™¤æœ‹å‹åœˆ ${id} åŠå…¶ç›¸å…³é€šçŸ¥`)
}
```

---

### ğŸŸ¢ é—®é¢˜ 4: æœ‹å‹åœˆ"éƒ¨åˆ†å¯è§"é€»è¾‘å¯èƒ½æœ‰æ¼æ´

**é—®é¢˜æè¿°**:
- ç”¨æˆ·å¯ä»¥è®¾ç½®æœ‹å‹åœˆ"éƒ¨åˆ†å¯è§"ï¼ˆ`visibility: 'partial'`ï¼‰
- ä½†æ˜¯**æ²¡æœ‰æ£€æŸ¥ AI æ˜¯å¦åœ¨å¯è§åˆ—è¡¨ä¸­**å°±å‘é€ç³»ç»Ÿæ¶ˆæ¯
- å¯èƒ½å¯¼è‡´ä¸åœ¨å¯è§åˆ—è¡¨ä¸­çš„ AI ä¹Ÿèƒ½çœ‹åˆ°æœ‹å‹åœˆ

**å½±å“**:
- éšç§è®¾ç½®å¤±æ•ˆ
- ç”¨æˆ·è®¾ç½®çš„"éƒ¨åˆ†å¯è§"æ²¡æœ‰çœŸæ­£ç”Ÿæ•ˆ

**ä½ç½®**:
- `src/pages/PublishMoment.tsx` ç¬¬ 122-150 è¡Œ

**å½“å‰é€»è¾‘**:
```typescript
// ä¸ºæ¯ä¸ªå¯ç”¨AIæœ‹å‹åœˆçš„è§’è‰²æ·»åŠ èŠå¤©è®°å½•
characters.forEach(character => {
  const enabled = localStorage.getItem(`ai_moments_enabled_${character.id}`)
  if (enabled === 'true') {
    // âŒ æ²¡æœ‰æ£€æŸ¥ visibility å’Œ visibleTo
    // ç›´æ¥å‘é€ç³»ç»Ÿæ¶ˆæ¯
  }
})
```

**ä¿®å¤å»ºè®®**:
```typescript
characters.forEach(character => {
  const enabled = localStorage.getItem(`ai_moments_enabled_${character.id}`)
  
  // âœ… æ£€æŸ¥å¯è§æ€§è®¾ç½®
  if (enabled === 'true') {
    if (visibility === 'private') {
      return // ç§å¯†æœ‹å‹åœˆï¼Œä¸é€šçŸ¥ä»»ä½•äºº
    }
    if (visibility === 'partial' && !visibleTo.includes(character.id)) {
      return // ä¸åœ¨å¯è§åˆ—è¡¨ä¸­ï¼Œä¸é€šçŸ¥
    }
    
    // å‘é€ç³»ç»Ÿæ¶ˆæ¯
    // ...
  }
})
```

---

## 3. ç¾¤èŠåŠŸèƒ½

### ğŸ”´ é—®é¢˜ 5: ç¾¤çº¢åŒ…è¿‡æœŸä¸è¿”è¿˜é‡‘é¢

**é—®é¢˜æè¿°**:
- ç¾¤çº¢åŒ…æœ‰ 24 å°æ—¶è¿‡æœŸæœºåˆ¶
- ä½†æ˜¯**æ²¡æœ‰è¿‡æœŸæ£€æŸ¥å’Œé€€æ¬¾é€»è¾‘**
- è¿‡æœŸçš„çº¢åŒ…é‡‘é¢ä¸ä¼šè¿”è¿˜ç»™å‘é€è€…

**å½±å“**:
- ç”¨æˆ·æŸå¤±é‡‘é¢
- ä¸å•èŠçº¢åŒ…çš„é€»è¾‘ä¸ä¸€è‡´

**ä½ç½®**:
- `src/context/GroupRedEnvelopeContext.tsx` - ç¼ºå°‘è¿‡æœŸæ£€æŸ¥
- `src/pages/GroupChatDetail.tsx` - æ²¡æœ‰å®šæ—¶æ£€æŸ¥è¿‡æœŸçº¢åŒ…

**ä¿®å¤å»ºè®®**:
```typescript
// åœ¨ GroupRedEnvelopeContext.tsx ä¸­æ·»åŠ 
export const checkExpiredRedEnvelopes = (): void => {
  const redEnvelopes = getRedEnvelopes()
  const now = Date.now()
  const ONE_DAY = 24 * 60 * 60 * 1000
  
  redEnvelopes.forEach(envelope => {
    if (envelope.status === 'active' && now - envelope.timestamp > ONE_DAY) {
      // è®¡ç®—æœªé¢†å–çš„é‡‘é¢
      const receivedCount = Object.keys(envelope.received).length
      const remainingPackets = envelope.packets.slice(receivedCount)
      const refundAmount = remainingPackets.reduce((sum, amount) => sum + amount, 0)
      
      // è¿”è¿˜ç»™å‘é€è€…
      if (refundAmount > 0) {
        const balance = getBalance()
        setBalance(balance + refundAmount)
        console.log(`çº¢åŒ… ${envelope.id} å·²è¿‡æœŸï¼Œé€€è¿˜ Â¥${refundAmount.toFixed(2)}`)
      }
      
      // æ ‡è®°ä¸ºå·²è¿‡æœŸ
      envelope.status = 'expired'
    }
  })
  
  saveRedEnvelopes(redEnvelopes)
}
```

---

### ğŸŸ¡ é—®é¢˜ 6: ç§»é™¤ç¾¤æˆå‘˜ä¸æ¸…ç†ç›¸å…³æ•°æ®

**é—®é¢˜æè¿°**:
- `removeMember()` åªä»ç¾¤æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤
- ä½†æ˜¯**ä¸æ¸…ç†è¯¥æˆå‘˜çš„çº¢åŒ…é¢†å–è®°å½•**
- è¢«ç§»é™¤çš„æˆå‘˜å·²é¢†å–çš„çº¢åŒ…è®°å½•ä¼šä¸€ç›´å­˜åœ¨

**å½±å“**:
- æ•°æ®ä¸ä¸€è‡´
- çº¢åŒ…è¯¦æƒ…ä¸­ä¼šæ˜¾ç¤ºå·²è¢«ç§»é™¤çš„æˆå‘˜

**ä½ç½®**:
- `src/context/GroupContext.tsx` ç¬¬ 162-172 è¡Œ
- `src/context/GroupRedEnvelopeContext.tsx` - æ²¡æœ‰æ¸…ç†é€»è¾‘

**ä¿®å¤å»ºè®®**:
```typescript
const removeMember = (groupId: string, memberId: string) => {
  setGroups(prev => prev.map(g => {
    if (g.id === groupId) {
      // æ¸…ç†è¯¥æˆå‘˜çš„çº¢åŒ…é¢†å–è®°å½•
      const redEnvelopes = getGroupRedEnvelopes(groupId)
      redEnvelopes.forEach(envelope => {
        if (envelope.received[memberId]) {
          delete envelope.received[memberId]
        }
      })
      saveGroupRedEnvelopes(redEnvelopes)
      
      return {
        ...g,
        members: g.members.filter(m => m.id !== memberId)
      }
    }
    return g
  }))
}
```

---

### ğŸŸ¢ é—®é¢˜ 7: ç¾¤èŠè§£æ•£ä¸æ¸…ç†æ¶ˆæ¯å’Œçº¢åŒ…

**é—®é¢˜æè¿°**:
- `deleteGroup()` åªæ ‡è®°ç¾¤èŠä¸º `disbanded: true`
- ä½†æ˜¯**ä¸æ¸…ç†ç¾¤æ¶ˆæ¯å’Œç¾¤çº¢åŒ…æ•°æ®**
- è§£æ•£çš„ç¾¤èŠæ•°æ®ä¼šä¸€ç›´å ç”¨å­˜å‚¨ç©ºé—´

**å½±å“**:
- å­˜å‚¨ç©ºé—´æµªè´¹
- å¯èƒ½å¯¼è‡´ localStorage è¶…é™

**ä½ç½®**:
- `src/context/GroupContext.tsx` ç¬¬ 134-139 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
const deleteGroup = (id: string) => {
  // æ ‡è®°ä¸ºå·²è§£æ•£
  setGroups(prev => prev.map(g => 
    g.id === id ? { ...g, disbanded: true } : g
  ))
  
  // å¯é€‰ï¼šæ¸…ç†ç¾¤æ¶ˆæ¯å’Œçº¢åŒ…ï¼ˆç»™ç”¨æˆ·é€‰æ‹©ï¼‰
  if (confirm('æ˜¯å¦åŒæ—¶åˆ é™¤ç¾¤èŠè®°å½•å’Œçº¢åŒ…æ•°æ®ï¼Ÿ\n\nåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
    localStorage.removeItem(`group_messages_${id}`)
    // æ¸…ç†ç¾¤çº¢åŒ…
    const allRedEnvelopes = JSON.parse(localStorage.getItem('group_red_envelopes') || '[]')
    const filtered = allRedEnvelopes.filter(e => e.groupId !== id)
    localStorage.setItem('group_red_envelopes', JSON.stringify(filtered))
  }
}
```

---

## 4. è§’è‰²ç®¡ç†åŠŸèƒ½

### ğŸ”´ é—®é¢˜ 8: åˆ é™¤è§’è‰²ä¸æ¸…ç†ç›¸å…³æ•°æ® âš ï¸ **ä¸¥é‡**

**é—®é¢˜æè¿°**:
- `deleteCharacter()` åªä»è§’è‰²åˆ—è¡¨ä¸­åˆ é™¤
- ä½†æ˜¯**ä¸æ¸…ç†ä»¥ä¸‹æ•°æ®**:
  - èŠå¤©è®°å½• (`chat_messages_${id}`)
  - æœ‹å‹åœˆæ•°æ®ï¼ˆè¯¥è§’è‰²å‘å¸ƒçš„æœ‹å‹åœˆï¼‰
  - æƒ…ä¾£ç©ºé—´å…³ç³»
  - äº²å¯†ä»˜å…³ç³»
  - ç¾¤èŠæˆå‘˜è®°å½•
  - ä¸–ç•Œä¹¦å…³è”
  - AI è®°å¿†æ•°æ®
  - æ—¥è®°æ•°æ®
  - ç»­ç«èŠ±æ•°æ®

**å½±å“**:
- **ä¸¥é‡çš„æ•°æ®æ³„æ¼**
- å­˜å‚¨ç©ºé—´å¤§é‡æµªè´¹
- å¯èƒ½å¯¼è‡´ localStorage è¶…é™
- åˆ é™¤è§’è‰²åé‡æ–°åˆ›å»ºåŒåè§’è‰²ä¼šçœ‹åˆ°æ—§æ•°æ®

**ä½ç½®**:
- `src/context/ContactsContext.tsx` ç¬¬ 231-233 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
const deleteCharacter = (id: string) => {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²å—ï¼Ÿ\n\nå°†ä¼šæ¸…é™¤ï¼š\nâ€¢ æ‰€æœ‰èŠå¤©è®°å½•\nâ€¢ TAå‘å¸ƒçš„æœ‹å‹åœˆ\nâ€¢ æƒ…ä¾£ç©ºé—´å…³ç³»\nâ€¢ äº²å¯†ä»˜å…³ç³»\nâ€¢ ç¾¤èŠæˆå‘˜è®°å½•\nâ€¢ æ‰€æœ‰ç›¸å…³æ•°æ®\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
    return
  }
  
  // 1. åˆ é™¤è§’è‰²æœ¬èº«
  setCharacters(prev => prev.filter(c => c.id !== id))
  
  // 2. æ¸…ç†èŠå¤©è®°å½•
  localStorage.removeItem(`chat_messages_${id}`)
  
  // 3. æ¸…ç†æœ‹å‹åœˆ
  const moments = JSON.parse(localStorage.getItem('moments') || '[]')
  const filteredMoments = moments.filter(m => m.userId !== id)
  localStorage.setItem('moments', JSON.stringify(filteredMoments))
  
  // 4. æ¸…ç†æƒ…ä¾£ç©ºé—´
  const coupleSpace = JSON.parse(localStorage.getItem('couple_space_relation') || 'null')
  if (coupleSpace && coupleSpace.characterId === id) {
    localStorage.removeItem('couple_space_relation')
    localStorage.removeItem('couple_photos')
    localStorage.removeItem('couple_messages')
    localStorage.removeItem('couple_anniversaries')
  }
  
  // 5. æ¸…ç†äº²å¯†ä»˜å…³ç³»
  localStorage.removeItem(`intimate_pay_${id}`)
  localStorage.removeItem(`intimate_pay_reverse_${id}`)
  
  // 6. ä»æ‰€æœ‰ç¾¤èŠä¸­ç§»é™¤
  const groups = JSON.parse(localStorage.getItem('groups') || '[]')
  const updatedGroups = groups.map(g => ({
    ...g,
    members: g.members.filter(m => m.id !== id)
  }))
  localStorage.setItem('groups', JSON.stringify(updatedGroups))
  
  // 7. æ¸…ç†ä¸–ç•Œä¹¦å…³è”
  // (éœ€è¦éå†æ‰€æœ‰ä¸–ç•Œä¹¦ï¼Œç§»é™¤è¯¥è§’è‰²ID)
  
  // 8. æ¸…ç†å…¶ä»–æ•°æ®
  localStorage.removeItem(`diaries_${id}`)
  localStorage.removeItem(`memories_${id}`)
  localStorage.removeItem(`memory_summary_${id}`)
  localStorage.removeItem(`streak_data_${id}`)
  localStorage.removeItem(`ai_moments_enabled_${id}`)
  
  console.log(`âœ… è§’è‰² ${id} åŠå…¶æ‰€æœ‰ç›¸å…³æ•°æ®å·²åˆ é™¤`)
}
```

---

## 5. æ¶ˆæ¯ç®¡ç†åŠŸèƒ½

### ğŸŸ¡ é—®é¢˜ 9: åˆ é™¤æ¶ˆæ¯ä¸æ¸…ç†å…³è”çš„çº¢åŒ…/è½¬è´¦æ•°æ®

**é—®é¢˜æè¿°**:
- `handleDeleteMessage()` åªåˆ é™¤æ¶ˆæ¯æœ¬èº«
- ä½†æ˜¯**ä¸æ¸…ç†å…³è”çš„çº¢åŒ…æˆ–è½¬è´¦è®°å½•**
- åˆ é™¤çš„çº¢åŒ…/è½¬è´¦æ¶ˆæ¯å¯¹åº”çš„æ•°æ®ä¼šä¸€ç›´å­˜åœ¨

**å½±å“**:
- æ•°æ®ä¸ä¸€è‡´
- å­˜å‚¨ç©ºé—´æµªè´¹
- å¯èƒ½å¯¼è‡´çº¢åŒ…/è½¬è´¦çŠ¶æ€å¼‚å¸¸

**ä½ç½®**:
- `src/pages/ChatDetail.tsx` ç¬¬ 2261-2286 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
const handleDeleteMessage = () => {
  if (longPressedMessage) {
    if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
      setShowMessageMenu(false)
      setLongPressedMessage(null)
      return
    }
    
    // æ¸…ç†å…³è”æ•°æ®
    if (longPressedMessage.redEnvelopeId) {
      // æ¸…ç†çº¢åŒ…è®°å½•
      const redEnvelopes = JSON.parse(localStorage.getItem('red_envelopes') || '[]')
      const filtered = redEnvelopes.filter(e => e.id !== longPressedMessage.redEnvelopeId)
      localStorage.setItem('red_envelopes', JSON.stringify(filtered))
    }
    
    if (longPressedMessage.transfer) {
      // æ¸…ç†è½¬è´¦è®°å½•ï¼ˆå¦‚æœæœ‰ç‹¬ç«‹å­˜å‚¨ï¼‰
      // ...
    }
    
    // åˆ é™¤æ¶ˆæ¯
    const newMessages = messages.filter(msg => msg.id !== longPressedMessage.id)
    safeSetMessages(newMessages)
    
    if (id) {
      localStorage.setItem(`chat_messages_${id}`, JSON.stringify(newMessages))
    }
    
    console.log('ğŸ—‘ï¸ æ¶ˆæ¯åŠå…³è”æ•°æ®å·²æ°¸ä¹…åˆ é™¤')
    setShowMessageMenu(false)
    setLongPressedMessage(null)
  }
}
```

---

### ğŸŸ¢ é—®é¢˜ 10: æ‰¹é‡åˆ é™¤æ¶ˆæ¯æ€§èƒ½é—®é¢˜

**é—®é¢˜æè¿°**:
- `handleBatchDelete()` ä½¿ç”¨ `filter()` éå†æ‰€æœ‰æ¶ˆæ¯
- å¦‚æœé€‰ä¸­çš„æ¶ˆæ¯å¾ˆå¤šï¼ˆå¦‚ 1000 æ¡ï¼‰ï¼Œæ€§èƒ½ä¼šå¾ˆå·®
- æ²¡æœ‰è¿›åº¦æç¤ºï¼Œç”¨æˆ·å¯èƒ½ä»¥ä¸ºå¡æ­»äº†

**å½±å“**:
- åˆ é™¤å¤§é‡æ¶ˆæ¯æ—¶ç•Œé¢å¡é¡¿
- ç”¨æˆ·ä½“éªŒå·®

**ä½ç½®**:
- `src/pages/ChatDetail.tsx` ç¬¬ 2346-2371 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
const handleBatchDelete = async () => {
  if (selectedMessageIds.size === 0) {
    alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯')
    return
  }
  
  if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedMessageIds.size} æ¡æ¶ˆæ¯å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
    return
  }
  
  // æ˜¾ç¤ºè¿›åº¦æç¤º
  setIsDeleting(true)
  
  try {
    // ä½¿ç”¨ Set æé«˜æŸ¥æ‰¾æ€§èƒ½
    const idsToDelete = new Set(selectedMessageIds)
    
    // åˆ†æ‰¹åˆ é™¤ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
    const batchSize = 100
    let newMessages = [...messages]
    
    for (let i = 0; i < newMessages.length; i += batchSize) {
      const batch = newMessages.slice(i, i + batchSize)
      newMessages = newMessages.filter(msg => !idsToDelete.has(msg.id))
      
      // è®©å‡ºä¸»çº¿ç¨‹
      await new Promise(resolve => setTimeout(resolve, 0))
    }
    
    // ä¿å­˜
    safeSetMessages(newMessages)
    if (id) {
      localStorage.setItem(`chat_messages_${id}`, JSON.stringify(newMessages))
    }
    
    console.log(`ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤äº† ${selectedMessageIds.size} æ¡æ¶ˆæ¯`)
  } finally {
    setIsDeleting(false)
    setIsBatchDeleteMode(false)
    setSelectedMessageIds(new Set())
  }
}
```

---

## 6. AI APIè°ƒç”¨

### ğŸŸ¡ é—®é¢˜ 11: API é‡è¯•å¯èƒ½å¯¼è‡´é‡å¤æ‰£è´¹

**é—®é¢˜æè¿°**:
- `callAI()` æœ‰é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- ä½†æ˜¯**æ²¡æœ‰æ£€æŸ¥ API æ˜¯å¦å·²ç»æˆåŠŸä½†è¿”å›å¤±è´¥**
- å¯èƒ½å¯¼è‡´åŒä¸€ä¸ªè¯·æ±‚è¢«å‘é€å¤šæ¬¡ï¼Œé‡å¤æ‰£è´¹

**å½±å“**:
- ç”¨æˆ· API è´¹ç”¨å¢åŠ 
- å¯èƒ½æ”¶åˆ°é‡å¤çš„ AI å›å¤

**ä½ç½®**:
- `src/utils/api.ts` ç¬¬ 298-347 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
// æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶
const requestCache = new Map<string, Promise<string>>()

export async function callAI(messages: Message[] | string, retries = 1, customMaxTokens?: number): Promise<string> {
  // ç”Ÿæˆè¯·æ±‚æŒ‡çº¹
  const fingerprint = JSON.stringify({ messages, customMaxTokens })
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ç›¸åŒè¯·æ±‚
  if (requestCache.has(fingerprint)) {
    console.log('ğŸ”„ æ£€æµ‹åˆ°é‡å¤è¯·æ±‚ï¼Œä½¿ç”¨ç¼“å­˜ç»“æœ')
    return requestCache.get(fingerprint)!
  }
  
  // åˆ›å»ºè¯·æ±‚ Promise
  const requestPromise = (async () => {
    try {
      // åŸæœ‰çš„ API è°ƒç”¨é€»è¾‘
      // ...
      return result
    } finally {
      // è¯·æ±‚å®Œæˆåæ¸…ç†ç¼“å­˜
      requestCache.delete(fingerprint)
    }
  })()
  
  // ç¼“å­˜è¯·æ±‚
  requestCache.set(fingerprint, requestPromise)
  
  return requestPromise
}
```

---

### ğŸŸ¢ é—®é¢˜ 12: API è¶…æ—¶æ—¶é—´è¿‡çŸ­

**é—®é¢˜æè¿°**:
- `fetchWithTimeout()` é»˜è®¤è¶…æ—¶æ—¶é—´æ˜¯ 15 ç§’
- å¯¹äºå¤æ‚çš„ AI è¯·æ±‚ï¼ˆå¦‚ç”Ÿæˆé•¿æ–‡æœ¬ï¼‰ï¼Œ15 ç§’å¯èƒ½ä¸å¤Ÿ
- è¶…æ—¶åä¼šé‡è¯•ï¼Œä½†å¯èƒ½è¿˜æ˜¯è¶…æ—¶

**å½±å“**:
- å¤æ‚è¯·æ±‚å®¹æ˜“å¤±è´¥
- ç”¨æˆ·ä½“éªŒå·®

**ä½ç½®**:
- `src/utils/api.ts` ç¬¬ 29 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
// æ ¹æ®è¯·æ±‚ç±»å‹åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
async function fetchWithTimeout(
  url: string, 
  options: RequestInit, 
  timeout = 30000 // é»˜è®¤ 30 ç§’
): Promise<Response> {
  // å¦‚æœæ˜¯ç”Ÿæˆå›¾ç‰‡æˆ–é•¿æ–‡æœ¬ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
  const body = options.body ? JSON.parse(options.body as string) : {}
  if (body.max_tokens > 2000) {
    timeout = 60000 // 60 ç§’
  }
  
  const controller = new AbortController()
  const timeoutId = setTimeout(() => controller.abort(), timeout)
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal
    })
    clearTimeout(timeoutId)
    return response
  } catch (error: any) {
    clearTimeout(timeoutId)
    if (error.name === 'AbortError') {
      throw new Error(`è¯·æ±‚è¶…æ—¶ (${timeout}ms)`)
    }
    throw error
  }
}
```

---

## 7. å­˜å‚¨ç®¡ç†

### ğŸ”´ é—®é¢˜ 13: localStorage è¶…é™æ—¶æ²¡æœ‰é™çº§æ–¹æ¡ˆ âš ï¸ **ä¸¥é‡**

**é—®é¢˜æè¿°**:
- `setItem()` åœ¨ localStorage è¶…é™æ—¶ä¼šè‡ªåŠ¨æ¸…ç†
- ä½†æ˜¯**æ¸…ç†åä»ç„¶å¯èƒ½å¤±è´¥**ï¼ˆå¦‚æœæ•°æ®å¤ªå¤§ï¼‰
- æ²¡æœ‰é™çº§åˆ° IndexedDB çš„é€»è¾‘

**å½±å“**:
- æ•°æ®ä¿å­˜å¤±è´¥
- ç”¨æˆ·å¯èƒ½ä¸¢å¤±èŠå¤©è®°å½•
- åº”ç”¨å¯èƒ½å´©æºƒ

**ä½ç½®**:
- `src/utils/storage.ts` ç¬¬ 18-43 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
export const setItem = async (key: string, value: any): Promise<boolean> => {
  const jsonString = JSON.stringify(value)
  
  try {
    localStorage.setItem(key, jsonString)
    return true
  } catch (error) {
    if (error instanceof Error && error.name === 'QuotaExceededError') {
      console.warn('âš ï¸ localStorage è¶…é™ï¼Œå°è¯•è‡ªåŠ¨æ¸…ç†...')
      autoCleanIfNeeded()
      
      try {
        localStorage.setItem(key, jsonString)
        return true
      } catch (retryError) {
        // é™çº§åˆ° IndexedDB
        console.warn('âš ï¸ localStorage ä»ç„¶è¶…é™ï¼Œé™çº§åˆ° IndexedDB')
        try {
          await IDB.setItem(IDB.STORES.FALLBACK, key, value)
          console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ° IndexedDB')
          return true
        } catch (idbError) {
          console.error('âŒ IndexedDB ä¹Ÿå¤±è´¥äº†:', idbError)
          alert('å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼è¯·æ¸…ç†æ•°æ®ã€‚')
          return false
        }
      }
    }
    console.error('Storage error:', error)
    return false
  }
}
```

---

### ğŸŸ¡ é—®é¢˜ 14: è‡ªåŠ¨æ¸…ç†å¯èƒ½åˆ é™¤é‡è¦æ•°æ®

**é—®é¢˜æè¿°**:
- `cleanUnimportantData()` åªæ¸…ç† `temp_`ã€`cache_`ã€`preview_` å¼€å¤´çš„æ•°æ®
- ä½†æ˜¯**æ²¡æœ‰æ£€æŸ¥æ•°æ®çš„é‡è¦æ€§**
- å¯èƒ½è¯¯åˆ ç”¨æˆ·æ­£åœ¨ä½¿ç”¨çš„ä¸´æ—¶æ•°æ®

**å½±å“**:
- ç”¨æˆ·æ­£åœ¨ç¼–è¾‘çš„è‰ç¨¿å¯èƒ½è¢«åˆ é™¤
- ä¸´æ—¶ä¸Šä¼ çš„å›¾ç‰‡å¯èƒ½ä¸¢å¤±

**ä½ç½®**:
- `src/utils/storage.ts` ç¬¬ 46-77 è¡Œ

**ä¿®å¤å»ºè®®**:
```typescript
const cleanUnimportantData = (): void => {
  try {
    console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ç¼“å­˜æ•°æ®')
    
    let cleanedCount = 0
    const now = Date.now()
    const ONE_HOUR = 60 * 60 * 1000
    
    // åªæ¸…ç†è¶…è¿‡ 1 å°æ—¶çš„ç¼“å­˜æ•°æ®
    const cacheKeys = ['temp_', 'cache_', 'preview_']
    for (let i = localStorage.length - 1; i >= 0; i--) {
      const key = localStorage.key(i)
      if (key && cacheKeys.some(prefix => key.startsWith(prefix))) {
        try {
          const data = localStorage.getItem(key)
          if (data) {
            const parsed = JSON.parse(data)
            // æ£€æŸ¥æ—¶é—´æˆ³ï¼Œåªåˆ é™¤æ—§æ•°æ®
            if (parsed.timestamp && now - parsed.timestamp > ONE_HOUR) {
              localStorage.removeItem(key)
              cleanedCount++
              console.log(`ğŸ—‘ï¸ æ¸…ç†è¿‡æœŸç¼“å­˜: ${key}`)
            }
          }
        } catch (e) {
          // æ— æ³•è§£æçš„æ•°æ®ç›´æ¥åˆ é™¤
          localStorage.removeItem(key)
          cleanedCount++
        }
      }
    }
    
    console.log(`âœ… æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç† ${cleanedCount} ä¸ªç¼“å­˜é¡¹`)
  } catch (error) {
    console.error('æ¸…ç†å­˜å‚¨ç©ºé—´å¤±è´¥:', error)
  }
}
```

---

### ğŸŸ¢ é—®é¢˜ 15: IndexedDB æ²¡æœ‰å®šæœŸæ¸…ç†æœºåˆ¶

**é—®é¢˜æè¿°**:
- èŠå¤©è®°å½•ä¼šè‡ªåŠ¨è¿ç§»åˆ° IndexedDB
- ä½†æ˜¯**æ²¡æœ‰å®šæœŸæ¸…ç†æ—§æ•°æ®çš„æœºåˆ¶**
- IndexedDB æ•°æ®ä¼šæ— é™ç´¯ç§¯

**å½±å“**:
- IndexedDB ç©ºé—´å ç”¨è¶Šæ¥è¶Šå¤§
- å¯èƒ½è¾¾åˆ°æµè§ˆå™¨é…é¢é™åˆ¶
- æŸ¥è¯¢æ€§èƒ½ä¸‹é™

**ä½ç½®**:
- `src/utils/indexedDBStorage.ts` - ç¼ºå°‘æ¸…ç†æœºåˆ¶

**ä¿®å¤å»ºè®®**:
```typescript
// æ·»åŠ å®šæœŸæ¸…ç†å‡½æ•°
export async function cleanupOldIndexedDBData(): Promise<void> {
  console.log('ğŸ§¹ å¼€å§‹æ¸…ç† IndexedDB æ—§æ•°æ®...')
  
  const db = await getDB()
  const tx = db.transaction([STORES.CHAT_MESSAGES], 'readwrite')
  const store = tx.objectStore(STORES.CHAT_MESSAGES)
  
  const allChats = await store.getAll()
  
  for (const chat of allChats) {
    if (chat.messages && chat.messages.length > 2000) {
      // åªä¿ç•™æœ€è¿‘ 2000 æ¡æ¶ˆæ¯
      chat.messages = chat.messages.slice(-2000)
      await store.put(chat)
      console.log(`âœ‚ï¸ ${chat.key}: è£å‰ªåˆ° 2000 æ¡æ¶ˆæ¯`)
    }
  }
  
  console.log('âœ… IndexedDB æ¸…ç†å®Œæˆ')
}

// åœ¨åº”ç”¨å¯åŠ¨æ—¶å®šæœŸæ¸…ç†ï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼‰
const CLEANUP_INTERVAL = 7 * 24 * 60 * 60 * 1000 // 7 å¤©
const lastCleanup = localStorage.getItem('last_indexeddb_cleanup')
const now = Date.now()

if (!lastCleanup || now - parseInt(lastCleanup) > CLEANUP_INTERVAL) {
  cleanupOldIndexedDBData().then(() => {
    localStorage.setItem('last_indexeddb_cleanup', now.toString())
  })
}
```

---

## ğŸ“Š é—®é¢˜ä¼˜å…ˆçº§æ€»ç»“

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

1. **åˆ é™¤è§’è‰²ä¸æ¸…ç†ç›¸å…³æ•°æ®** - æ•°æ®æ³„æ¼ï¼Œå­˜å‚¨æµªè´¹
2. **localStorage è¶…é™æ—¶æ²¡æœ‰é™çº§æ–¹æ¡ˆ** - å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
3. **ç¾¤çº¢åŒ…è¿‡æœŸä¸è¿”è¿˜é‡‘é¢** - ç”¨æˆ·æŸå¤±é‡‘é¢
4. **æ‹’ç»æƒ…ä¾£ç©ºé—´é‚€è¯·æ²¡æœ‰å¤„ç†é€»è¾‘** - åŠŸèƒ½ä¸å®Œæ•´

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®å°½å¿«ä¿®å¤ï¼‰

5. æƒ…ä¾£ç©ºé—´è§£é™¤å…³ç³»æ²¡æœ‰æ¸…ç†æ•°æ®
6. åˆ é™¤æœ‹å‹åœˆä¸æ¸…ç†ç›¸å…³è¯„è®ºå’Œç‚¹èµ
7. ç§»é™¤ç¾¤æˆå‘˜ä¸æ¸…ç†ç›¸å…³æ•°æ®
8. åˆ é™¤æ¶ˆæ¯ä¸æ¸…ç†å…³è”çš„çº¢åŒ…/è½¬è´¦æ•°æ®
9. API é‡è¯•å¯èƒ½å¯¼è‡´é‡å¤æ‰£è´¹
10. è‡ªåŠ¨æ¸…ç†å¯èƒ½åˆ é™¤é‡è¦æ•°æ®

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯ä»¥å»¶åä¿®å¤ï¼‰

11. æœ‹å‹åœˆ"éƒ¨åˆ†å¯è§"é€»è¾‘å¯èƒ½æœ‰æ¼æ´
12. ç¾¤èŠè§£æ•£ä¸æ¸…ç†æ¶ˆæ¯å’Œçº¢åŒ…
13. æ‰¹é‡åˆ é™¤æ¶ˆæ¯æ€§èƒ½é—®é¢˜
14. API è¶…æ—¶æ—¶é—´è¿‡çŸ­
15. IndexedDB æ²¡æœ‰å®šæœŸæ¸…ç†æœºåˆ¶

---

## ğŸ¯ ä¿®å¤å»ºè®®

**ç¬¬ä¸€é˜¶æ®µï¼ˆæœ¬å‘¨ï¼‰**:
1. ä¿®å¤åˆ é™¤è§’è‰²ä¸æ¸…ç†æ•°æ®çš„é—®é¢˜
2. æ·»åŠ  localStorage é™çº§åˆ° IndexedDB çš„é€»è¾‘
3. ä¿®å¤ç¾¤çº¢åŒ…è¿‡æœŸé€€æ¬¾é—®é¢˜
4. æ·»åŠ æ‹’ç»æƒ…ä¾£ç©ºé—´é‚€è¯·çš„åŠŸèƒ½

**ç¬¬äºŒé˜¶æ®µï¼ˆä¸‹å‘¨ï¼‰**:
5. å®Œå–„æ•°æ®æ¸…ç†æœºåˆ¶ï¼ˆæœ‹å‹åœˆã€ç¾¤èŠã€æ¶ˆæ¯ï¼‰
6. ä¼˜åŒ– API è°ƒç”¨é€»è¾‘ï¼ˆå»é‡ã€è¶…æ—¶ï¼‰
7. æ”¹è¿›è‡ªåŠ¨æ¸…ç†ç­–ç•¥

**ç¬¬ä¸‰é˜¶æ®µï¼ˆåç»­ï¼‰**:
8. æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‰¹é‡åˆ é™¤ã€æŸ¥è¯¢ï¼‰
9. æ·»åŠ å®šæœŸæ¸…ç†æœºåˆ¶
10. å®Œå–„éšç§è®¾ç½®é€»è¾‘

---

**ä½ æƒ³è®©æˆ‘å…ˆä¿®å¤å“ªäº›é—®é¢˜ï¼Ÿ** æˆ‘å»ºè®®ä¼˜å…ˆä¿®å¤å‰ 4 ä¸ªä¸¥é‡é—®é¢˜ã€‚

