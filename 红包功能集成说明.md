# 红包功能集成说明

## 已完成的工作

### 1. 创建的文件
- ✅ `src/context/RedEnvelopeContext.tsx` - 红包状态管理
- ✅ `src/components/RedEnvelopeCard.tsx` - 红包卡片组件
- ✅ `src/components/RedEnvelopeSender.tsx` - 发红包弹窗
- ✅ `src/components/RedEnvelopeDetail.tsx` - 红包详情弹窗
- ✅ `src/styles/redenvelope.css` - 红包样式（从digital-life复制）
- ✅ `src/App.tsx` - 已添加RedEnvelopeProvider

### 2. ChatDetail.tsx 需要的修改

#### 导入部分（已添加）
```tsx
import RedEnvelopeSender from '../components/RedEnvelopeSender'
import RedEnvelopeDetail from '../components/RedEnvelopeDetail'
import RedEnvelopeCard from '../components/RedEnvelopeCard'
import { useRedEnvelope, generateRedEnvelopeId, RedEnvelope, isRedEnvelopeExpired } from '../context/RedEnvelopeContext'
```

#### Message接口（已更新）
```tsx
interface Message {
  id: number
  type: 'received' | 'sent' | 'system'
  content: string
  time: string
  messageType?: 'text' | 'transfer' | 'system' | 'redenvelope'  // 添加 redenvelope
  transfer?: {
    amount: number
    message: string
    status?: 'pending' | 'received' | 'expired'
  }
  redEnvelopeId?: string  // 新增
  narrations?: {
    type: 'action' | 'thought'
    content: string
  }[]
}
```

#### 状态变量（需要添加到组件内）
```tsx
const { getRedEnvelope, saveRedEnvelope, updateRedEnvelope } = useRedEnvelope()

// 红包相关状态
const [showRedEnvelopeSender, setShowRedEnvelopeSender] = useState(false)
const [showRedEnvelopeDetail, setShowRedEnvelopeDetail] = useState(false)
const [selectedRedEnvelope, setSelectedRedEnvelope] = useState<RedEnvelope | null>(null)
const [canClaimRedEnvelope, setCanClaimRedEnvelope] = useState(false)
```

#### 红包处理函数（需要添加）
```tsx
// 发送红包
const handleSendRedEnvelope = (amount: number, blessing: string) => {
  if (!id) return
  
  const redEnvelope: RedEnvelope = {
    id: generateRedEnvelopeId(),
    amount,
    blessing,
    status: 'pending',
    sender: 'user',
    createdAt: Date.now(),
    claimedBy: null,
    claimedAt: null
  }
  
  saveRedEnvelope(id, redEnvelope)
  
  const message: Message = {
    id: Date.now(),
    type: 'sent',
    content: `[红包]${blessing}`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    messageType: 'redenvelope',
    redEnvelopeId: redEnvelope.id
  }
  
  setMessages(prev => [...prev, message])
  setShowRedEnvelopeSender(false)
}

// 打开红包详情
const handleOpenRedEnvelope = (redEnvelopeId: string) => {
  if (!id) return
  
  const redEnvelope = getRedEnvelope(id, redEnvelopeId)
  if (!redEnvelope) return
  
  const canClaim = redEnvelope.sender === 'ai' && 
                   redEnvelope.status === 'pending' && 
                   !isRedEnvelopeExpired(redEnvelope)
  
  setSelectedRedEnvelope(redEnvelope)
  setCanClaimRedEnvelope(canClaim)
  setShowRedEnvelopeDetail(true)
}

// 领取红包
const handleClaimRedEnvelope = () => {
  if (!id || !selectedRedEnvelope) return
  
  updateRedEnvelope(id, selectedRedEnvelope.id, {
    status: 'claimed',
    claimedBy: '我',
    claimedAt: Date.now()
  })
  
  const systemMessage: Message = {
    id: Date.now(),
    type: 'system',
    content: '你领取了对方的红包',
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    messageType: 'system'
  }
  
  setMessages(prev => [...prev, systemMessage])
  setShowRedEnvelopeDetail(false)
  alert(`已收到¥${selectedRedEnvelope.amount.toFixed(2)}`)
}
```

#### 消息渲染部分（需要在transfer判断前添加）

在 `<div className="max-w-[70%]">` 内的消息渲染部分，在 `message.messageType === 'transfer'` 判断之前添加：

```tsx
{message.messageType === 'redenvelope' && message.redEnvelopeId ? (
  (() => {
    const redEnvelope = getRedEnvelope(id!, message.redEnvelopeId)
    return redEnvelope ? (
      <RedEnvelopeCard
        redEnvelope={redEnvelope}
        onClick={() => handleOpenRedEnvelope(message.redEnvelopeId!)}
      />
    ) : (
      <div className="glass-card rounded-2xl p-4 shadow-lg">
        <span className="text-sm text-gray-500">红包已失效</span>
      </div>
    )
  })()
) : message.messageType === 'transfer' && message.transfer ? (
  // 原有的转账渲染代码...
```

#### ChatMenu 红包按钮（需要修改）

在 `<ChatMenu>` 组件的 `onSelectRedPacket` 中：

```tsx
onSelectRedPacket={() => {
  setShowMenu(false)
  setShowRedEnvelopeSender(true)  // 改为打开红包发送弹窗
}}
```

#### 在组件末尾添加弹窗组件（在 </div> 之前）

```tsx
{/* 红包发送弹窗 */}
<RedEnvelopeSender
  show={showRedEnvelopeSender}
  onClose={() => setShowRedEnvelopeSender(false)}
  onSend={handleSendRedEnvelope}
/>

{/* 红包详情弹窗 */}
<RedEnvelopeDetail
  show={showRedEnvelopeDetail}
  redEnvelope={selectedRedEnvelope}
  canClaim={canClaimRedEnvelope}
  onClose={() => setShowRedEnvelopeDetail(false)}
  onClaim={handleClaimRedEnvelope}
/>
```

## 注意事项

1. **文件已损坏**: `src/pages/ChatDetail.tsx` 在编辑过程中出现语法错误，已创建备份 `ChatDetail.tsx.backup`
2. **需要手动修复**: 请手动将上述代码片段正确集成到 ChatDetail.tsx 中
3. **样式已就绪**: 红包的所有CSS样式都在 `src/styles/redenvelope.css` 中，已从digital-life项目复制
4. **逻辑已重写**: 虽然样式复用，但所有逻辑都用React/TypeScript重写，适配当前项目架构

## 下一步

1. 恢复或重新编辑 `ChatDetail.tsx`，按照上述说明集成红包功能
2. 测试发送红包功能
3. 测试领取红包功能
4. 可选：添加AI自动发送红包的逻辑（在AI回复中检测红包标记）

## 文件位置

- 上下文: `src/context/RedEnvelopeContext.tsx`
- 组件: `src/components/RedEnvelope*.tsx`
- 样式: `src/styles/redenvelope.css`
- 需要修改: `src/pages/ChatDetail.tsx`
