# AI自由对话优化 + 私聊提示样式修复

## 🎯 本次优化内容

### 1. AI自由对话改为事件驱动（重要改进！）

**优化前的问题：**
- ❌ 使用定时器强制触发，每30秒AI就必须聊一次
- ❌ 即使群里没人说话，AI也会自己聊
- ❌ 非常不自然，像是在自言自语

**优化后的逻辑：**
- ✅ **事件驱动**：只有当用户发消息时，AI才可能回应
- ✅ **智能概率**：根据消息类型动态调整回应概率
  * 普通消息：25% 概率回应
  * 红包消息：50% 概率回应
  * @了AI：70% 概率回应
- ✅ **自然延迟**：2-5秒的随机延迟，模拟AI看到消息后思考的时间
- ✅ **避免刷屏**：同一条消息只触发一次，不会重复回应

### 2. 私聊提示显示为系统消息（样式修复）

**优化前：**
- ❌ "方方 私聊了你" 显示为普通消息（黑色，左侧）

**优化后：**
- ✅ "方方 私聊了你" 显示为系统消息（灰色，居中）
- ✅ 与撤回消息样式一致，更清晰

## 📊 AI自由对话触发逻辑详解

### 触发条件

1. **必须开启AI自由对话功能**（群设置中）
2. **必须有新消息**
3. **新消息必须是用户发的**（不是AI或系统消息）
4. **通过随机概率判断**

### 触发概率（智能调整）

```typescript
// 默认 25%
普通文本消息 → 25% 概率回应

// 红包消息 50%
用户发红包 → 50% 概率回应（AI对红包更感兴趣）

// @了AI 70%
用户 @某个AI → 70% 概率回应（被点名了更可能回应）
```

### 触发延迟

```typescript
延迟 2-5 秒后触发
// 模拟AI看到消息后思考的时间，更自然
```

### 防止重复触发

```typescript
// 使用 ref 记录上次触发的消息ID
if (lastTriggeredMessageIdRef.current === lastMessage.id) {
  return // 这条消息已经判断过了，不再触发
}
```

## 🔧 修改的文件

### 1. `src/pages/GroupChatDetail.tsx`

**修改位置1：AI自由对话系统（98-292行）**
```typescript
// 从定时器改为事件驱动
useEffect(() => {
  // 只有当消息数量变化时才触发
  // 根据消息类型智能调整概率
  // 延迟2-5秒后触发
  // 避免重复触发同一条消息
}, [messages.length, ...])  // 依赖 messages.length
```

**修改位置2：私聊提示消息类型（225-241行 和 867-883行）**
```typescript
// 判断是否是私聊提示消息
const isPrivateMessageNotice = messageData.content.includes('私聊了你')

// 设置为系统消息类型
messageType: isPrivateMessageNotice ? 'system' : 'text'
```

## 📝 使用说明

### AI自由对话功能

**如何开启：**
1. 进入群设置
2. 开启"AI自由对话"开关
3. AI会根据用户消息智能回应

**如何关闭：**
1. 进入群设置
2. 关闭"AI自由对话"开关
3. AI不会主动回应，需要点击纸飞机按钮

**行为说明：**
- ✅ AI会在用户发消息后 2-5 秒内可能回应
- ✅ 并不是每次都回应，有随机概率
- ✅ 发红包、@AI时回应概率更高
- ✅ AI不会自己聊，只在有人说话时才可能回应

### 私聊提示消息

**现在的显示效果：**
- 当AI私聊你时，群里会显示灰色居中的提示："方方 私聊了你"
- 与撤回消息样式一致
- 更清晰，不会与普通消息混淆

## 🎉 效果对比

### AI自由对话

**优化前：**
```
[30秒后]
AI1: "大家在吗？"
AI2: "我也不知道说什么..."
AI3: "..."
[30秒后又开始]
AI1: "还在吗？"
...（尴尬的自言自语）
```

**优化后：**
```
用户: "今天好累啊"
[2-3秒后，25%概率]
AI1: "怎么啦"
AI2: "要不要休息一下"
[自然的互动]

用户: "[发了一个红包]"
[3秒后，50%概率]
AI1: "谢谢老板！"
AI2: "手慢了😂"
[更真实的反应]
```

### 私聊提示

**优化前：**
```
[普通消息样式，左侧，黑色]
👤 方方 私聊了你
```

**优化后：**
```
[系统消息样式，居中，灰色]
        方方 私聊了你
```

## ⚠️ 注意事项

1. **AI不会无限对话**
   - 每条消息只触发一次判断
   - AI的回复不会触发其他AI回复
   - 避免了AI之间无限对话的问题

2. **概率是动态的**
   - 普通消息：25%（避免太吵）
   - 红包消息：50%（红包更吸引人）
   - @了AI：70%（被点名更可能回应）

3. **延迟是随机的**
   - 2-5秒的随机延迟
   - 模拟真人看消息后思考的时间
   - 更自然

4. **可以随时关闭**
   - 群设置中可以关闭AI自由对话
   - 关闭后AI不会主动回应
   - 需要点击纸飞机按钮才会回复

---

**优化完成时间**：2024年11月1日

**核心改进**：
- ✅ AI自由对话从定时强制改为事件驱动
- ✅ 智能概率调整，更自然
- ✅ 私聊提示显示为系统消息，样式统一
