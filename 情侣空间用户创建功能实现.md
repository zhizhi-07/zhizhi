# 情侣空间用户创建功能实现指南

## 需求
1. 用户可以在聊天中创建情侣空间内容（照片、留言、纪念日）
2. 照片可以上传本地图片或文字描述
3. 在聊天记录中标注"情侣空间有新上传"
4. AI能看到这些内容

## 实现步骤

### 1. 修改 ChatMenu.tsx
已完成：添加 `hasCoupleSpace` 和 `onSelectCoupleSpaceContent` 参数

### 2. 修改 ChatDetail.tsx

#### 2.1 添加状态变量（第388行附近）
```typescript
// 情侣空间相关状态
const [showCoupleSpaceInviteSender, setShowCoupleSpaceInviteSender] = useState(false)
const [showCoupleSpaceContentModal, setShowCoupleSpaceContentModal] = useState(false)
const [coupleSpaceContentType, setCoupleSpaceContentType] = useState<'photo' | 'message' | 'anniversary' | null>(null)
const [hasCoupleSpaceActive, setHasCoupleSpaceActive] = useState(false)

// 情侣空间内容表单数据
const [couplePhotoDescription, setCouplePhotoDescription] = useState('')
const [couplePhotoFile, setCouplePhotoFile] = useState<string | null>(null)
const [coupleMessageContent, setCoupleMessageContent] = useState('')
const [anniversaryDate, setAnniversaryDate] = useState('')
const [anniversaryTitle, setAnniversaryTitle] = useState('')
const [anniversaryDescription, setAnniversaryDescription] = useState('')
```

#### 2.2 添加useEffect检查情侣空间状态（第850行附近）
```typescript
// 检查情侣空间状态
useEffect(() => {
  const checkCoupleSpaceStatus = async () => {
    if (id) {
      const { hasActiveCoupleSpace } = await import('../utils/coupleSpaceUtils')
      const isActive = hasActiveCoupleSpace(id)
      setHasCoupleSpaceActive(isActive)
    }
  }
  checkCoupleSpaceStatus()
}, [id, messages])
```

#### 2.3 添加处理函数（第1250行handleSendCoupleSpaceInvite之后）
```typescript
// 打开情侣空间内容创建弹窗
const handleOpenCoupleSpaceContent = () => {
  setShowMenu(false)
  setShowCoupleSpaceContentModal(true)
}

// 发送情侣空间照片
const handleSendCouplePhoto = async () => {
  if (!id || !character) return
  if (!couplePhotoDescription.trim() && !couplePhotoFile) return
  
  // 保存到情侣空间数据库
  const { addCouplePhoto } = await import('../utils/coupleSpaceContentUtils')
  const description = couplePhotoDescription.trim() || '照片'
  addCouplePhoto(character.id, currentUser?.name || '我', description, couplePhotoFile || undefined)
  
  // 在聊天中添加系统消息
  const now = Date.now()
  const systemMsg: Message = {
    id: now,
    type: 'system',
    content: `📸 你在情侣空间上传了照片：${description}`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    timestamp: now,
    messageType: 'system',
    isHidden: false // AI可见
  }
  
  setMessages(prev => [...prev, systemMsg])
  
  // 重置表单
  setCouplePhotoDescription('')
  setCouplePhotoFile(null)
  setShowCoupleSpaceContentModal(false)
  setCoupleSpaceContentType(null)
  
  alert('照片已上传到情侣空间！')
}

// 发送情侣空间留言
const handleSendCoupleMessage = async () => {
  if (!id || !character) return
  if (!coupleMessageContent.trim()) return
  
  // 保存到情侣空间数据库
  const { addCoupleMessage } = await import('../utils/coupleSpaceContentUtils')
  addCoupleMessage(character.id, currentUser?.name || '我', coupleMessageContent.trim())
  
  // 在聊天中添加系统消息
  const now = Date.now()
  const systemMsg: Message = {
    id: now,
    type: 'system',
    content: `💌 你在情侣空间留言：${coupleMessageContent.trim()}`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    timestamp: now,
    messageType: 'system',
    isHidden: false // AI可见
  }
  
  setMessages(prev => [...prev, systemMsg])
  
  // 重置表单
  setCoupleMessageContent('')
  setShowCoupleSpaceContentModal(false)
  setCoupleSpaceContentType(null)
  
  alert('留言已发布到情侣空间！')
}

// 发送纪念日
const handleSendAnniversary = async () => {
  if (!id || !character) return
  if (!anniversaryDate || !anniversaryTitle.trim()) return
  
  // 保存到情侣空间数据库
  const { addCoupleAnniversary } = await import('../utils/coupleSpaceContentUtils')
  addCoupleAnniversary(
    character.id, 
    currentUser?.name || '我', 
    anniversaryDate, 
    anniversaryTitle.trim(), 
    anniversaryDescription.trim()
  )
  
  // 在聊天中添加系统消息
  const now = Date.now()
  const systemMsg: Message = {
    id: now,
    type: 'system',
    content: `🎂 你在情侣空间添加了纪念日：${anniversaryTitle.trim()}（${anniversaryDate}）`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    timestamp: now,
    messageType: 'system',
    isHidden: false // AI可见
  }
  
  setMessages(prev => [...prev, systemMsg])
  
  // 重置表单
  setAnniversaryDate('')
  setAnniversaryTitle('')
  setAnniversaryDescription('')
  setShowCoupleSpaceContentModal(false)
  setCoupleSpaceContentType(null)
  
  alert('纪念日已添加到情侣空间！')
}
```

#### 2.4 修改ChatMenu调用（第4419行附近）
```typescript
<ChatMenu
  onClose={() => setShowMenu(false)}
  onSelectImage={handleSelectImage}
  onSelectCamera={handleSelectCamera}
  onSelectRedPacket={() => {
    setShowMenu(false)
    setShowRedEnvelopeSender(true)
  }}
  onSelectTransfer={() => {
    setShowMenu(false)
    setShowTransferSender(true)
  }}
  onSelectIntimatePay={() => {
    setShowMenu(false)
    setShowIntimatePaySender(true)
  }}
  onSelectCoupleSpaceInvite={() => {
    setShowMenu(false)
    setShowCoupleSpaceInviteSender(true)
  }}
  onSelectCoupleSpaceContent={handleOpenCoupleSpaceContent}
  onSelectLocation={handleSelectLocation}
  onSelectVoiceMessage={handleSelectVoice}
  onSelectVoiceCall={() => {
    setShowMenu(false)
    setIsVideoCall(false)
    setCallStartTime(Date.now())
    setShowCallScreen(true)
  }}
  onSelectVideoCall={() => {
    setShowMenu(false)
    setIsVideoCall(true)
    setCallStartTime(Date.now())
    setShowCallScreen(true)
  }}
  hasCoupleSpace={hasCoupleSpaceActive}
/>
```

#### 2.5 添加情侣空间内容创建弹窗UI（第4550行附近，在其他弹窗之后）
```typescript
{/* 情侣空间内容创建弹窗 */}
{showCoupleSpaceContentModal && (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div 
      className="absolute inset-0 bg-black/40 backdrop-blur-sm"
      onClick={() => {
        setShowCoupleSpaceContentModal(false)
        setCoupleSpaceContentType(null)
      }}
    />
    <div className="relative w-full max-w-sm glass-card rounded-3xl p-6 shadow-2xl border border-white/20">
      {!coupleSpaceContentType ? (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">选择创建内容</h3>
          <div className="space-y-3">
            <button
              onClick={() => setCoupleSpaceContentType('photo')}
              className="w-full px-4 py-3 rounded-2xl glass-card border border-white/20 text-gray-900 font-medium ios-button flex items-center gap-3"
            >
              <span className="text-2xl">📸</span>
              <span>上传照片</span>
            </button>
            <button
              onClick={() => setCoupleSpaceContentType('message')}
              className="w-full px-4 py-3 rounded-2xl glass-card border border-white/20 text-gray-900 font-medium ios-button flex items-center gap-3"
            >
              <span className="text-2xl">💌</span>
              <span>发布留言</span>
            </button>
            <button
              onClick={() => setCoupleSpaceContentType('anniversary')}
              className="w-full px-4 py-3 rounded-2xl glass-card border border-white/20 text-gray-900 font-medium ios-button flex items-center gap-3"
            >
              <span className="text-2xl">🎂</span>
              <span>添加纪念日</span>
            </button>
          </div>
          <button
            onClick={() => setShowCoupleSpaceContentModal(false)}
            className="w-full px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button mt-4"
          >
            取消
          </button>
        </>
      ) : coupleSpaceContentType === 'photo' ? (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">📸 上传照片</h3>
          
          {/* 上传本地照片 */}
          <div className="mb-4">
            <label className="block text-sm text-gray-700 mb-2">选择照片（可选）</label>
            <input
              type="file"
              accept="image/*"
              onChange={(e) => {
                const file = e.target.files?.[0]
                if (file) {
                  const reader = new FileReader()
                  reader.onload = (evt) => {
                    setCouplePhotoFile(evt.target?.result as string)
                  }
                  reader.readAsDataURL(file)
                }
              }}
              className="w-full px-3 py-2 border border-gray-300 rounded-xl"
            />
            {couplePhotoFile && (
              <img src={couplePhotoFile} alt="预览" className="mt-2 w-full h-40 object-cover rounded-xl" />
            )}
          </div>
          
          {/* 照片描述 */}
          <div className="mb-4">
            <label className="block text-sm text-gray-700 mb-2">照片描述</label>
            <textarea
              value={couplePhotoDescription}
              onChange={(e) => setCouplePhotoDescription(e.target.value)}
              placeholder="描述这张照片..."
              className="w-full px-3 py-2 border border-gray-300 rounded-xl resize-none"
              rows={3}
            />
          </div>
          
          <div className="flex gap-3">
            <button
              onClick={() => setCoupleSpaceContentType(null)}
              className="flex-1 px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button"
            >
              返回
            </button>
            <button
              onClick={handleSendCouplePhoto}
              className="flex-1 px-4 py-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-medium ios-button shadow-lg"
            >
              上传
            </button>
          </div>
        </>
      ) : coupleSpaceContentType === 'message' ? (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">💌 发布留言</h3>
          
          <textarea
            value={coupleMessageContent}
            onChange={(e) => setCoupleMessageContent(e.target.value)}
            placeholder="写下你想说的话..."
            className="w-full px-3 py-2 border border-gray-300 rounded-xl resize-none mb-4"
            rows={5}
          />
          
          <div className="flex gap-3">
            <button
              onClick={() => setCoupleSpaceContentType(null)}
              className="flex-1 px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button"
            >
              返回
            </button>
            <button
              onClick={handleSendCoupleMessage}
              className="flex-1 px-4 py-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-medium ios-button shadow-lg"
            >
              发布
            </button>
          </div>
        </>
      ) : (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">🎂 添加纪念日</h3>
          
          <div className="space-y-3 mb-4">
            <div>
              <label className="block text-sm text-gray-700 mb-2">日期</label>
              <input
                type="date"
                value={anniversaryDate}
                onChange={(e) => setAnniversaryDate(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-xl"
              />
            </div>
            
            <div>
              <label className="block text-sm text-gray-700 mb-2">标题</label>
              <input
                type="text"
                value={anniversaryTitle}
                onChange={(e) => setAnniversaryTitle(e.target.value)}
                placeholder="例如：第一次见面"
                className="w-full px-3 py-2 border border-gray-300 rounded-xl"
              />
            </div>
            
            <div>
              <label className="block text-sm text-gray-700 mb-2">描述（可选）</label>
              <textarea
                value={anniversaryDescription}
                onChange={(e) => setAnniversaryDescription(e.target.value)}
                placeholder="记录这个特殊的日子..."
                className="w-full px-3 py-2 border border-gray-300 rounded-xl resize-none"
                rows={3}
              />
            </div>
          </div>
          
          <div className="flex gap-3">
            <button
              onClick={() => setCoupleSpaceContentType(null)}
              className="flex-1 px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button"
            >
              返回
            </button>
            <button
              onClick={handleSendAnniversary}
              className="flex-1 px-4 py-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-medium ios-button shadow-lg"
            >
              添加
            </button>
          </div>
        </>
      )}
    </div>
  </div>
)}
```

### 3. 修改 coupleSpaceContentUtils.ts

确保 `addCouplePhoto` 函数支持上传者姓名和本地照片：

```typescript
export const addCouplePhoto = (
  characterId: string, 
  uploaderName: string,
  description: string, 
  imageUrl?: string
): void => {
  const photos = getCouplePhotos()
  const newPhoto: CoupleAlbumPhoto = {
    id: Date.now().toString(),
    characterId,
    uploaderName,
    description,
    imageUrl: imageUrl || '/placeholder-photo.jpg', // 如果有本地照片就用，否则用占位符
    timestamp: Date.now()
  }
  
  photos.unshift(newPhoto)
  localStorage.setItem(STORAGE_KEY_PHOTOS, JSON.stringify(photos))
}
```

## 测试步骤

1. 开启情侣空间
2. 点击聊天菜单的"情侣空间"按钮
3. 选择上传照片/发布留言/添加纪念日
4. 填写内容后提交
5. 查看聊天记录中的系统消息
6. AI回复时能看到情侣空间的新内容

## 注意事项

1. 系统消息的 `isHidden` 设为 false，确保AI能看到
2. 情侣空间内容会同步到情侣空间页面
3. 用户上传的内容会显示上传者姓名
4. 照片可以是本地上传或文字描述
