# æƒ…ä¾£ç©ºé—´ç”¨æˆ·åˆ›å»ºåŠŸèƒ½å®ç°æŒ‡å—

## éœ€æ±‚
1. ç”¨æˆ·å¯ä»¥åœ¨èŠå¤©ä¸­åˆ›å»ºæƒ…ä¾£ç©ºé—´å†…å®¹ï¼ˆç…§ç‰‡ã€ç•™è¨€ã€çºªå¿µæ—¥ï¼‰
2. ç…§ç‰‡å¯ä»¥ä¸Šä¼ æœ¬åœ°å›¾ç‰‡æˆ–æ–‡å­—æè¿°
3. åœ¨èŠå¤©è®°å½•ä¸­æ ‡æ³¨"æƒ…ä¾£ç©ºé—´æœ‰æ–°ä¸Šä¼ "
4. AIèƒ½çœ‹åˆ°è¿™äº›å†…å®¹

## å®ç°æ­¥éª¤

### 1. ä¿®æ”¹ ChatMenu.tsx
å·²å®Œæˆï¼šæ·»åŠ  `hasCoupleSpace` å’Œ `onSelectCoupleSpaceContent` å‚æ•°

### 2. ä¿®æ”¹ ChatDetail.tsx

#### 2.1 æ·»åŠ çŠ¶æ€å˜é‡ï¼ˆç¬¬388è¡Œé™„è¿‘ï¼‰
```typescript
// æƒ…ä¾£ç©ºé—´ç›¸å…³çŠ¶æ€
const [showCoupleSpaceInviteSender, setShowCoupleSpaceInviteSender] = useState(false)
const [showCoupleSpaceContentModal, setShowCoupleSpaceContentModal] = useState(false)
const [coupleSpaceContentType, setCoupleSpaceContentType] = useState<'photo' | 'message' | 'anniversary' | null>(null)
const [hasCoupleSpaceActive, setHasCoupleSpaceActive] = useState(false)

// æƒ…ä¾£ç©ºé—´å†…å®¹è¡¨å•æ•°æ®
const [couplePhotoDescription, setCouplePhotoDescription] = useState('')
const [couplePhotoFile, setCouplePhotoFile] = useState<string | null>(null)
const [coupleMessageContent, setCoupleMessageContent] = useState('')
const [anniversaryDate, setAnniversaryDate] = useState('')
const [anniversaryTitle, setAnniversaryTitle] = useState('')
const [anniversaryDescription, setAnniversaryDescription] = useState('')
```

#### 2.2 æ·»åŠ useEffectæ£€æŸ¥æƒ…ä¾£ç©ºé—´çŠ¶æ€ï¼ˆç¬¬850è¡Œé™„è¿‘ï¼‰
```typescript
// æ£€æŸ¥æƒ…ä¾£ç©ºé—´çŠ¶æ€
useEffect(() => {
  const checkCoupleSpaceStatus = async () => {
    if (id) {
      const { hasActiveCoupleSpace } = await import('../utils/coupleSpaceUtils')
      const isActive = hasActiveCoupleSpace(id)
      setHasCoupleSpaceActive(isActive)
    }
  }
  checkCoupleSpaceStatus()
}, [id, messages])
```

#### 2.3 æ·»åŠ å¤„ç†å‡½æ•°ï¼ˆç¬¬1250è¡ŒhandleSendCoupleSpaceInviteä¹‹åï¼‰
```typescript
// æ‰“å¼€æƒ…ä¾£ç©ºé—´å†…å®¹åˆ›å»ºå¼¹çª—
const handleOpenCoupleSpaceContent = () => {
  setShowMenu(false)
  setShowCoupleSpaceContentModal(true)
}

// å‘é€æƒ…ä¾£ç©ºé—´ç…§ç‰‡
const handleSendCouplePhoto = async () => {
  if (!id || !character) return
  if (!couplePhotoDescription.trim() && !couplePhotoFile) return
  
  // ä¿å­˜åˆ°æƒ…ä¾£ç©ºé—´æ•°æ®åº“
  const { addCouplePhoto } = await import('../utils/coupleSpaceContentUtils')
  const description = couplePhotoDescription.trim() || 'ç…§ç‰‡'
  addCouplePhoto(character.id, currentUser?.name || 'æˆ‘', description, couplePhotoFile || undefined)
  
  // åœ¨èŠå¤©ä¸­æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
  const now = Date.now()
  const systemMsg: Message = {
    id: now,
    type: 'system',
    content: `ğŸ“¸ ä½ åœ¨æƒ…ä¾£ç©ºé—´ä¸Šä¼ äº†ç…§ç‰‡ï¼š${description}`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    timestamp: now,
    messageType: 'system',
    isHidden: false // AIå¯è§
  }
  
  setMessages(prev => [...prev, systemMsg])
  
  // é‡ç½®è¡¨å•
  setCouplePhotoDescription('')
  setCouplePhotoFile(null)
  setShowCoupleSpaceContentModal(false)
  setCoupleSpaceContentType(null)
  
  alert('ç…§ç‰‡å·²ä¸Šä¼ åˆ°æƒ…ä¾£ç©ºé—´ï¼')
}

// å‘é€æƒ…ä¾£ç©ºé—´ç•™è¨€
const handleSendCoupleMessage = async () => {
  if (!id || !character) return
  if (!coupleMessageContent.trim()) return
  
  // ä¿å­˜åˆ°æƒ…ä¾£ç©ºé—´æ•°æ®åº“
  const { addCoupleMessage } = await import('../utils/coupleSpaceContentUtils')
  addCoupleMessage(character.id, currentUser?.name || 'æˆ‘', coupleMessageContent.trim())
  
  // åœ¨èŠå¤©ä¸­æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
  const now = Date.now()
  const systemMsg: Message = {
    id: now,
    type: 'system',
    content: `ğŸ’Œ ä½ åœ¨æƒ…ä¾£ç©ºé—´ç•™è¨€ï¼š${coupleMessageContent.trim()}`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    timestamp: now,
    messageType: 'system',
    isHidden: false // AIå¯è§
  }
  
  setMessages(prev => [...prev, systemMsg])
  
  // é‡ç½®è¡¨å•
  setCoupleMessageContent('')
  setShowCoupleSpaceContentModal(false)
  setCoupleSpaceContentType(null)
  
  alert('ç•™è¨€å·²å‘å¸ƒåˆ°æƒ…ä¾£ç©ºé—´ï¼')
}

// å‘é€çºªå¿µæ—¥
const handleSendAnniversary = async () => {
  if (!id || !character) return
  if (!anniversaryDate || !anniversaryTitle.trim()) return
  
  // ä¿å­˜åˆ°æƒ…ä¾£ç©ºé—´æ•°æ®åº“
  const { addCoupleAnniversary } = await import('../utils/coupleSpaceContentUtils')
  addCoupleAnniversary(
    character.id, 
    currentUser?.name || 'æˆ‘', 
    anniversaryDate, 
    anniversaryTitle.trim(), 
    anniversaryDescription.trim()
  )
  
  // åœ¨èŠå¤©ä¸­æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
  const now = Date.now()
  const systemMsg: Message = {
    id: now,
    type: 'system',
    content: `ğŸ‚ ä½ åœ¨æƒ…ä¾£ç©ºé—´æ·»åŠ äº†çºªå¿µæ—¥ï¼š${anniversaryTitle.trim()}ï¼ˆ${anniversaryDate}ï¼‰`,
    time: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
    timestamp: now,
    messageType: 'system',
    isHidden: false // AIå¯è§
  }
  
  setMessages(prev => [...prev, systemMsg])
  
  // é‡ç½®è¡¨å•
  setAnniversaryDate('')
  setAnniversaryTitle('')
  setAnniversaryDescription('')
  setShowCoupleSpaceContentModal(false)
  setCoupleSpaceContentType(null)
  
  alert('çºªå¿µæ—¥å·²æ·»åŠ åˆ°æƒ…ä¾£ç©ºé—´ï¼')
}
```

#### 2.4 ä¿®æ”¹ChatMenuè°ƒç”¨ï¼ˆç¬¬4419è¡Œé™„è¿‘ï¼‰
```typescript
<ChatMenu
  onClose={() => setShowMenu(false)}
  onSelectImage={handleSelectImage}
  onSelectCamera={handleSelectCamera}
  onSelectRedPacket={() => {
    setShowMenu(false)
    setShowRedEnvelopeSender(true)
  }}
  onSelectTransfer={() => {
    setShowMenu(false)
    setShowTransferSender(true)
  }}
  onSelectIntimatePay={() => {
    setShowMenu(false)
    setShowIntimatePaySender(true)
  }}
  onSelectCoupleSpaceInvite={() => {
    setShowMenu(false)
    setShowCoupleSpaceInviteSender(true)
  }}
  onSelectCoupleSpaceContent={handleOpenCoupleSpaceContent}
  onSelectLocation={handleSelectLocation}
  onSelectVoiceMessage={handleSelectVoice}
  onSelectVoiceCall={() => {
    setShowMenu(false)
    setIsVideoCall(false)
    setCallStartTime(Date.now())
    setShowCallScreen(true)
  }}
  onSelectVideoCall={() => {
    setShowMenu(false)
    setIsVideoCall(true)
    setCallStartTime(Date.now())
    setShowCallScreen(true)
  }}
  hasCoupleSpace={hasCoupleSpaceActive}
/>
```

#### 2.5 æ·»åŠ æƒ…ä¾£ç©ºé—´å†…å®¹åˆ›å»ºå¼¹çª—UIï¼ˆç¬¬4550è¡Œé™„è¿‘ï¼Œåœ¨å…¶ä»–å¼¹çª—ä¹‹åï¼‰
```typescript
{/* æƒ…ä¾£ç©ºé—´å†…å®¹åˆ›å»ºå¼¹çª— */}
{showCoupleSpaceContentModal && (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div 
      className="absolute inset-0 bg-black/40 backdrop-blur-sm"
      onClick={() => {
        setShowCoupleSpaceContentModal(false)
        setCoupleSpaceContentType(null)
      }}
    />
    <div className="relative w-full max-w-sm glass-card rounded-3xl p-6 shadow-2xl border border-white/20">
      {!coupleSpaceContentType ? (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">é€‰æ‹©åˆ›å»ºå†…å®¹</h3>
          <div className="space-y-3">
            <button
              onClick={() => setCoupleSpaceContentType('photo')}
              className="w-full px-4 py-3 rounded-2xl glass-card border border-white/20 text-gray-900 font-medium ios-button flex items-center gap-3"
            >
              <span className="text-2xl">ğŸ“¸</span>
              <span>ä¸Šä¼ ç…§ç‰‡</span>
            </button>
            <button
              onClick={() => setCoupleSpaceContentType('message')}
              className="w-full px-4 py-3 rounded-2xl glass-card border border-white/20 text-gray-900 font-medium ios-button flex items-center gap-3"
            >
              <span className="text-2xl">ğŸ’Œ</span>
              <span>å‘å¸ƒç•™è¨€</span>
            </button>
            <button
              onClick={() => setCoupleSpaceContentType('anniversary')}
              className="w-full px-4 py-3 rounded-2xl glass-card border border-white/20 text-gray-900 font-medium ios-button flex items-center gap-3"
            >
              <span className="text-2xl">ğŸ‚</span>
              <span>æ·»åŠ çºªå¿µæ—¥</span>
            </button>
          </div>
          <button
            onClick={() => setShowCoupleSpaceContentModal(false)}
            className="w-full px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button mt-4"
          >
            å–æ¶ˆ
          </button>
        </>
      ) : coupleSpaceContentType === 'photo' ? (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡</h3>
          
          {/* ä¸Šä¼ æœ¬åœ°ç…§ç‰‡ */}
          <div className="mb-4">
            <label className="block text-sm text-gray-700 mb-2">é€‰æ‹©ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
            <input
              type="file"
              accept="image/*"
              onChange={(e) => {
                const file = e.target.files?.[0]
                if (file) {
                  const reader = new FileReader()
                  reader.onload = (evt) => {
                    setCouplePhotoFile(evt.target?.result as string)
                  }
                  reader.readAsDataURL(file)
                }
              }}
              className="w-full px-3 py-2 border border-gray-300 rounded-xl"
            />
            {couplePhotoFile && (
              <img src={couplePhotoFile} alt="é¢„è§ˆ" className="mt-2 w-full h-40 object-cover rounded-xl" />
            )}
          </div>
          
          {/* ç…§ç‰‡æè¿° */}
          <div className="mb-4">
            <label className="block text-sm text-gray-700 mb-2">ç…§ç‰‡æè¿°</label>
            <textarea
              value={couplePhotoDescription}
              onChange={(e) => setCouplePhotoDescription(e.target.value)}
              placeholder="æè¿°è¿™å¼ ç…§ç‰‡..."
              className="w-full px-3 py-2 border border-gray-300 rounded-xl resize-none"
              rows={3}
            />
          </div>
          
          <div className="flex gap-3">
            <button
              onClick={() => setCoupleSpaceContentType(null)}
              className="flex-1 px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button"
            >
              è¿”å›
            </button>
            <button
              onClick={handleSendCouplePhoto}
              className="flex-1 px-4 py-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-medium ios-button shadow-lg"
            >
              ä¸Šä¼ 
            </button>
          </div>
        </>
      ) : coupleSpaceContentType === 'message' ? (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">ğŸ’Œ å‘å¸ƒç•™è¨€</h3>
          
          <textarea
            value={coupleMessageContent}
            onChange={(e) => setCoupleMessageContent(e.target.value)}
            placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..."
            className="w-full px-3 py-2 border border-gray-300 rounded-xl resize-none mb-4"
            rows={5}
          />
          
          <div className="flex gap-3">
            <button
              onClick={() => setCoupleSpaceContentType(null)}
              className="flex-1 px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button"
            >
              è¿”å›
            </button>
            <button
              onClick={handleSendCoupleMessage}
              className="flex-1 px-4 py-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-medium ios-button shadow-lg"
            >
              å‘å¸ƒ
            </button>
          </div>
        </>
      ) : (
        <>
          <h3 className="text-xl font-bold text-gray-900 mb-4 text-center">ğŸ‚ æ·»åŠ çºªå¿µæ—¥</h3>
          
          <div className="space-y-3 mb-4">
            <div>
              <label className="block text-sm text-gray-700 mb-2">æ—¥æœŸ</label>
              <input
                type="date"
                value={anniversaryDate}
                onChange={(e) => setAnniversaryDate(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-xl"
              />
            </div>
            
            <div>
              <label className="block text-sm text-gray-700 mb-2">æ ‡é¢˜</label>
              <input
                type="text"
                value={anniversaryTitle}
                onChange={(e) => setAnniversaryTitle(e.target.value)}
                placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€æ¬¡è§é¢"
                className="w-full px-3 py-2 border border-gray-300 rounded-xl"
              />
            </div>
            
            <div>
              <label className="block text-sm text-gray-700 mb-2">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
              <textarea
                value={anniversaryDescription}
                onChange={(e) => setAnniversaryDescription(e.target.value)}
                placeholder="è®°å½•è¿™ä¸ªç‰¹æ®Šçš„æ—¥å­..."
                className="w-full px-3 py-2 border border-gray-300 rounded-xl resize-none"
                rows={3}
              />
            </div>
          </div>
          
          <div className="flex gap-3">
            <button
              onClick={() => setCoupleSpaceContentType(null)}
              className="flex-1 px-4 py-3 rounded-full glass-card border border-white/20 text-gray-900 font-medium ios-button"
            >
              è¿”å›
            </button>
            <button
              onClick={handleSendAnniversary}
              className="flex-1 px-4 py-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-medium ios-button shadow-lg"
            >
              æ·»åŠ 
            </button>
          </div>
        </>
      )}
    </div>
  </div>
)}
```

### 3. ä¿®æ”¹ coupleSpaceContentUtils.ts

ç¡®ä¿ `addCouplePhoto` å‡½æ•°æ”¯æŒä¸Šä¼ è€…å§“åå’Œæœ¬åœ°ç…§ç‰‡ï¼š

```typescript
export const addCouplePhoto = (
  characterId: string, 
  uploaderName: string,
  description: string, 
  imageUrl?: string
): void => {
  const photos = getCouplePhotos()
  const newPhoto: CoupleAlbumPhoto = {
    id: Date.now().toString(),
    characterId,
    uploaderName,
    description,
    imageUrl: imageUrl || '/placeholder-photo.jpg', // å¦‚æœæœ‰æœ¬åœ°ç…§ç‰‡å°±ç”¨ï¼Œå¦åˆ™ç”¨å ä½ç¬¦
    timestamp: Date.now()
  }
  
  photos.unshift(newPhoto)
  localStorage.setItem(STORAGE_KEY_PHOTOS, JSON.stringify(photos))
}
```

## æµ‹è¯•æ­¥éª¤

1. å¼€å¯æƒ…ä¾£ç©ºé—´
2. ç‚¹å‡»èŠå¤©èœå•çš„"æƒ…ä¾£ç©ºé—´"æŒ‰é’®
3. é€‰æ‹©ä¸Šä¼ ç…§ç‰‡/å‘å¸ƒç•™è¨€/æ·»åŠ çºªå¿µæ—¥
4. å¡«å†™å†…å®¹åæäº¤
5. æŸ¥çœ‹èŠå¤©è®°å½•ä¸­çš„ç³»ç»Ÿæ¶ˆæ¯
6. AIå›å¤æ—¶èƒ½çœ‹åˆ°æƒ…ä¾£ç©ºé—´çš„æ–°å†…å®¹

## æ³¨æ„äº‹é¡¹

1. ç³»ç»Ÿæ¶ˆæ¯çš„ `isHidden` è®¾ä¸º falseï¼Œç¡®ä¿AIèƒ½çœ‹åˆ°
2. æƒ…ä¾£ç©ºé—´å†…å®¹ä¼šåŒæ­¥åˆ°æƒ…ä¾£ç©ºé—´é¡µé¢
3. ç”¨æˆ·ä¸Šä¼ çš„å†…å®¹ä¼šæ˜¾ç¤ºä¸Šä¼ è€…å§“å
4. ç…§ç‰‡å¯ä»¥æ˜¯æœ¬åœ°ä¸Šä¼ æˆ–æ–‡å­—æè¿°
