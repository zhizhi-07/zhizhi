# 论坛功能 - 开发维护指南

## 📖 目录

1. [快速开始](#快速开始)
2. [文件说明](#文件说明)
3. [开发规范](#开发规范)
4. [常见任务](#常见任务)
5. [问题排查](#问题排查)
6. [性能优化](#性能优化)

---

## 快速开始

### 启动项目

```bash
npm run dev
```

访问：`http://localhost:3001/zhizhi/`

### 访问论坛

1. 进入桌面页面
2. 向左滑动到第二页
3. 点击"论坛"图标

---

## 文件说明

### 核心文件

```
src/
├── types/forum.ts              # 类型定义 - 所有接口和枚举
├── utils/forumStorage.ts       # 数据存储 - localStorage封装
├── context/ForumContext.tsx    # 状态管理 - Context + Provider
└── pages/
    ├── Forum.tsx               # 论坛主页
    ├── ForumPublish.tsx        # 发帖页面
    ├── ForumPostDetail.tsx     # 帖子详情
    └── ForumSearch.tsx         # 搜索页面
```

### 各文件职责

| 文件 | 职责 | 依赖关系 |
|------|------|---------|
| `types/forum.ts` | 类型定义 | 无依赖 |
| `forumStorage.ts` | 数据操作 | 依赖 types/forum.ts |
| `ForumContext.tsx` | 状态管理 | 依赖 forumStorage + types |
| `Forum.tsx` | 主页UI | 依赖 ForumContext |
| `ForumPublish.tsx` | 发帖UI | 依赖 ForumContext |
| `ForumPostDetail.tsx` | 详情UI | 依赖 ForumContext |
| `ForumSearch.tsx` | 搜索UI | 依赖 ForumContext |

---

## 开发规范

### 1. 命名规范

#### 文件命名
- 组件文件：`PascalCase.tsx` (如 `ForumPublish.tsx`)
- 工具文件：`camelCase.ts` (如 `forumStorage.ts`)
- 类型文件：`camelCase.ts` (如 `forum.ts`)

#### 变量命名
```typescript
// 组件：PascalCase
const ForumPost: React.FC = () => {}

// 函数：camelCase
const handleLike = () => {}

// 常量：UPPER_CASE
const MAX_IMAGES = 9

// 接口：PascalCase + I前缀（可选）
interface ForumPost {}

// 枚举：PascalCase
enum PostType {}
```

### 2. 代码组织

每个文件按以下顺序组织：

```typescript
// 1. 文件头注释
/**
 * 文件说明
 */

// 2. 导入语句
import { useState } from 'react'
import type { ForumPost } from '../types/forum'

// 3. 类型定义（如果需要）
interface ComponentProps {}

// 4. 常量定义
const MAX_LENGTH = 100

// 5. 主组件/函数
const Component = () => {
  // 5.1 状态定义
  const [state, setState] = useState()
  
  // 5.2 副作用
  useEffect(() => {}, [])
  
  // 5.3 事件处理
  const handleClick = () => {}
  
  // 5.4 渲染函数
  const renderItem = () => {}
  
  // 5.5 主渲染
  return <div>...</div>
}

// 6. 导出
export default Component
```

### 3. 注释规范

#### 函数注释
```typescript
/**
 * 函数说明
 * 
 * @param paramName - 参数说明
 * @returns 返回值说明
 * 
 * @example
 * ```typescript
 * const result = functionName('value')
 * ```
 */
function functionName(paramName: string): boolean {
  // 实现
}
```

#### 代码块注释
```typescript
// ==================== 模块名称 ====================
// 单行说明
const code = 'here'
```

### 4. TypeScript规范

#### 类型导入
```typescript
// 使用 type 关键字导入类型
import type { ForumPost } from '../types/forum'

// 默认导入不需要 type
import { useForum } from '../context/ForumContext'
```

#### 避免 any
```typescript
// ❌ 不好
const data: any = {}

// ✅ 好
const data: ForumPost = {}
const data: unknown = {} // 如果真的不知道类型
```

#### 可选链
```typescript
// ✅ 使用可选链
post.tags?.map(tag => ...)

// ✅ 使用空值合并
const count = post.likeCount ?? 0
```

---

## 常见任务

### 任务1：添加新字段到帖子

#### 步骤1：更新类型定义

`src/types/forum.ts`:
```typescript
export interface ForumPost {
  // ... 现有字段
  newField?: string  // 新字段（可选）
}
```

#### 步骤2：更新存储逻辑

`src/utils/forumStorage.ts`:
```typescript
export function addPost(post: Omit<ForumPost, 'id' | 'timestamp'>): ForumPost {
  const newPost: ForumPost = {
    ...post,
    id: generateId(),
    timestamp: Date.now(),
    newField: post.newField || '', // 处理新字段
    // ... 其他字段
  }
  // ...
}
```

#### 步骤3：更新UI

`src/pages/Forum.tsx`:
```typescript
{post.newField && (
  <div>{post.newField}</div>
)}
```

### 任务2：添加新的交互功能

#### 步骤1：在 Storage 层添加函数

`src/utils/forumStorage.ts`:
```typescript
/**
 * 新功能说明
 */
export function newFeature(param: string): boolean {
  // 实现逻辑
  return true
}
```

#### 步骤2：在 Context 中封装

`src/context/ForumContext.tsx`:
```typescript
// 在接口中添加
interface ForumContextType {
  // ...
  newFeature: (param: string) => boolean
}

// 在 Provider 中实现
const newFeature = useCallback((param: string) => {
  try {
    const result = forumStorage.newFeature(param)
    // 更新状态
    return result
  } catch (error) {
    console.error('操作失败:', error)
    return false
  }
}, [])

// 在 value 中导出
const value: ForumContextType = {
  // ...
  newFeature,
}
```

#### 步骤3：在组件中使用

`src/pages/Forum.tsx`:
```typescript
const { newFeature } = useForum()

const handleClick = () => {
  newFeature('参数')
}
```

### 任务3：添加新页面

#### 步骤1：创建页面文件

`src/pages/ForumNewPage.tsx`:
```typescript
import { useNavigate } from 'react-router-dom'
import { useForum } from '../context/ForumContext'

const ForumNewPage = () => {
  const navigate = useNavigate()
  const { posts } = useForum()
  
  return (
    <div>
      {/* 页面内容 */}
    </div>
  )
}

export default ForumNewPage
```

#### 步骤2：添加路由

`src/App.tsx`:
```typescript
// 1. 懒加载导入
const ForumNewPage = lazy(() => import('./pages/ForumNewPage'))

// 2. 添加路由
<Route path="/forum/new-page" element={<PageWrapper><ForumNewPage /></PageWrapper>} />
```

#### 步骤3：添加导航

在需要跳转的地方：
```typescript
navigate('/forum/new-page')
```

---

## 问题排查

### 问题1：数据不显示

**可能原因**：
1. ForumProvider 没有正确包裹
2. localStorage 数据损坏
3. 类型不匹配

**排查步骤**：
```typescript
// 1. 检查 Provider
// src/App.tsx 确保有：
<ForumProvider>
  <Routes>...</Routes>
</ForumProvider>

// 2. 检查数据
console.log(forumStorage.getPosts())

// 3. 清空数据重新初始化
forumStorage.clearAllForumData()
// 刷新页面
```

### 问题2：点赞不生效

**排查步骤**：
```typescript
// 1. 检查 Context 是否正确使用
const { toggleLike } = useForum()

// 2. 检查函数调用
const handleLike = (postId: string) => {
  console.log('点赞帖子:', postId)
  const result = toggleLike(postId)
  console.log('点赞结果:', result)
}

// 3. 检查 localStorage
const likes = localStorage.getItem('forum_likes')
console.log('点赞列表:', likes)
```

### 问题3：路由跳转失败

**排查步骤**：
```typescript
// 1. 检查路由是否注册
// src/App.tsx 中查找对应路由

// 2. 检查路径是否正确
navigate('/forum/publish') // ✅ 正确
navigate('forum/publish')  // ❌ 错误（缺少/）

// 3. 检查是否在 Router 内部
// 必须在 <Router> 组件内部才能使用 navigate
```

### 问题4：TypeScript 错误

**常见错误**：

```typescript
// 错误：类型不匹配
const post: ForumPost = { ... } // ❌ 缺少必需字段

// 解决：使用正确的类型
const post: Partial<ForumPost> = { ... } // ✅

// 错误：参数类型错误
toggleLike(123) // ❌ 应该是 string

// 解决：使用正确类型
toggleLike('123') // ✅
```

---

## 性能优化

### 1. 虚拟滚动（长列表）

安装依赖：
```bash
npm install react-window
```

使用：
```typescript
import { FixedSizeList } from 'react-window'

<FixedSizeList
  height={window.innerHeight - 200}
  itemCount={posts.length}
  itemSize={200}
  width="100%"
>
  {({ index, style }) => (
    <div style={style}>
      {renderPost(posts[index])}
    </div>
  )}
</FixedSizeList>
```

### 2. 图片懒加载

```typescript
// 方案1：原生 loading 属性
<img src={url} loading="lazy" alt="图片" />

// 方案2：Intersection Observer
const imgRef = useRef<HTMLImageElement>(null)

useEffect(() => {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target as HTMLImageElement
        img.src = img.dataset.src || ''
        observer.unobserve(img)
      }
    })
  })
  
  if (imgRef.current) {
    observer.observe(imgRef.current)
  }
  
  return () => observer.disconnect()
}, [])
```

### 3. 防抖和节流

```typescript
import { useMemo } from 'react'

// 防抖（搜索）
const debouncedSearch = useMemo(() => {
  let timer: NodeJS.Timeout
  return (keyword: string) => {
    clearTimeout(timer)
    timer = setTimeout(() => {
      performSearch(keyword)
    }, 300)
  }
}, [])

// 节流（滚动）
const throttledScroll = useMemo(() => {
  let lastRun = 0
  return () => {
    const now = Date.now()
    if (now - lastRun >= 100) {
      lastRun = now
      handleScroll()
    }
  }
}, [])
```

### 4. 组件优化

```typescript
import { memo } from 'react'

// 使用 memo 避免不必要的重渲染
const ForumPostItem = memo(({ post }: { post: ForumPost }) => {
  return <div>...</div>
}, (prevProps, nextProps) => {
  // 自定义比较函数
  return prevProps.post.id === nextProps.post.id &&
         prevProps.post.isLiked === nextProps.post.isLiked
})
```

---

## 数据管理

### LocalStorage 结构

```javascript
{
  "forum_posts": [...],           // 帖子列表
  "forum_comments": [...],        // 评论列表
  "forum_drafts": [...],          // 草稿箱
  "forum_favorites": ["id1"...],  // 收藏ID
  "forum_likes": ["id1"...],      // 点赞ID
}
```

### 数据清理

```typescript
// 清空所有论坛数据
import { clearAllForumData } from '../utils/forumStorage'
clearAllForumData()

// 清空特定数据
localStorage.removeItem('forum_posts')
```

### 数据备份

```typescript
// 导出数据
import { exportAllData } from '../utils/forumStorage'
const backup = exportAllData()
console.log(backup) // 复制保存

// 导入数据
import { importData } from '../utils/forumStorage'
importData(backupString)
```

---

## 扩展开发

### 添加视频支持

1. **更新发布页面**

`src/pages/ForumPublish.tsx`:
```typescript
const [videoUrl, setVideoUrl] = useState('')

const handleVideoSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  if (!file) return
  
  // 创建本地预览URL
  const url = URL.createObjectURL(file)
  setVideoUrl(url)
}
```

2. **更新帖子渲染**

`src/pages/Forum.tsx`:
```typescript
{post.videoUrl && (
  <video
    src={post.videoUrl}
    controls
    className="w-full rounded-lg mt-2"
    poster={post.videoThumb}
  />
)}
```

### 添加转发功能

1. **存储层**

`src/utils/forumStorage.ts`:
```typescript
export function sharePost(postId: string): ForumPost | null {
  const post = getPostById(postId)
  if (!post) return null
  
  // 创建转发帖子
  const sharedPost = addPost({
    ...post,
    forwardFrom: post,
    shareCount: post.shareCount + 1
  })
  
  // 更新原帖转发数
  updatePost(postId, {
    shareCount: post.shareCount + 1
  })
  
  return sharedPost
}
```

2. **Context层**

`src/context/ForumContext.tsx`:
```typescript
const sharePost = useCallback((postId: string) => {
  try {
    const result = forumStorage.sharePost(postId)
    if (result) {
      setPosts(prev => [result, ...prev])
    }
    return result
  } catch (error) {
    console.error('转发失败:', error)
    return null
  }
}, [])
```

3. **UI层**

`src/pages/Forum.tsx`:
```typescript
const { sharePost } = useForum()

const handleShare = (postId: string) => {
  sharePost(postId)
}
```

---

## 最佳实践

### 1. 错误处理

```typescript
// ✅ 好的做法
try {
  const result = await someAsyncFunction()
  if (!result) {
    throw new Error('操作失败')
  }
  // 成功处理
} catch (error) {
  console.error('详细错误信息:', error)
  setError('用户友好的错误提示')
}

// ❌ 不好的做法
const result = await someAsyncFunction() // 没有错误处理
```

### 2. 状态更新

```typescript
// ✅ 使用函数式更新
setPosts(prev => [...prev, newPost])

// ❌ 直接更新（可能丢失并发更新）
setPosts([...posts, newPost])
```

### 3. 性能优化

```typescript
// ✅ 使用 useCallback
const handleClick = useCallback(() => {
  // 处理逻辑
}, [dependencies])

// ✅ 使用 useMemo
const filteredPosts = useMemo(() => {
  return posts.filter(post => post.isLiked)
}, [posts])
```

### 4. 可访问性

```typescript
// ✅ 添加语义化标签
<button aria-label="点赞">
  <LikeIcon />
</button>

// ✅ 添加键盘支持
<div
  role="button"
  tabIndex={0}
  onKeyPress={(e) => e.key === 'Enter' && handleClick()}
  onClick={handleClick}
>
  ...
</div>
```

---

## 调试技巧

### 1. 查看 Context 状态

```typescript
const forumState = useForum()
console.log('论坛状态:', forumState)
```

### 2. 查看 LocalStorage

```javascript
// 在浏览器控制台
localStorage.getItem('forum_posts')
JSON.parse(localStorage.getItem('forum_posts'))
```

### 3. React DevTools

1. 安装 React DevTools 扩展
2. 查看组件树
3. 查看 Context 值
4. 查看 Props 和 State

### 4. 性能分析

```typescript
// 添加性能标记
console.time('loadPosts')
await loadPosts()
console.timeEnd('loadPosts')
```

---

## 部署清单

### 上线前检查

- [ ] 所有 TypeScript 错误已修复
- [ ] 所有 ESLint 警告已处理
- [ ] 所有功能已测试
- [ ] 已测试不同屏幕尺寸
- [ ] 已测试网络慢速情况
- [ ] 已添加错误边界
- [ ] 已优化图片大小
- [ ] 已测试数据量大的情况

### 性能指标

目标：
- 首屏加载 < 2s
- 点赞响应 < 100ms
- 列表滚动 60fps
- 搜索响应 < 300ms

---

## 常见问题

### Q1: 如何添加更多模拟数据？

A: 编辑 `src/utils/forumStorage.ts` 的 `initializeMockData()` 函数，添加更多帖子到 `mockPosts` 数组。

### Q2: 如何修改主题色？

A: 全局搜索 `#ff6c00` 和 `#ff8140`，替换为你的颜色。

### Q3: 如何禁用某个功能？

A: 在对应的按钮上添加 `disabled` 属性或条件渲染。

### Q4: 如何集成后端API？

A: 创建 `src/utils/forumApi.ts`，在 `ForumContext.tsx` 中替换 `forumStorage` 调用为 API 调用。

### Q5: 如何添加图片压缩？

A: 在图片上传时使用 `browser-image-compression`:
```typescript
import imageCompression from 'browser-image-compression'

const compressedFile = await imageCompression(file, {
  maxSizeMB: 1,
  maxWidthOrHeight: 1920
})
```

---

## 维护日志模板

```markdown
## 2025-10-29

### 新增功能
- [ ] 添加了XXX功能

### Bug修复
- [ ] 修复了XXX问题

### 性能优化
- [ ] 优化了XXX性能

### 重构
- [ ] 重构了XXX模块
```

---

## 联系方式

- **技术文档**: `论坛功能-完整架构文档.md`
- **快速开始**: `论坛功能-快速开始.md`
- **本文档**: `论坛功能-开发维护指南.md`

---

**文档版本**: v1.0  
**更新日期**: 2025-10-29  
**适用版本**: Forum v1.0


