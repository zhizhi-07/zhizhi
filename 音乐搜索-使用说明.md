# 🎵 音乐搜索功能 - 完整使用说明

## ⚠️ 重要：必须使用Netlify CLI启动

由于所有音乐API都有CORS跨域限制，**必须通过Netlify函数代理**才能正常搜索。

---

## 🚀 快速启动（推荐）

### 方法1：一键启动脚本

双击运行：**`启动音乐搜索功能.bat`**

脚本会自动：
1. 检查并安装Netlify CLI
2. 安装项目依赖
3. 启动开发服务器

### 方法2：手动启动

```bash
# 1. 全局安装Netlify CLI（只需一次）
npm install -g netlify-cli

# 2. 停止当前服务（如果正在运行）
# 按 Ctrl+C

# 3. 使用Netlify模式启动
npm run dev:netlify
```

---

## 📖 详细说明

### 为什么必须用Netlify CLI？

```
❌ npm run dev       → 只启动Vite，无法搜索（CORS错误）
✅ npm run dev:netlify → 启动Vite + Netlify函数，可以搜索
```

### 启动后会看到什么？

```
◈ Netlify Dev ◈
┌─────────────────────────────────────────────────┐
│                                                 │
│   ◈ Server now ready on http://localhost:8888  │
│                                                 │
└─────────────────────────────────────────────────┘

   ›   Loaded .netlify/functions/music-api
```

**访问地址**: http://localhost:8888 （不是5173！）

---

## 🎵 使用音乐搜索

1. **打开应用**
   - 访问 http://localhost:8888

2. **进入音乐播放器**
   - 桌面 → 小程序 → 音乐播放器
   - 或从发现页进入

3. **点击搜索图标** 🔍
   - 在播放器顶部导航栏

4. **输入关键词搜索**
   ```
   例如：
   - 周杰伦
   - 七里香
   - 晴天
   - 稻香
   ```

5. **查看结果**
   - **本地歌曲** 标签：本地已有的歌曲
   - **在线歌曲** 标签：在线搜索结果

6. **播放歌曲**
   - 点击本地歌曲：直接播放
   - 点击在线歌曲：提示添加到本地

---

## 🔍 搜索流程

系统会按顺序尝试以下API：

```
1. 网易云音乐 API
   ↓ 失败
2. QQ音乐 API
   ↓ 失败
3. 提示搜索失败
```

所有API调用都通过Netlify函数代理，避免CORS问题。

---

## 📊 查看搜索日志

打开浏览器控制台（F12），可以看到：

```
🔍 尝试使用网易云API搜索: 周杰伦
⚠️ 网易云API失败，切换到备用API
🔍 使用备用API搜索: 周杰伦
✅ QQ音乐搜索成功，找到 30 首
```

---

## 🎯 支持的功能

### ✅ 已实现
- 本地歌曲搜索
- 在线歌曲搜索（网易云、QQ音乐）
- 搜索历史记录
- 自动API切换
- 详细日志

### ⚠️ 限制
- 在线歌曲无法直接播放（需添加到本地）
- 部分歌曲可能有版权限制
- 搜索结果取决于API可用性

### 💡 建议
- 搜索到喜欢的歌曲后，将音频文件上传到本地
- 使用"上传歌曲"功能添加本地音乐文件
- 本地歌曲可以离线播放

---

## 🐛 常见问题

### Q1: 双击.bat文件没反应？
**A:** 
1. 右键选择"以管理员身份运行"
2. 或手动打开cmd运行命令

### Q2: 提示"netlify: command not found"？
**A:** 手动安装Netlify CLI
```bash
npm install -g netlify-cli
```

### Q3: 搜索一直转圈，没结果？
**A:**
1. 检查网络连接
2. 查看控制台错误信息
3. 尝试更换关键词
4. 确认使用的是 `npm run dev:netlify`

### Q4: 端口8888被占用？
**A:** Netlify会自动选择其他可用端口
```
Server now ready on http://localhost:8889
```

### Q5: 还是显示CORS错误？
**A:** 
1. 确认使用 `netlify dev` 启动
2. 检查浏览器地址是否是 localhost:8888
3. 清除浏览器缓存后重试

### Q6: 在线歌曲能播放吗？
**A:** 
- 目前不支持直接播放
- 建议将歌曲文件上传到本地
- 后续会完善在线播放功能

---

## 📦 文件说明

### 核心文件
- `netlify/functions/music-api.ts` - API代理服务
- `src/services/musicApi.ts` - 前端API调用
- `src/services/musicApiFallback.ts` - 备用方案
- `src/pages/MusicSearch.tsx` - 搜索页面

### 配置文件
- `netlify.toml` - Netlify配置
- `package.json` - 项目配置

### 脚本文件
- `启动音乐搜索功能.bat` - 一键启动脚本

---

## 🔄 更新日志

### v1.0 (2025-10-26)
- ✅ 实现本地搜索
- ✅ 实现在线搜索（网易云、QQ音乐）
- ✅ 添加Netlify函数代理
- ✅ 自动API降级
- ✅ 搜索历史
- ✅ 一键启动脚本

---

## 📞 技术支持

如遇到问题：
1. 查看浏览器控制台错误信息
2. 查看命令行输出日志
3. 检查网络连接
4. 确认使用正确的启动方式

---

**享受你的音乐之旅！** 🎵✨
