# 群聊聊天列表同步功能说明

## 🎯 问题

创建群聊后，群聊没有显示在微信首页的聊天列表中。

## ✅ 解决方案

### 1. 扩展 Chat 接口

**修改前**：
```typescript
interface Chat {
  id: string
  characterId: string  // 只支持单聊
  name: string
  avatar: string
  lastMessage: string
  time: string
}
```

**修改后**：
```typescript
interface Chat {
  id: string
  characterId?: string      // 单聊才有
  groupId?: string          // 群聊才有
  type: 'single' | 'group'  // 聊天类型
  name: string
  avatar: string
  lastMessage: string
  time: string
  memberCount?: number      // 群聊成员数
  unread?: number
  muted?: boolean
}
```

### 2. 自动同步群聊

添加 `useEffect` 监听群聊变化：

```typescript
useEffect(() => {
  if (groups.length === 0) return

  setChats(prev => {
    let updated = [...prev]
    let hasChanges = false

    groups.forEach(group => {
      const existingIndex = updated.findIndex(
        c => c.type === 'group' && c.groupId === group.id
      )
      
      if (existingIndex >= 0) {
        // 更新现有群聊
        if (有变化) {
          updated[existingIndex] = groupChat
          // 移到顶部
          updated = [groupChat, ...updated.filter((_, i) => i !== existingIndex)]
          hasChanges = true
        }
      } else {
        // 新增群聊
        updated = [groupChat, ...updated]
        hasChanges = true
      }
    })

    return hasChanges ? updated : prev
  })
}, [groups])
```

### 3. 区分导航路由

**点击聊天项时**：
```typescript
onClick={() => navigate(
  isGroup ? `/group/${chat.id}` : `/chat/${chat.id}`
)}
```

### 4. 显示优化

**群聊显示**：
- 群名称 + 成员数：`朋友群 (3)`
- 最后消息：`汁汁: 妈咪好呀~`
- 时间：`14:30`

**单聊显示**：
- 角色名称 + 火花天数：`汁汁 🔥 5`
- 最后消息：`妈咪好呀~`
- 时间：`14:30`

## 🔄 同步时机

### 1. 创建群聊时
```
用户创建群聊
  ↓
GroupContext 添加群聊
  ↓
groups 数组更新
  ↓
ChatList useEffect 触发
  ↓
自动添加到聊天列表（顶部）
```

### 2. 发送消息时
```
用户/AI 发送消息
  ↓
GroupChatDetail 更新群聊信息
  ↓
updateGroup() 更新 lastMessage 和 time
  ↓
groups 数组更新
  ↓
ChatList useEffect 触发
  ↓
更新聊天列表并移到顶部
```

### 3. 群成员变化时
```
添加/移除成员
  ↓
GroupContext 更新群聊
  ↓
groups 数组更新
  ↓
ChatList useEffect 触发
  ↓
更新成员数显示
```

## 📊 数据流

```
GroupContext (groups)
       ↓
   监听变化
       ↓
ChatList (chats)
       ↓
   保存到 localStorage
       ↓
   显示在界面
```

## 🎨 UI 效果

### 聊天列表展示

```
┌─────────────────────────────────┐
│ 微信                    🔍  ➕  │
├─────────────────────────────────┤
│                                 │
│ 🟦 朋友群 (3)          14:30   │
│    汁汁: 妈咪好呀~              │
│                                 │
│ 😊 汁汁 🔥 5           14:25   │
│    妈咪~人家想你啦              │
│                                 │
│ 😎 小明                14:20   │
│    哈哈，好的！                 │
│                                 │
└─────────────────────────────────┘
```

### 特点
- ✅ 群聊显示九宫格头像（如果有）
- ✅ 群聊显示成员数 `(3)`
- ✅ 单聊显示火花天数 `🔥 5`
- ✅ 最新消息在顶部
- ✅ 点击跳转到对应页面

## 🔧 技术细节

### 1. 性能优化
```typescript
// 只在有变化时更新
return hasChanges ? updated : prev
```

### 2. 防止重复
```typescript
// 检查是否已存在
const existingIndex = updated.findIndex(
  c => c.type === 'group' && c.groupId === group.id
)
```

### 3. 自动排序
```typescript
// 有新消息的聊天移到顶部
updated = [groupChat, ...updated.filter((_, i) => i !== existingIndex)]
```

### 4. 数据持久化
```typescript
// 自动保存到 localStorage
useEffect(() => {
  localStorage.setItem('chatList', JSON.stringify(chats))
}, [chats])
```

## 🎯 测试场景

### 场景1：创建新群聊
1. 点击 "+" → "创建群聊"
2. 选择成员，设置群名称
3. 点击"完成"
4. ✅ 自动跳转到群聊详情
5. ✅ 返回首页，群聊显示在列表顶部

### 场景2：群聊发送消息
1. 进入群聊
2. 发送消息
3. 返回首页
4. ✅ 群聊显示最新消息
5. ✅ 群聊移到列表顶部

### 场景3：AI回复消息
1. 在群聊中触发AI回复
2. AI发送消息
3. 返回首页
4. ✅ 群聊显示AI的消息
5. ✅ 格式：`AI名称: 消息内容`

### 场景4：混合列表
1. 创建多个单聊和群聊
2. 随机发送消息
3. ✅ 最新消息的聊天在顶部
4. ✅ 单聊和群聊正确区分
5. ✅ 点击跳转到正确页面

## 📝 注意事项

### 1. 类型安全
- 使用 `type: 'single' | 'group'` 明确区分
- 单聊必有 `characterId`
- 群聊必有 `groupId`

### 2. 数据一致性
- 群聊信息以 `GroupContext` 为准
- 聊天列表自动同步，不手动修改

### 3. 性能考虑
- 只在有变化时更新状态
- 避免不必要的重渲染

### 4. 用户体验
- 新消息自动置顶
- 显示成员数/火花天数
- 区分单聊和群聊图标

## 🎉 总结

通过以下改进：

✅ **自动同步**：创建群聊后自动显示在列表  
✅ **实时更新**：发送消息后自动更新列表  
✅ **智能排序**：最新消息自动置顶  
✅ **类型区分**：单聊和群聊正确区分  
✅ **数据持久化**：刷新页面后数据不丢失  

现在群聊功能与单聊功能完全一致，用户体验更加流畅！🎊
