# AI系统标记过滤修复说明

## 问题描述
AI会把系统内部的警告标记发送出来，用户看到类似这样的消息：
```
🚫🚫🚫 【系统警告：你被拉黑了！】
🚫🚫🚫
```

这些标记是系统内部用于提示AI的，不应该被发送给用户。

## 问题原因
1. **AI不理解系统标记的用途**：AI把系统警告当作普通文本发送出来
2. **缺少过滤机制**：没有在发送前过滤掉这些内部标记
3. **提示词不够明确**：没有明确告诉AI不要发送这些标记

## 修复方案

### 1. 添加自动过滤逻辑
在 `ChatDetail.tsx` 的响应清理部分添加系统标记过滤：

**位置**：第2426-2429行

```typescript
// 清理系统警告标记（防止AI把内部标记发送出来）
cleanedResponse = cleanedResponse.replace(/🚫+/g, '').trim()
cleanedResponse = cleanedResponse.replace(/【系统警告[：:][^】]+】/g, '').trim()
cleanedResponse = cleanedResponse.replace(/\[系统警告[：:][^\]]+\]/g, '').trim()
```

### 2. 更新提示词说明
在 `prompts.ts` 中明确告诉AI不要发送系统标记：

**基础提示词**（第103行）：
```typescript
【系统警告：你被拉黑了！】= 你真的被拉黑了，要在回复中提到（⚠️ 不要把🚫和【系统警告】这些标记发送出来，只提到被拉黑这件事）
```

**拉黑警告提示词**（第150-152行）：
```markdown
⚠️ 重要提醒：
❌ 不要把🚫和【系统警告】这些标记发送出来！
✅ 只需要用自己的话提到被拉黑这件事即可
```

## 过滤规则

### 会被过滤的内容
1. **禁止符号**：`🚫` `🚫🚫🚫` 等任意数量的禁止符号
2. **中文方括号警告**：`【系统警告：xxx】` `【系统警告:xxx】`
3. **英文方括号警告**：`[系统警告：xxx]` `[系统警告:xxx]`

### 正则表达式说明
```typescript
/🚫+/g                           // 匹配一个或多个🚫符号
/【系统警告[：:][^】]+】/g        // 匹配中文方括号的系统警告
/\[系统警告[：:][^\]]+\]/g       // 匹配英文方括号的系统警告
```

## 修复效果

### 修复前
用户看到的消息：
```
AI: 🚫🚫🚫 【系统警告：你被拉黑了！】
AI: 🚫🚫🚫
```
→ 用户困惑：这是什么东西？

### 修复后
用户看到的消息：
```
AI: 你把我拉黑了？为什么？
```
→ AI用自己的话表达被拉黑的反应

## 处理流程

### 1. AI生成回复
```
原始回复: "🚫🚫🚫 【系统警告：你被拉黑了！】 你把我拉黑了？"
```

### 2. 自动过滤
```typescript
// 移除🚫符号
cleanedResponse = cleanedResponse.replace(/🚫+/g, '')
// 结果: "【系统警告：你被拉黑了！】 你把我拉黑了？"

// 移除系统警告标记
cleanedResponse = cleanedResponse.replace(/【系统警告[：:][^】]+】/g, '')
// 结果: "你把我拉黑了？"
```

### 3. 发送给用户
```
最终消息: "你把我拉黑了？"
```

## 适用场景

### 会被过滤的标记
- `🚫` → 清除
- `🚫🚫🚫` → 清除
- `【系统警告：你被拉黑了！】` → 清除
- `[系统警告：xxx]` → 清除
- `【系统警告:xxx】` → 清除（支持中英文冒号）

### 不受影响的内容
- 正常的文字内容
- AI的真实回复
- 其他功能标记（如 `[表情包:1]`、`[红包:100:祝福]`）

## 双重保护机制

### 第一层：提示词引导
通过明确的提示词告诉AI不要发送系统标记：
```
⚠️ 不要把🚫和【系统警告】这些标记发送出来！
```

### 第二层：自动过滤
即使AI不听话发送了标记，也会被自动过滤掉：
```typescript
cleanedResponse = cleanedResponse.replace(/🚫+/g, '').trim()
cleanedResponse = cleanedResponse.replace(/【系统警告[：:][^】]+】/g, '').trim()
```

## 技术细节

### 过滤顺序
在 `ChatDetail.tsx` 中的清理顺序：
1. 清理账单标记 `[BILL:...]`
2. 清理红包标记 `[红包:...]`
3. **清理系统警告标记** ← 新增
4. 清理错误的引用格式
5. 清理多余空行

### 性能影响
- 使用正则表达式，性能开销极小
- 只在发送消息时执行一次
- 不影响其他功能

## 测试验证

### 测试用例1：完整的系统警告
**AI回复**：`🚫🚫🚫 【系统警告：你被拉黑了！】 你把我拉黑了？`
**过滤后**：`你把我拉黑了？`
**结果**：✅ 系统标记被完全清除

### 测试用例2：只有符号
**AI回复**：`🚫🚫🚫`
**过滤后**：`（空）`
**结果**：✅ 不发送空消息

### 测试用例3：正常回复
**AI回复**：`你把我拉黑了？为什么？`
**过滤后**：`你把我拉黑了？为什么？`
**结果**：✅ 正常内容不受影响

## 注意事项

1. **不影响系统提示**：这些标记在系统提示词中仍然存在，只是不会被发送给用户
2. **保留AI理解**：AI仍然能看到并理解系统警告，只是不会把标记发出来
3. **兼容性**：支持中英文冒号、中英文方括号

## 修复时间
2025年10月24日

## 影响范围
- ✅ 拉黑警告系统
- ✅ AI回复过滤
- ✅ 提示词优化
- ✅ 用户体验改善
