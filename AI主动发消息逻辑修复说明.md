# 🔧 AI 主动发消息逻辑修复

## ❌ 之前的问题

**错误判断：**
```
用户：你好
AI：你好呀～          ← 显示"AI主动消息功能已开启"
用户：在干嘛
AI：在看书呢          ← 显示"AI主动消息功能已开启"
```

AI 回复用户的消息也被算作"主动发消息" ❌

---

## ✅ 修复后的逻辑

**正确判断：**
```
用户：你好
AI：你好呀～          ← AI 刚回复过用户，不是主动发消息的时机
用户：在干嘛
AI：在看书呢          ← AI 刚回复过用户，不是主动发消息的时机
（用户 5 分钟没回复）
AI：你在忙吗？        ← ✅ 这才是主动发消息！
```

---

## 📋 新的判断规则

### 1. 基本条件
```typescript
// 最后一条消息必须是 AI 发的
if (lastMessage.type !== 'received') {
  return // 不是主动发消息的时机
}
```

### 2. 时间条件
```typescript
// 距离 AI 最后消息 5 分钟以上
const minWaitTime = 5 * 60 * 1000 // 5分钟
const maxWaitTime = 2 * 60 * 60 * 1000 // 2小时

if (timeSinceLastAiMessage > minWaitTime && 
    timeSinceLastAiMessage < maxWaitTime) {
  // 可以考虑主动发消息
}
```

### 3. AI 智能判断

AI 会根据以下因素决定是否发消息：

**✅ 应该发消息：**
1. AI 问了问题，但用户没回答 → 追问或换话题
2. 用户可能在忙，AI 想表达关心 → "在忙吗？"
3. AI 性格黏人/主动，想念用户 → "想你了"
4. 聊天突然中断，AI 想继续话题
5. AI 有新的想法/事情想分享

**❌ 不应该发消息：**
1. 话题已经自然结束
2. 用户可能真的在忙，不想打扰
3. AI 性格比较高冷/被动
4. 刚才说了晚安/再见等结束语
5. 没有必要追问的情况

---

## 🎯 实际效果

### 场景 1：用户没回复问题
```
AI：你今天过得怎么样？
（用户 5 分钟没回复）
AI：在忙吗？不急慢慢聊～  ← ✅ 主动发消息
```

### 场景 2：聊天突然中断
```
AI：我今天看了一部电影，超好看的！
（用户 10 分钟没回复）
AI：你要不要听我讲讲剧情？  ← ✅ 主动发消息
```

### 场景 3：黏人性格
```
AI：好的，那你先忙～
（用户 15 分钟没回复）
AI：想你了，在干嘛呢？    ← ✅ 主动发消息（黏人性格）
```

### 场景 4：高冷性格
```
AI：嗯，知道了
（用户 30 分钟没回复）
AI：SKIP                  ← ❌ 不发消息（高冷性格）
```

---

## 🔍 控制台日志

### 之前（错误）
```
✅ AI主动消息功能已开启
⏸️ AI刚回复过，不主动发消息
```

### 现在（正确）
```
✅ AI主动消息功能已开启
⏸️ AI 刚回复过用户，不是主动发消息的时机
```

或

```
✅ AI主动消息功能已开启
✅ 最后一条是 AI 的消息，用户未回复 - 可以考虑主动发消息
⏰ AI 最后消息是 5 分钟前，用户还没回复
💭 触发条件满足，准备让AI考虑是否主动发消息...
💭 角色名 考虑是否主动发消息...
✅ 角色名 主动发送了消息: 你在忙吗？
```

---

## 📊 判断流程图

```
开始
  ↓
是否开启主动消息功能？
  ↓ 是
最后一条消息是 AI 发的吗？
  ↓ 是
距离最后消息 > 5 分钟吗？
  ↓ 是
距离最后消息 < 2 小时吗？
  ↓ 是
AI 根据性格和上下文判断
  ↓
应该发消息？
  ↓ 是
发送主动消息 ✅
```

---

## 🎉 修复完成！

现在 AI 主动发消息的逻辑更加合理：
- ✅ 只有用户没回复时才主动发
- ✅ AI 会根据性格和情况智能判断
- ✅ 不会在回复用户时显示"主动发消息"
- ✅ 更像真人的聊天行为

**享受更智能的 AI 聊天体验吧！** 🚀
