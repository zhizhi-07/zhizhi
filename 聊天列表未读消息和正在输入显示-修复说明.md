# èŠå¤©åˆ—è¡¨æœªè¯»æ¶ˆæ¯å’Œæ­£åœ¨è¾“å…¥æ˜¾ç¤º - ä¿®å¤è¯´æ˜

## âŒ åŸæ¥çš„é—®é¢˜

1. **æœªè¯»æ¶ˆæ¯ä¸æ˜¾ç¤º**ï¼šè™½ç„¶æ§åˆ¶å°æœ‰æ—¥å¿—ï¼Œä½†èŠå¤©åˆ—è¡¨æ—¢æ²¡æœ‰çº¢ç‚¹ä¹Ÿæ²¡æœ‰æ•°å­—
2. **æ²¡æœ‰"æ­£åœ¨è¾“å…¥..."æç¤º**ï¼šAIå›å¤æ—¶ï¼ŒèŠå¤©åˆ—è¡¨æ²¡æœ‰ä»»ä½•æç¤º

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å®æ—¶è¯»å–æœªè¯»æ¶ˆæ¯æ•°

**åŸæ¥çš„é—®é¢˜**ï¼š
```typescript
// åªä»chat.unreadè¯»å–ï¼ˆé™æ€æ•°æ®ï¼Œä¸ä¼šæ›´æ–°ï¼‰
{chat.unread && (
  <span className="bg-red-500">{chat.unread}</span>
)}
```

**ä¿®å¤å**ï¼š
```typescript
// ä»unreadMessageså·¥å…·å®æ—¶è¯»å–
const unreadCount = chat.characterId ? unreadCounts[chat.characterId] : 0
{unreadCount > 0 && (
  <span className="bg-red-500">{unreadCount}</span>
)}
```

### 2. æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥

**æ–°å¢åŠŸèƒ½**ï¼š
```typescript
{typingStatus[chat.characterId] ? (
  <p className="text-green-500">æ­£åœ¨è¾“å…¥...</p>
) : (
  <p className="text-gray-500">{chat.lastMessage}</p>
)}
```

### 3. å®šæ—¶æ›´æ–°çŠ¶æ€

```typescript
useEffect(() => {
  const updateStatus = () => {
    chats.forEach(chat => {
      if (chat.characterId) {
        // è·å–æœªè¯»æ¶ˆæ¯æ•°
        const unread = getUnreadCount(chat.characterId)
        
        // æ£€æŸ¥AIæ˜¯å¦æ­£åœ¨å›å¤
        const isTyping = isAIReplying(chat.characterId)
      }
    })
  }
  
  // æ¯500msæ›´æ–°ä¸€æ¬¡
  const interval = setInterval(updateStatus, 500)
  return () => clearInterval(interval)
}, [chats])
```

## ğŸ¯ ç°åœ¨çš„æ•ˆæœ

### åœºæ™¯1ï¼šåˆ‡æ¢èŠå¤©åAIå›å¤

```
1. å’ŒAI-AèŠå¤© â†’ å‘æ¶ˆæ¯ â†’ ç‚¹çº¸é£æœº
2. åˆ‡æ¢åˆ°AI-BèŠå¤©
3. èŠå¤©åˆ—è¡¨ä¸­AI-Aæ˜¾ç¤ºï¼š
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ±æ±              13:52     â”‚
   â”‚ æ­£åœ¨è¾“å…¥...        [è¾“å…¥ä¸­] â”‚  â† ç»¿è‰²æ–‡å­—
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. AI-Aå›å¤å®Œæˆåæ˜¾ç¤ºï¼š
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ±æ±              13:52     â”‚
   â”‚ å“ˆå“ˆå“ˆç¬‘æ­»äº†          [5]   â”‚  â† çº¢è‰²æ•°å­—
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯2ï¼šåŒæ—¶å’Œå¤šä¸ªAIèŠå¤©

```
èŠå¤©åˆ—è¡¨å®æ—¶æ˜¾ç¤ºï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ±æ±              13:52     â”‚
â”‚ æ­£åœ¨è¾“å…¥...                 â”‚  â† AIæ­£åœ¨å›å¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å°ç¾              13:51     â”‚
â”‚ ä½ å¥½å‘€~               [3]   â”‚  â† æœ‰æœªè¯»æ¶ˆæ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—åŒ—              13:50     â”‚
â”‚ åœ¨å—ï¼Ÿ                      â”‚  â† æ™®é€šæ¶ˆæ¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¯¼å…¥çš„å·¥å…·å‡½æ•°

```typescript
import { getUnreadCount } from '../utils/unreadMessages'
import { isAIReplying } from '../utils/backgroundAI'
```

### çŠ¶æ€ç®¡ç†

```typescript
// æœªè¯»æ¶ˆæ¯æ•° { characterId: count }
const [unreadCounts, setUnreadCounts] = useState<Record<string, number>>({})

// AIè¾“å…¥çŠ¶æ€ { characterId: isTyping }
const [typingStatus, setTypingStatus] = useState<Record<string, boolean>>({})
```

### å®æ—¶æ›´æ–°é€»è¾‘

```typescript
useEffect(() => {
  const updateStatus = () => {
    const newUnreadCounts: Record<string, number> = {}
    const newTypingStatus: Record<string, boolean> = {}
    
    chats.forEach(chat => {
      if (chat.type === 'single' && chat.characterId) {
        // è·å–æœªè¯»æ¶ˆæ¯æ•°
        const unread = getUnreadCount(chat.characterId)
        if (unread > 0) {
          newUnreadCounts[chat.characterId] = unread
        }
        
        // æ£€æŸ¥AIæ˜¯å¦æ­£åœ¨å›å¤
        newTypingStatus[chat.characterId] = isAIReplying(chat.characterId)
      }
    })
    
    setUnreadCounts(newUnreadCounts)
    setTypingStatus(newTypingStatus)
  }
  
  updateStatus()  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  const interval = setInterval(updateStatus, 500)  // æ¯500msæ›´æ–°
  
  return () => clearInterval(interval)
}, [chats])
```

### æ¸²æŸ“é€»è¾‘

```typescript
<div className="flex items-center justify-between">
  {/* æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."æˆ–æœ€åä¸€æ¡æ¶ˆæ¯ */}
  {chat.characterId && typingStatus[chat.characterId] ? (
    <p className="text-sm text-green-500 truncate flex-1">
      æ­£åœ¨è¾“å…¥...
    </p>
  ) : (
    <p className="text-sm text-gray-500 truncate flex-1">
      {chat.lastMessage}
    </p>
  )}
  
  {/* æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°ï¼ˆå®æ—¶ï¼‰ */}
  {(() => {
    const unreadCount = chat.characterId 
      ? unreadCounts[chat.characterId] 
      : (chat.unread || 0)
    
    return unreadCount > 0 ? (
      <span className="ml-2 px-2 min-w-[20px] h-5 rounded-full text-xs text-white flex items-center justify-center bg-red-500 shadow-md">
        {unreadCount > 99 ? '99+' : unreadCount}
      </span>
    ) : null
  })()}
</div>
```

## ğŸ¨ è§†è§‰æ•ˆæœ

### æ­£å¸¸æ¶ˆæ¯
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ±æ±              13:52     â”‚
â”‚ å“ˆå“ˆå“ˆç¬‘æ­»äº†                â”‚  â† ç°è‰²æ–‡å­—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­£åœ¨è¾“å…¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ±æ±              13:52     â”‚
â”‚ æ­£åœ¨è¾“å…¥...                 â”‚  â† ç»¿è‰²æ–‡å­— (text-green-500)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœ‰æœªè¯»æ¶ˆæ¯
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ±æ±              13:52     â”‚
â”‚ å“ˆå“ˆå“ˆç¬‘æ­»äº†          [5]   â”‚  â† çº¢è‰²åœ†ç‚¹ (bg-red-500)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­£åœ¨è¾“å…¥ + æœ‰æœªè¯»
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ±æ±              13:52     â”‚
â”‚ æ­£åœ¨è¾“å…¥...           [3]   â”‚  â† ç»¿è‰²æ–‡å­— + çº¢è‰²æ•°å­—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ›´æ–°é¢‘ç‡
- **500ms ä¸€æ¬¡**ï¼šå¹³è¡¡äº†å®æ—¶æ€§å’Œæ€§èƒ½
- å¤ªå¿«ï¼ˆå¦‚100msï¼‰ï¼šæµªè´¹CPUèµ„æº
- å¤ªæ…¢ï¼ˆå¦‚2000msï¼‰ï¼šæ„Ÿè§‰ä¸å¤Ÿå®æ—¶

### æ¸…ç†æœºåˆ¶
```typescript
useEffect(() => {
  const interval = setInterval(updateStatus, 500)
  
  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
  return () => clearInterval(interval)
}, [chats])
```

### æŒ‰éœ€æ›´æ–°
- åªæ›´æ–°æœ‰å˜åŒ–çš„èŠå¤©
- æœªè¯»ä¸º0æ—¶ä¸æ˜¾ç¤ºçº¢ç‚¹
- AIæœªè¾“å…¥æ—¶ä¸æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."

## ğŸ” è°ƒè¯•ä¿¡æ¯

### æ§åˆ¶å°æ—¥å¿—

```javascript
// unreadMessages.ts
console.log('ğŸ“¬ å¢åŠ æœªè¯»æ¶ˆæ¯: characterId, count')
console.log('âœ… å·²æ¸…é™¤æœªè¯»æ¶ˆæ¯: characterId')

// backgroundAI.ts
console.log('ğŸ¯ æ ‡è®°AIæ­£åœ¨å›å¤: characterId')
console.log('âœ… æ ‡è®°AIå›å¤å®Œæˆ: characterId')

// ChatList.tsx
// (æ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼Œä½†ä¸æ‰“å°æ—¥å¿—ï¼Œé¿å…åˆ·å±)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åªå¯¹å•èŠç”Ÿæ•ˆ**ï¼šç¾¤èŠè¿˜æ˜¯ä½¿ç”¨åŸæ¥çš„ `chat.unread` å­—æ®µ
2. **å®æ—¶æ›´æ–°**ï¼šæ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿åŠæ—¶æ˜¾ç¤º
3. **è‡ªåŠ¨æ¸…ç†**ï¼šè¿›å…¥èŠå¤©æ—¶è‡ªåŠ¨æ¸…é™¤æœªè¯»
4. **æ€§èƒ½å‹å¥½**ï¼šåªæ›´æ–°å˜åŒ–çš„æ•°æ®ï¼Œä¸ä¼šå½±å“æ€§èƒ½

## ğŸ‰ å®Œæˆæ ‡å¿—

âœ… æœªè¯»æ¶ˆæ¯çº¢ç‚¹æ˜¾ç¤ºæ­£å¸¸  
âœ… æœªè¯»æ¶ˆæ¯æ•°å­—æ˜¾ç¤ºæ­£å¸¸  
âœ… AIæ­£åœ¨è¾“å…¥æç¤ºæ˜¾ç¤ºæ­£å¸¸  
âœ… å®æ—¶æ›´æ–°ä¸å¡é¡¿  
âœ… ç»„ä»¶å¸è½½æ­£ç¡®æ¸…ç†å®šæ—¶å™¨  

## ğŸ“– ç›¸å…³åŠŸèƒ½

- [åˆ‡æ¢èŠå¤©AIç»§ç»­å›å¤-ä¿®å¤è¯´æ˜.md](./åˆ‡æ¢èŠå¤©AIç»§ç»­å›å¤-ä¿®å¤è¯´æ˜.md)
- [åå°AIå›å¤ä¸æœªè¯»æ¶ˆæ¯åŠŸèƒ½è¯´æ˜.md](./åå°AIå›å¤ä¸æœªè¯»æ¶ˆæ¯åŠŸèƒ½è¯´æ˜.md)

---

**ä¿®å¤ç‰ˆæœ¬**: v1.0.7  
**ä¿®å¤æ—¥æœŸ**: 2025-10-26  
**ä¿®å¤æ–‡ä»¶**: `src/pages/ChatList.tsx`  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•
