# 世界书系统使用说明

## 功能概述

世界书（Lorebook / World Info）是一个基于关键词触发的知识库系统，用于管理角色的背景知识、世界观设定等信息。当对话中出现特定关键词时，相关内容会自动注入到 AI 的上下文中。

---

## 核心功能

### 关键词触发
- 设置触发关键词，当对话中出现时自动激活
- 支持多个关键词，任意一个匹配即可触发
- 支持大小写敏感匹配
- 支持正则表达式匹配

### 智能注入
- 根据优先级和插入顺序控制注入位置
- Token 预算管理，避免超出上下文限制
- 支持始终注入或按需注入
- 可选择注入位置（顶部、角色前、角色后、底部）

### 灵活管理
- 全局世界书：对所有角色生效
- 角色专属世界书：仅对指定角色生效
- 支持导入导出 JSON 格式
- 条目分类和备注功能

---

## 使用方法

### 创建世界书

1. 从桌面打开"世界书"应用
2. 点击右上角"+"创建新世界书
3. 填写基本信息：
   - 名称：世界书的名称
   - 描述：简要说明用途
   - 扫描深度：扫描最近 N 条消息（默认 10）
   - Token 预算：最大使用的 Token 数量（默认 2000）

### 添加条目

1. 在世界书编辑页面点击"添加条目"
2. 设置条目信息：
   - 名称：条目的标识名称
   - 关键词：触发该条目的关键词列表
   - 内容：要注入的文本内容
   - 优先级：0-999，数值越大优先级越高
   - 位置：选择注入位置

### 高级选项

**大小写敏感**
- 开启后，"Beijing" 和 "beijing" 会被视为不同关键词
- 关闭后，不区分大小写

**始终注入**
- 开启后，无论是否匹配关键词都会注入
- 适用于必须始终存在的背景信息

**正则表达式**
- 开启后，关键词将作为正则表达式处理
- 例如：`北京|Beijing` 可以匹配两种写法

---

## 使用场景

### 世界观设定

```
关键词：修仙世界, 灵气, 境界
内容：
这是一个修仙世界，天地间充满灵气。
修炼境界分为：炼气、筑基、金丹、元婴、化神、合体、渡劫、大乘。
```

### 角色背景

```
关键词：李明, 主角
内容：
李明，25岁，来自地球的穿越者。
拥有系统辅助，目前炼气三层。
性格谨慎，善于隐藏实力。
```

### 地点信息

```
关键词：青云宗, 宗门
内容：
青云宗位于青云山，是修仙界五大宗门之一。
宗主：云天子（化神期）
弟子：外门三千，内门五百，核心弟子二十。
```

### 物品设定

```
关键词：玄天剑, 法宝
内容：
玄天剑，上品灵器，锋利无比。
特殊能力：可吸收雷霆之力强化攻击。
当前持有者：李明
```

---

## 最佳实践

### 关键词设置

**推荐做法**
- 使用多个相关关键词：`北京, Beijing, 首都`
- 包含常见变体和简称
- 避免过于宽泛的关键词（如"的"、"是"）

**不推荐做法**
- 单一关键词容易遗漏
- 过于复杂的正则表达式难以维护
- 使用停用词作为关键词

### 内容编写

**清晰简洁**
```
良好示例：
张三，男，30岁，医生。
性格温和，擅长外科手术。

不良示例：
张三这个人呢，他是一个男的，今年应该是30岁左右吧，
职业的话是做医生的，性格方面比较温和...
```

**结构化信息**
```
推荐格式：
【基本信息】
姓名：张三
年龄：30岁
职业：医生

【性格特点】
温和、细心、责任心强

【技能专长】
外科手术、急救处理
```

### 优先级设置

- **900-999**：核心设定，必须优先注入
- **700-899**：重要背景，高优先级
- **400-699**：一般信息，中等优先级
- **100-399**：补充内容，低优先级
- **0-99**：可选信息，最低优先级

### Token 管理

**估算方法**
- 中文：约 1.5 字符 = 1 token
- 英文：约 4 字符 = 1 token
- 混合文本：按实际情况估算

**优化建议**
- 删除冗余描述
- 使用简洁的表达
- 合并相似条目
- 设置合理的 Token 预算

---

## 全局 vs 角色专属

### 全局世界书

**适用场景**
- 世界观设定（所有角色共享）
- 通用规则和设定
- 公共知识库

**优点**
- 一次设置，所有角色生效
- 便于统一管理
- 减少重复工作

### 角色专属世界书

**适用场景**
- 角色独有的背景故事
- 特定关系网络
- 个性化设定

**优点**
- 针对性强
- 不会影响其他角色
- 更精确的控制

---

## 导入导出

### 导出世界书

1. 在世界书列表中点击"更多"按钮
2. 选择"导出"
3. 保存为 JSON 文件

### 导入世界书

1. 在世界书列表底部点击"导入世界书"
2. 选择 JSON 文件
3. 系统自动创建新的世界书

### 文件格式

```json
{
  "name": "修仙世界设定",
  "description": "完整的修仙世界观设定",
  "entries": [
    {
      "name": "境界设定",
      "keys": ["境界", "修为", "实力"],
      "content": "修炼境界分为...",
      "enabled": true,
      "priority": 800,
      "position": "before_char"
    }
  ],
  "scan_depth": 10,
  "token_budget": 2000
}
```

---

## 集成到聊天

世界书会自动集成到聊天系统中：

1. **扫描消息**：系统扫描最近 N 条消息
2. **匹配关键词**：查找触发的条目
3. **排序选择**：按优先级排序，应用 Token 预算
4. **注入上下文**：将内容注入到 AI 提示词中
5. **AI 回复**：AI 基于完整上下文生成回复

**注入位置示例**
```
【顶部条目】
系统提示词
【角色前条目】
角色设定
【角色后条目】
对话历史
【底部条目】
```

---

## 常见问题

### 为什么条目没有被触发？

**检查清单**
- 条目是否已启用
- 关键词是否正确
- 是否在扫描深度范围内
- Token 预算是否已用完

### 如何提高触发准确性？

**建议**
- 增加关键词数量
- 使用更具体的关键词
- 调整大小写敏感设置
- 检查正则表达式语法

### Token 预算如何设置？

**参考值**
- 小型世界书：500-1000
- 中型世界书：1000-2000
- 大型世界书：2000-4000

**注意**
- 预算过小：重要信息可能被截断
- 预算过大：可能超出模型上下文限制

### 全局世界书和角色专属可以同时使用吗？

可以。系统会同时检查全局世界书和角色专属世界书，合并触发的条目后统一处理。

---

## 技术细节

### 匹配算法

1. 收集所有相关世界书（全局 + 角色专属）
2. 获取最近 N 条消息文本
3. 遍历所有条目，检查关键词匹配
4. 收集所有触发的条目
5. 按优先级和插入顺序排序
6. 应用 Token 预算限制
7. 按位置分组并构建最终文本

### 性能优化

- 使用缓存避免重复计算
- 延迟加载大型世界书
- 智能预测常用条目
- 异步处理匹配逻辑

---

## 更新日志

### v1.0.0 (2024-10-24)

**新增功能**
- 世界书管理系统
- 条目编辑器
- 关键词触发机制
- Token 预算管理
- 导入导出功能
- 全局和角色专属支持

**界面特点**
- 白色液态玻璃设计
- 移动端完美适配
- 简洁高级的排版
- 流畅的交互体验

---

## 技术支持

如有问题或建议，请查看相关文档：
- `lorebookSystem.ts` - 核心逻辑实现
- `WorldBook.tsx` - 管理界面
- `EditWorldBook.tsx` - 编辑界面
