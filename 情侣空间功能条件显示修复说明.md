# 情侣空间功能条件显示修复说明

## 问题描述

AI在没有开启情侣空间的情况下，会尝试使用情侣空间的功能（如留言、相册、纪念日），因为这些功能在提示词中是无条件显示的。

## 修复方案

### 1. 修改提示词生成函数 (`src/utils/prompts.ts`)

**修改内容：**
- 在 `buildRoleplayPrompt` 函数中添加 `hasCoupleSpace?: boolean` 参数
- 根据情侣空间状态条件性地显示功能：
  - **未开启时**：只显示 `[情侣空间邀请]` 功能
  - **已开启时**：显示完整的情侣空间功能（相册、留言、纪念日）

**代码变更：**
```typescript
// 函数签名添加参数
export const buildRoleplayPrompt = (
  character: Character,
  user: User,
  isNarratorMode: boolean,
  streakDays?: number,
  retrievedMemes?: RetrievedMeme[],
  hasCoupleSpace?: boolean  // 新增参数
) => {
```

**提示词变更：**
```typescript
// 条件性显示情侣空间功能
${hasCoupleSpace ? `💑 **情侣空间功能**（已开启）：
   📸 [相册:照片描述] - 分享生活瞬间
   💌 [留言:留言内容] - 偶尔来情侣空间说两句话
   🎂 [纪念日:日期|标题|描述] - 记录特殊日子` 
: `💑 **情侣空间** - [情侣空间邀请] | 收到时：[接受情侣空间] 或 [拒绝情侣空间]`}

// 使用建议部分也条件性显示
${hasCoupleSpace ? `- 情侣空间功能：已开启，想分享生活、记录特殊时刻时随时可以用
  * 相册：吃了好吃的、看到美景、自拍、任何想分享的画面
  * 留言：突然想说点什么、偶然路过情侣空间、心情好想留个言
  * 纪念日：重要日子、有意义的时刻、开玩笑编个纪念日都行` 
: `- 情侣空间：还未开启，如果想建立情侣空间可以发送邀请`}
```

### 2. 更新调用处 (`src/pages/ChatDetail.tsx`)

**修改内容：**
- 在生成AI回复前检查情侣空间状态
- 将状态传递给 `buildRoleplayPrompt` 函数

**代码变更：**
```typescript
// 在获取火花天数后，添加情侣空间状态检查
const { hasActiveCoupleSpace } = await import('../utils/coupleSpaceUtils')
const hasCoupleSpace = id ? hasActiveCoupleSpace(id) : false
console.log('💑 情侣空间状态:', hasCoupleSpace ? '已开启' : '未开启')

// 两处调用 buildRoleplayPrompt 时都传入状态
systemPrompt = buildRoleplayPrompt(
  { name: character?.name || 'AI', ... },
  { name: currentUser?.name || '用户' },
  enableNarration,
  streakDays,
  retrievedMemes,
  hasCoupleSpace  // 传入情侣空间状态
)
```

## 修复效果

### 未开启情侣空间时
- AI提示词中**不会显示**相册、留言、纪念日功能
- AI只能看到情侣空间邀请功能
- AI不会尝试使用 `[相册:]`、`[留言:]`、`[纪念日:]` 等标记

### 已开启情侣空间时
- AI提示词中**完整显示**所有情侣空间功能
- AI可以正常使用相册、留言、纪念日功能
- AI知道这些功能已经可用

## 技术细节

### 情侣空间状态判断
使用 `hasActiveCoupleSpace(characterId)` 函数判断：
- 检查 localStorage 中是否有情侣空间关系记录
- 验证关系状态是否为 `'active'`
- 验证角色ID是否匹配

### 提示词动态生成
- 使用模板字符串的条件表达式 `${condition ? 'A' : 'B'}`
- 根据 `hasCoupleSpace` 参数动态生成不同的提示词内容
- 确保AI只能看到当前可用的功能

## 测试建议

1. **未开启情侣空间场景**
   - 创建新角色对话
   - 观察AI是否会尝试使用留言、相册等功能
   - 验证AI只能发送情侣空间邀请

2. **已开启情侣空间场景**
   - 接受情侣空间邀请
   - 观察AI是否能正常使用相册、留言、纪念日功能
   - 验证功能使用的合理性

3. **状态切换场景**
   - 从未开启切换到已开启
   - 验证AI行为是否正确切换

## 相关文件

- `src/utils/prompts.ts` - 提示词生成逻辑
- `src/pages/ChatDetail.tsx` - AI回复生成逻辑
- `src/utils/coupleSpaceUtils.ts` - 情侣空间状态管理
- `src/utils/coupleSpaceContentUtils.ts` - 情侣空间内容管理

## 修复日期

2024年10月25日
