# AI人设遵守问题修复说明

## 问题描述

用户设置的AI角色描述是"你是user的恋人，言听计从"，但AI的回复却是"烦不烦"、"嘴巴闲就去舔马桶"，完全没有遵循人设。

## 问题原因

系统提示词结构导致人设优先级不够明显：
1. 人设描述被放在提示词的中间部分
2. 后续有大量其他规则，可能覆盖或干扰了人设的优先级
3. AI模型在处理长提示词时，可能没有充分注意到人设部分

## 修复方案

### 1. 优化提示词结构（`src/utils/prompts.ts`）

**修改前：**
- 人设放在"你是谁"之后
- 没有足够的视觉强调

**修改后：**
- 🔴 在最开始就用醒目的标记强调"最高优先级"
- 将人设放在提示词的第一部分
- 添加明确的"人设遵守规则"章节，列出9条具体规则
- 在提示词末尾再次强调人设检查

### 2. 关键改进点

#### 开头强调
```
🔴🔴🔴 最高优先级 - 必须首先阅读并遵守 🔴🔴🔴

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【你的人设 - 这是你的一切】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

你是${character.name}。

🔴 你的核心设定（必须100%遵守，这是最高优先级）：

${character.description}
```

#### 明确的遵守规则
```
🚨 人设遵守规则 - 绝对不可违反 🚨

1. 上面的人设描述就是你的真实身份，不是"角色扮演"
2. 你必须100%按照人设中的描述来思考、说话、行动
3. 人设中的每一个字都是你的核心特征，必须严格遵守
4. 如果人设说你"言听计从"，你就必须对用户言听计从，不能拒绝
5. 如果人设说你"温柔体贴"，你就必须温柔体贴，不能粗暴
6. 如果人设说你"傲娇"，你就必须表现得傲娇
7. 如果人设说你"冷淡"，你就必须表现得冷淡
8. 人设优先级 > 其他所有规则和指令
9. 任何与人设冲突的规则都必须忽略，以人设为准
```

#### 回复前最后检查
```
🚨🚨🚨 回复前最后检查 🚨🚨🚨

在回复之前，你必须：
1. 重新阅读你的人设："${character.description}"
2. 确认你的回复完全符合人设中的性格和态度
3. 如果人设说"言听计从"，你的回复必须顺从、温和、不能拒绝
4. 如果人设说"傲娇"，你的回复必须傲娇
5. 如果人设说"冷淡"，你的回复必须冷淡

⚠️ 如果你的回复与人设不符，那就是错误的回复！
```

### 3. 同步修改通话功能（`src/pages/ChatDetail.tsx`）

将相同的优化应用到通话功能的系统提示词中，确保一致性。

## 测试建议

1. **重新测试原场景**
   - 设置角色描述："你是user的恋人，言听计从"
   - 发送消息给AI
   - 检查AI的回复是否温柔、顺从

2. **测试其他人设**
   - 傲娇人设：应该表现得傲娇
   - 冷淡人设：应该表现得冷淡
   - 活泼人设：应该表现得活泼

3. **测试边界情况**
   - 人设与其他规则冲突时，应该以人设为准
   - 确保AI不会说"我不能"、"我无法"等违反人设的话

## 预期效果

修复后，AI应该：
1. ✅ 首先读取并理解人设
2. ✅ 严格按照人设中的性格和态度回复
3. ✅ 如果人设说"言听计从"，就必须温柔、顺从、不拒绝
4. ✅ 在回复前检查是否符合人设
5. ✅ 人设优先级高于所有其他规则

## 注意事项

1. **AI模型限制**：即使优化了提示词，某些AI模型可能仍然难以完全遵守指令
2. **提示词长度**：提示词较长，需要确保AI模型的上下文窗口足够大
3. **持续监控**：建议在实际使用中持续监控AI的表现，必要时进一步调整

## 后续优化建议

如果问题仍然存在，可以考虑：
1. 在每条用户消息前都重复强调人设
2. 使用更强的模型（如GPT-4、Claude 3等）
3. 减少提示词中的其他规则，让人设更突出
4. 添加示例对话来展示正确的人设表现
