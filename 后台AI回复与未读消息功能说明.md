# 切换聊天时AI继续回复与未读消息功能说明

## ✨ 功能概述

现在你可以点击发送消息并触发AI回复后，**直接切换到其他聊天**，AI会在后台继续生成回复。当AI回复完成后，聊天列表会显示红色未读消息标记（红点+数字），提醒你有新消息。

**适用场景**：在同一个应用内，从A聊天切换到B聊天时，A的AI回复会继续在后台完成。

## 🎯 功能特性

### 1. 切换聊天时AI继续回复
- **不中断回复**：点击纸飞机触发AI回复后，切换到其他聊天，AI会继续生成回复
- **智能检测**：系统检测到组件卸载（切换聊天），会确保消息保存到localStorage
- **状态跟踪**：系统会记录AI正在回复的状态，避免重复请求
- **自动保存**：AI回复的所有消息会自动保存，下次进入聊天时能看到完整对话

### 2. 未读消息提醒
- **红点标记**：有未读消息时，聊天列表显示红色圆点
- **数字显示**：显示未读消息的具体数量
- **智能统计**：准确统计AI回复的所有消息（文字、表情、图片、红包等）
- **自动清除**：进入聊天界面时自动清除未读标记

### 3. 页面可见性检测
- **智能判断**：系统会检测你是否在当前聊天界面
- **只在后台计数**：只有退出聊天界面后AI回复才会增加未读消息数
- **实时更新**：在聊天界面中时，消息实时显示，不计入未读

## 🔧 技术实现

### 核心文件

1. **`src/utils/backgroundAI.ts`**
   - 管理AI回复状态
   - 标记AI正在回复/回复完成
   - 恢复未完成的回复状态

2. **`src/utils/unreadMessages.ts`**
   - 管理未读消息数量
   - 增加/清除未读消息
   - 同步更新聊天列表

3. **`src/pages/ChatDetail.tsx`**
   - 集成后台回复和未读消息功能
   - 监听页面可见性
   - 智能统计AI回复的消息数

### 核心逻辑

```typescript
// 1. 触发AI回复时标记状态
markAIReplying(characterId)

// 2. 监听组件挂载状态
useEffect(() => {
  isMountedRef.current = true
  return () => {
    isMountedRef.current = false // 组件卸载时标记
  }
}, [id])

// 3. AI每发一条消息，计数+1
aiRepliedCountRef.current++

// 4. AI回复完成时
if (!isMountedRef.current) {
  // 组件已卸载（切换聊天），保存消息并增加未读
  localStorage.setItem(`chat_messages_${id}`, JSON.stringify(messages))
  incrementUnread(id, aiRepliedCount)
} else if (!isPageVisible) {
  // 页面不可见，只增加未读
  incrementUnread(id, aiRepliedCount)
}
markAIReplyComplete(id)

// 5. 进入聊天时清除未读
clearUnread(characterId)
```

## 📊 使用场景

### 场景 1：切换聊天等待AI回复（主要场景）
1. 正在和AI-A聊天，发送消息并点击纸飞机
2. AI-A开始生成回复（可能需要10-30秒）
3. **不等待**，直接切换到AI-B的聊天
4. AI-A在后台继续生成回复
5. 回复完成后，聊天列表中AI-A显示红色未读标记 🔴
6. 切回AI-A查看完整回复

### 场景 2：同时和多个AI聊天
1. 给AI-A发消息 → 触发回复 → 切换
2. 给AI-B发消息 → 触发回复 → 切换
3. 给AI-C发消息 → 触发回复 → 回到聊天列表
4. 等待片刻，查看聊天列表哪些AI已回复（红点）
5. 依次进入查看每个AI的回复

### 场景 3：回到聊天列表等待
1. 发送消息并触发AI回复
2. 返回聊天列表做其他事
3. AI回复完成后，聊天列表显示未读标记
4. 点击进入查看回复

## 🎨 视觉效果

### 聊天列表未读标记
```
┌─────────────────────────────┐
│ [头像] AI名称        13:52   │
│        最后一条消息...    [3] │ ← 红色圆点显示未读数量
└─────────────────────────────┘
```

### 未读消息样式
- **背景色**：`bg-red-500`（红色）
- **文字色**：`text-white`（白色）
- **形状**：圆形徽章
- **位置**：消息预览右侧
- **超过99条**：显示 `99+`

## ⚙️ 配置选项

### 持久化存储
- **AI回复状态**：存储在 `localStorage` 的 `ai_replying` 键
- **未读消息数**：存储在 `localStorage` 的 `unread_messages` 键
- **数据同步**：自动同步到聊天列表

### 超时设置
- **状态恢复时限**：5分钟
- **超过5分钟的待处理回复会被自动清除**

## 📝 注意事项

1. **不会打断正在进行的回复**：如果AI正在回复，不能重复触发
2. **只统计AI的回复**：用户自己发的消息不计入未读
3. **智能清除**：进入聊天界面时自动清除未读，不需要手动操作
4. **多端同步**：如果在多个标签页打开，未读消息会实时同步

## 🔍 调试信息

### 控制台日志

```javascript
// 标记AI回复
console.log('🎯 点击纸飞机按钮，准备调用AI')

// 页面可见性变化
console.log('👁️ 页面可见性变化: 可见/隐藏')

// AI回复完成
console.log('📬 后台AI回复完成，新增未读消息: X')

// 清除未读
console.log('✅ 已清除未读消息: characterId')
```

## 🎉 体验优化

### 性能优化
- **轻量级状态管理**：使用 `useRef` 避免不必要的重渲染
- **按需更新**：只在必要时更新聊天列表
- **延迟加载**：未读消息数据延迟同步，不阻塞UI

### 用户体验
- **即时反馈**：未读消息立即显示，不需要刷新
- **视觉突出**：红色标记醒目，不会错过消息
- **智能提醒**：只在真正有新消息时提醒

## 🚀 未来扩展

可能的功能扩展方向：
1. **消息推送**：集成浏览器通知API，桌面弹窗提醒
2. **声音提醒**：新消息到达时播放提示音
3. **消息预览**：在聊天列表直接预览部分消息内容
4. **未读消息过滤**：一键查看所有有未读消息的聊天
5. **消息汇总**：显示所有未读消息的总数

## 📖 相关文档

- [AI主动发消息功能说明.md](./AI主动发消息功能说明.md)
- [聊天系统技术文档](./ChatDetail拆分计划.md)
- [存储系统说明](./IndexedDB存储升级说明.md)

---

**版本**: v1.0.6  
**更新日期**: 2025-10-26  
**功能状态**: ✅ 已完成并测试
