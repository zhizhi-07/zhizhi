# 📝 记忆系统 - 角色描述提取

## 🎯 功能说明

现在记忆系统会**自动从角色描述中提取关于用户的初始记忆**。

### 问题

之前记忆系统只从对话中提取记忆，如果角色描述中包含了关于用户的信息（比如"用户是我的男朋友"），AI 不会记住。

### 解决方案

在第一次进入聊天时，自动分析角色描述，提取关于用户的信息并保存为初始记忆。

---

## 🔧 工作原理

### 提取时机

```
用户第一次进入聊天
↓
检查是否已提取过初始记忆
↓
如果没有，调用 AI 分析角色描述
↓
提取关于用户的信息
↓
保存为初始记忆（标记为"初始记忆"）
↓
设置标记，下次不再提取
```

### 提取内容

从角色描述中提取：
- ✅ 用户的基本信息（姓名、年龄、职业等）
- ✅ 用户的偏好喜好
- ✅ 用户和角色的关系
- ✅ 其他重要信息

---

## 📊 示例

### 角色描述格式

支持两种格式：

#### 格式 1：直接描述
```
你是一个温柔体贴的女朋友。
用户是你的男朋友，名字叫小明，今年25岁，在北京工作。
你们已经在一起两年了，感情很好。
小明喜欢打篮球，不喜欢吃榴莲。
```

#### 格式 2：Character Card 格式（酒馆 AI）
```
{{char}} 是一个温柔体贴的女朋友。
{{user}} 是 {{char}} 的男朋友，名字叫小明，今年25岁，在北京工作。
{{char}} 和 {{user}} 已经在一起两年了，感情很好。
{{user}} 喜欢打篮球，不喜欢吃榴莲。
```

**说明**：
- `{{user}}` 或 `{{User}}` = 用户
- `{{char}}` 或 `{{Char}}` = AI 角色
- 系统会自动识别并提取关于 `{{user}}` 的信息

### 提取的初始记忆

```json
[
  {
    "type": "fact",
    "content": "用户名字是小明",
    "importance": 9,
    "tags": ["基本信息", "初始记忆"]
  },
  {
    "type": "fact",
    "content": "用户25岁",
    "importance": 8,
    "tags": ["基本信息", "初始记忆"]
  },
  {
    "type": "fact",
    "content": "用户在北京工作",
    "importance": 7,
    "tags": ["基本信息", "初始记忆"]
  },
  {
    "type": "relationship",
    "content": "用户是我的男朋友，在一起两年了",
    "importance": 10,
    "tags": ["关系", "初始记忆"]
  },
  {
    "type": "preference",
    "content": "用户喜欢打篮球",
    "importance": 7,
    "tags": ["偏好", "初始记忆"]
  },
  {
    "type": "preference",
    "content": "用户不喜欢吃榴莲",
    "importance": 7,
    "tags": ["偏好", "初始记忆"]
  }
]
```

---

## 🎯 提取原则

### ✅ 会提取

- 明确提到的用户信息
- 用户和角色的关系
- 用户的偏好、习惯
- 其他重要的用户信息

### ❌ 不会提取

- 角色自己的信息
- 推测或想象的内容
- 不确定的信息

---

## 💡 使用建议

### 1. 在角色描述中包含用户信息

**推荐（直接描述）**：
```
你是一个温柔的女朋友。
用户是你的男朋友，名字叫小明，25岁，在北京工作。
你们在一起两年了。
小明喜欢打篮球，不喜欢吃榴莲。
```

**推荐（Character Card 格式）**：
```
{{char}} 是一个温柔的女朋友。
{{user}} 是 {{char}} 的男朋友，名字叫小明，25岁，在北京工作。
{{char}} 和 {{user}} 在一起两年了。
{{user}} 喜欢打篮球，不喜欢吃榴莲。
```

**不推荐**：
```
你是一个温柔的女朋友。
（没有关于用户的信息）
```

### 2. 明确表达

**好的表达**：
```
用户名字是小明
用户25岁
用户在北京工作
```

**不好的表达**：
```
你的男朋友（没说名字）
年轻人（没说年龄）
在大城市工作（没说哪里）
```

### 3. 查看提取结果

进入聊天后，查看记忆查看器，确认初始记忆是否正确提取。

---

## 🔄 提取流程

### 第一次进入聊天

```
1. 用户打开聊天
   ↓
2. useEffect 触发
   ↓
3. 检查 localStorage: initial_memories_extracted_角色ID
   ↓
4. 如果没有标记，调用 AI 分析角色描述
   ↓
5. AI 返回提取的记忆
   ↓
6. 保存记忆到 memorySystem
   ↓
7. 设置标记 initial_memories_extracted_角色ID = true
   ↓
8. 下次进入时跳过提取
```

### 第二次及以后

```
1. 用户打开聊天
   ↓
2. useEffect 触发
   ↓
3. 检查 localStorage: initial_memories_extracted_角色ID
   ↓
4. 发现已提取过，跳过
   ↓
5. 直接使用已保存的记忆
```

---

## 📝 控制台日志

### 第一次提取

```
💭 开始提取初始记忆...
💭 从角色描述中提取了 6 条初始记忆
💭 初始记忆提取完成
```

### 已提取过

```
💭 初始记忆已提取过，跳过
```

### 角色描述为空

```
💭 角色描述为空，跳过初始记忆提取
```

---

## 🎨 记忆标记

所有从角色描述中提取的记忆都会自动添加 `"初始记忆"` 标签，方便区分。

**在记忆查看器中**：
```
📌 基本信息
• 用户名字是小明 [基本信息] [初始记忆]
• 用户25岁 [基本信息] [初始记忆]

❤️ 偏好喜好
• 用户喜欢打篮球 [偏好] [初始记忆]
```

---

## 🔧 技术实现

### memorySystem.ts

```typescript
// 从角色描述中提取初始记忆
async extractInitialMemories(characterDescription: string): Promise<void> {
  // 检查是否已提取过
  if (this.initialMemoriesExtracted) {
    console.log('💭 初始记忆已提取过，跳过')
    return
  }

  // 调用 AI 分析角色描述
  const prompt = `分析以下角色描述，提取关于用户的信息...`
  const response = await callAI([{ role: 'user', content: prompt }])
  
  // 解析并保存记忆
  // 添加"初始记忆"标签
  // 设置提取标记
}
```

### ChatDetail.tsx

```typescript
// 从角色描述中提取初始记忆（只执行一次）
useEffect(() => {
  if (character?.description && id) {
    memorySystem.extractInitialMemories(character.description)
      .then(() => {
        console.log('💭 初始记忆提取完成')
      })
      .catch((error: any) => {
        console.error('❌ 初始记忆提取失败:', error)
      })
  }
}, [character?.description, id, memorySystem])
```

---

## 💰 成本影响

### API 调用

- 每个角色只调用一次（第一次进入聊天时）
- 后续进入不再调用
- 成本可控

### 示例

```
角色A：第一次进入 → 调用 1 次 API
角色A：第二次进入 → 不调用
角色A：第三次进入 → 不调用

角色B：第一次进入 → 调用 1 次 API
角色B：第二次进入 → 不调用
```

---

## 🎊 总结

### ✅ 功能完成

1. ✅ 自动从角色描述中提取用户信息
2. ✅ 只在第一次进入时提取
3. ✅ 添加"初始记忆"标签
4. ✅ 保存到记忆系统
5. ✅ 成本可控（每个角色只调用一次）

### 🎯 使用方法

1. 在角色描述中包含用户信息
2. 第一次进入聊天时自动提取
3. 查看记忆查看器确认
4. 后续对话中 AI 会记住这些信息

### 💡 建议

- 在角色描述中明确写出用户信息
- 第一次进入后检查记忆是否正确
- 如有错误，可在记忆查看器中删除

---

**完成时间**: 2025-10-19  
**状态**: ✅ 已完成  
**方式**: 自动提取，每个角色只执行一次

🎉 **现在 AI 会记住角色描述中的用户信息了！** 🎉
